<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°„é¾é–€ Pro - å…¨å“¡åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #d4af37; --dark-green: #1a472a; --card-red: #e74c3c; }
        body { background: var(--dark-green); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 10px; }
        .setup-box { background: rgba(0,0,0,0.85); padding: 25px; border-radius: 20px; border: 2px solid var(--gold); margin-bottom: 20px; }
        .player-card { background: rgba(0,0,0,0.9); padding: 12px; border-radius: 12px; border: 2px solid #444; width: 130px; position: relative; }
        .player-card.active { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .kick-btn { position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; border: 2px solid white; display: none; }
        .is-host .kick-btn { display: block; }
        .balance-pos { color: #2ecc71; font-weight: bold; }
        .balance-neg { color: #ff7675; font-weight: bold; }
        .board { background: radial-gradient(circle, #2d5a3c 0%, #1a472a 100%); padding: 30px; border-radius: 50px; border: 4px solid var(--gold); position: relative; }
        .pool-display { font-size: 48px; color: #f1c40f; font-weight: bold; text-shadow: 2px 2px 4px black; }
        .cards { display: flex; justify-content: center; gap: 15px; margin: 20px 0; height: 160px; }
        .card { width: 100px; height: 145px; background: white; border-radius: 10px; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 35px; font-weight: bold; border: 2px solid #333; }
        .card.hidden { background: #2c3e50; color: transparent; border: 2px solid #7f8c8d; }
        button { padding: 10px 18px; cursor: pointer; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; color: #1a472a; margin: 5px; }
        
        /* å…¨å“¡åŒæ­¥ç‰¹æ•ˆå±¤ */
        #all-in-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; 
            justify-content: center; align-items: center; pointer-events: none;
        }
        #all-in-overlay img { width: 85%; max-width: 550px; border-radius: 20px; box-shadow: 0 0 30px #e74c3c; }
    </style>
</head>
<body>

<div id="all-in-overlay"><img src="https://i.makeagif.com/media/11-26-2024/eH5Q4S.gif"><h1>æœ‰äººå­¤æ³¨ä¸€æ“²äº†ï¼ï¼ï¼</h1></div>
<audio id="all-in-sound" src="https://actions.google.com/sounds/v1/foley/metal_trash_can_impact.ogg"></audio>

<div class="game-container">
    <h1>ğŸŸï¸ çš‡å®¶å°„é¾é–€ Pro (å…¨å“¡ç‰¹æ•ˆç‰ˆ)</h1>

    <div id="setup-area" class="setup-box">
        <div id="login-part">
            <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±">
            <button onclick="joinRoom()">æ‰¾å›èº«åˆ† / é€²å…¥</button>
        </div>
        <div id="host-part" style="display:none;">
            <h3 style="color:var(--gold);">ğŸ‘‘ æˆ¿ä¸»è¨­å®š</h3>
            åˆå§‹æœ¬é‡‘: <input type="number" id="start-balance" value="1000" style="width:80px;">
            åº•æ³¨: <input type="number" id="entry-fee" value="100" style="width:80px;">
            æ£„ç‰Œç½°é‡‘: <input type="number" id="fold-penalty" value="20" style="width:80px;">
            <button onclick="hostStartGame()" style="background:#2ecc71; color:white;">æ­£å¼é–‹æ¡Œ</button>
        </div>
    </div>

    <div id="player-area" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:20px;"></div>

    <div id="main-board" class="board" style="display:none;">
        <div class="pool-display">ğŸ’° $<span id="pool-val">0</span></div>
        <div id="status-msg" style="margin:10px; font-weight:bold; color:#f1c40f; min-height:1.5em;"></div>
        <div class="cards">
            <div id="c1" class="card hidden">?</div>
            <div id="c3" class="card hidden">?</div>
            <div id="c2" class="card hidden">?</div>
        </div>

        <div id="controls">
            <div id="draw-phase" style="display:none;"><button onclick="playerDrawGoal()" style="font-size:1.6rem; background:#3498db; color:white;">ğŸƒ æŠ½é¾é–€ç‰Œ</button></div>
            <div id="bet-phase" style="display:none;">
                <input type="number" id="bet-amount" placeholder="ä¸‹æ³¨é‡‘é¡" style="width:120px;">
                <button onclick="triggerAllIn()" style="background:#c0392b; color:white;">ALL IN</button>
                <button onclick="handleAction('shoot')" style="background:#2ecc71; color:white;">å°„é–€ï¼</button>
                <button onclick="handleAction('fold')" style="background:#95a5a6; color:white;">æ”¾æ£„</button>
            </div>
            <div id="host-controls" style="margin-top:20px; display:none;"><button onclick="hostResetToLobby()" style="background:#e74c3c; color:white;">ğŸš¨ æˆ¿ä¸»é‡è£½</button></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
        authDomain: "dargongatepoker.firebaseapp.com",
        databaseURL: "https://dargongatepoker-default-rtdb.firebaseio.com",
        projectId: "dargongatepoker",
        storageBucket: "dargongatepoker.firebasestorage.app",
        messagingSenderId: "204663560828",
        appId: "1:204663560828:web:9ede7b6190babde73f07f9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameRef = db.ref('dragonGate/room1');

    let myId = localStorage.getItem('dg_id') || "";
    let localData = {};
    let lastEffectId = ""; // é¿å…ç‰¹æ•ˆé‡è¤‡è§¸ç™¼

    function joinRoom() {
        const name = document.getElementById('my-name').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
        if (!myId) {
            const newRef = gameRef.child('players').push();
            myId = newRef.key;
            localStorage.setItem('dg_id', myId);
        }
        gameRef.child('players/'+myId).update({ name: name, lastActive: Date.now() });
        startListening();
        document.getElementById('login-part').style.display = 'none';
    }

    function startListening() {
        gameRef.on('value', snap => {
            localData = snap.val() || {};
            const players = localData.players || {};
            if (!players[myId]) return;

            const pKeys = Object.keys(players);
            const isHost = (pKeys[0] === myId);

            // å…¨å“¡åŒæ­¥ç‰¹æ•ˆåµæ¸¬
            if (localData.allInTrigger && localData.allInTrigger !== lastEffectId) {
                showAllInEffect();
                lastEffectId = localData.allInTrigger;
            }

            document.body.className = isHost ? "is-host" : "";
            document.getElementById('setup-area').style.display = localData.gameStarted ? 'none' : 'block';
            document.getElementById('host-part').style.display = (!localData.gameStarted && isHost) ? 'block' : 'none';
            document.getElementById('main-board').style.display = localData.gameStarted ? 'block' : 'none';
            document.getElementById('host-controls').style.display = (localData.gameStarted && isHost) ? 'block' : 'none';

            renderUI();
            renderPlayers();
        });
    }

    function showAllInEffect() {
        document.getElementById('all-in-sound').play();
        const overlay = document.getElementById('all-in-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => { overlay.style.display = 'none'; }, 3000);
    }

    function triggerAllIn() {
        if (confirm(`ğŸ”¥ ç¢ºå®šè¦å…¨å“¡åŒæ­¥ã€Œæˆ‘è¦å…¨éƒ¨ã€ä¸¦ä¸‹æ³¨ $${localData.pool} å—ï¼Ÿ`)) {
            // ç™¼é€åŒæ­¥æŒ‡ä»¤çµ¦æ‰€æœ‰äºº
            gameRef.update({ allInTrigger: Date.now().toString() });
            // è‡ªå‹•å¡«å…¥é‡‘é¡
            document.getElementById('bet-amount').value = localData.pool;
        }
    }

    function playerDrawGoal() {
        let deck = localData.deck || generateDecks(2);
        const c1 = deck.pop(); const c2 = deck.pop();
        gameRef.update({ deck: deck, c1: c1, c2: c2, c3: null, gameState: 'betting', statusMsg: `è¼ªåˆ° ã€${localData.players[myId].name}ã€‘ ä¸‹æ³¨` });
    }

    function handleAction(type) {
        let bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
        if (type !== 'fold' && (bet < 1 || bet > localData.pool)) return alert("é‡‘é¡ç„¡æ•ˆ");
        
        let nBal = localData.players[myId].balance, nPool = localData.pool, msg = "", c3 = null;
        let deck = localData.deck || generateDecks(2);

        if (type === 'fold') {
            const pen = localData.foldPenalty || 20;
            nBal -= pen; nPool += pen; msg = `${localData.players[myId].name} æ£„ç‰Œã€‚`;
        } else {
            c3 = deck.pop();
            const min = Math.min(localData.c1.val, localData.c2.val), max = Math.max(localData.c1.val, localData.c2.val);
            if (localData.c1.val === localData.c2.val) {
                if (c3.val === localData.c1.val) { nBal -= bet*3; nPool += bet*3; msg = `ğŸš§ æ’æŸ±ï¼è¼¸ $${bet*3}`; }
                else if (c3.val > localData.c1.val) { nBal += bet; nPool -= bet; msg = `ğŸ‰ è´äº†ï¼è´ $${bet}`; }
                else { nBal -= bet; nPool += bet; msg = `âŒ è¼¸äº†ï¼è¼¸ $${bet}`; }
            } else {
                if (c3.val > min && c3.val < max) { nBal += bet; nPool -= bet; msg = `ğŸ‰ å°„é€²ï¼è´ $${bet}`; }
                else if (c3.val === min || c3.val === max) { nBal -= bet*2; nPool += bet*2; msg = `ğŸš§ æ’æŸ±ï¼è¼¸ $${bet*2}`; }
                else { nBal -= bet; nPool += bet; msg = `âŒ æ²’é€²ï¼è¼¸ $${bet}`; }
            }
        }

        const pKeys = Object.keys(localData.players);
        let nextK = pKeys[(pKeys.indexOf(myId) + 1) % pKeys.length];
        gameRef.update({
            [`players/${myId}/balance`]: nBal,
            pool: nPool,
            deck: deck,
            c3: c3 || null,
            statusMsg: msg,
            gameState: 'drawing',
            currentPlayerKey: nextK,
            allInTrigger: null // å‹•ä½œå®Œæˆå¾Œé‡è¨­ç‰¹æ•ˆæ¨™è¨˜
        });
        document.getElementById('bet-amount').value = "";
    }

    function renderPlayers() {
        const area = document.getElementById('player-area'); area.innerHTML = '';
        Object.keys(localData.players).forEach(id => {
            const p = localData.players[id];
            const div = document.createElement('div');
            div.className = `player-card ${id === localData.currentPlayerKey ? 'active' : ''}`;
            const bCls = p.balance >= 0 ? 'balance-pos' : 'balance-neg';
            div.innerHTML = `<button class="kick-btn" onclick="kickPlayer('${id}')">âœ•</button><b>${p.name}</b><br><span class="${bCls}">$${p.balance}</span>`;
            area.appendChild(div);
        });
    }

    function kickPlayer(id) { if(confirm("ç¢ºå®šè¸¢é™¤ï¼Ÿ")) gameRef.child('players/'+id).remove(); }
    function hostStartGame() {
        const fee = parseInt(document.getElementById('entry-fee').value);
        const start = parseInt(document.getElementById('start-balance').value);
        const foldP = parseInt(document.getElementById('fold-penalty').value);
        let players = localData.players, pool = 0;
        Object.keys(players).forEach(id => { players[id].balance = start - fee; pool += fee; });
        gameRef.update({ gameStarted: true, pool: pool, entryFee: fee, foldPenalty: foldP, deck: generateDecks(2), gameState: 'drawing', players: players, currentPlayerKey: Object.keys(players)[0], statusMsg: "è«‹æŠ½ç‰Œï¼" });
    }
    function generateDecks(n){ let d=[]; const s=['â™ ','â™¥','â™¦','â™£']; for(let i=0;i<n;i++) s.forEach(x=>{for(let v=1;v<=13;v++) d.push({val:v,suit:x,label:(v==1?'A':v==11?'J':v==12?'Q':v==13?'K':v)});}); return d.sort(()=>Math.random()-0.5); }
    function hostResetToLobby() { if(confirm("é‡è£½ï¼Ÿ")) gameRef.update({ gameStarted: false }); }
    function renderUI() {
        document.getElementById('pool-val').innerText = localData.pool || 0;
        document.getElementById('status-msg').innerText = localData.statusMsg || "";
        updateCard('c1', localData.c1); updateCard('c2', localData.c2); updateCard('c3', localData.c3);
        const isTurn = (localData.currentPlayerKey === myId);
        document.getElementById('draw-phase').style.display = (isTurn && localData.gameState === 'drawing') ? 'block' : 'none';
        document.getElementById('bet-phase').style.display = (isTurn && localData.gameState === 'betting') ? 'block' : 'none';
    }
    function updateCard(id, c) {
        const el = document.getElementById(id);
        if (!c) { el.classList.add('hidden'); el.innerText = '?'; }
        else { el.classList.remove('hidden'); el.innerText = `${c.suit}\n${c.label}`; el.style.color = (c.suit === 'â™¥' || c.suit === 'â™¦') ? 'red' : 'black'; }
    }
</script>
</body>
</html>

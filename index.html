<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°„é¾é–€ Pro - æ——è‰¦æ­£å¼ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-green: #1a472a;
            --felt: #2d5a3c;
            --card-red: #e74c3c;
            --table-border: #8B6914;
        }
        * { box-sizing: border-box; }
        body {
            background: #0d2318;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            margin: 0; padding: 8px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* â•â• SETUP SCREEN â•â• */
        .setup-box {
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 20px;
            border: 2px solid var(--gold);
            max-width: 480px; margin: 10px auto;
        }
        .input-group { margin: 10px 0; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap; }
        input[type="text"], input[type="number"], select { padding: 8px; border-radius: 5px; border: none; text-align: center; background: #333; color: white; }
        button { padding: 10px 15px; cursor: pointer; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; color: #1a472a; margin: 3px; transition: transform 0.1s; }
        button:active { transform: scale(0.96); }

        /* â•â• POKER TABLE â•â• */
        #table-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            /* é•·æ©¢åœ“æ¡Œï¼šé«˜åº¦ = å¯¬åº¦ Ã— 0.62 */
            padding-top: 62%;
        }
        #poker-table {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 40%, #3a7a52 0%, var(--felt) 55%, #1e4a30 100%);
            border-radius: 50%;
            border: 12px solid var(--table-border);
            box-shadow:
                0 0 0 4px #5a3a08,
                0 0 0 8px #2a1a04,
                inset 0 0 60px rgba(0,0,0,0.4),
                0 20px 60px rgba(0,0,0,0.8);
            overflow: hidden;
        }
        /* æ¡Œé¢ç´‹è·¯ */
        #poker-table::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                45deg, transparent, transparent 20px,
                rgba(255,255,255,0.015) 20px, rgba(255,255,255,0.015) 21px
            );
            border-radius: 50%;
        }

        /* â•â• æ¡Œé¢ä¸­å¤®ç‰Œå€ â•â• */
        #table-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -52%);
            width: 68%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 5;
        }
        .pool-display {
            font-size: clamp(18px, 4vw, 28px);
            color: #f1c40f;
            font-weight: bold;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }
        #status-msg {
            font-size: clamp(12px, 2.5vw, 15px);
            color: #ccc;
            min-height: 18px;
        }

        /* é–€æŸ±å€ï¼šå·¦æŸ± | é¾é–€ | å³æŸ± */
        .gate-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            width: 100%;
        }
        .card-slot-wrap {
            display: flex; flex-direction: column;
            align-items: center; gap: 3px;
        }
        .slot-label {
            font-size: clamp(9px, 1.8vw, 12px);
            color: #aaa; letter-spacing: 1px;
        }
        .slot-label.gate-lbl {
            color: var(--gold); font-weight: bold;
            font-size: clamp(9px, 1.8vw, 12px);
        }
        .post-connector {
            width: clamp(10px, 3vw, 20px); height: 3px;
            background: linear-gradient(90deg, rgba(212,175,55,0.6), rgba(212,175,55,0.2));
            flex-shrink: 0; align-self: center; margin-top: 16px;
        }
        .post-connector.right { background: linear-gradient(90deg, rgba(212,175,55,0.2), rgba(212,175,55,0.6)); }

        /* ç‰Œæ¨£å¼ */
        .card {
            width: clamp(44px, 9vw, 64px);
            height: clamp(62px, 13vw, 90px);
            background: white; border-radius: 7px;
            color: black;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: clamp(16px, 3.5vw, 24px);
            font-weight: bold;
            border: 2px solid #333;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
            white-space: pre-wrap;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .card.hidden { background: #1e3a5f; color: transparent; border-color: #3a6a9f; }
        .card.red { color: var(--card-red); }
        .gate-frame {
            width: clamp(44px, 9vw, 64px);
            height: clamp(62px, 13vw, 90px);
            border: 2px dashed rgba(212,175,55,0.4);
            border-radius: 7px;
            background: rgba(212,175,55,0.04);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: visible; flex-shrink: 0;
        }
        .gate-inner-text { color: rgba(212,175,55,0.3); font-size: clamp(8px, 1.5vw, 11px); }
        #c3-in-gate { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 10; }

        /* â•â• ç‰Œå † (3Dåšåº¦æ•ˆæœ) â•â• */
        #deck-stack-wrap {
            display: flex; flex-direction: column;
            align-items: center; gap: 5px;
            margin-top: 6px;
        }
        #deck-label { font-size: clamp(9px, 1.8vw, 12px); color: #aaa; }
        #deck-stack {
            position: relative;
            width: clamp(44px, 9vw, 62px);
            height: clamp(62px, 13vw, 88px);
            cursor: default;
        }
        /* åšåº¦å±¤ */
        .deck-layer {
            position: absolute;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3a5f, #2a4f7a);
            border-radius: 6px;
            border: 1.5px solid #3a6a9f;
        }
        .deck-layer:nth-child(1) { transform: translate(4px, 4px); background: #1a2f4a; }
        .deck-layer:nth-child(2) { transform: translate(2px, 2px); background: #1e3555; }
        .deck-layer:nth-child(3) { transform: translate(0, 0); background: linear-gradient(135deg, #2a4f80, #1e3a64); box-shadow: 2px 2px 8px rgba(0,0,0,0.6); }
        /* ç‰ŒèƒŒèŠ±ç´‹ */
        .deck-layer:nth-child(3)::after {
            content: 'ğŸ‚ ';
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(20px, 4vw, 30px);
            opacity: 0.5;
        }
        /* å¯é»æ“Šç‹€æ…‹ */
        #deck-stack.clickable {
            cursor: pointer;
            animation: deckPulse 1.2s ease-in-out infinite;
        }
        #deck-stack.clickable .deck-layer:nth-child(3) {
            background: linear-gradient(135deg, #3a6faa, #2a4f80);
            box-shadow: 0 0 15px rgba(212,175,55,0.5), 2px 2px 8px rgba(0,0,0,0.6);
            border-color: var(--gold);
        }
        #deck-count-badge {
            position: absolute; bottom: -6px; right: -6px;
            background: var(--gold); color: #1a472a;
            font-size: 10px; font-weight: bold;
            border-radius: 10px; padding: 1px 5px;
            z-index: 5;
        }
        @keyframes deckPulse {
            0%,100% { transform: scale(1); }
            50% { transform: scale(1.06); }
        }
        #deck-hint {
            font-size: clamp(9px, 1.8vw, 11px);
            color: var(--gold); opacity: 0;
            transition: opacity 0.3s;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
        }
        #deck-hint.show { opacity: 1; }

        /* â•â• ä¸‹æ³¨å€ï¼ˆæ¡Œé¢åº•éƒ¨å›ºå®šï¼‰ â•â• */
        #bet-panel {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(0deg, rgba(0,0,0,0.97) 0%, rgba(0,0,0,0.9) 100%);
            border-top: 2px solid var(--gold);
            padding: 10px 12px 20px;
            z-index: 200;
        }
        .chip-container { display: flex; justify-content: center; gap: 6px; margin: 6px 0; flex-wrap: wrap; }
        .chip-btn { background: none; border: none; padding: 0; cursor: pointer; transition: transform 0.1s; }
        .chip-btn:active { transform: scale(0.88); }
        .chip-btn img { width: clamp(44px, 11vw, 58px); height: clamp(44px, 11vw, 58px); border-radius: 50%; }
        #bet-amount { background: #222; color: var(--gold); border: 2px solid var(--gold); font-size: 1.2rem; width: 90px; border-radius: 8px; text-align: center; padding: 4px; }
        .bet-row { display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap; margin: 6px 0; }
        .action-btn-row { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        #shoot-normal { background: #2ecc71; color: white; font-size: 1rem; }
        #btn-up    { background: #3498db; color: white; }
        #btn-down  { background: #e67e22; color: white; }
        #btn-allin { background: var(--card-red); color: white; }
        #btn-fold  { background: #7f8c8d; color: white; font-size: 0.9rem; }

        /* â•â• æ©¢åœ“æ¡Œä¸Šç©å®¶åº§ä½ â•â• */
        .seat {
            position: absolute;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 20;
        }
        .seat-card {
            background: rgba(0,0,0,0.82);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 4px 7px;
            font-size: clamp(10px, 2vw, 13px);
            min-width: clamp(60px, 14vw, 90px);
            max-width: clamp(70px, 16vw, 100px);
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .seat-card.active { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); background: rgba(212,175,55,0.12); }
        .seat-card.is-me { border-color: #3498db; }
        .seat-card.active.is-me { border-color: var(--gold); }
        .seat-name { font-weight: bold; font-size: clamp(10px,2vw,13px); }
        .seat-balance { color: #2ecc71; font-size: clamp(9px,1.8vw,11px); }
        .seat-timer { color: #ff7675; font-size: clamp(8px,1.6vw,10px); }
        .seat-crown { color: var(--gold); font-size: 10px; }
        .seat-kick {
            position: absolute; top: -6px; right: -6px;
            background: #e74c3c; color: white; border-radius: 50%;
            width: 18px; height: 18px; border: 1px solid white;
            display: none; cursor: pointer; font-size: 11px; line-height: 16px;
            z-index: 25;
        }
        body.is-host .seat:not(.is-me) .seat-kick { display: block; }

        /* è¼ªåˆ°è‡ªå·±æ™‚æ¡Œé¢ç™¼å…‰ */
        @keyframes tableGlow {
            0%,100% { box-shadow: 0 0 0 4px #5a3a08, 0 0 0 8px #2a1a04, inset 0 0 60px rgba(0,0,0,0.4), 0 20px 60px rgba(0,0,0,0.8); }
            50%      { box-shadow: 0 0 0 4px var(--gold), 0 0 0 10px rgba(212,175,55,0.3), inset 0 0 60px rgba(0,0,0,0.4), 0 20px 60px rgba(0,0,0,0.8); }
        }
        #poker-table.my-turn { animation: tableGlow 1.5s ease-in-out infinite; }

        /* â•â• é ‚éƒ¨è³‡è¨Šåˆ— â•â• */
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 700px; margin: 0 auto 6px;
            padding: 0 4px;
            font-size: clamp(11px, 2.2vw, 14px);
        }
        #cards-left-badge {
            background: rgba(0,0,0,0.6); border: 1px solid #555;
            border-radius: 12px; padding: 3px 10px; font-size: 0.85em; color: #aaa;
        }
        .emoji-bar { display: flex; gap: 6px; }
        .emoji-btn { font-size: 1.3rem; background: rgba(0,0,0,0.4); border: 1px solid #555; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; }
        #host-reset-btn { background: #e74c3c; color: white; font-size: 0.8rem; padding: 5px 10px; display: none; }
        body.is-host #host-reset-btn { display: inline-block; }

        /* â•â• OVERLAYS â•â• */
        canvas#shot-canvas { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:7000; }

        #result-banner {
            display: none; position: fixed;
            top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.5);
            z-index: 8000; background: rgba(0,0,0,0.93);
            border-radius: 20px; padding: 16px 32px;
            border: 3px solid var(--gold); text-align: center;
            transition: transform 0.35s cubic-bezier(0.175,0.885,0.32,1.275), opacity 0.35s;
            opacity: 0; pointer-events: none;
        }
        #result-banner.show { display: block; transform: translate(-50%,-50%) scale(1); opacity: 1; }
        .rb-emoji  { font-size: 2.5rem; }
        .rb-text   { font-size: 1.5rem; font-weight: bold; margin: 4px 0; }
        .rb-amount { font-size: 2rem; font-weight: bold; }
        .rb-amount.positive { color: #2ecc71; }
        .rb-amount.negative { color: var(--card-red); }

        .confetti-piece { position: fixed; width: 9px; height: 13px; top: -20px; border-radius: 2px; pointer-events: none; animation: confettiFall linear forwards; z-index: 7999; }
        @keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity:1; } 100% { transform: translateY(110vh) rotate(720deg); opacity:0; } }

        #all-in-confirm-overlay { display: none; position: fixed; inset:0; background: rgba(0,0,0,0.9); z-index:9000; flex-direction:column; justify-content:center; align-items:center; }
        #all-in-confirm-overlay.show { display: flex; }
        .allin-box { background: linear-gradient(135deg,#1a1a1a,#2c0000); border: 3px solid var(--card-red); border-radius: 24px; padding: 28px 36px; text-align: center; animation: alinPop 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        @keyframes alinPop { from { transform:scale(0.6); opacity:0; } to { transform:scale(1); opacity:1; } }
        .allin-box h2 { font-size: 1.8rem; color: var(--card-red); margin:0 0 6px; }
        .allin-box p  { color:#ccc; margin:0 0 14px; }
        .allin-amount { font-size: 2.2rem; color: var(--gold); font-weight: bold; margin-bottom: 18px; }
        .allin-yes { background: var(--card-red) !important; color: white !important; font-size: 1rem !important; padding: 10px 24px !important; }
        .allin-no  { background: #555 !important; color: white !important; font-size: 1rem !important; padding: 10px 24px !important; }

        #all-in-overlay { display: none; position: fixed; inset:0; background: rgba(0,0,0,0.96); z-index:9999; flex-direction:column; justify-content:center; align-items:center; }

        #my-turn-toast { display:none; position:fixed; bottom:130px; left:50%; transform:translateX(-50%); background:var(--gold); color:#1a472a; font-weight:bold; font-size:1rem; padding:8px 24px; border-radius:30px; z-index:8500; box-shadow:0 4px 20px rgba(0,0,0,0.6); animation:toastBounce 0.4s ease-out; }
        @keyframes toastBounce { from { transform:translateX(-50%) translateY(30px); opacity:0; } to { transform:translateX(-50%) translateY(0); opacity:1; } }

        #refill-toast { display:none; position:fixed; top:70px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.92); color:var(--gold); border:2px solid var(--gold); font-size:0.9rem; padding:8px 20px; border-radius:20px; z-index:8500; text-align:center; white-space:nowrap; }

        #emoji-broadcast-area { position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:10000; }
        .broadcast-item { background:rgba(0,0,0,0.88); color:var(--gold); padding:8px 18px; border-radius:30px; margin-bottom:5px; font-weight:bold; border:2px solid var(--gold); animation:fadeUp 2.5s forwards; }
        @keyframes fadeUp { 0%{opacity:0;transform:translateY(10px);} 20%{opacity:1;transform:translateY(0);} 80%{opacity:1;} 100%{opacity:0;transform:translateY(-20px);} }

        /* â•â• SETUP ç•«é¢çš„ title â•â• */
        h1 { font-size: clamp(1.2rem,4vw,1.8rem); margin: 8px 0; color: var(--gold); text-shadow: 0 2px 8px rgba(0,0,0,0.8); }

        /* æ¡Œé¢åº•éƒ¨ spacerï¼ˆè®“ bet-panel ä¸æ“‹ä½å…§å®¹ï¼‰ */
        #bottom-spacer { height: 150px; }
    </style>
</head>
<body>

<canvas id="shot-canvas"></canvas>
<div id="emoji-broadcast-area"></div>

<!-- çµæœæ©«å¹… -->
<div id="result-banner">
    <div class="rb-emoji" id="rb-emoji">ğŸ‰</div>
    <div class="rb-text"  id="rb-text">å°„é€²ï¼</div>
    <div class="rb-amount" id="rb-amount">+$0</div>
</div>

<!-- ALL IN ç¢ºèª -->
<div id="all-in-confirm-overlay">
    <div class="allin-box">
        <h2>ğŸ”¥ ALL IN ç¢ºèª</h2>
        <p>ä½ ç¢ºå®šè¦æŠ¼ä¸Šå…¨éƒ¨å½©é‡‘ï¼Ÿ</p>
        <div class="allin-amount" id="allin-pool-preview">$0</div>
        <div style="display:flex;gap:14px;justify-content:center;">
            <button class="allin-yes" onclick="confirmAllIn()">ğŸ’¥ æˆ‘è¦å…¨éƒ¨ï¼</button>
            <button class="allin-no"  onclick="cancelAllIn()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- ALL IN å½±ç‰‡ -->
<div id="all-in-overlay"><div id="video-box"></div><h1 style="color:var(--gold);margin-top:20px;">æˆ‘è¦å…¨éƒ¨ï¼ï¼ï¼</h1></div>

<div id="refill-toast"></div>
<div id="my-turn-toast">ğŸ¯ è¼ªåˆ°ä½ äº†ï¼</div>

<!-- éŸ³æ•ˆ -->
<audio id="sfx-win"   src="sfx/win.mp3"   preload="auto"></audio>
<audio id="sfx-lose"  src="sfx/lose.mp3"  preload="auto"></audio>
<audio id="sfx-crash" src="sfx/crash.mp3" preload="auto"></audio>
<audio id="sfx-fold"  src="sfx/fold.mp3"  preload="auto"></audio>
<audio id="sfx-allin" src="sfx/allin.mp3" preload="auto"></audio>
<audio id="sfx-deal"  src="sfx/deal.mp3"  preload="auto"></audio>

<!-- â•â• SETUP ç•«é¢ â•â• -->
<div id="setup-area">
    <h1>ğŸŸï¸ åŸ”å¢˜é‡‘é¾é–€ Pro</h1>
    <div class="setup-box">
        <div id="login-part">
            <div class="input-group">
                <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±" style="width:180px;">
            </div>
            <button onclick="joinRoom()" style="background:#2ecc71;color:white;width:160px;font-size:1.1rem;margin-top:8px;">é€²å…¥å¤§å»³</button>
        </div>
        <div id="host-part" style="display:none;">
            <h3 style="color:var(--gold);margin:0 0 10px;">ğŸ‘‘ æˆ¿ä¸»è¦å‰‡è¨­å®š</h3>
            <div class="input-group">åˆå§‹æœ¬é‡‘: <input type="number" id="start-balance" value="1000" style="width:80px;"></div>
            <div class="input-group">é–‹å±€åº•æ³¨: <input type="number" id="entry-fee" value="100" style="width:70px;"> &nbsp; æ£„ç‰Œç½°é‡‘: <input type="number" id="fold-penalty" value="20" style="width:60px;"></div>
            <div class="input-group">ç‰Œçµ„æ•¸é‡: <select id="deck-count"><option value="1">1å‰¯</option><option value="2" selected>2å‰¯</option><option value="3">3å‰¯</option><option value="4">4å‰¯</option></select></div>
            <div class="input-group"><label><input type="checkbox" id="auto-refill" checked> æ± é‡‘ä¸è¶³è‡ªå‹•è£œåº•</label></div>
            <button onclick="hostStartGame()" style="background:#2ecc71;color:white;width:90%;font-size:1.1rem;margin-top:10px;">âœ… ç¢ºèªä¸¦é–‹æ¡Œ</button>
        </div>
    </div>
</div>

<!-- â•â• GAME ç•«é¢ â•â• -->
<div id="game-area" style="display:none;">
    <h1 style="margin:4px 0;">ğŸŸï¸ åŸ”å¢˜é‡‘é¾é–€ Pro</h1>

    <!-- é ‚éƒ¨å·¥å…·åˆ— -->
    <div id="top-bar">
        <div class="emoji-bar">
            <button class="emoji-btn" onclick="sendEmoji('ğŸ˜‚')">ğŸ˜‚</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ”¥')">ğŸ”¥</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ’¸')">ğŸ’¸</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ’©')">ğŸ’©</button>
        </div>
        <div id="cards-left-badge">ğŸ´ <span id="cards-left">0</span></div>
        <button id="host-reset-btn" onclick="hostResetToLobby()">ğŸš¨ é‡è£½</button>
    </div>

    <!-- æ©¢åœ“ç‰Œæ¡Œ -->
    <div id="table-container">
        <div id="poker-table">
            <!-- æ¡Œé¢ä¸­å¤®å€ -->
            <div id="table-center">
                <div class="pool-display">ğŸ’° $<span id="pool-val">0</span></div>
                <div id="status-msg">ç­‰å¾…ç™¼ç‰Œ...</div>

                <!-- å·¦æŸ± | é¾é–€ | å³æŸ± -->
                <div class="gate-row">
                    <div class="card-slot-wrap">
                        <div class="slot-label">å·¦æŸ±</div>
                        <div id="c1" class="card hidden">?</div>
                    </div>
                    <div class="post-connector"></div>
                    <div class="card-slot-wrap">
                        <div class="slot-label gate-lbl">ğŸ‰ é¾é–€</div>
                        <div class="gate-frame" id="gate-frame">
                            <span class="gate-inner-text" id="gate-inner">å¾…å°„é–€</span>
                            <div id="c3-in-gate"></div>
                        </div>
                    </div>
                    <div class="post-connector right"></div>
                    <div class="card-slot-wrap">
                        <div class="slot-label">å³æŸ±</div>
                        <div id="c2" class="card hidden">?</div>
                    </div>
                </div>

                <!-- ç‰Œå †ï¼ˆé»æ“ŠæŠ½ç‰Œï¼‰ -->
                <div id="deck-stack-wrap">
                    <div id="deck-label">ç‰Œçµ„</div>
                    <div id="deck-stack" onclick="onDeckClick()">
                        <div class="deck-layer"></div>
                        <div class="deck-layer"></div>
                        <div class="deck-layer">
                            <span id="deck-count-badge">0</span>
                        </div>
                    </div>
                    <div id="deck-hint">é»æ“ŠæŠ½ç‰Œ</div>
                </div>
            </div>

            <!-- ç©å®¶åº§ä½ï¼ˆJSå‹•æ…‹ç”Ÿæˆï¼‰ -->
            <div id="seats-container"></div>
        </div>
    </div>

    <div id="bottom-spacer"></div>
</div>

<!-- â•â• ä¸‹æ³¨é¢æ¿ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ â•â• -->
<div id="bet-panel">
    <div class="chip-container">
        <button class="chip-btn" onclick="addBet(10)"><img src="pic/m10.jpg"></button>
        <button class="chip-btn" onclick="addBet(50)"><img src="pic/m50.jpg"></button>
        <button class="chip-btn" onclick="addBet(100)"><img src="pic/m100.jpg"></button>
        <button class="chip-btn" onclick="addBet(500)"><img src="pic/m500.jpg"></button>
        <button class="chip-btn" onclick="addBet(1000)"><img src="pic/m1000.jpg"></button>
    </div>
    <div class="bet-row">
        ä¸‹æ³¨ï¼š<input type="number" id="bet-amount" value="0" readonly>
        <button onclick="document.getElementById('bet-amount').value=0" style="background:#555;color:white;padding:6px 12px;">æ¸…ç©º</button>
    </div>
    <div class="action-btn-row">
        <button id="shoot-normal" onclick="handleAction('shoot')">ğŸ¯ å°„é–€ï¼</button>
        <button id="btn-up"   onclick="handleAction('up')"   style="display:none;">â¬†ï¸ çŒœå¤§</button>
        <button id="btn-down" onclick="handleAction('down')" style="display:none;">â¬‡ï¸ çŒœå°</button>
        <button id="btn-allin" onclick="setAllIn()">ğŸ’¥ ALL IN</button>
        <button id="btn-fold"  onclick="handleAction('fold')">ğŸ³ï¸ æ”¾æ£„($<span id="fold-cost-ui">0</span>)</button>
    </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE åˆå§‹åŒ–
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
    apiKey: "AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
    authDomain: "dargongatepoker.firebaseapp.com",
    databaseURL: "https://dargongatepoker-default-rtdb.firebaseio.com",
    projectId: "dargongatepoker",
    storageBucket: "dargongatepoker.firebasestorage.app",
    messagingSenderId: "204663560828",
    appId: "1:204663560828:web:9ede7b6190babde73f07f9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const gameRef = db.ref('dragonGate/room1');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å…¨åŸŸç‹€æ…‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let myId = "";
let localData = {};
let lastEffectId = "INITIAL";
let lastShotId   = "INITIAL";   // (1) å»£æ’­é£›ç‰Œï¼šè¿½è¹¤ä¸Šæ¬¡å·²æ’­çš„ shotId
let lastEmojiTime = 0;
let serverOffset = 0;
let wasMyturn = false;
const labels = {1:'A', 11:'J', 12:'Q', 13:'K'};

db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());
function getServerNow() { return Date.now() + serverOffset; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   éŸ³æ•ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function playSfx(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.currentTime = 0;
    el.play().catch(() => {});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   (1) é£›ç‰Œå‹•ç•«ï¼ˆå»£æ’­ç‰ˆï¼‰
   æ‰€æœ‰ç©å®¶éƒ½å¾ Firebase æ”¶åˆ° shotResult å¾Œæ’­æ”¾
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function animateShotCard(cardData, resultType, onDone) {
    const canvas = document.getElementById('shot-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const gateEl = document.getElementById('gate-frame');
    const gateRect = gateEl.getBoundingClientRect();
    const gateX = gateRect.left + gateRect.width / 2;
    const gateY = gateRect.top  + gateRect.height / 2;

    const c1Rect = document.getElementById('c1').getBoundingClientRect();
    const c2Rect = document.getElementById('c2').getBoundingClientRect();
    const leftPostX  = c1Rect.left + c1Rect.width / 2;
    const rightPostX = c2Rect.left + c2Rect.width / 2;

    const isRed = cardData.suit === 'â™¥' || cardData.suit === 'â™¦';
    const cardW = 60, cardH = 86;

    // èµ·é»ï¼šå¾ deck-stack ä½ç½®é£›å‡º
    const deckEl = document.getElementById('deck-stack');
    const deckRect = deckEl.getBoundingClientRect();
    let startX = deckRect.left + deckRect.width / 2;
    let startY = deckRect.top  + deckRect.height / 2;

    let endX, endY;
    if (resultType === 'win') {
        endX = gateX; endY = gateY;
    } else if (resultType === 'crash') {
        endX = (Math.random() > 0.5) ? leftPostX : rightPostX;
        endY = gateY;
    } else {
        endX = (Math.random() > 0.5) ? -cardW : canvas.width + cardW;
        endY = gateY - 30;
    }

    const cpX = (startX + endX) / 2 + (Math.random() - 0.5) * 100;
    const cpY = Math.min(startY, endY) - 160;

    let t = 0;
    const dur = 55;
    let rotation = 0;

    function drawCard(x, y, rot, alpha, scale = 1) {
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.translate(x, y);
        ctx.rotate(rot);
        ctx.scale(scale, scale);
        ctx.fillStyle = '#fff';
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        rRect(ctx, -cardW/2, -cardH/2, cardW, cardH, 7);
        ctx.fill(); ctx.stroke();
        ctx.fillStyle = isRed ? '#e74c3c' : '#111';
        ctx.font = `bold 20px 'Segoe UI'`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(cardData.suit, 0, -11);
        ctx.fillText(String(cardData.label), 0, 14);
        ctx.restore();
    }

    function rRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
        ctx.quadraticCurveTo(x+w,y,x+w,y+r);
        ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
        ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
        ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
        ctx.closePath();
    }

    let particles = [];
    function spawnCrash(x,y) {
        for (let i=0;i<22;i++) {
            const a=Math.random()*Math.PI*2, s=3+Math.random()*7;
            particles.push({ x, y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:1, color: Math.random()>0.5?'#f39c12':'#e74c3c' });
        }
    }

    let phase='fly', it=0;

    function frame() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (phase==='fly') {
            t++;
            const p=t/dur;
            const e = p<0.5 ? 2*p*p : -1+(4-2*p)*p;
            const bx=(1-e)*(1-e)*startX + 2*(1-e)*e*cpX + e*e*endX;
            const by=(1-e)*(1-e)*startY + 2*(1-e)*e*cpY + e*e*endY;
            rotation += 0.14;
            drawCard(bx, by, rotation, Math.min(1,p*3));
            if (t>=dur) { phase='impact'; if(resultType==='crash') spawnCrash(endX,endY); }
            requestAnimationFrame(frame);
        } else if (phase==='impact') {
            it++;
            if (resultType==='win') {
                const a=1-it/22, sc=1-it/28;
                if (a>0) {
                    ctx.save(); ctx.strokeStyle=`rgba(46,204,113,${a})`; ctx.lineWidth=4;
                    ctx.beginPath(); ctx.arc(endX,endY,45+it*3,0,Math.PI*2); ctx.stroke(); ctx.restore();
                    drawCard(endX,endY,0,a,sc);
                }
            } else if (resultType==='crash') {
                particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.3; p.life-=0.04;
                    ctx.save(); ctx.globalAlpha=p.life; ctx.fillStyle=p.color;
                    ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fill(); ctx.restore(); });
                particles=particles.filter(p=>p.life>0);
                drawCard(endX+(Math.random()-0.5)*(10-it*0.5),endY,Math.random()*0.3,Math.max(0,1-it/20));
            } else {
                const a=Math.max(0,1-it/14), fly=it*9, dir=endX<canvas.width/2?-1:1;
                drawCard(endX+dir*fly,endY-fly*0.25,rotation+it*0.2,a);
            }
            if (it>=26||(resultType==='lose'&&it>=16)) {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                if (onDone) onDone();
                return;
            }
            requestAnimationFrame(frame);
        }
    }
    requestAnimationFrame(frame);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   çµæœæ©«å¹…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showResultBanner(emoji, text, amount) {
    const b = document.getElementById('result-banner');
    document.getElementById('rb-emoji').innerText = emoji;
    document.getElementById('rb-text').innerText  = text;
    const ae = document.getElementById('rb-amount');
    ae.innerText = (amount >= 0 ? '+' : '') + '$' + Math.abs(amount);
    ae.className = 'rb-amount ' + (amount >= 0 ? 'positive' : 'negative');
    b.classList.remove('show'); b.style.display='block';
    requestAnimationFrame(() => requestAnimationFrame(() => b.classList.add('show')));
    setTimeout(() => { b.classList.remove('show'); setTimeout(() => b.style.display='none', 400); }, 2800);
}

/* å½©ç´™ */
function spawnConfetti(n) {
    const cols=['#f1c40f','#2ecc71','#3498db','#e74c3c','#9b59b6','#fff'];
    for (let i=0;i<n;i++) {
        const el=document.createElement('div'); el.className='confetti-piece';
        el.style.left=Math.random()*100+'vw';
        el.style.background=cols[Math.floor(Math.random()*cols.length)];
        el.style.animationDuration=(1.4+Math.random()*1.5)+'s';
        el.style.animationDelay=(Math.random()*0.5)+'s';
        document.body.appendChild(el); setTimeout(()=>el.remove(),3500);
    }
}

/* Toast */
let myTurnTimer=null;
function showMyTurnToast() {
    const t=document.getElementById('my-turn-toast'); t.style.display='block';
    if('vibrate'in navigator) navigator.vibrate([150,50,150]);
    clearTimeout(myTurnTimer); myTurnTimer=setTimeout(()=>t.style.display='none',3000);
}
let refillTimer=null;
function showRefillToast(fee,count) {
    const t=document.getElementById('refill-toast');
    t.innerText=`ğŸ’° æ± é‡‘ä¸è¶³ï¼Œæ¯äººè£œåº• $${fee}ï¼ˆå…±è£œ $${fee*count}ï¼‰`;
    t.style.display='block'; clearTimeout(refillTimer); refillTimer=setTimeout(()=>t.style.display='none',3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   (2) æ©¢åœ“æ¡Œç©å®¶åº§ä½è¨ˆç®—
   è‡ªå·±æ°¸é æ”¾åœ¨æœ€ä¸‹æ–¹ï¼ˆåº•éƒ¨ä¸­å¤®ï¼‰ï¼Œå…¶ä»–äººå‡åˆ†åœ¨æ©¢åœ“ä¸Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSeats() {
    const container = document.getElementById('seats-container');
    container.innerHTML = '';
    if (!localData.players) return;

    const pKeys = Object.keys(localData.players);
    const n = pKeys.length;
    if (n === 0) return;

    const myIdx = pKeys.indexOf(myId);

    // æ©¢åœ“é•·çŸ­è»¸æ¯”ï¼ˆåº§ä½æ“ºåœ¨æ¡Œé‚Šç·£ï¼‰
    // ä»¥ % è¡¨ç¤ºï¼Œç›¸å°æ–¼ table-container
    const rx = 47; // æ°´å¹³åŠå¾‘ %
    const ry = 44; // å‚ç›´åŠå¾‘ %

    pKeys.forEach((id, i) => {
        const p = localData.players[id];
        const isMe = (id === myId);
        const isHost = (i === 0);
        const isActive = (id === localData.currentPlayerKey);

        // è§’åº¦ï¼šè‡ªå·±å›ºå®šåœ¨ 90Â°ï¼ˆæ­£ä¸‹æ–¹ï¼‰ï¼Œå…¶ä»–äººå‡å‹»åˆ†ä½ˆ
        // å¾æ­£ä¸‹æ–¹é–‹å§‹ï¼Œé€†æ™‚é‡åˆ†é…ï¼ˆè®“ç‰Œæ¡Œæ„Ÿè¦ºè‡ªç„¶ï¼‰
        let relIdx = (i - myIdx + n) % n;
        let angleDeg = 90 + relIdx * (360 / n);
        let angleRad = (angleDeg * Math.PI) / 180;

        let cx = 50 + rx * Math.cos(angleRad);
        let cy = 50 + ry * Math.sin(angleRad);

        const seat = document.createElement('div');
        seat.className = 'seat' + (isMe ? ' is-me' : '');
        seat.style.left = cx + '%';
        seat.style.top  = cy + '%';

        const crown = isHost ? `<span class="seat-crown">ğŸ‘‘</span>` : '';
        let timer = '';
        if (isActive && localData.lastActionTime) {
            const sec = Math.max(0, 60 - Math.floor((getServerNow() - localData.lastActionTime) / 1000));
            timer = `<div class="seat-timer">â±${sec}s</div>`;
        }

        let cardClass = 'seat-card' + (isActive ? ' active' : '') + (isMe ? ' is-me' : '');

        seat.innerHTML = `
            <button class="seat-kick" onclick="kickPlayer('${id}')">âœ•</button>
            <div class="${cardClass}">
                <div class="seat-name">${p.name}${crown}</div>
                <div class="seat-balance">$${p.balance}</div>
                ${timer}
            </div>`;
        container.appendChild(seat);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   (3) ç‰Œå †é»æ“Šé‚è¼¯
   gameState = 'waiting_deal'  â†’ é»ç‰Œå † = æŠ½å·¦å³æŸ±
   gameState = 'waiting_shoot' â†’ é»ç‰Œå † = å°„é–€ï¼ˆæŠ½é¾é–€ç‰Œï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onDeckClick() {
    if (!localData.gameStarted) return;
    const isTurn = (localData.currentPlayerKey === myId);
    if (!isTurn) return;

    if (localData.gameState === 'waiting_deal') {
        drawGoalPost();
    } else if (localData.gameState === 'waiting_shoot') {
        // å…ˆç¢ºèªå·²ä¸‹æ³¨
        const bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
        if (bet < 1 || bet > localData.pool) {
            // é–ƒçˆæç¤ºéœ€å…ˆä¸‹æ³¨
            const hint = document.getElementById('deck-hint');
            hint.innerText = 'âš ï¸ è«‹å…ˆä¸‹æ³¨ï¼';
            hint.classList.add('show');
            setTimeout(() => { hint.innerText = 'é»æ“ŠæŠ½ç‰Œ'; hint.classList.remove('show'); }, 1500);
            return;
        }
        // æ±ºå®šé¡å‹
        const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;
        if (isSame) {
            // å°å­ï¼šéœ€è¦çŒœå¤§/çŒœå°ï¼Œä¸ç›´æ¥æŠ½ï¼Œæç¤ºæŒ‰éˆ•
            const hint = document.getElementById('deck-hint');
            hint.innerText = 'âš ï¸ è«‹å…ˆçŒœå¤§æˆ–çŒœå°';
            hint.classList.add('show');
            setTimeout(() => { hint.innerText = 'é»æ“ŠæŠ½ç‰Œ'; hint.classList.remove('show'); }, 1500);
        } else {
            handleAction('shoot');
        }
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ ¸å¿ƒè¨ˆæ™‚å™¨ï¼ˆæ¯ç§’ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setInterval(() => {
    if (myId && localData.players && localData.players[myId])
        gameRef.child('players/'+myId).update({ lastActive: getServerNow() });
}, 5000);

setInterval(() => {
    if (!localData.players) return;
    const now = getServerNow();
    const players = localData.players;
    const pKeys = Object.keys(players);

    if (pKeys[0] === myId) {
        pKeys.forEach(id => {
            if (id !== myId && (!players[id].lastActive || now - players[id].lastActive > 60000))
                gameRef.child('players/'+id).remove();
        });
    }

    if (pKeys.length === 0 && localData.gameStarted) {
        gameRef.update({ gameStarted: false, c1:null, c2:null, c3:null }); return;
    }
    if (!localData.gameStarted) return;

    const cpKey = localData.currentPlayerKey;
    if (cpKey && !players[cpKey]) {
        gameRef.update({ gameState:'waiting_deal', currentPlayerKey:pKeys[0], lastActionTime:firebase.database.ServerValue.TIMESTAMP }); return;
    }

    if (pKeys[0] === myId && localData.lastActionTime) {
        const diff = (now - localData.lastActionTime) / 1000;
        if (diff > 60.5) {
            gameRef.child('players/'+cpKey).remove().then(() => {
                const nk = Object.keys(localData.players).filter(k=>k!==cpKey);
                gameRef.update({ gameState:'waiting_deal', currentPlayerKey:nk[0]||null, statusMsg:"ç©å®¶è¶…æ™‚è¸¢é™¤", lastActionTime:firebase.database.ServerValue.TIMESTAMP });
            });
        }
    }
    renderSeats(); // æ¯ç§’æ›´æ–°è¨ˆæ™‚å™¨
}, 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JOIN / LISTEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function joinRoom() {
    const name = document.getElementById('my-name').value.trim();
    if (!name) return alert("è«‹è¼¸å…¥æš±ç¨±");

    // 1. å…ˆè®€ä¸€æ¬¡ç›®å‰æˆ¿é–“ç‹€æ…‹
    gameRef.once('value', snap => {
        const data = snap.val() || {};

        // 2. è¨˜ä½ç›®å‰çš„å»£æ’­ IDï¼Œé¿å…é€²å ´å°±è§¸ç™¼èˆŠçš„ç‰¹æ•ˆ
        if (data.allInTrigger) lastEffectId = data.allInTrigger;
        if (data.lastEmoji)    lastEmojiTime = data.lastEmoji.time;
        if (data.lastShot)     lastShotId    = data.lastShot.id;

        // 3. å»ºç«‹ç©å®¶ï¼Œç”¨ set ç¢ºä¿å®Œæ•´è¦†è“‹
        const newRef = gameRef.child('players').push();
        myId = newRef.key;

        // 4. å¯«å®Œä¹‹å¾Œæ‰é–‹å§‹ç›£è½ï¼Œç”¨ then ç¢ºä¿é †åº
        gameRef.child('players/'+myId).set({
            name, balance: 0, lastActive: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            // 5. éš±è—ç™»å…¥å€ï¼Œé–‹å§‹ç›£è½
            document.getElementById('login-part').style.display = 'none';
            startListening();
        });
    });
}

function startListening() {
    gameRef.on('value', snap => {
        localData = snap.val() || {};

        // è‹¥è‡ªå·±é‚„ä¸åœ¨ç©å®¶åˆ—è¡¨ï¼ˆæ¥µçŸ­æš«çš„åŒæ­¥å»¶é²ï¼‰ï¼Œç›´æ¥è·³éé€™æ¬¡æ›´æ–°
        if (!localData.players || !localData.players[myId]) return;

        const pKeys = Object.keys(localData.players);
        const isHost = (pKeys[0] === myId);
        document.body.className = isHost ? "is-host" : "";

        // Emoji å»£æ’­
        if (localData.lastEmoji && localData.lastEmoji.time > lastEmojiTime) {
            showEmojiBroadcast(localData.lastEmoji.name, localData.lastEmoji.icon);
            lastEmojiTime = localData.lastEmoji.time;
        }

        // ALL IN å½±ç‰‡
        if (localData.allInTrigger && localData.allInTrigger !== lastEffectId) {
            const v = document.getElementById('video-box');
            v.innerHTML = `<video width="315" height="560" autoplay playsinline><source src="video/allin.mp4" type="video/mp4"></video>`;
            document.getElementById('all-in-overlay').style.display='flex';
            playSfx('sfx-allin');
            setTimeout(() => document.getElementById('all-in-overlay').style.display='none', 2500);
            lastEffectId = localData.allInTrigger;
        }

        // (1) å»£æ’­é£›ç‰Œï¼šæ‰€æœ‰äººéƒ½æ”¶åˆ° lastShot ä¸” id ä¸åŒæ™‚æ’­æ”¾
        if (localData.lastShot && localData.lastShot.id !== lastShotId) {
            const shot = localData.lastShot;
            lastShotId = shot.id;
            // å…ˆæ›´æ–°å·¦å³æŸ±ï¼ˆè®“å‹•ç•«çµæŸä½ç½®æ­£ç¢ºï¼‰
            updateCard('c1', localData.c1);
            updateCard('c2', localData.c2);
            document.getElementById('gate-inner').style.display = 'none';
            animateShotCard(shot.card, shot.resultType, () => {
                updateGateCard(localData.c3);
                const sfxMap = { win:'sfx-win', crash:'sfx-crash', lose:'sfx-lose', fold:'sfx-fold' };
                playSfx(sfxMap[shot.resultType] || 'sfx-lose');
                if (shot.resultType === 'win') spawnConfetti(40);
                showResultBanner(shot.emoji, shot.text, shot.delta);
            });
        }

        if (localData.gameStarted) {
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            renderUI(isHost);
            const isTurnNow = (localData.currentPlayerKey === myId);
            if (isTurnNow && !wasMyturn) showMyTurnToast();
            wasMyturn = isTurnNow;
        } else {
            document.getElementById('setup-area').style.display = 'block';
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('host-part').style.display = isHost ? 'block' : 'none';
            wasMyturn = false;
        }
        renderSeats();
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderUI(isHost) {
    document.getElementById('pool-val').innerText = localData.pool || 0;
    document.getElementById('status-msg').innerText = localData.statusMsg || "";
    document.getElementById('cards-left').innerText = localData.deck ? localData.deck.length : 0;
    document.getElementById('fold-cost-ui').innerText = localData.foldPenalty || 20;

    updateCard('c1', localData.c1);
    updateCard('c2', localData.c2);
    // åªåœ¨éæ’­æ”¾å‹•ç•«æ™‚æ›´æ–°é¾é–€ï¼ˆé¿å…è“‹æ‰é£›ç‰Œï¼‰
    if (!localData.lastShot || localData.lastShot.id === lastShotId)
        updateGateCard(localData.c3);

    const isTurn = (localData.currentPlayerKey === myId);
    const table = document.getElementById('poker-table');
    if (isTurn) table.classList.add('my-turn'); else table.classList.remove('my-turn');

    // ç‰Œå †äº’å‹•ç‹€æ…‹
    const deck = document.getElementById('deck-stack');
    const hint = document.getElementById('deck-hint');
    const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;

    if (isTurn && localData.gameState === 'waiting_deal') {
        deck.classList.add('clickable');
        hint.innerText = 'é»æ“ŠæŠ½ç‰Œ';
        hint.classList.add('show');
        document.getElementById('bet-panel').style.display = 'none';
    } else if (isTurn && localData.gameState === 'waiting_shoot') {
        deck.classList.add('clickable');
        hint.innerText = isSame ? 'ä¸‹æ³¨å¾ŒçŒœå¤§/çŒœå°' : 'ä¸‹æ³¨å¾Œé»æ“Šå°„é–€';
        hint.classList.add('show');
        document.getElementById('bet-panel').style.display = 'block';
    } else {
        deck.classList.remove('clickable');
        hint.classList.remove('show');
        document.getElementById('bet-panel').style.display = 'none';
    }

    // çŒœå¤§/çŒœå° vs å°„é–€
    document.getElementById('shoot-normal').style.display = isSame ? 'none' : 'inline-block';
    document.getElementById('btn-up').style.display   = isSame ? 'inline-block' : 'none';
    document.getElementById('btn-down').style.display = isSame ? 'inline-block' : 'none';

    // ç‰Œåº«æ•¸é‡ badge
    document.getElementById('deck-count-badge').innerText = localData.deck ? localData.deck.length : 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hostStartGame() {
    const fee   = parseInt(document.getElementById('entry-fee').value)    || 100;
    const start = parseInt(document.getElementById('start-balance').value) || 1000;
    const decks = parseInt(document.getElementById('deck-count').value)    || 2;
    const refill = document.getElementById('auto-refill').checked;
    let players = localData.players, pool = 0;
    Object.keys(players).forEach(id => { players[id].balance = start - fee; pool += fee; });
    gameRef.update({
        gameStarted:true, deck:generateDecks(decks), pool, entryFee:fee,
        foldPenalty: parseInt(document.getElementById('fold-penalty').value) || 20,
        autoRefill:refill, deckCount:decks, gameState:'waiting_deal',
        currentPlayerKey:Object.keys(players)[0], players,
        lastActionTime:firebase.database.ServerValue.TIMESTAMP, statusMsg:"æ–°å±€é–‹å§‹"
    });
}

function drawGoalPost() {
    playSfx('sfx-deal');
    let deck = localData.deck || [];
    if (deck.length < 3) deck = generateDecks(localData.deckCount || 2);
    const c1 = deck.pop(); const c2 = deck.pop();
    gameRef.update({
        deck, c1, c2, c3:null, gameState:'waiting_shoot',
        lastActionTime:firebase.database.ServerValue.TIMESTAMP, statusMsg:"è«‹ä¸‹æ³¨å¾ŒæŠ½é–€ç‰Œ"
    });
}

function handleAction(type) {
    let bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
    if (type !== 'fold' && (bet < 1 || bet > localData.pool)) return alert("è«‹ä¸‹æ³¨");

    let p = localData.players[myId], nBal = p.balance, nPool = localData.pool;
    let msg = "", c3 = null, deck = localData.deck || [];
    let resultType = 'neutral', deltaAmount = 0;

    if (type === 'fold') {
        nBal -= localData.foldPenalty; nPool += localData.foldPenalty;
        msg = `${p.name} æ£„ç‰Œ`; resultType='fold'; deltaAmount=-localData.foldPenalty;
    } else {
        if (deck.length < 1) deck = generateDecks(localData.deckCount || 2);
        c3 = deck.pop();
        const min = Math.min(localData.c1.val, localData.c2.val);
        const max = Math.max(localData.c1.val, localData.c2.val);

        if (localData.c1.val === localData.c2.val) {
            if (c3.val === localData.c1.val) {
                nBal-=bet*3; nPool+=bet*3; msg=`æ’æŸ±(-$${bet*3})`; resultType='crash'; deltaAmount=-(bet*3);
            } else if ((type==='up'&&c3.val>localData.c1.val)||(type==='down'&&c3.val<localData.c1.val)) {
                nBal+=bet; nPool-=bet; msg=`çŒœå°(+$${bet})`; resultType='win'; deltaAmount=bet;
            } else {
                nBal-=bet; nPool+=bet; msg=`çŒœéŒ¯(-$${bet})`; resultType='lose'; deltaAmount=-bet;
            }
        } else {
            if (c3.val>min && c3.val<max) {
                nBal+=bet; nPool-=bet; msg=`å°„é€²(+$${bet})`; resultType='win'; deltaAmount=bet;
            } else if (c3.val===min||c3.val===max) {
                nBal-=bet*2; nPool+=bet*2; msg=`æ’æŸ±(-$${bet*2})`; resultType='crash'; deltaAmount=-(bet*2);
            } else {
                nBal-=bet; nPool+=bet; msg=`æ²’é€²(-$${bet})`; resultType='lose'; deltaAmount=-bet;
            }
        }
    }

    const pKeys = Object.keys(localData.players);
    let nextK = pKeys[(pKeys.indexOf(myId)+1) % pKeys.length];

    // autoRefill
    let updates = {
        [`players/${myId}/balance`]:nBal, pool:nPool, deck, c3:c3||null,
        statusMsg:msg, gameState:'waiting_deal', currentPlayerKey:nextK,
        lastActionTime:firebase.database.ServerValue.TIMESTAMP
    };
    const minPool = localData.entryFee * pKeys.length;
    const needRefill = (localData.autoRefill && nPool < minPool) || (nPool <= 0);
    let refillTriggered = false;
    if (needRefill) {
        let total=0;
        pKeys.forEach(k => {
            const cb = (k===myId) ? nBal : localData.players[k].balance;
            updates[`players/${k}/balance`] = cb - localData.entryFee;
            total += localData.entryFee;
        });
        updates.pool = nPool + total;
        refillTriggered = true;
    }

    // (1) å»£æ’­é£›ç‰Œè³‡è¨Šåˆ° Firebase
    const emojiMap = { win:'ğŸ‰', crash:'ğŸ’¥', lose:'ğŸ˜­', fold:'ğŸ³ï¸' };
    const textMap  = {
        win:  (type==='up'||type==='down') ? 'çŒœå°ï¼' : 'å°„é€²ï¼',
        crash:'æ’æŸ±ï¼ï¼',
        lose: (type==='up'||type==='down') ? 'çŒœéŒ¯äº†' : 'æ²’é€²...',
        fold: 'æ£„ç‰Œ'
    };
    if (type !== 'fold' && c3) {
        updates.lastShot = {
            id: getServerNow().toString(),
            card: c3,
            resultType,
            emoji: emojiMap[resultType],
            text:  textMap[resultType],
            delta: deltaAmount
        };
    }
    // æ£„ç‰Œç›´æ¥æœ¬æ©Ÿé¡¯ç¤ºï¼ˆä¸å»£æ’­é£›ç‰Œï¼‰
    if (type === 'fold') {
        playSfx('sfx-fold');
        showResultBanner('ğŸ³ï¸', 'æ£„ç‰Œ', deltaAmount);
        if (refillTriggered) showRefillToast(localData.entryFee, pKeys.length);
    } else {
        // refillToast åœ¨å‹•ç•«å›èª¿ä¸­é¡¯ç¤ºï¼ˆç”± startListening çš„ lastShot è§¸ç™¼ï¼‰
        if (refillTriggered) {
            // å­˜åˆ° updates è®“å‹•ç•«å›èª¿å¾Œé¡¯ç¤º
            updates._refillFee   = localData.entryFee;
            updates._refillCount = pKeys.length;
        }
    }

    gameRef.update(updates);
    document.getElementById('bet-amount').value = 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sendEmoji(icon) {
    gameRef.update({ lastEmoji:{ name:localData.players[myId].name, icon, time:firebase.database.ServerValue.TIMESTAMP } });
}
function showEmojiBroadcast(name, icon) {
    const a=document.getElementById('emoji-broadcast-area');
    const d=document.createElement('div'); d.className='broadcast-item';
    d.innerText=`${name}: ${icon}`; a.appendChild(d); setTimeout(()=>d.remove(),2500);
}

function updateCard(id, c) {
    const el = document.getElementById(id);
    if (!c) { el.classList.add('hidden'); el.innerText='?'; }
    else { el.classList.remove('hidden'); el.innerText=`${c.suit}\n${c.label}`; el.classList.toggle('red', c.suit==='â™¥'||c.suit==='â™¦'); }
}
function updateGateCard(c) {
    const gi  = document.getElementById('gate-inner');
    const c3g = document.getElementById('c3-in-gate');
    if (!c) {
        gi.style.display=''; gi.innerText='å¾…å°„é–€';
        c3g.style.display='none'; c3g.innerHTML='';
    } else {
        gi.style.display='none';
        const isRed = c.suit==='â™¥'||c.suit==='â™¦';
        c3g.style.display='block';
        c3g.style.cssText='display:block;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;';
        c3g.innerHTML=`<div class="card${isRed?' red':''}" style="width:clamp(44px,9vw,64px);height:clamp(62px,13vw,90px);">${c.suit}\n${c.label}</div>`;
    }
}

function addBet(v) {
    let cur = parseInt(document.getElementById('bet-amount').value)||0;
    document.getElementById('bet-amount').value = Math.min(cur+v, localData.pool);
}
function setAllIn() {
    document.getElementById('allin-pool-preview').innerText = '$'+(localData.pool||0);
    document.getElementById('all-in-confirm-overlay').classList.add('show');
}
function cancelAllIn() { document.getElementById('all-in-confirm-overlay').classList.remove('show'); }
function confirmAllIn() {
    document.getElementById('all-in-confirm-overlay').classList.remove('show');
    gameRef.update({ allInTrigger: getServerNow().toString() });
    document.getElementById('bet-amount').value = localData.pool;
}

function generateDecks(count) {
    let deck=[];
    const suits=['â™ ','â™¥','â™¦','â™£'];
    for (let i=0;i<count;i++) suits.forEach(s=>{ for(let v=1;v<=13;v++) deck.push({val:v,suit:s,label:labels[v]||v}); });
    return deck.sort(()=>Math.random()-0.5);
}
function kickPlayer(id) { if(confirm("å‰”é™¤è©²ç©å®¶ï¼Ÿ")) gameRef.child('players/'+id).remove(); }
function hostResetToLobby() { if(confirm("é‡è£½å¤§å»³ç‹€æ…‹ï¼Ÿ")) gameRef.update({gameStarted:false}); }
</script>
</body>
</html>

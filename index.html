// --- ÂÉÖ‰øÆÊ≠£ÈÇèËºØÈÉ®ÂàÜÔºå‰∏çÂΩ±Èüø UI ---

    // ÂÆöÊúüË®àÊôÇËàáÊéõÊ©üÂâîÈô§ (Ê†∏ÂøÉ‰øÆÂæ©)
    setInterval(() => {
        if (!localData.gameStarted || !localData.players) return;
        
        const pKeys = Object.keys(localData.players);
        const currentPlayerId = localData.currentPlayerKey;

        // 1. Â¶ÇÊûúÁï∂ÂâçÊ¥ªÂãïÁé©ÂÆ∂Â∑≤Á∂ì‰∏çÂú®ÂêçÂñÆ‰∏≠ (Ë¢´Ë∏¢Èô§ÊàñÈõ¢Èñã)ÔºåÂº∑Âà∂ÂàáÊèõÂà∞‰∏ã‰∏Ä‰Ωç
        if (!localData.players[currentPlayerId]) {
            const nextK = pKeys[0]; // ÊäìÂâ©‰∏ã‰æÜÁöÑÁ¨¨‰∏ÄÂÄã‰∫∫
            gameRef.update({
                gameState: 'waiting_deal',
                currentPlayerKey: nextK,
                statusMsg: "Áé©ÂÆ∂Â∑≤Èõ¢ÈñãÔºåÊèõ‰∏ã‰∏Ä‰Ωç",
                lastActionTime: Date.now(),
                c1: null, c2: null, c3: null
            });
            return;
        }

        // 2. È°ØÁ§∫ÁßíÊï∏Êõ¥Êñ∞ (Á¥îÂâçÁ´Ø)
        renderPlayers(); 

        // 3. Êàø‰∏ªÂü∑Ë°åÊéõÊ©üÂâîÈô§Âà§Êñ∑
        // Âç≥‰ΩøÂéüÊàø‰∏ªËµ∞‰∫ÜÔºåÊñ∞ÂêçÂñÆÁ¨¨‰∏Ä‰Ωç pKeys[0] ÊúÉËá™ÂãïÊé•ÊâãÊ≠§Âà§Êñ∑
        if (pKeys[0] === myId && localData.lastActionTime) {
            const diff = (Date.now() - localData.lastActionTime) / 1000;
            if (diff > 60) {
                const afkId = currentPlayerId;
                const nextK = pKeys[(pKeys.indexOf(afkId) + 1) % pKeys.length];
                
                // ÂÖàÁßªÈô§ÊéõÊ©üÁé©ÂÆ∂ÔºåÂÜçÊõ¥Êñ∞ÁãÄÊÖã
                gameRef.child('players/' + afkId).remove().then(() => {
                    gameRef.update({
                        gameState: 'waiting_deal',
                        currentPlayerKey: nextK,
                        statusMsg: "ÊéõÊ©üË∏¢Èô§ÔºåÊèõ‰∏ã‰∏Ä‰Ωç",
                        lastActionTime: Date.now(),
                        c1: null, c2: null, c3: null
                    });
                });
            }
        }
    }, 1000);

    // ‰øÆÊîπ kickPlayer Á¢∫‰øùÊàø‰∏ªÂâîÈô§ÂæåÁãÄÊÖãÁ´ãÂç≥Êõ¥Êñ∞
    function kickPlayer(id) { 
        if(confirm("Á¢∫ÂÆöÂâîÈô§Ôºü")) {
            const pKeys = Object.keys(localData.players);
            if (id === localData.currentPlayerKey) {
                const nextK = pKeys[(pKeys.indexOf(id) + 1) % pKeys.length];
                gameRef.update({
                    gameState: 'waiting_deal',
                    currentPlayerKey: nextK,
                    statusMsg: "Áé©ÂÆ∂Ë¢´ÂâîÈô§ÔºåÊèõ‰∏ã‰∏Ä‰Ωç",
                    lastActionTime: Date.now(),
                    c1: null, c2: null, c3: null
                });
            }
            gameRef.child('players/'+id).remove();
        } 
    }

    // --- ‰ª•‰∏ãÁÇ∫ÂéüÊú¨Á©©ÂÆöÁöÑÂäüËÉΩÂáΩÊï∏Ôºå‰øùÊåÅ‰∏çÂãï ---

    function joinRoom() {
        const nameInput = document.getElementById('my-name').value.trim();
        if (!nameInput) return alert("Ë´ãËº∏ÂÖ•Êö±Á®±");
        if (!myId) {
            const newRef = gameRef.child('players').push();
            myId = newRef.key;
            localStorage.setItem('dg_id', myId);
        }
        gameRef.child('players/'+myId).update({ name: nameInput, lastActive: Date.now() });
        gameRef.once('value', snap => {
            const d = snap.val();
            if(d && d.allInTrigger) lastEffectId = d.allInTrigger;
            startListening();
        });
        document.getElementById('login-part').style.display = 'none';
    }

    function startListening() {
        gameRef.on('value', snap => {
            localData = snap.val() || {};
            if (!localData.players || !localData.players[myId]) return;
            const pKeys = Object.keys(localData.players);
            const isHost = (pKeys[0] === myId);
            document.body.className = isHost ? "is-host" : "";

            if (localData.allInTrigger && localData.allInTrigger !== lastEffectId) {
                const videoBox = document.getElementById('video-box');
                videoBox.innerHTML = `<iframe width="315" height="560" src="https://www.youtube.com/embed/GtyYndoTyV8?start=25&end=27&autoplay=1&mute=0&controls=0&modestbranding=1&rel=0&iv_load_policy=3" frameborder="0" allow="autoplay; encrypted-media"></iframe>`;
                document.getElementById('all-in-overlay').style.display = 'flex';
                setTimeout(() => { 
                    document.getElementById('all-in-overlay').style.display = 'none'; 
                    videoBox.innerHTML = ''; 
                }, 3500);
                lastEffectId = localData.allInTrigger;
            }

            if (localData.gameStarted) {
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('main-board').style.display = 'block';
                document.getElementById('fold-cost-ui').innerText = localData.foldPenalty || 0;
                renderUI(isHost);
            } else {
                document.getElementById('setup-area').style.display = 'block';
                document.getElementById('host-part').style.display = isHost ? 'block' : 'none';
                document.getElementById('main-board').style.display = 'none';
            }
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            renderPlayers();
        });
    }

    function renderPlayers() {
        const area = document.getElementById('player-area'); if(!area) return;
        area.innerHTML = '';
        const now = Date.now();
        const players = localData.players || {};
        Object.keys(players).forEach(id => {
            const p = players[id];
            const isActive = (id === localData.currentPlayerKey);
            const div = document.createElement('div');
            div.className = `player-card ${isActive ? 'active' : ''}`;
            
            let timerHtml = "";
            if (isActive && localData.lastActionTime) {
                const timeLeft = Math.max(0, 60 - Math.floor((now - localData.lastActionTime) / 1000));
                timerHtml = `<div class="timer-display">‚è± ${timeLeft}s</div>`;
            }

            div.innerHTML = `
                <button class="kick-btn" onclick="kickPlayer('${id}')">‚úï</button>
                <b>${p.name}</b>${Object.keys(players)[0] === id ? ' üëë' : ''}<br>
                <span class="player-balance ${p.balance < 0 ? 'balance-neg' : ''}">$${p.balance}</span>
                ${timerHtml}`;
            area.appendChild(div);
        });
    }

    function hostStartGame() {
        const fee = parseInt(document.getElementById('entry-fee').value) || 0;
        const start = parseInt(document.getElementById('start-balance').value) || 1000;
        const penalty = parseInt(document.getElementById('fold-penalty').value) || 0;
        const decks = parseInt(document.getElementById('deck-count').value) || 2;
        const refill = document.getElementById('auto-refill').checked;
        let players = localData.players, pool = 0;
        Object.keys(players).forEach(id => { players[id].balance = start - fee; pool += fee; });
        gameRef.update({
            gameStarted: true,
            deck: generateDecks(decks),
            pool: pool,
            entryFee: fee,
            foldPenalty: penalty,
            autoRefill: refill,
            deckCount: decks,
            gameState: 'waiting_deal',
            statusMsg: "ÈÅäÊà≤ÈñãÂßãÔºÅË´ãÁôºÁâå„ÄÇ",
            currentPlayerKey: Object.keys(players)[0],
            players: players,
            lastActionTime: Date.now(),
            c1: null, c2: null, c3: null
        });
    }

    function drawGoalPost() {
        let deck = localData.deck || [];
        if (deck.length < 3) deck = generateDecks(localData.deckCount || 2);
        const c1 = deck.pop(); const c2 = deck.pop();
        gameRef.update({
            deck: deck, c1: c1, c2: c2, c3: null,
            gameState: 'waiting_shoot',
            lastActionTime: Date.now(),
            statusMsg: `Ëº™Âà∞ „Äê${localData.players[localData.currentPlayerKey].name}„Äë ‰∏ãÊ≥®`
        });
    }

    function handleAction(type) {
        let bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
        if (type !== 'fold') {
            if (bet < 1 || bet > localData.pool) return alert("ÈáëÈ°çÁÑ°Êïà");
            if (bet % 10 !== 0) return alert("È†àÁÇ∫ 10 ÁöÑÂÄçÊï∏");
        }
        let p = localData.players[myId];
        let nBal = p.balance, nPool = localData.pool, msg = "", c3 = null;
        let deck = localData.deck || [];

        if (type === 'fold') {
            nBal -= localData.foldPenalty; nPool += localData.foldPenalty;
            msg = `${p.name} ÊîæÊ£Ñ (-$${localData.foldPenalty})`;
        } else {
            if (deck.length < 1) deck = generateDecks(localData.deckCount || 2);
            c3 = deck.pop();
            const min = Math.min(localData.c1.val, localData.c2.val), max = Math.max(localData.c1.val, localData.c2.val);
            if (localData.c1.val === localData.c2.val) {
                if (c3.val === localData.c1.val) { nBal -= bet*3; nPool += bet*3; msg = `üöß ÊíûÊü±ÔºÅËº∏ $${bet*3}`; }
                else if ((type === 'up' && c3.val > localData.c1.val) || (type === 'down' && c3.val < localData.c1.val)) { nBal += bet; nPool -= bet; msg = `üéâ ÁåúÂ∞çÔºÅË¥è $${bet}`; }
                else { nBal -= bet; nPool += bet; msg = `‚ùå ÁåúÈåØÔºÅËº∏ $${bet}`; }
            } else {
                if (c3.val > min && c3.val < max) { nBal += bet; nPool -= bet; msg = `üéâ Â∞ÑÈÄ≤ÔºÅË¥è $${bet}`; }
                else if (c3.val === min || c3.val === max) { nBal -= bet*2; nPool += bet*2; msg = `üöß ÊíûÊü±ÔºÅËº∏ $${bet*2}`; }
                else { nBal -= bet; nPool += bet; msg = `‚ùå Ê≤íÈÄ≤ÔºÅËº∏ $${bet}`; }
            }
        }

        const pKeys = Object.keys(localData.players);
        let nextK = pKeys[(pKeys.indexOf(myId) + 1) % pKeys.length];
        let updates = {
            [`players/${myId}/balance`]: nBal, pool: nPool, deck: deck, c3: c3 || null,
            statusMsg: msg + " | Á≠âÂæÖ‰∏ãÂÆ∂ÊäΩÁâå",
            gameState: 'waiting_deal',
            currentPlayerKey: nextK,
            lastActionTime: Date.now()
        };

        const threshold = localData.entryFee * pKeys.length;
        if ((nPool < threshold && localData.autoRefill) || nPool <= 0) {
            pKeys.forEach(k => {
                let bal = (k === myId ? nBal : localData.players[k].balance);
                updates[`players/${k}/balance`] = bal - localData.entryFee;
                updates.pool += localData.entryFee;
            });
            updates.statusMsg = msg + " | üí∞ Âü∑Ë°åË£úÂ∫ïÔºÅ";
        }
        gameRef.update(updates);
        document.getElementById('bet-amount').value = "";
    }

    function renderUI(isHost) {
        document.getElementById('pool-val').innerText = localData.pool || 0;
        document.getElementById('status-msg').innerText = localData.statusMsg || "";
        document.getElementById('cards-left').innerText = localData.deck ? localData.deck.length : 0;
        updateCard('c1', localData.c1); updateCard('c2', localData.c2); updateCard('c3', localData.c3);
        
        const isTurn = (localData.currentPlayerKey === myId);
        const isDeal = (localData.gameState === 'waiting_deal');
        const isShoot = (localData.gameState === 'waiting_shoot');
        
        document.getElementById('player-deal-btn').style.display = (isTurn && isDeal) ? 'block' : 'none';
        document.getElementById('bet-controls').style.display = (isTurn && isShoot) ? 'block' : 'none';

        const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;
        document.getElementById('shoot-normal').style.display = isSame ? 'none' : 'inline-block';
        document.getElementById('guess-buttons').style.display = isSame ? 'inline-block' : 'none';
    }

    function setAllIn() {
        if (confirm("üî• Á¢∫ÂÆöË¶ÅALL INÂóéÔºü")) {
            gameRef.update({ allInTrigger: Date.now().toString() });
            document.getElementById('bet-amount').value = localData.pool;
        }
    }

    function updateCard(id, c) {
        const el = document.getElementById(id);
        if (!c) { el.classList.add('hidden'); el.innerText = '?'; }
        else { el.classList.remove('hidden'); el.innerText = `${c.suit}\n${c.label}`; el.classList.toggle('red', c.suit === '‚ô•' || c.suit === '‚ô¶'); }
    }

    function generateDecks(count) {
        let deck = []; const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        for (let i = 0; i < count; i++) suits.forEach(s => { for (let v = 1; v <= 13; v++) deck.push({ val: v, suit: s, label: labels[v] || v }); });
        return deck.sort(() => Math.random() - 0.5);
    }
    function hostResetToLobby() { if(confirm("Á¢∫ÂÆöÈáçË£ΩÔºü")) gameRef.update({ gameStarted: false }); }

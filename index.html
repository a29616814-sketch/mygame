<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°„é¾é–€ Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
:root {
    --gold:#d4af37; --felt:#2d5a3c; --dark:#1a472a; --red:#e74c3c; --wood:#8B6914;
    --safe-bottom:env(safe-area-inset-bottom,0px); --safe-left:env(safe-area-inset-left,0px);
    --safe-right:env(safe-area-inset-right,0px);   --safe-top:env(safe-area-inset-top,0px);
}
*{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html,body{ width:100%; height:100%; background:#0d1f15; color:white; font-family:'Segoe UI',sans-serif; overflow:hidden; touch-action:manipulation; }

/* â•â•â•â• ç™»å…¥ç•«é¢ â•â•â•â• */
#login-screen{
    position:fixed; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    background:radial-gradient(ellipse at center,#1a472a 0%,#0a1f0f 100%);
    z-index:100; padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
}
#login-screen h1{ font-size:clamp(1.4rem,5vw,2.2rem); color:var(--gold); margin-bottom:20px; text-shadow:0 2px 12px rgba(212,175,55,0.5); }
.setup-box{ background:rgba(0,0,0,0.75); border:2px solid var(--gold); border-radius:20px; padding:24px 28px; width:min(400px,90vw); }
.input-row{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
.input-row label{ color:#aaa; font-size:0.85rem; }
.input-row input,.input-row select{ padding:9px 12px; border-radius:8px; border:none; background:#333; color:white; font-size:1rem; width:100%; }
.input-inline{ display:flex; gap:8px; }
.input-inline>div{ flex:1; display:flex; flex-direction:column; gap:4px; }
.input-inline label{ color:#aaa; font-size:0.78rem; }
.input-inline input,.input-inline select{ padding:7px; border-radius:8px; border:none; background:#333; color:white; font-size:0.9rem; width:100%; }
.btn-main{ width:100%; padding:12px; background:#2ecc71; color:white; border:none; border-radius:10px; font-size:1.05rem; font-weight:bold; cursor:pointer; margin-top:6px; }
.btn-main:active{ filter:brightness(0.9); }
.btn-leave{ background:#e74c3c !important; }
.chk-row{ display:flex; align-items:center; gap:8px; color:#ccc; font-size:0.88rem; margin:5px 0; }

/* â•â•â•â• ç­‰å¾…å¤§å»³ â•â•â•â• */
#lobby-screen{
    position:fixed; inset:0; display:none; flex-direction:column;
    background:radial-gradient(ellipse at center,#1a472a 0%,#0a1f0f 100%);
    z-index:90; padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
    overflow:hidden;
}
#lobby-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px 8px; border-bottom:1px solid rgba(212,175,55,0.3);
    flex-shrink:0;
}
#lobby-header h2{ color:var(--gold); font-size:clamp(1rem,4vw,1.4rem); }
.lobby-leave-btn{
    background:rgba(231,76,60,0.8); border:1px solid #e74c3c; color:white;
    border-radius:20px; padding:5px 14px; cursor:pointer; font-size:0.85rem; font-weight:bold;
}
.lobby-leave-btn:active{ filter:brightness(0.85); }

#lobby-body{ display:flex; flex:1; overflow:hidden; gap:0; }

/* ç©å®¶åˆ—è¡¨ */
#lobby-players-panel{
    width:min(180px,38%); border-right:1px solid rgba(212,175,55,0.2);
    display:flex; flex-direction:column; flex-shrink:0;
}
#lobby-players-panel h3{ color:#aaa; font-size:0.8rem; padding:8px 12px 4px; border-bottom:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
#lobby-player-list{ flex:1; overflow-y:auto; padding:6px 8px; }
.lobby-player-item{
    display:flex; align-items:center; gap:6px;
    padding:6px 8px; border-radius:8px; margin-bottom:4px;
    background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
    font-size:clamp(11px,2.2vw,14px);
}
.lobby-player-item.is-host{ border-color:rgba(212,175,55,0.5); background:rgba(212,175,55,0.08); }
.lobby-player-item.is-me{ border-color:rgba(52,152,219,0.5); }
.lobby-player-dot{ width:8px; height:8px; border-radius:50%; background:#2ecc71; flex-shrink:0; }
.lobby-player-name{ flex:1; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.lobby-player-crown{ font-size:0.9rem; flex-shrink:0; }

/* å¤§å»³å³å´ï¼šèŠå¤© + é–‹å§‹ */
#lobby-right{ flex:1; display:flex; flex-direction:column; overflow:hidden; }

/* èŠå¤©å€ */
#lobby-chat-area{ flex:1; display:flex; flex-direction:column; overflow:hidden; }
#lobby-chat-msgs{
    flex:1; overflow-y:auto; padding:8px 10px; display:flex; flex-direction:column; gap:4px;
    scroll-behavior:smooth;
}
.chat-msg{ font-size:clamp(11px,2.2vw,13px); line-height:1.4; word-break:break-word; }
.chat-msg .chat-name{ color:var(--gold); font-weight:bold; margin-right:4px; }
.chat-msg.system{ color:#888; font-style:italic; }
.chat-msg.is-me .chat-name{ color:#74b9ff; }

#lobby-chat-input-row{
    display:flex; gap:6px; padding:6px 10px 10px;
    border-top:1px solid rgba(255,255,255,0.07); flex-shrink:0;
}
#lobby-chat-input{
    flex:1; background:#1a2a1e; border:1px solid #3a5a3c; border-radius:20px;
    color:white; padding:7px 14px; font-size:0.9rem; outline:none;
}
#lobby-chat-input::placeholder{ color:#556; }
#lobby-chat-send{
    background:var(--gold); color:#1a1a1a; border:none; border-radius:50%;
    width:34px; height:34px; cursor:pointer; font-size:1rem; flex-shrink:0;
    display:flex; align-items:center; justify-content:center; font-weight:bold;
}
#lobby-chat-send:active{ filter:brightness(0.85); }

/* æˆ¿ä¸»é–‹å±€å€ */
#lobby-host-controls{
    padding:8px 10px; border-top:1px solid rgba(212,175,55,0.2);
    background:rgba(212,175,55,0.05); flex-shrink:0;
}
#lobby-host-controls h3{ color:var(--gold); font-size:0.85rem; margin-bottom:8px; }
.input-inline-sm{ display:flex; gap:6px; margin-bottom:6px; }
.input-inline-sm>div{ flex:1; display:flex; flex-direction:column; gap:2px; }
.input-inline-sm label{ color:#aaa; font-size:0.72rem; }
.input-inline-sm input,.input-inline-sm select{ padding:5px 7px; border-radius:6px; border:none; background:#2a2a2a; color:white; font-size:0.85rem; width:100%; }
#lobby-waiting-msg{ text-align:center; color:#888; font-size:0.9rem; padding:10px; }

/* â•â•â•â• éŠæˆ²ç•«é¢ â•â•â•â• */
#game-screen{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; }

#table-wrap{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:#0d1f15;
    padding:max(var(--safe-top),6px) max(var(--safe-right),8px) max(var(--safe-bottom),6px) max(var(--safe-left),8px);
}
#oval{
    position:relative;
    width:min(92vw,92vh*1.9); height:min(88vh,88vw*1.9);
    background:radial-gradient(ellipse at 50% 45%,#3a7a52 0%,#2d5a3c 55%,#1e4a30 100%);
    border-radius:50%; border:12px solid var(--wood);
    box-shadow:0 0 0 4px #5a3a08,0 0 0 8px #2a1a04,inset 0 0 80px rgba(0,0,0,0.4),0 20px 60px rgba(0,0,0,0.8);
}
#oval::before{
    content:''; position:absolute; inset:0; border-radius:50%;
    background:repeating-linear-gradient(45deg,transparent,transparent 22px,rgba(255,255,255,0.012) 22px,rgba(255,255,255,0.012) 23px);
    pointer-events:none;
}
@keyframes tableGlow{
    0%,100%{ box-shadow:0 0 0 4px #5a3a08,0 0 0 8px #2a1a04,inset 0 0 80px rgba(0,0,0,0.4),0 20px 60px rgba(0,0,0,0.8); }
    50%{ box-shadow:0 0 0 4px var(--gold),0 0 0 12px rgba(212,175,55,0.3),inset 0 0 80px rgba(0,0,0,0.4),0 20px 60px rgba(0,0,0,0.8); }
}
#oval.my-turn{ animation:tableGlow 1.5s ease-in-out infinite; }

#table-center{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-62%);
    display:flex; flex-direction:column; align-items:center; gap:4px;
    z-index:10; pointer-events:none;
}
#pool-display{ font-size:clamp(14px,3vmin,22px); color:#f1c40f; font-weight:bold; text-shadow:0 2px 8px rgba(0,0,0,0.8); }
#status-msg{ font-size:clamp(8px,1.7vmin,12px); color:#ccc; min-height:14px; }
#cards-and-deck{ display:flex; align-items:center; gap:clamp(4px,1.5vmin,12px); pointer-events:auto; }

.post-wrap{ display:flex; flex-direction:column; align-items:center; gap:2px; }
.post-label{ font-size:clamp(7px,1.3vmin,10px); color:#aaa; letter-spacing:1px; }
.post-label.gate{ color:var(--gold); font-weight:bold; }
.connector{ width:clamp(4px,1.2vmin,10px); height:3px; background:linear-gradient(90deg,rgba(212,175,55,0.6),rgba(212,175,55,0.2)); align-self:center; flex-shrink:0; }
.connector.r{ background:linear-gradient(90deg,rgba(212,175,55,0.2),rgba(212,175,55,0.6)); }

.card{
    width:clamp(44px,7.5vmin,68px); height:clamp(62px,10.5vmin,96px);
    background:white; border-radius:8px; color:black;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    font-size:clamp(15px,3.2vmin,26px); font-weight:bold;
    border:2px solid #333; box-shadow:2px 2px 8px rgba(0,0,0,0.5); white-space:pre-wrap; flex-shrink:0;
}
.card.hidden{ background:#1e3a5f; color:transparent; border-color:#3a6a9f; }
.card.red{ color:var(--red); }

.gate-frame{
    width:clamp(44px,7.5vmin,68px); height:clamp(62px,10.5vmin,96px);
    border:2px dashed rgba(212,175,55,0.4); border-radius:8px; background:rgba(212,175,55,0.04);
    display:flex; align-items:center; justify-content:center; position:relative; overflow:visible; flex-shrink:0;
}
.gate-frame .gate-inner-text{ color:rgba(212,175,55,0.3); font-size:clamp(7px,1.3vmin,10px); }
#c3-in-gate{ display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10; }

#deck-stack{ position:relative; width:clamp(44px,7.5vmin,68px); height:clamp(62px,10.5vmin,96px); cursor:default; flex-shrink:0; }
.dk{ position:absolute; width:100%; height:100%; border-radius:8px; border:1.5px solid #3a6a9f; }
.dk:nth-child(1){ transform:translate(5px,5px); background:#182e49; }
.dk:nth-child(2){ transform:translate(2px,2px); background:#1c3454; }
.dk:nth-child(3){ transform:translate(0,0); background:linear-gradient(135deg,#2a4f80,#1e3a64); box-shadow:3px 3px 10px rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; font-size:clamp(15px,3.2vmin,26px); color:rgba(255,255,255,0.25); }
#deck-stack.can-click{ cursor:pointer; animation:deckPulse 1s ease-in-out infinite; }
#deck-stack.can-click .dk:nth-child(3){ background:linear-gradient(135deg,#4a80cc,#2a5090); box-shadow:0 0 18px rgba(212,175,55,0.7),3px 3px 10px rgba(0,0,0,0.7); border-color:var(--gold); }
@keyframes deckPulse{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.09);} }
#deck-badge{ position:absolute; bottom:-8px; right:-8px; z-index:6; background:var(--gold); color:#1a472a; font-size:9px; font-weight:bold; border-radius:10px; padding:1px 5px; }
#deck-hint{ position:absolute; bottom:-20px; left:50%; transform:translateX(-50%); white-space:nowrap; font-size:clamp(7px,1.4vmin,10px); color:var(--gold); opacity:0; transition:opacity 0.3s; pointer-events:none; }
#deck-hint.show{ opacity:1; }

/* åº§ä½ */
.seat{ position:absolute; transform:translate(-50%,-50%); z-index:20; text-align:center; }
.seat-box{
    background:rgba(0,0,0,0.85); border:2px solid #555; border-radius:12px;
    padding:clamp(4px,0.8vmin,7px) clamp(8px,1.5vmin,14px);
    font-size:clamp(10px,2vmin,15px);
    min-width:clamp(58px,11vmin,96px); max-width:clamp(72px,13vmin,112px);
    line-height:1.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    transition:transform 0.18s,box-shadow 0.18s,max-width 0.18s; cursor:default;
}
.seat-box.expanded{ transform:scale(1.22); max-width:clamp(90px,18vmin,160px); box-shadow:0 4px 20px rgba(0,0,0,0.7); z-index:50; position:relative; }
.seat-box.active{ border-color:var(--gold); box-shadow:0 0 10px var(--gold); background:rgba(212,175,55,0.15); }
.seat-box.is-me{ border-color:#3498db; }
.seat-box.active.is-me{ border-color:var(--gold); }
.seat-box.kicked{ border-color:#e74c3c; background:rgba(231,76,60,0.12); opacity:0.6; }
.seat-name{ font-weight:bold; font-size:clamp(11px,2.2vmin,16px); }
.seat-bal{ color:#2ecc71; font-size:clamp(10px,1.9vmin,14px); font-weight:bold; }
.seat-tmr{ color:#ff7675; font-size:clamp(9px,1.6vmin,12px); }
.seat-kick{ position:absolute; top:-6px; right:-6px; background:#e74c3c; color:white; border-radius:50%; width:18px; height:18px; border:1px solid white; display:none; cursor:pointer; font-size:10px; line-height:16px; z-index:25; }
body.is-host .seat:not(.is-me) .seat-kick{ display:block; }

/* ä¸‹æ³¨é¢æ¿ */
#bet-panel{
    position:absolute; bottom:18%; left:50%; transform:translateX(-50%);
    width:90%; display:none; flex-direction:row; align-items:center; justify-content:center;
    gap:clamp(4px,1vmin,8px); padding:8px 12px 10px;
    background:rgba(26,70,42,0.88); border-radius:16px; border:1.5px solid rgba(212,175,55,0.5);
    box-shadow:0 2px 16px rgba(0,0,0,0.35),inset 0 1px 0 rgba(255,255,255,0.06);
    z-index:30; pointer-events:auto; flex-wrap:wrap;
}
.chip-row{ display:flex; gap:clamp(3px,0.8vmin,6px); align-items:center; }
.chip-btn{ background:none; border:none; padding:0; cursor:pointer; }
.chip-btn:active{ transform:scale(0.88); }
.chip-btn img{ width:clamp(30px,5vmin,44px); height:clamp(30px,5vmin,44px); border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.5); }
.bet-actions{ display:flex; align-items:center; gap:4px; flex-wrap:wrap; justify-content:center; }
#bet-amount{ background:rgba(0,0,0,0.55); color:var(--gold); border:2px solid var(--gold); font-size:0.95rem; width:60px; border-radius:7px; padding:2px 5px; text-align:center; }
.action-row{ display:flex; gap:clamp(3px,0.8vmin,6px); flex-wrap:wrap; justify-content:center; align-items:center; }
.action-row button{ padding:clamp(5px,1vmin,8px) clamp(8px,1.5vmin,12px); border:none; border-radius:7px; font-weight:bold; cursor:pointer; font-size:clamp(10px,1.8vmin,14px); white-space:nowrap; }
.btn-up{ background:#3498db; color:white; }
.btn-down{ background:#e67e22; color:white; }
.btn-allin{ background:var(--red); color:white; }
.btn-fold{ background:#7f8c8d; color:white; }
.btn-clear{ background:rgba(0,0,0,0.4); color:#ccc; border:1px solid #555; padding:clamp(5px,1vmin,8px) 7px!important; font-size:clamp(9px,1.5vmin,12px)!important; }
.bet-divider{ width:1px; height:32px; background:rgba(212,175,55,0.2); margin:0 1px; }

/* éŠæˆ²å…§èŠå¤© */
#game-chat-toggle{
    position:absolute; left:10px; bottom:50px; width:36px; height:36px;
    background:rgba(0,0,0,0.65); border:1px solid rgba(212,175,55,0.5);
    border-radius:50%; font-size:1.1rem; cursor:pointer; z-index:31;
    display:flex; align-items:center; justify-content:center;
    transition:background 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#game-chat-toggle.open{ background:rgba(212,175,55,0.25); border-color:var(--gold); }
#game-chat-toggle .chat-unread{
    position:absolute; top:-4px; right:-4px; background:var(--red);
    color:white; font-size:9px; font-weight:bold; border-radius:50%;
    width:16px; height:16px; display:none; align-items:center; justify-content:center;
}
#game-chat-toggle .chat-unread.show{ display:flex; }
#game-chat-panel{
    position:absolute; left:52px; bottom:8px;
    width:min(260px,60vw); height:180px;
    background:rgba(10,25,15,0.95); border:1px solid rgba(212,175,55,0.35);
    border-radius:14px; display:none; flex-direction:column; z-index:30; overflow:hidden;
    animation:chatSlideIn 0.2s ease-out;
}
@keyframes chatSlideIn{ from{opacity:0;transform:scaleY(0.5);transform-origin:bottom;} to{opacity:1;transform:scaleY(1);} }
#game-chat-msgs{ flex:1; overflow-y:auto; padding:6px 8px; display:flex; flex-direction:column; gap:3px; scroll-behavior:smooth; }
#game-chat-input-row{ display:flex; gap:4px; padding:4px 6px; border-top:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
#game-chat-input{ flex:1; background:#1a2a1e; border:1px solid #3a5a3c; border-radius:12px; color:white; padding:5px 10px; font-size:0.8rem; outline:none; }
#game-chat-send{ background:var(--gold); color:#1a1a1a; border:none; border-radius:50%; width:26px; height:26px; cursor:pointer; font-size:0.8rem; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:bold; }

/* Emoji */
#emoji-toggle{
    position:absolute; left:10px; bottom:12px; width:36px; height:36px;
    background:rgba(0,0,0,0.65); border:1px solid rgba(212,175,55,0.5);
    border-radius:50%; font-size:1.2rem; cursor:pointer; z-index:31;
    display:none; align-items:center; justify-content:center; transition:background 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#emoji-toggle.open{ background:rgba(212,175,55,0.25); border-color:var(--gold); }
#emoji-toggle:active{ transform:scale(0.9); }
#emoji-bar{
    position:absolute; left:52px; bottom:56px; display:none; gap:5px; z-index:30;
    background:rgba(0,0,0,0.78); padding:5px 8px; border-radius:22px; border:1px solid rgba(212,175,55,0.3);
    transform-origin:left bottom; animation:emojiSlideIn 0.2s ease-out;
}
@keyframes emojiSlideIn{ from{opacity:0;transform:scaleX(0.3);} to{opacity:1;transform:scaleX(1);} }
.emoji-btn{ font-size:1.2rem; background:none; border:none; border-radius:50%; width:34px; height:34px; cursor:pointer; transition:transform 0.15s; }
.emoji-btn:active{ transform:scale(1.3); }

/* å·¥å…·åˆ— */
#tools{ position:absolute; bottom:10px; right:10px; display:none; flex-direction:column; gap:5px; z-index:30; align-items:flex-end; }
.tool-btn{ background:rgba(0,0,0,0.6); border:1px solid #555; color:var(--gold); border-radius:20px; padding:5px 10px; cursor:pointer; font-size:clamp(9px,1.6vmin,12px); white-space:nowrap; }
.tool-btn:active{ filter:brightness(1.3); }
.tool-btn.leave{ border-color:#e74c3c; color:#e74c3c; }

/* Canvas */
#shot-canvas{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:7000; }

/* çµæœæ©«å¹… */
#result-banner{
    display:none; position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%) scale(0.5); z-index:8000;
    background:rgba(0,0,0,0.93); border-radius:20px; padding:14px 28px;
    border:3px solid var(--gold); text-align:center;
    transition:transform 0.35s cubic-bezier(0.175,0.885,0.32,1.275),opacity 0.35s;
    opacity:0; pointer-events:none;
}
#result-banner.show{ display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }
.rb-emoji{ font-size:2.2rem; }
.rb-text{ font-size:1.3rem; font-weight:bold; margin:3px 0; }
.rb-amount{ font-size:1.7rem; font-weight:bold; }
.rb-amount.positive{ color:#2ecc71; }
.rb-amount.negative{ color:var(--red); }

.confetti-piece{ position:fixed; width:10px; height:14px; top:-20px; border-radius:2px; pointer-events:none; animation:confettiFall linear forwards; z-index:7999; }
@keyframes confettiFall{ 0%{transform:translateY(0) rotate(0deg);opacity:1;} 100%{transform:translateY(110vh) rotate(720deg);opacity:0;} }

#all-in-confirm-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:9000; flex-direction:column; justify-content:center; align-items:center; }
#all-in-confirm-overlay.show{ display:flex; }
.allin-box{ background:linear-gradient(135deg,#1a1a1a,#2c0000); border:3px solid var(--red); border-radius:24px; padding:22px 30px; text-align:center; animation:alinPop 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
@keyframes alinPop{ from{transform:scale(0.6);opacity:0;} to{transform:scale(1);opacity:1;} }
.allin-box h2{ font-size:1.5rem; color:var(--red); margin-bottom:6px; }
.allin-box p{ color:#ccc; margin-bottom:12px; }
.allin-amount{ font-size:2rem; color:var(--gold); font-weight:bold; margin-bottom:16px; }
.allin-yes{ background:var(--red)!important; color:white!important; font-size:1rem!important; padding:9px 20px!important; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin:0 6px; }
.allin-no{ background:#555!important; color:white!important; font-size:1rem!important; padding:9px 20px!important; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin:0 6px; }
#all-in-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.96); z-index:9999; flex-direction:column; justify-content:center; align-items:center; }
#all-in-overlay h1{ color:var(--gold); margin-top:20px; }

#my-turn-toast{ display:none; position:fixed; top:50%; right:12px; transform:translateY(-50%) translateX(60px); background:var(--gold); color:#1a472a; font-weight:bold; font-size:0.9rem; padding:8px 18px; border-radius:30px; z-index:8500; box-shadow:0 4px 20px rgba(0,0,0,0.6); animation:toastSlideIn 0.4s ease-out forwards; }
@keyframes toastSlideIn{ from{transform:translateY(-50%) translateX(60px);opacity:0;} to{transform:translateY(-50%) translateX(0);opacity:1;} }
#refill-toast{ display:none; position:fixed; top:14px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.92); color:var(--gold); border:2px solid var(--gold); font-size:0.85rem; padding:7px 18px; border-radius:20px; z-index:8500; white-space:nowrap; }
#reconnect-toast{ display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.95); color:var(--gold); border:2px solid var(--gold); border-radius:16px; padding:16px 28px; text-align:center; z-index:9500; font-size:1rem; }

#emoji-broadcast-area{ position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:10000; }
.broadcast-item{ background:rgba(0,0,0,0.88); color:var(--gold); padding:7px 16px; border-radius:30px; margin-bottom:5px; font-weight:bold; border:2px solid var(--gold); animation:fadeUp 2.5s forwards; white-space:nowrap; }
@keyframes fadeUp{ 0%{opacity:0;transform:translateY(10px);} 15%{opacity:1;transform:translateY(0);} 80%{opacity:1;} 100%{opacity:0;transform:translateY(-15px);} }

@keyframes winPulse{ 0%{box-shadow:2px 2px 8px rgba(0,0,0,0.5);} 40%{transform:scale(1.15);box-shadow:0 0 28px #2ecc71,0 0 55px #2ecc71;} 100%{box-shadow:2px 2px 8px rgba(0,0,0,0.5);} }
@keyframes losePulse{ 0%{transform:scale(1);} 20%{transform:translateX(-7px) scale(1.05);box-shadow:0 0 22px var(--red);} 40%{transform:translateX(7px) scale(1.05);box-shadow:0 0 22px var(--red);} 60%{transform:translateX(-4px);} 80%{transform:translateX(4px);} 100%{transform:scale(1);} }
@keyframes crashPulse{ 0%{transform:scale(1);} 30%{transform:scale(1.18) rotate(-5deg);box-shadow:0 0 38px #f39c12;} 60%{transform:scale(1.1) rotate(5deg);} 100%{transform:scale(1);} }
.anim-win{ animation:winPulse 0.7s ease-out; }
.anim-lose{ animation:losePulse 0.7s ease-out; }
.anim-crash{ animation:crashPulse 0.7s ease-out; }
#main-board,#player-area-wrapper,.player-toggle-btn{ display:none!important; }
    </style>
</head>
<body>
<canvas id="shot-canvas"></canvas>
<div id="emoji-broadcast-area"></div>
<div id="reconnect-toast"></div>

<div id="result-banner">
    <div class="rb-emoji" id="rb-emoji">ğŸ‰</div>
    <div class="rb-text" id="rb-text">å°„é€²!</div>
    <div class="rb-amount" id="rb-amount">+$0</div>
</div>
<div id="all-in-confirm-overlay">
    <div class="allin-box">
        <h2>ğŸ”¥ ALL IN ç¢ºèª</h2>
        <p>ä½ ç¢ºå®šè¦æŠ¼ä¸Šå…¨éƒ¨å½©é‡‘?</p>
        <div class="allin-amount" id="allin-pool-preview">$0</div>
        <div><button class="allin-yes" onclick="confirmAllIn()">ğŸ’¥ æˆ‘è¦å…¨éƒ¨!</button><button class="allin-no" onclick="cancelAllIn()">å–æ¶ˆ</button></div>
    </div>
</div>
<div id="all-in-overlay"><div id="video-box"></div><h1>æˆ‘è¦å…¨éƒ¨!!!</h1></div>
<div id="refill-toast"></div>
<div id="my-turn-toast">ğŸ¯ è¼ªåˆ°ä½ äº†!</div>

<audio id="sfx-win"   src="sfx/win.mp3"   preload="auto"></audio>
<audio id="sfx-lose"  src="sfx/lose.mp3"  preload="auto"></audio>
<audio id="sfx-crash" src="sfx/crash.mp3" preload="auto"></audio>
<audio id="sfx-fold"  src="sfx/fold.mp3"  preload="auto"></audio>
<audio id="sfx-allin" src="sfx/allin.mp3" preload="auto"></audio>
<audio id="sfx-deal"  src="sfx/deal.mp3"  preload="auto"></audio>

<!-- â•â• ç™»å…¥ç•«é¢ â•â• -->
<div id="login-screen">
    <h1>ğŸŸï¸ åŸ”å¢˜é‡‘é¾é–€ Pro</h1>
    <div class="setup-box">
        <div class="input-row">
            <label>æš±ç¨±</label>
            <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
        </div>
        <button class="btn-main" onclick="joinRoom()">ğŸƒ é€²å…¥å¤§å»³</button>
    </div>
</div>

<!-- â•â• ç­‰å¾…å¤§å»³ â•â• -->
<div id="lobby-screen">
    <div id="lobby-header">
        <h2>ğŸŸï¸ ç­‰å¾…å¤§å»³</h2>
        <button class="lobby-leave-btn" onclick="leaveRoom()">ğŸšª é›¢é–‹</button>
    </div>
    <div id="lobby-body">
        <!-- ç©å®¶åˆ—è¡¨ -->
        <div id="lobby-players-panel">
            <h3>ğŸ‘¥ ç©å®¶ (<span id="lobby-player-count">0</span>)</h3>
            <div id="lobby-player-list"></div>
        </div>
        <!-- å³å´èŠå¤©+é–‹å±€ -->
        <div id="lobby-right">
            <div id="lobby-chat-area">
                <div id="lobby-chat-msgs"></div>
                <div id="lobby-chat-input-row">
                    <input type="text" id="lobby-chat-input" placeholder="èªªé»ä»€éº¼..." maxlength="60" onkeydown="if(event.key==='Enter')sendLobbyChat()">
                    <button id="lobby-chat-send" onclick="sendLobbyChat()">â¤</button>
                </div>
            </div>
            <!-- æˆ¿ä¸»è¨­å®šï¼ˆåªæœ‰æˆ¿ä¸»çœ‹åˆ°ï¼‰ -->
            <div id="lobby-host-controls" style="display:none;">
                <h3>ğŸ‘‘ æˆ¿ä¸»è¨­å®š</h3>
                <div class="input-inline-sm">
                    <div><label>åˆå§‹æœ¬é‡‘</label><input type="number" id="start-balance" value="1000"></div>
                    <div><label>åº•æ³¨</label><input type="number" id="entry-fee" value="100"></div>
                    <div><label>æ£„ç‰Œç½°é‡‘</label><input type="number" id="fold-penalty" value="20"></div>
                </div>
                <div class="input-inline-sm">
                    <div>
                        <label>ç‰Œçµ„æ•¸</label>
                        <select id="deck-count">
                            <option value="1">1å‰¯</option>
                            <option value="2" selected>2å‰¯</option>
                            <option value="3">3å‰¯</option>
                            <option value="4">4å‰¯</option>
                        </select>
                    </div>
                    <div style="justify-content:flex-end;flex-direction:row;align-items:center;gap:6px;padding-top:14px;">
                        <input type="checkbox" id="auto-refill" checked>
                        <label style="color:#aaa;font-size:0.78rem;">è‡ªå‹•è£œåº•</label>
                    </div>
                </div>
                <button class="btn-main" onclick="hostStartGame()">âœ… é–‹å§‹éŠæˆ²</button>
            </div>
            <div id="lobby-waiting-msg">â³ ç­‰å¾…æˆ¿ä¸»é–‹å§‹éŠæˆ²...</div>
        </div>
    </div>
</div>

<!-- â•â• éŠæˆ²ç•«é¢ â•â• -->
<div id="game-screen">
    <div id="table-wrap">
        <div id="oval">
            <div id="table-center">
                <div id="pool-display">ğŸ’° $<span id="pool-val">0</span></div>
                <div id="status-msg"></div>
                <div id="cards-and-deck">
                    <div class="post-wrap"><div class="post-label">å·¦æŸ±</div><div id="c1" class="card hidden">?</div></div>
                    <div class="connector"></div>
                    <div class="post-wrap">
                        <div class="post-label gate">ğŸ‰ é¾é–€</div>
                        <div class="gate-frame" id="gate-frame">
                            <span class="gate-inner-text" id="gate-inner">å¾…å°„é–€</span>
                            <div id="c3-in-gate"></div>
                        </div>
                    </div>
                    <div class="connector r"></div>
                    <div class="post-wrap"><div class="post-label">å³æŸ±</div><div id="c2" class="card hidden">?</div></div>
                    <div style="width:2px;height:50px;background:rgba(255,255,255,0.1);margin:0 3px;align-self:center;flex-shrink:0;"></div>
                    <div class="post-wrap" style="position:relative;">
                        <div class="post-label" style="color:#aaa;">ç‰Œåº«</div>
                        <div id="deck-stack" onclick="onDeckClick()">
                            <div class="dk"></div><div class="dk"></div>
                            <div class="dk">ğŸ‚ <span id="deck-badge">0</span></div>
                        </div>
                        <div id="deck-hint">é»æ“ŠæŠ½ç‰Œ</div>
                    </div>
                </div>
                <div style="font-size:clamp(7px,1.3vmin,10px);color:#888;margin-top:1px;">å‰© <span id="cards-left">0</span> å¼µ</div>
            </div>

            <div id="seats-layer"></div>

            <!-- ä¸‹æ³¨é¢æ¿ -->
            <div id="bet-panel">
                <div class="chip-row">
                    <button class="chip-btn" onclick="addBet(10)"><img src="pic/m10.jpg" onerror="this.outerHTML='<div onclick=\'addBet(10)\' style=\'width:34px;height:34px;border-radius:50%;background:#27ae60;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>10</div>'"></button>
                    <button class="chip-btn" onclick="addBet(50)"><img src="pic/m50.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(50)\' style=\'width:34px;height:34px;border-radius:50%;background:#2980b9;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>50</div>'"></button>
                    <button class="chip-btn" onclick="addBet(100)"><img src="pic/m100.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(100)\' style=\'width:34px;height:34px;border-radius:50%;background:#8e44ad;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>100</div>'"></button>
                    <button class="chip-btn" onclick="addBet(500)"><img src="pic/m500.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(500)\' style=\'width:34px;height:34px;border-radius:50%;background:#e67e22;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>500</div>'"></button>
                    <button class="chip-btn" onclick="addBet(1000)"><img src="pic/m1000.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(1000)\' style=\'width:34px;height:34px;border-radius:50%;background:#c0392b;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>1K</div>'"></button>
                </div>
                <div class="bet-divider"></div>
                <div class="bet-actions">
                    <input type="number" id="bet-amount" value="0" readonly>
                    <button class="btn-clear" onclick="document.getElementById('bet-amount').value=0">âœ•</button>
                </div>
                <div class="bet-divider"></div>
                <div class="action-row">
                    <button class="btn-up" id="btn-up" onclick="handleAction('up')" style="display:none;">â¬† çŒœå¤§</button>
                    <button class="btn-down" id="btn-down" onclick="handleAction('down')" style="display:none;">â¬‡ çŒœå°</button>
                    <button class="btn-allin" onclick="setAllIn()">ğŸ’¥ ALL IN</button>
                    <button class="btn-fold" onclick="handleAction('fold')">ğŸ³ æ£„ç‰Œ($<span id="fold-cost-ui">0</span>)</button>
                </div>
            </div>

            <!-- éŠæˆ²å…§èŠå¤© -->
            <div id="game-chat-toggle" onclick="toggleGameChat()">
                ğŸ’¬<span class="chat-unread" id="chat-unread"></span>
            </div>
            <div id="game-chat-panel">
                <div id="game-chat-msgs"></div>
                <div id="game-chat-input-row">
                    <input type="text" id="game-chat-input" placeholder="èªªé»ä»€éº¼..." maxlength="60" onkeydown="if(event.key==='Enter')sendGameChat()">
                    <button id="game-chat-send" onclick="sendGameChat()">â¤</button>
                </div>
            </div>

            <!-- Emoji -->
            <button id="emoji-toggle" onclick="toggleEmojiBar()" title="è¡¨æƒ…ç¬¦è™Ÿ">ğŸ˜„</button>
            <div id="emoji-bar">
                <button class="emoji-btn" onclick="sendEmoji('ğŸ˜‚')">ğŸ˜‚</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ”¥')">ğŸ”¥</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ’¸')">ğŸ’¸</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ’©')">ğŸ’©</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸƒ')">ğŸƒ</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ‘‘')">ğŸ‘‘</button>
            </div>

            <!-- å·¥å…·åˆ— -->
            <div id="tools">
                <button class="tool-btn leave" onclick="leaveRoom()">ğŸšª é›¢é–‹</button>
                <button class="tool-btn" id="host-reset-btn" onclick="hostResetToLobby()" style="display:none;">ğŸš¨ é‡è£½</button>
            </div>
        </div>
    </div>
</div>

<div style="display:none;">
    <div id="main-board"><div id="bet-controls"></div><div id="player-deal-btn"></div><div id="host-controls"></div></div>
    <div id="player-area-wrapper"><div id="player-area"></div></div>
</div>

<script>
/* â•â•â•â• Firebase â•â•â•â• */
const firebaseConfig = {
    apiKey:"AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
    authDomain:"dargongatepoker.firebaseapp.com",
    databaseURL:"https://dargongatepoker-default-rtdb.firebaseio.com",
    projectId:"dargongatepoker",
    storageBucket:"dargongatepoker.firebasestorage.app",
    messagingSenderId:"204663560828",
    appId:"1:204663560828:web:9ede7b6190babde73f07f9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const gameRef  = db.ref('dragonGate/room1');
const chatRef  = db.ref('dragonGate/chat');

/* â•â•â•â• å…¨åŸŸç‹€æ…‹ â•â•â•â• */
let myId='', myName='', localData={};
let lastEffectId='INITIAL', lastShotId='INITIAL', lastEmojiTime=0;
let serverOffset=0, wasMyturn=false, emojiBarOpen=false;
let gameChatOpen=false, chatUnreadCount=0;
let lastChatTime=0;
const labels={1:'A',11:'J',12:'Q',13:'K'};
const RECONNECT_WINDOW=60*1000, KICK_GRACE=10*1000;

db.ref('.info/serverTimeOffset').on('value', s => serverOffset=s.val());
function getServerNow(){ return Date.now()+serverOffset; }

/* â•â•â•â• éŸ³æ•ˆ â•â•â•â• */
function playSfx(id){ const el=document.getElementById(id); if(!el)return; el.currentTime=0; el.play().catch(()=>{}); }

/* â•â•â•â• ç•«é¢åˆ‡æ› â•â•â•â• */
function showScreen(name){
    document.getElementById('login-screen').style.display  = name==='login'  ? 'flex' : 'none';
    document.getElementById('lobby-screen').style.display  = name==='lobby'  ? 'flex' : 'none';
    document.getElementById('game-screen').style.display   = name==='game'   ? 'block': 'none';
}

/* â•â•â•â• èŠå¤© â•â•â•â• */
function renderChatMsg(data, targetId, myCheck){
    const el = document.getElementById(targetId);
    if(!el) return;
    const isSystem = !data.name;
    const isMe = data.uid === myId;
    const div = document.createElement('div');
    div.className = 'chat-msg' + (isSystem?' system':'') + (isMe?' is-me':'');
    if(isSystem){
        div.innerHTML = `<span style="color:#666;">âš™ï¸ ${data.text}</span>`;
    } else {
        div.innerHTML = `<span class="chat-name">${data.name}</span>${data.text}`;
    }
    el.appendChild(div);
    // ä¿ç•™æœ€è¿‘ 10 æ¢
    while(el.children.length > 10) el.removeChild(el.firstChild);
    el.scrollTop = el.scrollHeight;
}

function sendLobbyChat(){
    const input = document.getElementById('lobby-chat-input');
    const text = input.value.trim();
    if(!text || !myId) return;
    chatRef.push({ uid:myId, name:myName, text, time:firebase.database.ServerValue.TIMESTAMP });
    input.value='';
}

function sendGameChat(){
    const input = document.getElementById('game-chat-input');
    const text = input.value.trim();
    if(!text || !myId) return;
    chatRef.push({ uid:myId, name:myName, text, time:firebase.database.ServerValue.TIMESTAMP });
    input.value='';
}

function startChatListener(){
    // åªç›£è½æœ€å¾Œ 10 æ¢ï¼Œä¸”åªæ¥æ”¶ã€Œæ¯”é€²å…¥æ™‚æ›´æ–°çš„ã€
    chatRef.limitToLast(10).on('child_added', snap => {
        const d = snap.val();
        if(!d || d.time <= lastChatTime) return;
        // åŒæ­¥åˆ°å¤§å»³èŠå¤©
        renderChatMsg(d, 'lobby-chat-msgs', true);
        // åŒæ­¥åˆ°éŠæˆ²å…§èŠå¤©
        renderChatMsg(d, 'game-chat-msgs', true);
        // éŠæˆ²å…§æœªè®€æç¤º
        if(!gameChatOpen && d.uid !== myId){
            chatUnreadCount++;
            const badge = document.getElementById('chat-unread');
            if(badge){ badge.innerText=chatUnreadCount; badge.classList.add('show'); }
        }
    });
}

function toggleGameChat(){
    gameChatOpen = !gameChatOpen;
    const panel = document.getElementById('game-chat-panel');
    const btn   = document.getElementById('game-chat-toggle');
    const badge = document.getElementById('chat-unread');
    if(gameChatOpen){
        panel.style.display='flex'; btn.classList.add('open');
        chatUnreadCount=0; if(badge){ badge.classList.remove('show'); }
        document.getElementById('game-chat-msgs').scrollTop = 9999;
    } else {
        panel.style.display='none'; btn.classList.remove('open');
    }
}

/* â•â•â•â• Emoji â•â•â•â• */
function toggleEmojiBar(){
    emojiBarOpen=!emojiBarOpen;
    const bar=document.getElementById('emoji-bar'), btn=document.getElementById('emoji-toggle');
    if(emojiBarOpen){ bar.style.display='flex'; btn.classList.add('open'); btn.innerText='âœ•'; }
    else{ bar.style.display='none'; btn.classList.remove('open'); btn.innerText='ğŸ˜„'; }
}
function sendEmoji(icon){
    gameRef.update({lastEmoji:{name:myName,icon,time:firebase.database.ServerValue.TIMESTAMP}});
    if(emojiBarOpen) toggleEmojiBar();
}
function showEmojiBroadcast(name,icon){
    const a=document.getElementById('emoji-broadcast-area');
    const d=document.createElement('div'); d.className='broadcast-item';
    d.innerText=`${name}: ${icon}`; a.appendChild(d); setTimeout(()=>d.remove(),2500);
}

/* â•â•â•â• Toasts â•â•â•â• */
let myTurnTimer=null;
function showMyTurnToast(){
    const t=document.getElementById('my-turn-toast'); t.style.display='block';
    if('vibrate' in navigator) navigator.vibrate([150,50,150]);
    clearTimeout(myTurnTimer); myTurnTimer=setTimeout(()=>t.style.display='none',3000);
}
let refillTimer=null;
function showRefillToast(fee,count){
    const t=document.getElementById('refill-toast');
    t.innerText=`ğŸ’° æ± é‡‘ä¸è¶³,æ¯äººè£œåº• $${fee}(å…±è£œ $${fee*count})`;
    t.style.display='block'; clearTimeout(refillTimer); refillTimer=setTimeout(()=>t.style.display='none',3500);
}
function showReconnectToast(msg,duration){
    const t=document.getElementById('reconnect-toast'); t.innerHTML=msg; t.style.display='block';
    if(duration) setTimeout(()=>t.style.display='none',duration);
}
function hideReconnectToast(){ document.getElementById('reconnect-toast').style.display='none'; }

/* â•â•â•â• åº§ä½æ¸²æŸ“ â•â•â•â• */
function renderSeats(){
    const layer=document.getElementById('seats-layer');
    if(!layer||!localData.players) return;
    layer.innerHTML='';
    const pKeys=Object.keys(localData.players);
    if(pKeys.length===0) return;

    pKeys.forEach((id,i)=>{
        const p=localData.players[id];
        const isMe=(id===myId), isHost=(i===0);
        const isActive=(id===localData.currentPlayerKey);
        const isKicked=!!p.kickedAt;

        let cx,cy;
        if(isMe){
            cx=50; cy=88;
        } else {
            const others=pKeys.filter(k=>k!==myId);
            const oi=others.indexOf(id), oc=others.length;
            const rx=42,ry=36;
            const startDeg=210,endDeg=330;
            const deg=oc===1?270:startDeg+(oi/(oc-1))*(endDeg-startDeg);
            const rad=deg*Math.PI/180;
            cx=50+rx*Math.cos(rad); cy=50+ry*Math.sin(rad);
        }

        const crown=isHost?' ğŸ‘‘':'';
        let tmr='';
        if(isActive&&localData.lastActionTime&&!isKicked){
            const sec=Math.max(0,60-Math.floor((getServerNow()-localData.lastActionTime)/1000));
            tmr=`<div class="seat-tmr">â±${sec}s</div>`;
        }
        if(isKicked){
            const remain=Math.max(0,Math.ceil((p.kickedAt+KICK_GRACE-getServerNow())/1000));
            tmr=`<div class="seat-tmr">ğŸš« ${remain}så¾Œç§»é™¤</div>`;
        }

        const boxCls=['seat-box',isActive&&!isKicked?'active':'',isMe?'is-me':'',isKicked?'kicked':''].filter(Boolean).join(' ');
        const node=document.createElement('div');
        node.className='seat'+(isMe?' is-me':'');
        node.style.left=cx+'%'; node.style.top=cy+'%';
        const kickBtn=(!isKicked)?`<button class="seat-kick" onclick="kickPlayer('${id}')">âœ•</button>`:'';
        node.innerHTML=`${kickBtn}<div class="${boxCls}"><div class="seat-name">${p.name}${crown}</div><div class="seat-bal">$${p.balance}</div>${tmr}</div>`;

        const boxEl=node.querySelector('.seat-box');
        boxEl.addEventListener('click',e=>{
            if(e.target.classList.contains('seat-kick')) return;
            const exp=boxEl.classList.contains('expanded');
            document.querySelectorAll('.seat-box.expanded').forEach(el=>el.classList.remove('expanded'));
            if(!exp) boxEl.classList.add('expanded');
        });
        layer.appendChild(node);
    });

    document.getElementById('oval').addEventListener('click',e=>{
        if(!e.target.closest('.seat-box'))
            document.querySelectorAll('.seat-box.expanded').forEach(el=>el.classList.remove('expanded'));
    });

    const oval=document.getElementById('oval');
    if(oval){
        if(localData.currentPlayerKey===myId) oval.classList.add('my-turn');
        else oval.classList.remove('my-turn');
    }
}

/* â•â•â•â• å¤§å»³ç©å®¶åˆ—è¡¨æ¸²æŸ“ â•â•â•â• */
function renderLobbyPlayers(){
    if(!localData.players) return;
    const pKeys=Object.keys(localData.players);
    document.getElementById('lobby-player-count').innerText=pKeys.length;
    const list=document.getElementById('lobby-player-list');
    list.innerHTML='';
    pKeys.forEach((id,i)=>{
        const p=localData.players[id];
        const isMe=(id===myId), isHost=(i===0);
        const div=document.createElement('div');
        div.className='lobby-player-item'+(isHost?' is-host':'')+(isMe?' is-me':'');
        div.innerHTML=`<span class="lobby-player-dot"></span><span class="lobby-player-name">${p.name}</span>${isHost?'<span class="lobby-player-crown">ğŸ‘‘</span>':''}${isMe?'<span style="color:#74b9ff;font-size:0.75rem;">(æˆ‘)</span>':''}`;
        list.appendChild(div);
    });
}

/* â•â•â•â• åŠ å…¥æˆ¿é–“ â•â•â•â• */
function joinRoom(){
    const name=document.getElementById('my-name').value.trim();
    if(!name) return alert('è«‹è¼¸å…¥æš±ç¨±');
    myName=name;

    const savedId=localStorage.getItem('dgp_myId');
    const savedName=localStorage.getItem('dgp_myName');
    const savedTime=parseInt(localStorage.getItem('dgp_savedAt')||'0');
    const now=Date.now();
    const canReconnect=savedId&&savedName===name&&(now-savedTime<RECONNECT_WINDOW);

    if(canReconnect){
        gameRef.child('players/'+savedId).once('value',snap=>{
            const existing=snap.val();
            if(existing&&!existing.kickedAt){
                myId=savedId; saveMyId(name);
                gameRef.child('players/'+myId).update({lastActive:firebase.database.ServerValue.TIMESTAMP});
                showReconnectToast('ğŸ”„ é‡é€£æˆåŠŸ',2000);
                startListening();
            } else if(existing&&existing.kickedAt){
                showReconnectToast('â³ ç­‰å¾…åº§ä½é‡‹æ”¾...');
                const chk=setInterval(()=>{
                    gameRef.child('players/'+savedId).once('value',s2=>{
                        if(!s2.val()){ clearInterval(chk); hideReconnectToast(); createNewPlayer(name); }
                    });
                },1000);
            } else { createNewPlayer(name); }
        });
    } else { createNewPlayer(name); }
}

function createNewPlayer(name){
    gameRef.once('value',snap=>{
        const data=snap.val()||{};
        const players=data.players||{};
        const now=getServerNow();
        Object.keys(players).forEach(id=>{
            const p=players[id];
            if(!p.kickedAt&&(!p.lastActive||now-p.lastActive>70000)) gameRef.child('players/'+id).remove();
        });
        const pKeys=Object.keys(players).filter(id=>!players[id].kickedAt||(now-players[id].kickedAt<KICK_GRACE));
        if(pKeys.length===0) gameRef.update({gameStarted:false,c1:null,c2:null,c3:null,currentPlayerKey:null});

        const newRef=gameRef.child('players').push();
        myId=newRef.key; saveMyId(name);
        gameRef.child('players/'+myId).set({name,balance:0,lastActive:firebase.database.ServerValue.TIMESTAMP});

        if(data.allInTrigger) lastEffectId=data.allInTrigger;
        if(data.lastEmoji)    lastEmojiTime=data.lastEmoji.time;
        if(data.lastShot)     lastShotId=data.lastShot.id;
        lastChatTime=getServerNow();

        // ç³»çµ±è¨Šæ¯
        chatRef.push({uid:'system',text:`${name} é€²å…¥å¤§å»³`,time:firebase.database.ServerValue.TIMESTAMP});

        startListening();
        startChatListener();
    });
}

function saveMyId(name){
    localStorage.setItem('dgp_myId',myId);
    localStorage.setItem('dgp_myName',name);
    localStorage.setItem('dgp_savedAt',Date.now().toString());
}

/* â•â•â•â• é›¢é–‹æˆ¿é–“ â•â•â•â• */
function leaveRoom(){
    if(!confirm('ç¢ºå®šé›¢é–‹æˆ¿é–“ï¼Ÿ')) return;
    doLeave();
}
function doLeave(){
    if(!myId) return;
    const pKeys=localData.players?Object.keys(localData.players):[];
    const isHost=pKeys[0]===myId;
    const wasActive=localData.currentPlayerKey===myId;

    // ç³»çµ±è¨Šæ¯
    chatRef.push({uid:'system',text:`${myName} é›¢é–‹äº†æˆ¿é–“`,time:firebase.database.ServerValue.TIMESTAMP});

    // ç§»é™¤è‡ªå·±
    gameRef.child('players/'+myId).remove().then(()=>{
        // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæˆ¿ä¸»è‡ªå‹•è½‰ç§»ï¼ˆFirebase å‰©ä¸‹çš„ç¬¬ä¸€å€‹ key å°±æ˜¯æ–°æˆ¿ä¸»ï¼‰
        const remaining=pKeys.filter(k=>k!==myId);
        if(remaining.length===0){
            // æœ€å¾Œä¸€äººé›¢é–‹ï¼Œé‡ç½®
            gameRef.update({gameStarted:false,c1:null,c2:null,c3:null,currentPlayerKey:null});
        } else if(wasActive){
            // è¢«è¸¢çš„æ˜¯ç•¶å‰å‡ºç‰Œè€…ï¼Œè·³ä¸‹ä¸€ä½
            const active=remaining.filter(k=>localData.players[k]&&!localData.players[k].kickedAt);
            gameRef.update({gameState:'waiting_deal',currentPlayerKey:active[0]||remaining[0]||null,lastActionTime:firebase.database.ServerValue.TIMESTAMP});
        }
    });

    // æ¸… localStorage
    localStorage.removeItem('dgp_myId');
    localStorage.removeItem('dgp_myName');
    localStorage.removeItem('dgp_savedAt');
    myId=''; myName='';

    // åœæ­¢ç›£è½
    gameRef.off(); chatRef.off();

    // å›åˆ°ç™»å…¥ç•«é¢
    showScreen('login');
    document.getElementById('my-name').value='';
}

/* â•â•â•â• ä¸»ç›£è½ â•â•â•â• */
function startListening(){
    gameRef.on('value',snap=>{
        localData=snap.val()||{};
        if(!localData.players||!localData.players[myId]){
            // è¢«è¸¢é™¤å¾Œ slot æ¶ˆå¤± â†’ å›ç™»å…¥
            localStorage.removeItem('dgp_myId'); localStorage.removeItem('dgp_myName'); localStorage.removeItem('dgp_savedAt');
            gameRef.off(); chatRef.off();
            showScreen('login'); document.getElementById('my-name').value='';
            return;
        }

        const pKeys=Object.keys(localData.players);
        const isHost=(pKeys[0]===myId);
        document.body.className=isHost?'is-host':'';

        // Emoji å»£æ’­
        if(localData.lastEmoji&&localData.lastEmoji.time>lastEmojiTime){
            showEmojiBroadcast(localData.lastEmoji.name,localData.lastEmoji.icon);
            lastEmojiTime=localData.lastEmoji.time;
        }

        // é£›ç‰Œå»£æ’­ï¼ˆå…¶ä»–äººå°„çš„ï¼‰
        if(localData.lastShot&&localData.lastShot.id!==lastShotId){
            const shot=localData.lastShot; lastShotId=shot.id;
            if(shot.shooterId!==myId){
                updateCard('c1',localData.c1); updateCard('c2',localData.c2);
                document.getElementById('gate-inner').style.display='none';
                animateShotCard(shot.card,shot.resultType,()=>{
                    updateGateCard(localData.c3);
                    const sfxMap={win:'sfx-win',crash:'sfx-crash',lose:'sfx-lose'};
                    playSfx(sfxMap[shot.resultType]||'sfx-lose');
                    if(shot.resultType==='win') spawnConfetti(40);
                    showResultBanner(shot.emoji,shot.text,shot.delta,shot.resultType);
                });
            }
        }

        // ALL IN å½±ç‰‡
        if(localData.allInTrigger&&localData.allInTrigger!==lastEffectId){
            const v=document.getElementById('video-box');
            v.innerHTML=`<video width="315" height="560" autoplay muted playsinline><source src="video/allin.mp4" type="video/mp4"></video>`;
            document.getElementById('all-in-overlay').style.display='flex';
            playSfx('sfx-allin');
            setTimeout(()=>document.getElementById('all-in-overlay').style.display='none',2500);
            lastEffectId=localData.allInTrigger;
        }

        if(localData.gameStarted){
            showScreen('game');
            document.getElementById('emoji-toggle').style.display='flex';
            document.getElementById('emoji-bar').style.display='none';
            document.getElementById('game-chat-toggle').style.display='flex';
            document.getElementById('tools').style.display='flex';
            emojiBarOpen=false;
            document.getElementById('emoji-toggle').classList.remove('open');
            document.getElementById('emoji-toggle').innerText='ğŸ˜„';
            renderUI(isHost);
            const isTurnNow=(localData.currentPlayerKey===myId);
            if(isTurnNow&&!wasMyturn) showMyTurnToast();
            wasMyturn=isTurnNow;
        } else {
            showScreen('lobby');
            document.getElementById('emoji-toggle').style.display='none';
            document.getElementById('emoji-bar').style.display='none';
            document.getElementById('game-chat-toggle').style.display='none';
            document.getElementById('tools').style.display='none';
            // æˆ¿ä¸»è¨­å®š
            document.getElementById('lobby-host-controls').style.display=isHost?'block':'none';
            document.getElementById('lobby-waiting-msg').style.display=isHost?'none':'block';
            wasMyturn=false;
        }

        document.getElementById('host-reset-btn').style.display=isHost?'block':'none';
        renderSeats();
        renderLobbyPlayers();
    });
}

/* â•â•â•â• å¿ƒè·³ & è‡ªå‹•æ¸…ç† â•â•â•â• */
setInterval(()=>{
    if(myId&&localData.players&&localData.players[myId])
        gameRef.child('players/'+myId).update({lastActive:getServerNow()});
},5000);

setInterval(()=>{
    if(!localData.players) return;
    const now=getServerNow(), players=localData.players;
    const pKeys=Object.keys(players);
    if(pKeys[0]!==myId) return; // åªæœ‰æˆ¿ä¸»åŸ·è¡Œæ¸…ç†

    pKeys.forEach(id=>{
        const p=players[id];
        // kickedAt è¶…é KICK_GRACE â†’ çœŸæ­£åˆªé™¤
        if(p.kickedAt&&now-p.kickedAt>=KICK_GRACE){
            gameRef.child('players/'+id).remove(); return;
        }
        // å¿ƒè·³è¶…æ™‚ 70 ç§’ï¼ˆéè‡ªå·±ï¼‰â†’ æ¨™è¨˜ kickedAt
        if(!p.kickedAt&&id!==myId&&(!p.lastActive||now-p.lastActive>70000)){
            gameRef.child('players/'+id).update({kickedAt:getServerNow()});
        }
    });

    // ç•¶å‰å‡ºç‰Œè€…è¢«æ¨™è¨˜ kickedAt â†’ è·³ä¸‹ä¸€ä½
    if(localData.gameStarted){
        const cpKey=localData.currentPlayerKey;
        if(cpKey&&players[cpKey]&&players[cpKey].kickedAt){
            const active=pKeys.filter(k=>!players[k].kickedAt);
            const ci=active.indexOf(cpKey);
            const nextK=active[(ci+1)%active.length]||active[0]||null;
            gameRef.update({gameState:'waiting_deal',currentPlayerKey:nextK,lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:'ç©å®¶è¶…æ™‚ï¼Œç§»å‡ºåº§ä½'});
        }
        // 60ç§’ç„¡æ“ä½œ â†’ æ¨™è¨˜è¸¢é™¤
        if(localData.lastActionTime){
            const diff=(now-localData.lastActionTime)/1000;
            const cpKey=localData.currentPlayerKey;
            if(diff>60.5&&cpKey&&players[cpKey]&&!players[cpKey].kickedAt){
                const ts=getServerNow();
                gameRef.child('players/'+cpKey).update({kickedAt:ts}).then(()=>{
                    const active=pKeys.filter(k=>!players[k].kickedAt&&k!==cpKey);
                    gameRef.update({gameState:'waiting_deal',currentPlayerKey:active[0]||null,statusMsg:'ç©å®¶è¶…æ™‚ï¼Œç§»å‡ºåº§ä½',lastActionTime:firebase.database.ServerValue.TIMESTAMP});
                });
            }
        }
    }
    renderSeats();
},1000);

/* â•â•â•â• è¸¢ç©å®¶ â•â•â•â• */
function kickPlayer(id){
    if(!confirm('å‰”é™¤è©²ç©å®¶ï¼Ÿï¼ˆ10ç§’å¾Œç§»é™¤ï¼ŒæœŸé–“å¯é‡é€£ï¼‰')) return;
    gameRef.child('players/'+id).update({kickedAt:getServerNow()});
    chatRef.push({uid:'system',text:`${localData.players[id]?.name||'ç©å®¶'} è¢«è¸¢å‡ºæˆ¿é–“`,time:firebase.database.ServerValue.TIMESTAMP});
    if(localData.currentPlayerKey===id){
        const pKeys=Object.keys(localData.players);
        const active=pKeys.filter(k=>k!==id&&!localData.players[k].kickedAt);
        gameRef.update({gameState:'waiting_deal',currentPlayerKey:active[0]||null,lastActionTime:firebase.database.ServerValue.TIMESTAMP});
    }
}

/* â•â•â•â• é–‹å±€ â•â•â•â• */
function hostStartGame(){
    const fee=parseInt(document.getElementById('entry-fee').value)||100;
    const start=parseInt(document.getElementById('start-balance').value)||1000;
    const decks=parseInt(document.getElementById('deck-count').value)||2;
    const refill=document.getElementById('auto-refill').checked;
    let players=localData.players, pool=0;
    Object.keys(players).forEach(id=>{ players[id].balance=start-fee; pool+=fee; });
    gameRef.update({
        gameStarted:true, deck:generateDecks(decks), pool, entryFee:fee,
        foldPenalty:parseInt(document.getElementById('fold-penalty').value)||20,
        autoRefill:refill, deckCount:decks, gameState:'waiting_deal',
        currentPlayerKey:Object.keys(players)[0], players,
        lastActionTime:firebase.database.ServerValue.TIMESTAMP, statusMsg:'æ–°å±€é–‹å§‹'
    });
    chatRef.push({uid:'system',text:'éŠæˆ²é–‹å§‹ï¼',time:firebase.database.ServerValue.TIMESTAMP});
}

function drawGoalPost(){
    playSfx('sfx-deal');
    let deck=localData.deck||[];
    if(deck.length<3) deck=generateDecks(localData.deckCount||2);
    const c1=deck.pop(), c2=deck.pop();
    gameRef.update({deck,c1,c2,c3:null,gameState:'waiting_shoot',lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:'è«‹ä¸‹æ³¨å¾ŒæŠ½é–€ç‰Œ'});
}

/* â•â•â•â• éŠæˆ²å‹•ä½œ â•â•â•â• */
function handleAction(type){
    let bet=Math.abs(parseInt(document.getElementById('bet-amount').value))||0;
    if(type!=='fold'&&(bet<1||bet>localData.pool)) return alert('è«‹ä¸‹æ³¨');
    let p=localData.players[myId], nBal=p.balance, nPool=localData.pool;
    let msg='', c3=null, deck=localData.deck||[];
    let resultType='neutral', deltaAmount=0;

    if(type==='fold'){
        nBal-=localData.foldPenalty; nPool+=localData.foldPenalty;
        msg=`${p.name} æ£„ç‰Œ`; resultType='fold'; deltaAmount=-localData.foldPenalty;
    } else {
        if(deck.length<1) deck=generateDecks(localData.deckCount||2);
        c3=deck.pop();
        const min=Math.min(localData.c1.val,localData.c2.val);
        const max=Math.max(localData.c1.val,localData.c2.val);
        if(localData.c1.val===localData.c2.val){
            if(c3.val===localData.c1.val){ nBal-=bet*3; nPool+=bet*3; msg=`æ’æŸ±(-$${bet*3})`; resultType='crash'; deltaAmount=-(bet*3); }
            else if((type==='up'&&c3.val>localData.c1.val)||(type==='down'&&c3.val<localData.c1.val)){ nBal+=bet; nPool-=bet; msg=`çŒœå°(+$${bet})`; resultType='win'; deltaAmount=bet; }
            else{ nBal-=bet; nPool+=bet; msg=`çŒœéŒ¯(-$${bet})`; resultType='lose'; deltaAmount=-bet; }
        } else {
            if(c3.val>min&&c3.val<max){ nBal+=bet; nPool-=bet; msg=`å°„é€²(+$${bet})`; resultType='win'; deltaAmount=bet; }
            else if(c3.val===min||c3.val===max){ nBal-=bet*2; nPool+=bet*2; msg=`æ’æŸ±(-$${bet*2})`; resultType='crash'; deltaAmount=-(bet*2); }
            else{ nBal-=bet; nPool+=bet; msg=`æ²’é€²(-$${bet})`; resultType='lose'; deltaAmount=-bet; }
        }
    }

    const pKeys=Object.keys(localData.players);
    const active=pKeys.filter(k=>!localData.players[k].kickedAt);
    const myActiveIdx=active.indexOf(myId);
    const nextK=active[(myActiveIdx+1)%active.length];

    let updates={
        [`players/${myId}/balance`]:nBal, pool:nPool, deck, c3:c3||null,
        statusMsg:msg, gameState:'waiting_deal', currentPlayerKey:nextK,
        lastActionTime:firebase.database.ServerValue.TIMESTAMP
    };

    const minPoolNeeded=localData.entryFee*active.length;
    const needRefill=(localData.autoRefill&&nPool<minPoolNeeded)||(nPool<=0);
    let refillTriggered=false;
    if(needRefill){
        let total=0;
        active.forEach(k=>{ const cb=(k===myId)?nBal:localData.players[k].balance; updates[`players/${k}/balance`]=cb-localData.entryFee; total+=localData.entryFee; });
        updates.pool=nPool+total; refillTriggered=true;
    }

    if(type!=='fold'&&c3){
        updates.lastShot={
            id:Date.now().toString(), shooterId:myId, card:c3, resultType,
            emoji:resultType==='win'?'ğŸ‰':resultType==='crash'?'ğŸ’¥':'ğŸ˜­',
            text:resultType==='win'?(type==='up'||type==='down'?'çŒœå°!':'å°„é€²!'):resultType==='crash'?'æ’æŸ±!!':(type==='up'||type==='down'?'çŒœéŒ¯äº†':'æ²’é€²...'),
            delta:deltaAmount
        };
    }

    gameRef.update(updates);
    document.getElementById('bet-amount').value=0;

    if(type!=='fold'&&c3){
        document.getElementById('gate-inner').style.display='none';
        animateShotCard(c3,resultType,()=>{
            updateGateCard(c3);
            if(resultType==='win'){ playSfx('sfx-win'); spawnConfetti(40); showResultBanner('ğŸ‰',type==='up'?'çŒœå°!':'å°„é€²!',deltaAmount,'win'); }
            else if(resultType==='crash'){ playSfx('sfx-crash'); showResultBanner('ğŸ’¥','æ’æŸ±!!',deltaAmount,'crash'); }
            else{ playSfx('sfx-lose'); showResultBanner('ğŸ˜­',type==='up'||type==='down'?'çŒœéŒ¯äº†':'æ²’é€²...',deltaAmount,'lose'); }
            if(refillTriggered) showRefillToast(localData.entryFee,active.length);
        });
    } else {
        playSfx('sfx-fold');
        showResultBanner('ğŸ³ï¸','æ£„ç‰Œ',deltaAmount,'fold');
        if(refillTriggered) showRefillToast(localData.entryFee,active.length);
    }
}

function onDeckClick(){
    if(!localData.gameStarted) return;
    if(localData.currentPlayerKey!==myId) return;
    if(localData.gameState==='waiting_deal'){
        drawGoalPost();
    } else if(localData.gameState==='waiting_shoot'){
        const bet=Math.abs(parseInt(document.getElementById('bet-amount').value))||0;
        const isSame=localData.c1&&localData.c2&&localData.c1.val===localData.c2.val;
        if(bet<1||bet>localData.pool){
            const h=document.getElementById('deck-hint');
            h.innerText='âš ï¸ è«‹å…ˆä¸‹æ³¨!'; h.classList.add('show');
            setTimeout(()=>{ h.innerText='ä¸‹æ³¨å¾Œé»æ“Šå°„é–€'; },1500); return;
        }
        if(isSame){
            const h=document.getElementById('deck-hint');
            h.innerText='âš ï¸ è«‹çŒœå¤§æˆ–çŒœå°'; h.classList.add('show');
            setTimeout(()=>{ h.innerText='çŒœå¤§/çŒœå°'; },1500);
        } else { handleAction('shoot'); }
    }
}

/* â•â•â•â• renderUI â•â•â•â• */
function renderUI(isHost){
    document.getElementById('pool-val').innerText=localData.pool||0;
    document.getElementById('status-msg').innerText=localData.statusMsg||'';
    document.getElementById('cards-left').innerText=localData.deck?localData.deck.length:0;
    document.getElementById('fold-cost-ui').innerText=localData.foldPenalty||20;
    updateCard('c1',localData.c1); updateCard('c2',localData.c2); updateGateCard(localData.c3);

    const isTurn=(localData.currentPlayerKey===myId);
    const isSame=localData.c1&&localData.c2&&localData.c1.val===localData.c2.val;
    const deckEl=document.getElementById('deck-stack');
    const hintEl=document.getElementById('deck-hint');
    const badgeEl=document.getElementById('deck-badge');
    if(badgeEl) badgeEl.innerText=localData.deck?localData.deck.length:0;

    if(isTurn&&localData.gameState==='waiting_deal'){ deckEl.classList.add('can-click'); hintEl.innerText='é»æ“ŠæŠ½ç‰Œ'; hintEl.classList.add('show'); }
    else if(isTurn&&localData.gameState==='waiting_shoot'){ deckEl.classList.add('can-click'); hintEl.innerText=isSame?'çŒœå¤§/çŒœå°':'ä¸‹æ³¨å¾Œé»æ“Šå°„é–€'; hintEl.classList.add('show'); }
    else{ deckEl.classList.remove('can-click'); hintEl.classList.remove('show'); }

    document.getElementById('bet-panel').style.display=(isTurn&&localData.gameState==='waiting_shoot')?'flex':'none';
    document.getElementById('btn-up').style.display=isSame?'inline-block':'none';
    document.getElementById('btn-down').style.display=isSame?'inline-block':'none';
}

/* â•â•â•â• ç‰Œå€æ›´æ–° â•â•â•â• */
function updateGateCard(c){
    const gi=document.getElementById('gate-inner'), c3g=document.getElementById('c3-in-gate');
    if(!c){ gi.style.display=''; gi.innerText='å¾…å°„é–€'; c3g.style.display='none'; c3g.innerHTML=''; }
    else{
        gi.style.display='none';
        const isRed=c.suit==='â™¥'||c.suit==='â™¦'; c3g.style.display='block';
        const w='clamp(44px,7.5vmin,68px)',h='clamp(62px,10.5vmin,96px)';
        c3g.innerHTML=`<div class="card${isRed?' red':''}" style="width:${w};height:${h};">${c.suit}\n${c.label}</div>`;
    }
}
function updateCard(id,c){
    const el=document.getElementById(id);
    if(!c){ el.classList.add('hidden'); el.innerText='?'; }
    else{ el.classList.remove('hidden'); el.innerText=`${c.suit}\n${c.label}`; el.classList.toggle('red',c.suit==='â™¥'||c.suit==='â™¦'); }
}

/* â•â•â•â• é£›ç‰Œå‹•ç•« â•â•â•â• */
function animateShotCard(cardData,resultType,onDone){
    const canvas=document.getElementById('shot-canvas'), ctx=canvas.getContext('2d');
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    function tr(rect){ return{x:rect.left+rect.width/2,y:rect.top+rect.height/2}; }
    const gate=tr(document.getElementById('gate-frame').getBoundingClientRect());
    const deck=tr(document.getElementById('deck-stack').getBoundingClientRect());
    const lpost=tr(document.getElementById('c1').getBoundingClientRect());
    const rpost=tr(document.getElementById('c2').getBoundingClientRect());
    const isRed=cardData.suit==='â™¥'||cardData.suit==='â™¦';
    const cardW=60,cardH=86;
    let endX,endY;
    if(resultType==='win'){ endX=gate.x; endY=gate.y; }
    else if(resultType==='crash'){ const pp=Math.random()>0.5?lpost:rpost; endX=pp.x; endY=pp.y; }
    else{ endX=Math.random()>0.5?-cardW:canvas.width+cardW; endY=gate.y-40; }
    const cpX=(deck.x+endX)/2+(Math.random()-0.5)*80;
    const cpY=Math.min(deck.y,endY)-130;
    let t=0,rotation=0;
    function drawCard(x,y,rot,alpha){
        ctx.save(); ctx.globalAlpha=alpha; ctx.translate(x,y); ctx.rotate(rot);
        ctx.fillStyle='#fff'; ctx.strokeStyle='#333'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(-cardW/2+8,-cardH/2); ctx.lineTo(cardW/2-8,-cardH/2);
        ctx.quadraticCurveTo(cardW/2,-cardH/2,cardW/2,-cardH/2+8);
        ctx.lineTo(cardW/2,cardH/2-8); ctx.quadraticCurveTo(cardW/2,cardH/2,cardW/2-8,cardH/2);
        ctx.lineTo(-cardW/2+8,cardH/2); ctx.quadraticCurveTo(-cardW/2,cardH/2,-cardW/2,cardH/2-8);
        ctx.lineTo(-cardW/2,-cardH/2+8); ctx.quadraticCurveTo(-cardW/2,-cardH/2,-cardW/2+8,-cardH/2);
        ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.fillStyle=isRed?'#e74c3c':'#000'; ctx.font="bold 20px 'Segoe UI'";
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(cardData.suit,0,-10); ctx.fillText(cardData.label.toString(),0,14);
        ctx.restore();
    }
    let particles=[];
    function spawnCrash(x,y){ for(let i=0;i<20;i++){ const a=Math.random()*Math.PI*2,s=3+Math.random()*6; particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,color:Math.random()>0.5?'#f39c12':'#e74c3c'}); } }
    let phase='fly',it=0;
    function frame(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(phase==='fly'){
            t++; const pp=t/50,e=pp<0.5?2*pp*pp:-1+(4-2*pp)*pp;
            const bx=(1-e)*(1-e)*deck.x+2*(1-e)*e*cpX+e*e*endX;
            const by=(1-e)*(1-e)*deck.y+2*(1-e)*e*cpY+e*e*endY;
            rotation+=0.15; drawCard(bx,by,rotation,Math.min(1,pp*3));
            if(t>=50){ phase='impact'; if(resultType==='crash') spawnCrash(endX,endY); }
            requestAnimationFrame(frame);
        } else if(phase==='impact'){
            it++;
            if(resultType==='win'){ const sc=1-it/25,a=1-it/20; if(a>0){ ctx.save(); ctx.strokeStyle=`rgba(46,204,113,${a})`; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(endX,endY,50+it*3,0,Math.PI*2); ctx.stroke(); ctx.restore(); drawCard(endX,endY,0,a*sc); } }
            else if(resultType==='crash'){ particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.3;p.life-=0.04;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();ctx.restore();}); particles=particles.filter(p=>p.life>0); drawCard(endX+(Math.random()-0.5)*(10-it*0.5),endY,Math.random()*0.3,Math.max(0,1-it/20)); }
            else{ const a=Math.max(0,1-it/15),fly=it*8,dir=endX<canvas.width/2?-1:1; drawCard(endX+dir*fly,endY-fly*0.3,rotation+it*0.2,a); }
            if(it>=25||(resultType==='lose'&&it>=18)){ ctx.clearRect(0,0,canvas.width,canvas.height); if(onDone) onDone(); return; }
            requestAnimationFrame(frame);
        }
    }
    requestAnimationFrame(frame);
}

/* â•â•â•â• å…¶ä»–å·¥å…· â•â•â•â• */
function showResultBanner(emoji,text,amount,type){
    const b=document.getElementById('result-banner');
    document.getElementById('rb-emoji').innerText=emoji;
    document.getElementById('rb-text').innerText=text;
    const ae=document.getElementById('rb-amount');
    ae.innerText=(amount>=0?'+':'')+'$'+amount;
    ae.className='rb-amount '+(amount>=0?'positive':'negative');
    b.classList.remove('show'); b.style.display='block';
    requestAnimationFrame(()=>requestAnimationFrame(()=>b.classList.add('show')));
    setTimeout(()=>{ b.classList.remove('show'); setTimeout(()=>b.style.display='none',400); },2800);
}
function spawnConfetti(count){
    const cols=['#f1c40f','#2ecc71','#3498db','#e74c3c','#9b59b6','#fff'];
    for(let i=0;i<count;i++){
        const el=document.createElement('div'); el.className='confetti-piece';
        el.style.left=Math.random()*100+'vw'; el.style.background=cols[Math.floor(Math.random()*cols.length)];
        el.style.animationDuration=(1.5+Math.random()*1.5)+'s'; el.style.animationDelay=(Math.random()*0.5)+'s';
        document.body.appendChild(el); setTimeout(()=>el.remove(),3500);
    }
}
function addBet(v){ let cur=parseInt(document.getElementById('bet-amount').value)||0; document.getElementById('bet-amount').value=Math.min(cur+v,localData.pool); }
function setAllIn(){ document.getElementById('allin-pool-preview').innerText='$'+(localData.pool||0); document.getElementById('all-in-confirm-overlay').classList.add('show'); }
function cancelAllIn(){ document.getElementById('all-in-confirm-overlay').classList.remove('show'); }
function confirmAllIn(){ document.getElementById('all-in-confirm-overlay').classList.remove('show'); gameRef.update({allInTrigger:getServerNow().toString()}); document.getElementById('bet-amount').value=localData.pool; }
function generateDecks(count){ let deck=[]; const suits=['â™ ','â™¥','â™¦','â™£']; for(let i=0;i<count;i++) suits.forEach(s=>{ for(let v=1;v<=13;v++) deck.push({val:v,suit:s,label:labels[v]||v}); }); return deck.sort(()=>Math.random()-0.5); }
function hostResetToLobby(){ if(confirm('é‡è£½å¤§å»³ç‹€æ…‹ï¼Ÿ')) gameRef.update({gameStarted:false}); }
</script>
</body>
</html>

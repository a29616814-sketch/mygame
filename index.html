<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°„é¾é–€ Pro - æœ€çµ‚æ•´åˆç©©å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #d4af37; --dark-green: #1a472a; --card-red: #e74c3c; --spectator: #95a5a6; }
        body { background: var(--dark-green); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 10px; }
        .game-container { max-width: 1000px; margin: auto; }
        .player-list { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; min-height: 80px; }
        .player-card { background: rgba(0,0,0,0.8); padding: 12px; border-radius: 12px; border: 2px solid #444; width: 130px; position: relative; }
        .player-card.active { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); background: rgba(212, 175, 55, 0.1); }
        .player-card.is-spectator { border: 2px dashed var(--spectator); opacity: 0.6; }
        .player-balance { color: #2ecc71; font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .board { background: radial-gradient(circle, #2d5a3c 0%, #1a472a 100%); padding: 30px; border-radius: 50px; border: 4px solid var(--gold); box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .pool-display { font-size: 48px; color: #f1c40f; font-weight: bold; }
        .cards { display: flex; justify-content: center; gap: 15px; margin: 20px 0; height: 160px; }
        .card { width: 100px; height: 150px; background: white; border-radius: 10px; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 35px; font-weight: bold; border: 2px solid #333; }
        .card.hidden { background: #2c3e50; color: transparent; border: 2px solid #7f8c8d; }
        .card.red { color: var(--card-red); }
        .setup-box { background: rgba(0,0,0,0.7); padding: 25px; border-radius: 20px; border: 1px solid var(--gold); margin-bottom: 20px; }
        input { padding: 10px; border-radius: 5px; border: none; text-align: center; font-size: 1rem; margin: 5px; }
        button { padding: 10px 18px; cursor: pointer; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; color: #1a472a; margin: 4px; }
        button:hover { filter: brightness(1.2); }
        .admin-btn { background: #e74c3c; color: white; }
        #status-msg { height: 35px; font-size: 1.2rem; color: #f1c40f; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

<div id="game-ui" class="game-container">
    <h1>ğŸŸï¸ çš‡å®¶å°„é¾é–€ Pro</h1>

    <div id="setup-area" class="setup-box">
        <div id="login-part">
            <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±">
            <button onclick="joinRoom()">é»æˆ‘é€²å…¥éŠæˆ²</button>
        </div>
        <div id="host-part" style="display:none;">
            <p>ğŸ‘‘ æˆ¿ä¸»è¨­å®š (æ•¸å€¼å°‡å­˜æ–¼é›²ç«¯)</p>
            åˆå§‹æœ¬é‡‘: <input type="number" id="start-balance" value="1000" style="width:80px;">
            çºŒæ± åº•æ³¨: <input type="number" id="entry-fee" value="100" style="width:70px;">
            æ’æŸ±å€ç‡: <input type="number" id="hit-rate" value="2" style="width:50px;">
            <button onclick="hostStartGame()">å…¨å“¡æ”¶éŒ¢ãƒ»æ­£å¼é–‹å±€</button>
        </div>
    </div>

    <div id="player-area" class="player-list"></div>

    <div id="main-board" class="board" style="display:none;">
        <div class="pool-display">ğŸ’° $<span id="pool-val">0</span></div>
        <div id="status-msg">ç­‰å¾…ç™¼ç‰Œ...</div>

        <div class="cards">
            <div id="c1" class="card hidden">?</div>
            <div id="c3" class="card hidden">?</div>
            <div id="c2" class="card hidden">?</div>
        </div>

        <div id="controls">
            <div id="bet-controls" style="display:none;">
                <input type="number" id="bet-amount" placeholder="ä¸‹æ³¨(10å€)" min="10" step="10" style="width:140px;">
                <div id="action-buttons" style="display:inline-block;">
                    <button id="shoot-normal" onclick="handleAction('shoot')">å°„é–€ï¼</button>
                    <div id="guess-buttons" style="display:none;">
                        <button onclick="handleAction('up')" style="background:#3498db; color:white;">çŒœå¤§</button>
                        <button onclick="handleAction('down')" style="background:#e67e22; color:white;">çŒœå°</button>
                    </div>
                </div>
                <button onclick="setAllIn()" style="background:var(--card-red); color:white;">ALL IN</button>
                <button onclick="handleAction('fold')" style="background:#95a5a6;">æ”¾æ£„</button>
            </div>
            
            <div id="host-controls" style="margin-top:20px; border-top:1px solid #666; padding-top:10px; display:none;">
                <button id="deal-btn" onclick="drawGoalPost()" style="background: #2ecc71; color: white;">â™  ç«‹å³ç™¼ç‰Œ â™£</button>
                <button class="admin-btn" onclick="forceReset()">ğŸš¨ å¼·åˆ¶é‡ç½®ç‹€æ…‹</button>
            </div>
        </div>
        <p style="font-size: 12px; color: #888;">ç‰Œå †å‰©é¤˜: <span id="cards-left">0</span></p>
    </div>
</div>

<div id="kicked-screen" style="display:none; padding:100px;">
    <h1>ğŸš« å·²é›¢é–‹æˆ¿é–“</h1>
    <button onclick="location.reload()">é‡æ–°é€²å…¥</button>
</div>

<script>
    // --- 1. Firebase é…ç½® (è«‹ç¢ºä¿è³‡æ–™åº« Rules å·²è¨­ç‚º true) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
        authDomain: "dargongatepoker.firebaseapp.com",
        databaseURL: "https://dargongatepoker-default-rtdb.firebaseio.com",
        projectId: "dargongatepoker",
        storageBucket: "dargongatepoker.firebasestorage.app",
        messagingSenderId: "204663560828",
        appId: "1:204663560828:web:9ede7b6190babde73f07f9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameRef = db.ref('dragonGate/room1');

    let myId = "", myName = "", isHost = false, localData = {};
    const labels = {1:'A', 11:'J', 12:'Q', 13:'K'};

    // --- 2. æ ¸å¿ƒé‚è¼¯ï¼šåŠ å…¥æˆ¿é–“ ---
    function joinRoom() {
        myName = document.getElementById('my-name').value.trim();
        if (!myName) return alert("è«‹è¼¸å…¥æš±ç¨±");

        const newRef = gameRef.child('players').push();
        myId = newRef.key;

        // è¨­å®šæ–·ç·šè‡ªå‹•åˆªé™¤
        newRef.onDisconnect().remove();

        // å¯«å…¥åˆå§‹è³‡æ–™
        newRef.set({
            name: myName,
            balance: 0,
            status: 'spectator',
            isHost: false
        }).then(() => {
            document.getElementById('login-part').style.display = 'none';
            startListening();
        }).catch(err => {
            alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase Rules æ˜¯å¦é–‹å•Ÿï¼š" + err.message);
        });
    }

    // --- 3. ç›£è½é›²ç«¯æ•¸æ“š ---
    function startListening() {
        gameRef.on('value', snap => {
            localData = snap.val() || {};
            
            // æª¢æŸ¥è‡ªå·±æ˜¯å¦é‚„åœ¨æˆ¿é–“
            if (!localData.players || !localData.players[myId]) {
                if (myId) document.getElementById('kicked-screen').style.display = 'block';
                return;
            }

            const pKeys = Object.keys(localData.players);
            // åˆ—è¡¨ç¬¬ä¸€å€‹ç©å®¶è‡ªå‹•æˆç‚ºæˆ¿ä¸» (Host Migration)
            isHost = (pKeys[0] === myId);
            
            // æ›´æ–° UI é¡¯ç¤º
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            document.getElementById('host-part').style.display = (isHost && !localData.gameStarted) ? 'block' : 'none';

            if (localData.gameStarted) {
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('main-board').style.display = 'block';
                renderUI();
            }
            renderPlayers();
        });
    }

    // --- 4. æˆ¿ä¸»æ“ä½œ ---
    function hostStartGame() {
        const fee = parseInt(document.getElementById('entry-fee').value) || 100;
        const start = parseInt(document.getElementById('start-balance').value) || 1000;
        const rate = parseInt(document.getElementById('hit-rate').value) || 2;
        
        let updates = { 
            gameStarted: true, 
            deck: generateDeck(), 
            pool: 0, 
            entryFee: fee, 
            hitRate: rate, 
            gameState: 'waiting_deal', 
            statusMsg: "éŠæˆ²æ­£å¼é–‹å§‹ï¼Œè«‹æˆ¿ä¸»ç™¼ç‰Œï¼" 
        };

        Object.keys(localData.players).forEach((id, idx) => {
            updates[`players/${id}/balance`] = start - fee;
            updates[`players/${id}/status`] = 'player';
            updates.pool += fee;
            if (idx === 0) updates.currentPlayerKey = id;
        });
        gameRef.update(updates);
    }

    function drawGoalPost() {
        let deck = localData.deck || generateDeck();
        if (deck.length < 5) deck = generateDeck();
        const c1 = deck.pop(); const c2 = deck.pop();
        
        const pKeys = Object.keys(localData.players).filter(k => localData.players[k].status === 'player');
        let currentK = localData.currentPlayerKey;
        if (!pKeys.includes(currentK)) currentK = pKeys[0];

        gameRef.update({
            deck: deck, c1: c1, c2: c2, c3: null,
            gameState: 'waiting_shoot',
            currentPlayerKey: currentK,
            statusMsg: `è¼ªåˆ°ç©å®¶ ã€${localData.players[currentK].name}ã€‘ ä¸‹æ³¨`
        });
    }

    // --- 5. éŠæˆ²å‹•ä½œ ---
    function handleAction(type) {
        let bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
        const p = localData.players[myId];
        const hitRate = localData.hitRate || 2;

        if (type !== 'fold') {
            if (bet < 10 || bet % 10 !== 0 || bet > p.balance || bet > localData.pool) {
                return alert("é‡‘é¡ä¸ç¬¦è¦å‰‡ (10å€æ•¸ä¸”ä¸è¶…éé¤˜é¡/æ± å­)");
            }
        }

        let deck = localData.deck;
        const c3 = deck.pop();
        let nBal = p.balance, nPool = localData.pool, msg = "";

        if (type === 'fold') {
            msg = `${p.name} æ”¾æ£„å°„é–€`;
        } else {
            const min = Math.min(localData.c1.val, localData.c2.val);
            const max = Math.max(localData.c1.val, localData.c2.val);
            if (localData.c1.val === localData.c2.val) {
                if (c3.val === localData.c1.val) { nBal -= bet*3; nPool += bet*3; msg = "ğŸ’¥ ä¸‰å€æ’æŸ±ï¼æ…˜ï¼"; }
                else if ((type === 'up' && c3.val > localData.c1.val) || (type === 'down' && c3.val < localData.c1.val)) { nBal += bet; nPool -= bet; msg = "ğŸ‰ çŒœå°äº†ï¼æ”¶éŒ¢ï¼"; }
                else { nBal -= bet; nPool += bet; msg = "âŒ çŒœéŒ¯äº†ï¼ŒéŒ¢ç•™ä¸‹ã€‚"; }
            } else {
                if (c3.val > min && c3.val < max) { nBal += bet; nPool -= bet; msg = "ğŸ‰ å°„é€²ï¼æ­å–œï¼"; }
                else if (c3.val === min || c3.val === max) { nBal -= bet*hitRate; nPool += bet*hitRate; msg = `ğŸš§ æ’æŸ±ï¼ç½° ${hitRate} å€ï¼`; }
                else { nBal -= bet; nPool += bet; msg = "âŒ é–€å¤–çƒï¼Œå¯æƒœã€‚"; }
            }
        }

        const pKeys = Object.keys(localData.players).filter(k => localData.players[k].status === 'player');
        let nextK = pKeys[(pKeys.indexOf(myId) + 1) % pKeys.length];

        let updates = {
            [`players/${myId}/balance`]: nBal,
            pool: nPool, deck: deck, c3: c3,
            statusMsg: msg,
            gameState: 'waiting_deal',
            currentPlayerKey: nextK
        };

        // æ²’éŒ¢è‡ªå‹•è£œæ± é‚è¼¯
        if (nPool <= 0) {
            updates.pool = 0;
            pKeys.forEach(k => {
                let currentBal = (k === myId) ? nBal : localData.players[k].balance;
                if (currentBal >= localData.entryFee) {
                    updates[`players/${k}/balance`] = currentBal - localData.entryFee;
                    updates.pool += localData.entryFee;
                } else {
                    updates[`players/${k}/status`] = 'spectator';
                }
            });
            updates.statusMsg = "ğŸ’¸ æ± å­ç©ºäº†ï¼Œå…¨å“¡è‡ªå‹•æ”¶åº•ï¼";
        }

        gameRef.update(updates);
        document.getElementById('bet-amount').value = "";
    }

    // --- 6. UI è¼”åŠ©å‡½æ•¸ ---
    function renderUI() {
        document.getElementById('pool-val').innerText = localData.pool;
        document.getElementById('status-msg').innerText = localData.statusMsg;
        document.getElementById('cards-left').innerText = localData.deck ? localData.deck.length : 0;
        
        updateCard('c1', localData.c1);
        updateCard('c2', localData.c2);
        updateCard('c3', localData.c3);

        const isTurn = (localData.currentPlayerKey === myId);
        const isShoot = (localData.gameState === 'waiting_shoot');
        const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;
        const isConsec = localData.c1 && localData.c2 && Math.abs(localData.c1.val - localData.c2.val) === 1;

        document.getElementById('bet-controls').style.display = (isTurn && isShoot) ? 'block' : 'none';
        document.getElementById('shoot-normal').style.display = (isSame || isConsec) ? 'none' : 'inline-block';
        document.getElementById('guess-buttons').style.display = isSame ? 'inline-block' : 'none';
        document.getElementById('deal-btn').style.display = (isHost && localData.gameState === 'waiting_deal') ? 'inline-block' : 'none';
    }

    function renderPlayers() {
        const area = document.getElementById('player-area');
        area.innerHTML = '';
        Object.keys(localData.players).forEach(id => {
            const p = localData.players[id];
            const div = document.createElement('div');
            div.className = `player-card ${id === localData.currentPlayerKey ? 'active' : ''} ${p.status === 'spectator' ? 'is-spectator' : ''}`;
            div.innerHTML = `
                <b>${p.isHost ? 'ğŸ‘‘' : ''}${p.name}</b><br>
                <span class="player-balance">$${p.balance}</span><br>
                <small>${p.status === 'player' ? 'éŠæˆ²ä¸­' : 'è§€çœ¾'}</small>
                <div style="margin-top:5px">
                    ${isHost && id !== myId ? `<button onclick="kick('${id}')" style="background:#e74c3c;color:white;font-size:10px;padding:2px">è¸¢å‡º</button>` : ''}
                    ${isHost && p.status === 'spectator' ? `<button onclick="approve('${id}')" style="background:#27ae60;color:white;font-size:10px;padding:2px">å‡†å…¥</button>` : ''}
                </div>
            `;
            area.appendChild(div);
        });
    }

    function updateCard(id, c) {
        const el = document.getElementById(id);
        if (!c) { el.classList.add('hidden'); el.innerText = '?'; }
        else {
            el.classList.remove('hidden');
            el.innerText = `${c.suit}\n${c.label}`;
            el.classList.toggle('red', c.suit === 'â™¥' || c.suit === 'â™¦');
        }
    }

    function generateDeck() {
        let d = []; const s = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        for (let i = 0; i < 2; i++) s.forEach(suit => { for (let v = 1; v <= 13; v++) d.push({ val: v, suit, label: labels[v] || v }); });
        return d.sort(() => Math.random() - 0.5);
    }

    function approve(id) {
        let amt = prompt("è«‹è¨­å®šè©²ç©å®¶èµ·å§‹é‡‘é¡ (100å€æ•¸):", "1000");
        if (amt && parseInt(amt) % 100 === 0) {
            gameRef.child(`players/${id}`).update({ status: 'player', balance: parseInt(amt) });
        } else { alert("é‡‘é¡ç„¡æ•ˆï¼"); }
    }

    function kick(id) { if(confirm("ç¢ºå®šè¸¢å‡ºæ­¤ç©å®¶ï¼Ÿ")) gameRef.child(`players/${id}`).remove(); }
    
    function forceReset() {
        if(confirm("å¼·åˆ¶é‡ç½®å°‡æ¸…ç©ºç›®å‰ç‰Œå±€ï¼Œç¢ºå®šï¼Ÿ")) {
            gameRef.update({ gameState: 'waiting_deal', statusMsg: "æˆ¿ä¸»å·²é‡ç½®ç‰Œå±€ç‹€æ…‹", c1: null, c2: null, c3: null });
        }
    }

    function setAllIn() {
        document.getElementById('bet-amount').value = Math.min(localData.players[myId].balance, localData.pool);
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°„é¾é–€ Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
:root {
    --gold:#d4af37; --felt:#2d5a3c; --dark:#1a472a; --red:#e74c3c; --wood:#8B6914;
    --safe-bottom:env(safe-area-inset-bottom,0px); --safe-left:env(safe-area-inset-left,0px);
    --safe-right:env(safe-area-inset-right,0px);   --safe-top:env(safe-area-inset-top,0px);
}
*{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html,body{ width:100%; height:100%; background:#0d1f15; color:white; font-family:'Segoe UI',sans-serif; overflow:hidden; touch-action:manipulation; }

/* â•â•â•â• ç™»å…¥ç•«é¢ â•â•â•â• */
#login-screen{
    position:fixed; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    background:radial-gradient(ellipse at center,#1a472a 0%,#0a1f0f 100%);
    z-index:100; padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
}
#login-screen h1{ font-size:clamp(1.4rem,5vw,2.2rem); color:var(--gold); margin-bottom:20px; text-shadow:0 2px 12px rgba(212,175,55,0.5); }
.setup-box{ background:rgba(0,0,0,0.75); border:2px solid var(--gold); border-radius:20px; padding:24px 28px; width:min(400px,90vw); }
.input-row{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
.input-row label{ color:#aaa; font-size:0.85rem; }
.input-row input,.input-row select{ padding:9px 12px; border-radius:8px; border:none; background:#333; color:white; font-size:1rem; width:100%; }
.input-inline{ display:flex; gap:8px; }
.input-inline>div{ flex:1; display:flex; flex-direction:column; gap:4px; }
.input-inline label{ color:#aaa; font-size:0.78rem; }
.input-inline input,.input-inline select{ padding:7px; border-radius:8px; border:none; background:#333; color:white; font-size:0.9rem; width:100%; }
.btn-main{ width:100%; padding:12px; background:#2ecc71; color:white; border:none; border-radius:10px; font-size:1.05rem; font-weight:bold; cursor:pointer; margin-top:6px; }
.btn-main:active{ filter:brightness(0.9); }
.btn-leave{ background:#e74c3c !important; }
.chk-row{ display:flex; align-items:center; gap:8px; color:#ccc; font-size:0.88rem; margin:5px 0; }

/* â•â•â•â• ç­‰å¾…å¤§å»³ â•â•â•â• */
#lobby-screen{
    position:fixed; inset:0; display:none; flex-direction:column;
    background:radial-gradient(ellipse at center,#1a472a 0%,#0a1f0f 100%);
    z-index:90; padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
    overflow:hidden;
}
#lobby-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px 8px; border-bottom:1px solid rgba(212,175,55,0.3);
    flex-shrink:0;
}
#lobby-header h2{ color:var(--gold); font-size:clamp(1rem,4vw,1.4rem); }
.lobby-leave-btn{
    background:rgba(231,76,60,0.8); border:1px solid #e74c3c; color:white;
    border-radius:20px; padding:5px 14px; cursor:pointer; font-size:0.85rem; font-weight:bold;
}
.lobby-leave-btn:active{ filter:brightness(0.85); }

#lobby-body{ display:flex; flex:1; overflow:hidden; gap:0; }

/* ç©å®¶åˆ—è¡¨ */
#lobby-players-panel{
    width:min(180px,38%); border-right:1px solid rgba(212,175,55,0.2);
    display:flex; flex-direction:column; flex-shrink:0;
}
#lobby-players-panel h3{ color:#aaa; font-size:0.8rem; padding:8px 12px 4px; border-bottom:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
#lobby-player-list{ flex:1; overflow-y:auto; padding:6px 8px; }
.lobby-player-item{
    display:flex; align-items:center; gap:6px;
    padding:6px 8px; border-radius:8px; margin-bottom:4px;
    background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
    font-size:clamp(11px,2.2vw,14px);
}
.lobby-player-item.is-host{ border-color:rgba(212,175,55,0.5); background:rgba(212,175,55,0.08); }
.lobby-player-item.is-me{ border-color:rgba(52,152,219,0.5); }
.lobby-player-dot{ width:8px; height:8px; border-radius:50%; background:#2ecc71; flex-shrink:0; }
.lobby-player-name{ flex:1; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.lobby-player-crown{ font-size:0.9rem; flex-shrink:0; }

/* å¤§å»³å³å´:èŠå¤© + é–‹å§‹ */
#lobby-right{ flex:1; display:flex; flex-direction:column; overflow:hidden; }

/* èŠå¤©å€ */
#lobby-chat-area{ flex:1; display:flex; flex-direction:column; overflow:hidden; }
#lobby-chat-msgs{
    flex:1; overflow-y:auto; padding:8px 10px; display:flex; flex-direction:column; gap:4px;
    scroll-behavior:smooth;
}
.chat-msg{ font-size:clamp(11px,2.2vw,13px); line-height:1.4; word-break:break-word; }
.chat-msg .chat-name{ color:var(--gold); font-weight:bold; margin-right:4px; }
.chat-msg.system{ color:#888; font-style:italic; }
.chat-msg.is-me .chat-name{ color:#74b9ff; }

#lobby-chat-input-row{
    display:flex; gap:6px; padding:6px 10px 10px;
    border-top:1px solid rgba(255,255,255,0.07); flex-shrink:0;
}
#lobby-chat-input{
    flex:1; background:#1a2a1e; border:1px solid #3a5a3c; border-radius:20px;
    color:white; padding:7px 14px; font-size:0.9rem; outline:none;
}
#lobby-chat-input::placeholder{ color:#556; }
#lobby-chat-send{
    background:var(--gold); color:#1a1a1a; border:none; border-radius:50%;
    width:34px; height:34px; cursor:pointer; font-size:1rem; flex-shrink:0;
    display:flex; align-items:center; justify-content:center; font-weight:bold;
}
#lobby-chat-send:active{ filter:brightness(0.85); }

/* æˆ¿ä¸»é–‹å±€å€ */
#lobby-host-controls{
    padding:8px 10px; border-top:1px solid rgba(212,175,55,0.2);
    background:rgba(212,175,55,0.05); flex-shrink:0;
}
#lobby-host-controls h3{ color:var(--gold); font-size:0.85rem; margin-bottom:8px; }
.input-inline-sm{ display:flex; gap:6px; margin-bottom:6px; }
.input-inline-sm>div{ flex:1; display:flex; flex-direction:column; gap:2px; }
.input-inline-sm label{ color:#aaa; font-size:0.72rem; }
.input-inline-sm input,.input-inline-sm select{ padding:5px 7px; border-radius:6px; border:none; background:#2a2a2a; color:white; font-size:0.85rem; width:100%; }
#lobby-waiting-msg{ text-align:center; color:#888; font-size:0.9rem; padding:10px; }

/* â•â•â•â• éŠæˆ²ç•«é¢ â•â•â•â• */
#game-screen{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; }

#table-wrap{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:#0d1f15;
    padding:max(var(--safe-top),6px) max(var(--safe-right),8px) max(var(--safe-bottom),6px) max(var(--safe-left),8px);
}
#oval{
    position:relative;
    width:min(92vw,92vh*1.9); height:min(88vh,88vw*1.9);
    background:radial-gradient(ellipse at 50% 45%,#3a7a52 0%,#2d5a3c 55%,#1e4a30 100%);
    border-radius:50%; border:12px solid var(--wood);
    box-shadow:0 0 0 4px #5a3a08,0 0 0 8px #2a1a04,inset 0 0 80px rgba(0,0,0,0.4),0 20px 60px rgba(0,0,0,0.8);
}
#oval::before{
    content:''; position:absolute; inset:0; border-radius:50%;
    background:repeating-linear-gradient(45deg,transparent,transparent 22px,rgba(255,255,255,0.012) 22px,rgba(255,255,255,0.012) 23px);
    pointer-events:none;
}
@keyframes tableGlow{
    0%,100%{ box-shadow:0 0 0 4px #5a3a08,0 0 0 8px #2a1a04,inset 0 0 80px rgba(0,0,0,0.4),0 20px 60px rgba(0,0,0,0.8); }
    50%{ box-shadow:0 0 0 4px var(--gold),0 0 0 12px rgba(212,175,55,0.3),inset 0 0 80px rgba(0,0,0,0.4),0 20px 60px rgba(0,0,0,0.8); }
}
#oval.my-turn{ animation:tableGlow 1.5s ease-in-out infinite; }

#table-center{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-62%);
    display:flex; flex-direction:column; align-items:center; gap:4px;
    z-index:10; pointer-events:none;
}
/* â•â•â•â• ç±Œç¢¼æ•£è½é¡¯ç¤º â•â•â•â• */
#pool-display{
    display:flex; flex-direction:column; align-items:center; gap:3px;
    pointer-events:none;
}
/* æ•£è½å®¹å™¨ï¼šå›ºå®šå°ºå¯¸è®“ç±Œç¢¼åœ¨è£¡é¢è‡ªç”±é£› */
#pool-chip-stack{
    position:relative;
    width:130px; height:56px;   /* å¯¬çŸ®çš„çŸ©å½¢å€ï¼Œæ¨¡æ“¬æ¡Œé¢å½©æ± å€åŸŸ */
    flex-shrink:0;
}
/* æ¯æšç±Œç¢¼ â€” position:absoluteï¼Œåº§æ¨™ç”± JS äº‚æ•¸çµ¦ */
.chip-coin{
    position:absolute;
    filter:drop-shadow(0 3px 5px rgba(0,0,0,0.65));
    transform-origin:center center;
    /* é€²å ´ï¼šå¾ä¸Šæ–¹æ‰è½ + å½ˆè·³ */
    animation:chipScatter 0.38s cubic-bezier(0.22,1,0.36,1) both;
}
@keyframes chipScatter{
    0%  { opacity:0; transform:var(--chip-rot) translateY(-28px) scale(0.6); }
    55% { opacity:1; transform:var(--chip-rot) translateY(4px)  scale(1.06); }
    78% { transform:var(--chip-rot) translateY(-2px) scale(0.97); }
    100%{ opacity:1; transform:var(--chip-rot) translateY(0)    scale(1);    }
}
/* é‡‘é¡æ–‡å­— */
#pool-amount-text{
    font-size:clamp(11px,2.2vmin,15px); color:#f1c40f; font-weight:bold;
    text-shadow:0 1px 6px rgba(0,0,0,0.9), 0 0 12px rgba(241,196,15,0.4);
    letter-spacing:0.5px;
}
@keyframes poolPop{ 0%{transform:scale(1);} 40%{transform:scale(1.22);color:#fff;} 100%{transform:scale(1);} }
.pool-pop{ animation:poolPop 0.4s ease-out; }
#status-msg{ font-size:clamp(8px,1.7vmin,12px); color:#ccc; min-height:14px; }
#cards-and-deck{ display:flex; align-items:center; gap:clamp(4px,1.5vmin,12px); pointer-events:auto; }

.post-wrap{ display:flex; flex-direction:column; align-items:center; gap:2px; }
.post-label{ font-size:clamp(7px,1.3vmin,10px); color:#aaa; letter-spacing:1px; }
.post-label.gate{ color:var(--gold); font-weight:bold; }
.connector{ width:clamp(4px,1.2vmin,10px); height:3px; background:linear-gradient(90deg,rgba(212,175,55,0.6),rgba(212,175,55,0.2)); align-self:center; flex-shrink:0; }
.connector.r{ background:linear-gradient(90deg,rgba(212,175,55,0.2),rgba(212,175,55,0.6)); }

.card{
    width:clamp(44px,7.5vmin,68px); height:clamp(62px,10.5vmin,96px);
    background:white; border-radius:8px; color:black;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    font-size:clamp(15px,3.2vmin,26px); font-weight:bold;
    border:2px solid #333; box-shadow:2px 2px 8px rgba(0,0,0,0.5); white-space:pre-wrap; flex-shrink:0;
}
.card.hidden{ background:#1e3a5f; color:transparent; border-color:#3a6a9f; }
.card.red{ color:var(--red); }

.gate-frame{
    width:clamp(44px,7.5vmin,68px); height:clamp(62px,10.5vmin,96px);
    border:2px dashed rgba(212,175,55,0.4); border-radius:8px; background:rgba(212,175,55,0.04);
    display:flex; align-items:center; justify-content:center; position:relative; overflow:visible; flex-shrink:0;
}
.gate-frame .gate-inner-text{ color:rgba(212,175,55,0.3); font-size:clamp(7px,1.3vmin,10px); }
#c3-in-gate{ display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10; }

#deck-stack{ position:relative; width:clamp(44px,7.5vmin,68px); height:clamp(62px,10.5vmin,96px); cursor:default; flex-shrink:0; }
.dk{ position:absolute; width:100%; height:100%; border-radius:8px; border:1.5px solid #3a6a9f; }
.dk:nth-child(1){ transform:translate(5px,5px); background:#182e49; }
.dk:nth-child(2){ transform:translate(2px,2px); background:#1c3454; }
.dk:nth-child(3){ transform:translate(0,0); background:linear-gradient(135deg,#2a4f80,#1e3a64); box-shadow:3px 3px 10px rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; font-size:clamp(15px,3.2vmin,26px); color:rgba(255,255,255,0.25); }
#deck-stack.can-click{ cursor:pointer; animation:deckPulse 1s ease-in-out infinite; }
#deck-stack.can-click .dk:nth-child(3){ background:linear-gradient(135deg,#4a80cc,#2a5090); box-shadow:0 0 18px rgba(212,175,55,0.7),3px 3px 10px rgba(0,0,0,0.7); border-color:var(--gold); }
@keyframes deckPulse{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.09);} }
#deck-badge{ position:absolute; bottom:-8px; right:-8px; z-index:6; background:var(--gold); color:#1a472a; font-size:9px; font-weight:bold; border-radius:10px; padding:1px 5px; }
#deck-hint{ position:absolute; bottom:-20px; left:50%; transform:translateX(-50%); white-space:nowrap; font-size:clamp(7px,1.4vmin,10px); color:var(--gold); opacity:0; transition:opacity 0.3s; pointer-events:none; }
#deck-hint.show{ opacity:1; }

/* åº§ä½ */
.seat{ position:absolute; transform:translate(-50%,-50%); z-index:20; text-align:center; }
.seat-box{
    background:rgba(0,0,0,0.85); border:2px solid #555; border-radius:12px;
    padding:clamp(4px,0.8vmin,7px) clamp(8px,1.5vmin,14px);
    font-size:clamp(10px,2vmin,15px);
    min-width:clamp(58px,11vmin,96px); max-width:clamp(72px,13vmin,112px);
    line-height:1.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    transition:transform 0.18s,box-shadow 0.18s,max-width 0.18s; cursor:default;
}
.seat-box.expanded{ transform:scale(1.22); max-width:clamp(90px,18vmin,160px); box-shadow:0 4px 20px rgba(0,0,0,0.7); z-index:50; position:relative; }
.seat-box.active{ border-color:var(--gold); box-shadow:0 0 10px var(--gold); background:rgba(212,175,55,0.15); }
.seat-box.is-me{ border-color:#3498db; }
.seat-box.active.is-me{ border-color:var(--gold); }
.seat-box.kicked{ border-color:#e74c3c; background:rgba(231,76,60,0.12); opacity:0.6; }
.seat-name{ font-weight:bold; font-size:clamp(11px,2.2vmin,16px); }
.seat-bal{ color:#2ecc71; font-size:clamp(10px,1.9vmin,14px); font-weight:bold; }
.seat-tmr{ color:#ff7675; font-size:clamp(9px,1.6vmin,12px); }
.seat-kick{ position:absolute; top:-6px; right:-6px; background:#e74c3c; color:white; border-radius:50%; width:18px; height:18px; border:1px solid white; display:none; cursor:pointer; font-size:10px; line-height:16px; z-index:25; }
body.is-host .seat:not(.is-me) .seat-kick{ display:block; }

/* ä¸‹æ³¨é¢æ¿ */
#bet-panel{
    position:absolute; bottom:18%; left:50%; transform:translateX(-50%);
    width:90%; display:none; flex-direction:row; align-items:center; justify-content:center;
    gap:clamp(4px,1vmin,8px); padding:8px 12px 10px;
    background:rgba(26,70,42,0.88); border-radius:16px; border:1.5px solid rgba(212,175,55,0.5);
    box-shadow:0 2px 16px rgba(0,0,0,0.35),inset 0 1px 0 rgba(255,255,255,0.06);
    z-index:30; pointer-events:auto; flex-wrap:wrap;
}
.chip-row{ display:flex; gap:clamp(3px,0.8vmin,6px); align-items:center; }
.chip-btn{ background:none; border:none; padding:0; cursor:pointer; }
.chip-btn:active{ transform:scale(0.88); }
.chip-btn img{ width:clamp(30px,5vmin,44px); height:clamp(30px,5vmin,44px); border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.5); }
.bet-actions{ display:flex; align-items:center; gap:4px; flex-wrap:wrap; justify-content:center; }
#bet-amount{ background:rgba(0,0,0,0.55); color:var(--gold); border:2px solid var(--gold); font-size:0.95rem; width:60px; border-radius:7px; padding:2px 5px; text-align:center; }
.action-row{ display:flex; gap:clamp(3px,0.8vmin,6px); flex-wrap:wrap; justify-content:center; align-items:center; }
.action-row button{ padding:clamp(5px,1vmin,8px) clamp(8px,1.5vmin,12px); border:none; border-radius:7px; font-weight:bold; cursor:pointer; font-size:clamp(10px,1.8vmin,14px); white-space:nowrap; }
.btn-up{ background:#3498db; color:white; }
.btn-down{ background:#e67e22; color:white; }
.btn-allin{ background:var(--red); color:white; }
.btn-fold{ background:#7f8c8d; color:white; }
.btn-clear{ background:rgba(0,0,0,0.4); color:#ccc; border:1px solid #555; padding:clamp(5px,1vmin,8px) 7px!important; font-size:clamp(9px,1.5vmin,12px)!important; }
.bet-divider{ width:1px; height:32px; background:rgba(212,175,55,0.2); margin:0 1px; }

/* éŠæˆ²å…§èŠå¤© */
#game-chat-toggle{
    position:absolute; left:10px; bottom:50px; width:36px; height:36px;
    background:rgba(0,0,0,0.65); border:1px solid rgba(212,175,55,0.5);
    border-radius:50%; font-size:1.1rem; cursor:pointer; z-index:31;
    display:flex; align-items:center; justify-content:center;
    transition:background 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#game-chat-toggle.open{ background:rgba(212,175,55,0.25); border-color:var(--gold); }
#game-chat-toggle .chat-unread{
    position:absolute; top:-4px; right:-4px; background:var(--red);
    color:white; font-size:9px; font-weight:bold; border-radius:50%;
    width:16px; height:16px; display:none; align-items:center; justify-content:center;
}
#game-chat-toggle .chat-unread.show{ display:flex; }
#game-chat-panel{
    position:absolute; left:52px; bottom:8px;
    width:min(260px,60vw); height:180px;
    background:rgba(10,25,15,0.95); border:1px solid rgba(212,175,55,0.35);
    border-radius:14px; display:none; flex-direction:column; z-index:30; overflow:hidden;
    animation:chatSlideIn 0.2s ease-out;
}
@keyframes chatSlideIn{ from{opacity:0;transform:scaleY(0.5);transform-origin:bottom;} to{opacity:1;transform:scaleY(1);} }
#game-chat-msgs{ flex:1; overflow-y:auto; padding:6px 8px; display:flex; flex-direction:column; gap:3px; scroll-behavior:smooth; }
#game-chat-input-row{ display:flex; gap:4px; padding:4px 6px; border-top:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
#game-chat-input{ flex:1; background:#1a2a1e; border:1px solid #3a5a3c; border-radius:12px; color:white; padding:5px 10px; font-size:0.8rem; outline:none; }
#game-chat-send{ background:var(--gold); color:#1a1a1a; border:none; border-radius:50%; width:26px; height:26px; cursor:pointer; font-size:0.8rem; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:bold; }

/* â•â•â•â• Emoji é¢æ¿ (5 å€‹ä¸€åˆ—) â•â•â•â• */
#emoji-toggle{
    position:absolute; left:10px; bottom:12px; width:36px; height:36px;
    background:rgba(0,0,0,0.65); border:1px solid rgba(212,175,55,0.5);
    border-radius:50%; font-size:1.2rem; cursor:pointer; z-index:31;
    display:none; align-items:center; justify-content:center; transition:background 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#emoji-toggle.open{ background:rgba(212,175,55,0.25); border-color:var(--gold); }
#emoji-toggle:active{ transform:scale(0.9); }

/* â•â•â•â• Emoji é¢æ¿ï¼š5 å€‹ä¸€åˆ—çš„æ ¼ç‹€æ’åˆ— â•â•â•â• */
#emoji-bar{
    position:absolute; left:52px; bottom:56px; display:none; z-index:30;
    background:rgba(0,0,0,0.88); padding:8px; border-radius:16px; border:1px solid rgba(212,175,55,0.3);
    transform-origin:left bottom; animation:emojiSlideIn 0.2s ease-out;
}
#emoji-bar .emoji-grid{
    display:grid; grid-template-columns:repeat(5,1fr); gap:4px;
}
@keyframes emojiSlideIn{ from{opacity:0;transform:scaleX(0.3);} to{opacity:1;transform:scaleX(1);} }
.emoji-btn{
    font-size:1.2rem; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
    border-radius:8px; width:38px; height:38px; cursor:pointer; transition:transform 0.15s,background 0.15s;
    display:flex; align-items:center; justify-content:center;
}
.emoji-btn:hover{ background:rgba(212,175,55,0.2); border-color:rgba(212,175,55,0.5); }
.emoji-btn:active{ transform:scale(1.25); }
/* æ¨™ç±¤åˆ— */
#emoji-bar .emoji-label{
    color:rgba(212,175,55,0.6); font-size:0.68rem; padding:2px 2px 4px;
    letter-spacing:1px; text-transform:uppercase;
}

/* å·¥å…·åˆ— */
#tools{ position:absolute; bottom:10px; right:10px; display:none; flex-direction:column; gap:5px; z-index:30; align-items:flex-end; }
.tool-btn{ background:rgba(0,0,0,0.6); border:1px solid #555; color:var(--gold); border-radius:20px; padding:5px 10px; cursor:pointer; font-size:clamp(9px,1.6vmin,12px); white-space:nowrap; }
.tool-btn:active{ filter:brightness(1.3); }
.tool-btn.leave{ border-color:#e74c3c; color:#e74c3c; }

/* â•â•â•â• BGM æ§åˆ¶å™¨ â•â•â•â• */
#bgm-ctrl{
    position:fixed; top:max(var(--safe-top),10px); right:max(var(--safe-right),10px);
    z-index:8600; display:none; align-items:center; gap:6px;
    background:rgba(0,0,0,0.72); border:1px solid rgba(212,175,55,0.45);
    border-radius:30px; padding:5px 12px 5px 8px;
    backdrop-filter:blur(8px); box-shadow:0 2px 16px rgba(0,0,0,0.5);
    transition:opacity 0.3s;
}
#bgm-ctrl:hover{ opacity:1 !important; }
#bgm-toggle-btn{
    background:none; border:none; color:var(--gold); font-size:1.15rem;
    cursor:pointer; width:26px; height:26px; display:flex; align-items:center; justify-content:center;
    border-radius:50%; transition:transform 0.18s;
}
#bgm-toggle-btn:active{ transform:scale(0.85); }
#bgm-toggle-btn.playing{ animation:bgmSpin 4s linear infinite; }
@keyframes bgmSpin{ 0%{filter:drop-shadow(0 0 4px var(--gold));} 50%{filter:drop-shadow(0 0 10px var(--gold));} 100%{filter:drop-shadow(0 0 4px var(--gold));} }
#bgm-vol{
    -webkit-appearance:none; appearance:none;
    width:56px; height:4px; background:rgba(255,255,255,0.18); border-radius:4px; outline:none; cursor:pointer;
}
#bgm-vol::-webkit-slider-thumb{
    -webkit-appearance:none; width:14px; height:14px; border-radius:50%;
    background:var(--gold); cursor:pointer; box-shadow:0 0 6px rgba(212,175,55,0.6);
}
#bgm-vol::-moz-range-thumb{ width:14px; height:14px; border-radius:50%; background:var(--gold); border:none; cursor:pointer; }
#bgm-note{ font-size:0.65rem; color:rgba(212,175,55,0.7); letter-spacing:0.5px; white-space:nowrap; }

/* â•â•â•â• Pool å‹•ç•«ï¼ˆèˆŠç‰ˆ pool-val å·²ç§»é™¤ï¼Œä¿ç•™ keyframe çµ¦ pool-amount-textï¼‰ â•â•â•â• */

/* â•â•â•â• åº§ä½å€’è¨ˆæ™‚é€²åº¦æ¢ â•â•â•â• */
.seat-timer-bar-wrap{
    width:100%; height:3px; background:rgba(255,255,255,0.1); border-radius:2px;
    margin-top:3px; overflow:hidden;
}
.seat-timer-bar{
    height:100%; border-radius:2px;
    background:linear-gradient(90deg,#2ecc71,#f1c40f);
    transition:width 1s linear, background 1s;
}
.seat-timer-bar.warn{ background:linear-gradient(90deg,#e67e22,#e74c3c); }

/* â•â•â•â• ç‰Œé¢å‡ç´šï¼šç™¼å…‰é‚Šæ¡† â•â•â•â• */
.card.red{ color:var(--red); text-shadow:0 0 6px rgba(231,76,60,0.4); }
.card:not(.hidden):not(.red){ text-shadow:0 0 4px rgba(0,0,0,0.3); }
.card:not(.hidden){
    box-shadow:2px 2px 10px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.8);
}

/* â•â•â•â• ç±Œç¢¼æŒ‰éˆ• hover å…‰æšˆ â•â•â•â• */
.chip-btn img:hover{ box-shadow:0 0 14px rgba(212,175,55,0.7),0 2px 6px rgba(0,0,0,0.5); transform:scale(1.08); }
.chip-btn img{ transition:transform 0.15s, box-shadow 0.15s; }

/* â•â•â•â• è¼ªåˆ°ä½  Toast å‡ç´š â•â•â•â• */
#my-turn-toast{
    display:none; position:fixed; top:50%; right:12px;
    transform:translateY(-50%) translateX(60px);
    background:linear-gradient(135deg,var(--gold),#b8960c);
    color:#1a472a; font-weight:bold; font-size:0.95rem;
    padding:10px 22px; border-radius:30px; z-index:8500;
    box-shadow:0 0 24px rgba(212,175,55,0.6),0 4px 20px rgba(0,0,0,0.6);
    animation:toastSlideIn 0.4s ease-out forwards;
    border:2px solid rgba(255,255,255,0.3);
}
@keyframes toastSlideIn{ from{transform:translateY(-50%) translateX(60px);opacity:0;} to{transform:translateY(-50%) translateX(0);opacity:1;} }

/* â•â•â•â• çµæœæ©«å¹…å‡ç´š â•â•â•â• */
#result-banner{
    display:none; position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%) scale(0.5); z-index:8000;
    border-radius:24px; padding:18px 36px;
    border:3px solid var(--gold); text-align:center;
    transition:transform 0.38s cubic-bezier(0.175,0.885,0.32,1.275),opacity 0.38s;
    opacity:0; pointer-events:none; overflow:hidden;
}
#result-banner.type-win{
    background:linear-gradient(135deg,rgba(0,0,0,0.95),rgba(26,70,42,0.95));
    border-color:#2ecc71;
    box-shadow:0 0 40px rgba(46,204,113,0.5), 0 10px 40px rgba(0,0,0,0.8);
}
#result-banner.type-lose{
    background:linear-gradient(135deg,rgba(0,0,0,0.95),rgba(60,20,20,0.95));
    border-color:var(--red);
    box-shadow:0 0 30px rgba(231,76,60,0.35), 0 10px 40px rgba(0,0,0,0.8);
}
#result-banner.type-crash{
    background:linear-gradient(135deg,rgba(0,0,0,0.95),rgba(50,35,10,0.95));
    border-color:#f39c12;
    box-shadow:0 0 30px rgba(243,156,18,0.4), 0 10px 40px rgba(0,0,0,0.8);
}
#result-banner.show{ display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }
.rb-emoji{ font-size:2.6rem; line-height:1; }
.rb-text{ font-size:1.4rem; font-weight:bold; margin:5px 0 4px; }
.rb-amount{ font-size:1.9rem; font-weight:bold; letter-spacing:1px; }
.rb-amount.positive{ color:#2ecc71; text-shadow:0 0 16px rgba(46,204,113,0.7); }
.rb-amount.negative{ color:var(--red); text-shadow:0 0 12px rgba(231,76,60,0.5); }
#result-banner::before{
    content:''; position:absolute; inset:0; pointer-events:none; border-radius:22px;
    background:linear-gradient(135deg,rgba(255,255,255,0.06) 0%,transparent 60%);
}

/* Canvas */
#shot-canvas{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:7000; }

/* â•â•â•â• å…¶ä»– â•â•â•â• */

.confetti-piece{ position:fixed; width:10px; height:14px; top:-20px; border-radius:2px; pointer-events:none; animation:confettiFall linear forwards; z-index:7999; }
@keyframes confettiFall{ 0%{transform:translateY(0) rotate(0deg);opacity:1;} 100%{transform:translateY(110vh) rotate(720deg);opacity:0;} }

#all-in-confirm-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:9000; flex-direction:column; justify-content:center; align-items:center; }
#all-in-confirm-overlay.show{ display:flex; }
.allin-box{ background:linear-gradient(135deg,#1a1a1a,#2c0000); border:3px solid var(--red); border-radius:24px; padding:22px 30px; text-align:center; animation:alinPop 0.35s cubic-bezier(0.175,0.885,0.32,1.275); box-shadow:0 0 30px rgba(231,76,60,0.4), 0 10px 40px rgba(0,0,0,0.8); }
@keyframes alinPop{ from{transform:scale(0.5) rotate(-5deg);opacity:0;} to{transform:scale(1) rotate(0deg);opacity:1;} }
.allin-box h2{ font-size:1.5rem; color:var(--red); margin-bottom:6px; }
.allin-box p{ color:#ccc; margin-bottom:12px; }
.allin-amount{ font-size:2rem; color:var(--gold); font-weight:bold; margin-bottom:16px; }
.allin-yes{ background:var(--red)!important; color:white!important; font-size:1rem!important; padding:9px 20px!important; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin:0 6px; }
.allin-no{ background:#555!important; color:white!important; font-size:1rem!important; padding:9px 20px!important; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin:0 6px; }
#all-in-overlay{
    display:none; position:fixed; inset:0;
    background:radial-gradient(ellipse at center, rgba(120,0,0,0.97) 0%, rgba(0,0,0,0.99) 100%);
    z-index:9999; flex-direction:column; justify-content:center; align-items:center;
    overflow:hidden;
}
#all-in-overlay::before{
    content:''; position:absolute; inset:-20px;
    background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,50,0,0.05) 10px,rgba(255,50,0,0.05) 12px);
    animation:allInBg 0.5s linear infinite;
}
@keyframes allInBg{ 0%{transform:translate(0,0);} 100%{transform:translate(12px,12px);} }
#all-in-overlay h1{
    color:var(--gold); margin-top:16px; font-size:clamp(1.4rem,5vw,2.2rem);
    text-shadow:0 0 20px rgba(255,150,0,0.9), 0 0 40px rgba(255,100,0,0.6);
    animation:allInTitle 0.4s ease-out infinite alternate; z-index:1;
    letter-spacing:2px;
}
@keyframes allInTitle{ from{transform:scale(1);} to{transform:scale(1.06);} }
#gif-box{ position:relative; z-index:1; border-radius:16px; overflow:hidden;
    box-shadow:0 0 40px rgba(255,100,0,0.6), 0 0 80px rgba(255,0,0,0.3);
}

/* â•â•â•â• ç±Œç¢¼SVGæ¨£å¼ â•â•â•â• */
.chip-svg-wrap{ display:flex; flex-direction:column; align-items:center; gap:2px; cursor:pointer; }
.chip-svg-wrap:active{ transform:scale(0.88); }
.chip-svg{ filter:drop-shadow(0 3px 6px rgba(0,0,0,0.5)); transition:filter 0.15s,transform 0.15s; }
.chip-svg:hover{ filter:drop-shadow(0 0 10px rgba(212,175,55,0.7)) drop-shadow(0 3px 6px rgba(0,0,0,0.5)); transform:translateY(-2px); }

/* â•â•â•â• æ´—ç‰Œå‹•ç•«å‡ç´š â•â•â•â• */
#shuffle-overlay{
    display:none; position:fixed; inset:0; z-index:8800;
    background:rgba(0,0,0,0.88); flex-direction:column;
    align-items:center; justify-content:center; gap:16px;
    backdrop-filter:blur(6px);
}
#shuffle-overlay.show{ display:flex; }
#shuffle-stage{ position:relative; width:280px; height:160px; }
.shuf-card{
    position:absolute; width:58px; height:82px;
    border-radius:9px; border:2px solid rgba(100,160,255,0.6);
    background:linear-gradient(135deg,#2a4f80,#1e3a64);
    box-shadow:2px 2px 12px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.15);
    display:flex; align-items:center; justify-content:center;
    font-size:1.6rem; color:rgba(255,255,255,0.2);
    transition:transform 0.2s cubic-bezier(0.34,1.56,0.64,1), left 0.25s ease, top 0.25s ease;
    will-change:transform,left,top;
}
.shuf-card::before{
    content:''; position:absolute; inset:3px;
    border:1px solid rgba(100,160,255,0.3); border-radius:6px;
}
#shuffle-label{
    color:var(--gold); font-size:1.1rem; font-weight:bold;
    letter-spacing:3px; text-shadow:0 0 16px rgba(212,175,55,0.7);
    animation:shufflePulse 0.8s ease-in-out infinite alternate;
}
@keyframes shufflePulse{ from{opacity:0.7;} to{opacity:1; text-shadow:0 0 24px rgba(212,175,55,1);} }
#shuffle-progress{ width:200px; height:5px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden; }
#shuffle-progress-bar{ height:100%; width:0%; border-radius:4px; background:linear-gradient(90deg,var(--gold),#2ecc71); transition:width 0.4s ease; }
#shuffle-player-name{ color:#aaa; font-size:0.8rem; letter-spacing:1px; }

#refill-toast{ display:none; position:fixed; top:14px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.92); color:var(--gold); border:2px solid var(--gold); font-size:0.85rem; padding:7px 18px; border-radius:20px; z-index:8500; white-space:nowrap; }
#reconnect-toast{ display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.95); color:var(--gold); border:2px solid var(--gold); border-radius:16px; padding:16px 28px; text-align:center; z-index:9500; font-size:1rem; }

#emoji-broadcast-area{ position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:10000; }
.broadcast-item{ background:rgba(0,0,0,0.88); color:var(--gold); padding:7px 16px; border-radius:30px; margin-bottom:5px; font-weight:bold; border:2px solid var(--gold); animation:fadeUp 2.5s forwards; white-space:nowrap; }
@keyframes fadeUp{ 0%{opacity:0;transform:translateY(10px);} 15%{opacity:1;transform:translateY(0);} 80%{opacity:1;} 100%{opacity:0;transform:translateY(-15px);} }

@keyframes winPulse{ 0%{box-shadow:2px 2px 8px rgba(0,0,0,0.5);} 40%{transform:scale(1.15);box-shadow:0 0 28px #2ecc71,0 0 55px #2ecc71;} 100%{box-shadow:2px 2px 8px rgba(0,0,0,0.5);} }
@keyframes losePulse{ 0%{transform:scale(1);} 20%{transform:translateX(-7px) scale(1.05);box-shadow:0 0 22px var(--red);} 40%{transform:translateX(7px) scale(1.05);box-shadow:0 0 22px var(--red);} 60%{transform:translateX(-4px);} 80%{transform:translateX(4px);} 100%{transform:scale(1);} }
@keyframes crashPulse{ 0%{transform:scale(1);} 30%{transform:scale(1.18) rotate(-5deg);box-shadow:0 0 38px #f39c12;} 60%{transform:scale(1.1) rotate(5deg);} 100%{transform:scale(1);} }
.anim-win{ animation:winPulse 0.7s ease-out; }
.anim-lose{ animation:losePulse 0.7s ease-out; }
.anim-crash{ animation:crashPulse 0.7s ease-out; }
#main-board,#player-area-wrapper,.player-toggle-btn{ display:none!important; }

/* â•â•â•â• è§€çœ¾ â•â•â•â• */
.lobby-player-item.is-spectator{ border-color:rgba(52,152,219,0.35); background:rgba(52,152,219,0.06); }
.spectator-tag{ font-size:0.68rem; color:#74b9ff; background:rgba(52,152,219,0.22); border-radius:4px; padding:1px 5px; margin-left:3px; }
#spectator-notice{ display:none; padding:7px 12px; background:rgba(52,152,219,0.1); border-top:1px solid rgba(52,152,219,0.3); font-size:0.82rem; color:#74b9ff; flex-shrink:0; }
#spectator-notice button{ background:#3498db; color:white; border:none; border-radius:7px; padding:4px 12px; font-size:0.8rem; cursor:pointer; margin-left:8px; }
#spectator-watermark{ display:none; position:fixed; top:max(var(--safe-top),8px); left:50%; transform:translateX(-50%); background:rgba(52,152,219,0.2); border:1px solid rgba(52,152,219,0.5); color:#74b9ff; font-size:0.75rem; padding:3px 14px; border-radius:20px; z-index:8000; pointer-events:none; letter-spacing:1px; }
/* æˆ¿ä¸»è§€çœ¾ç®¡ç† */
#spectator-mgmt{ display:none; background:rgba(52,152,219,0.07); border:1px solid rgba(52,152,219,0.3); border-radius:8px; padding:7px 10px; margin-bottom:6px; }
#spectator-mgmt .smgmt-title{ color:#74b9ff; font-size:0.78rem; margin-bottom:5px; }
#spectator-mgmt-list .smgmt-row{ display:flex; align-items:center; gap:5px; margin-bottom:4px; font-size:0.82rem; }
#spectator-mgmt-list .smgmt-name{ flex:1; color:#ccc; }
#spectator-mgmt-list button{ font-size:0.75rem; padding:2px 8px; border:none; border-radius:5px; cursor:pointer; }
.btn-promote{ background:#2ecc71; color:white; }
.btn-kick-spec{ background:#e74c3c; color:white; }
/* çµç®—è¦†è“‹å±¤ */
#gameover-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.93); z-index:9800; flex-direction:column; align-items:center; justify-content:center; }
#gameover-overlay.show{ display:flex; }
#gameover-box{ background:linear-gradient(135deg,#111,#0d2a0d); border:3px solid var(--gold); border-radius:24px; padding:22px 30px; text-align:center; max-width:min(400px,92vw); width:100%; box-shadow:0 0 40px rgba(212,175,55,0.3); }
#gameover-box h2{ color:var(--gold); font-size:1.35rem; margin-bottom:12px; }
.rank-row{ display:flex; justify-content:space-between; align-items:center; padding:6px 10px; border-radius:8px; margin-bottom:4px; font-size:0.95rem; }
.rank-row.rank-1st{ background:rgba(212,175,55,0.18); }
.rank-row .rank-name{ font-weight:bold; }
.rank-row .rank-bal{ font-weight:bold; }
.rank-row .rank-bal.pos{ color:#2ecc71; }
.rank-row .rank-bal.neg{ color:#e74c3c; }
#gameover-box p{ color:#aaa; font-size:0.85rem; margin-top:12px; }
    </style>
</head>
<body>
<div id="spectator-watermark">ğŸ‘ è§€çœ¾æ¨¡å¼</div>

<!-- çµç®—è¦†è“‹ -->
<div id="gameover-overlay">
  <div id="gameover-box">
    <h2>ğŸ† æœ¬å±€çµç®—</h2>
    <div id="gameover-rankings"></div>
    <p>å›åˆ°å¤§å»³ï¼Œç­‰å¾…æˆ¿ä¸»é–‹æ–°å±€...</p>
  </div>
</div>

<canvas id="shot-canvas"></canvas>
<div id="emoji-broadcast-area"></div>
<div id="reconnect-toast"></div>

<div id="result-banner">
    <div class="rb-emoji" id="rb-emoji">ğŸ‰</div>
    <div class="rb-text" id="rb-text">å°„é€²!</div>
    <div class="rb-amount" id="rb-amount">+$0</div>
</div>
<div id="all-in-confirm-overlay">
    <div class="allin-box">
        <h2>ğŸ”¥ ALL IN ç¢ºèª</h2>
        <p>ä½ ç¢ºå®šè¦æŠ¼ä¸Šå…¨éƒ¨å½©é‡‘?</p>
        <div class="allin-amount" id="allin-pool-preview">$0</div>
        <div><button class="allin-yes" onclick="confirmAllIn()">ğŸ’¥ æˆ‘è¦å…¨éƒ¨!</button><button class="allin-no" onclick="cancelAllIn()">å–æ¶ˆ</button></div>
    </div>
</div>
<div id="all-in-overlay"><div id="gif-box"></div><h1>æˆ‘è¦å…¨éƒ¨!!!</h1></div>
<!-- â•â• æ´—ç‰Œå‹•ç•« â•â• -->
<div id="shuffle-overlay">
    <div id="shuffle-stage"></div>
    <div id="shuffle-label">ğŸƒ æ´—ç‰Œä¸­...</div>
    <div id="shuffle-player-name"></div>
    <div id="shuffle-progress"><div id="shuffle-progress-bar"></div></div>
</div>
<div id="refill-toast"></div>
<div id="my-turn-toast">ğŸ¯ è¼ªåˆ°ä½ äº†!</div>

<audio id="sfx-win"   src="sfx/win.mp3"   preload="auto"></audio>
<audio id="sfx-lose"  src="sfx/lose.mp3"  preload="auto"></audio>
<audio id="sfx-crash" src="sfx/crash.mp3" preload="auto"></audio>
<audio id="sfx-fold"  src="sfx/fold.mp3"  preload="auto"></audio>
<audio id="sfx-allin" src="sfx/allin.mp3" preload="auto"></audio>
<audio id="sfx-deal"  src="sfx/deal.mp3"  preload="auto"></audio>
<audio id="bgm"       src="sfx/bgm.mp3"   preload="auto" loop></audio>
<!-- ALL IN GIFï¼ˆå–ä»£ mp4ï¼Œä¸éœ€è¦æ‰‹å‹¢è§£é–ï¼Œç›´æ¥æ§åˆ¶ srcï¼‰ -->
<img id="allin-gif" src="" alt="" style="display:none;max-width:88vw;max-height:55vh;border-radius:14px;position:relative;z-index:1;box-shadow:0 0 40px rgba(255,100,0,0.7),0 0 80px rgba(255,0,0,0.3);" />

<!-- â•â• ç™»å…¥ç•«é¢ â•â• -->
<div id="login-screen">
    <h1>ğŸŸï¸ åŸ”å¢˜é‡‘é¾é–€ Pro</h1>
    <div class="setup-box">
        <div class="input-row">
            <label>æš±ç¨±</label>
            <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
        </div>
        <button class="btn-main" onclick="joinRoom()">ğŸƒ é€²å…¥å¤§å»³</button>
    </div>
</div>

<!-- â•â• ç­‰å¾…å¤§å»³ â•â• -->
<div id="lobby-screen">
    <div id="lobby-header">
        <h2>ğŸŸï¸ ç­‰å¾…å¤§å»³</h2>
        <button class="lobby-leave-btn" onclick="leaveRoom()">ğŸšª é›¢é–‹</button>
    </div>
    <div id="lobby-body">
        <!-- ç©å®¶/è§€çœ¾åˆ—è¡¨ -->
        <div id="lobby-players-panel">
            <h3 style="color:#aaa;font-size:0.8rem;padding:8px 12px 4px;border-bottom:1px solid rgba(255,255,255,0.07);flex-shrink:0;">ğŸ® ç©å®¶ (<span id="lobby-player-count">0</span>)</h3>
            <div id="lobby-player-list" style="overflow-y:auto;padding:6px 8px;"></div>
            <div style="border-top:1px solid rgba(52,152,219,0.2);flex-shrink:0;">
                <h3 style="color:#74b9ff;font-size:0.78rem;padding:5px 12px 3px;border-bottom:1px solid rgba(255,255,255,0.05);">ğŸ‘ è§€çœ¾ (<span id="lobby-spectator-count">0</span>)</h3>
                <div id="lobby-spectator-list" style="overflow-y:auto;padding:4px 8px;max-height:80px;"></div>
            </div>
        </div>
        <!-- å³å´èŠå¤©+é–‹å±€ -->
        <div id="lobby-right">
            <div id="lobby-chat-area">
                <div id="lobby-chat-msgs"></div>
                <div id="lobby-chat-input-row">
                    <input type="text" id="lobby-chat-input" placeholder="èªªé»ä»€éº¼..." maxlength="60" onkeydown="if(event.key==='Enter')sendLobbyChat()">
                    <button id="lobby-chat-send" onclick="sendLobbyChat()">â¤</button>
                </div>
            </div>
            <!-- è§€çœ¾é€šçŸ¥æ¬„ï¼ˆè§€çœ¾æ‰çœ‹åˆ°ï¼‰ -->
            <div id="spectator-notice">
                ğŸ‘ ä½ æ˜¯è§€çœ¾ï¼Œåªèƒ½çœ‹éŠæˆ²åŠèŠå¤©ã€‚<button onclick="requestJoin()">ğŸ“¢ ç”³è«‹åŠ å…¥</button>
            </div>
            <!-- æˆ¿ä¸»è¨­å®š(åªæœ‰æˆ¿ä¸»çœ‹åˆ°) -->
            <div id="lobby-host-controls" style="display:none;">
                <h3>ğŸ‘‘ æˆ¿ä¸»è¨­å®š</h3>
                <div class="input-inline-sm">
                    <div><label>åˆå§‹æœ¬é‡‘</label><input type="number" id="start-balance" value="1000"></div>
                    <div><label>åº•æ³¨</label><input type="number" id="entry-fee" value="100"></div>
                    <div><label>æ£„ç‰Œç½°é‡‘</label><input type="number" id="fold-penalty" value="20"></div>
                </div>
                <div class="input-inline-sm">
                    <div>
                        <label>ç‰Œçµ„æ•¸</label>
                        <select id="deck-count">
                            <option value="1">1å‰¯</option>
                            <option value="2" selected>2å‰¯</option>
                            <option value="3">3å‰¯</option>
                            <option value="4">4å‰¯</option>
                        </select>
                    </div>
                    <div style="justify-content:flex-end;flex-direction:row;align-items:center;gap:6px;padding-top:14px;">
                        <input type="checkbox" id="auto-refill" checked>
                        <label style="color:#aaa;font-size:0.78rem;">æ± ä½è£œåº•</label>
                    </div>
                </div>
                <!-- äººå“¡ç®¡ç†ï¼ˆæˆ¿ä¸»çœ‹åˆ°ï¼šç©å®¶â†”è§€çœ¾é›™å‘åˆ‡æ›ï¼‰ -->
                <div id="host-member-mgmt" style="background:rgba(255,255,255,0.04);border:1px solid rgba(212,175,55,0.25);border-radius:8px;padding:7px 10px;margin-bottom:6px;">
                    <div style="color:var(--gold);font-size:0.78rem;margin-bottom:6px;font-weight:bold;">ğŸ‘‘ äººå“¡ç®¡ç†</div>
                    <div id="host-member-list"></div>
                </div>
                <button class="btn-main" onclick="hostStartGame()">âœ… é–‹å§‹éŠæˆ²</button>
            </div>
            <div id="lobby-waiting-msg">â³ ç­‰å¾…æˆ¿ä¸»é–‹å§‹éŠæˆ²...</div>
        </div>
    </div>
</div>

<!-- â•â• BGM æ§åˆ¶å™¨ â•â• -->
<div id="bgm-ctrl">
    <button id="bgm-toggle-btn" onclick="toggleBgm()" title="èƒŒæ™¯éŸ³æ¨‚">ğŸµ</button>
    <input type="range" id="bgm-vol" min="0" max="1" step="0.05" value="0.35" oninput="setBgmVol(this.value)" title="éŸ³é‡">
    <span id="bgm-note">BGM</span>
</div>

<!-- â•â• éŠæˆ²ç•«é¢ â•â• -->
<div id="game-screen">
    <div id="table-wrap">
        <div id="oval">
            <div id="table-center">
                <div id="pool-display">
                    <div id="pool-chip-stack"></div>
                    <div id="pool-amount-text">ğŸ’° $0</div>
                </div>
                <div id="status-msg"></div>
                <div id="cards-and-deck">
                    <div class="post-wrap"><div class="post-label">å·¦æŸ±</div><div id="c1" class="card hidden">?</div></div>
                    <div class="connector"></div>
                    <div class="post-wrap">
                        <div class="post-label gate">ğŸ‰ é¾é–€</div>
                        <div class="gate-frame" id="gate-frame">
                            <span class="gate-inner-text" id="gate-inner">å¾…å°„é–€</span>
                            <div id="c3-in-gate"></div>
                        </div>
                    </div>
                    <div class="connector r"></div>
                    <div class="post-wrap"><div class="post-label">å³æŸ±</div><div id="c2" class="card hidden">?</div></div>
                    <div style="width:2px;height:50px;background:rgba(255,255,255,0.1);margin:0 3px;align-self:center;flex-shrink:0;"></div>
                    <div class="post-wrap" style="position:relative;">
                        <div class="post-label" style="color:#aaa;">ç‰Œåº«</div>
                        <div id="deck-stack" onclick="onDeckClick()">
                            <div class="dk"></div><div class="dk"></div>
                            <div class="dk">ğŸ‚ <span id="deck-badge">0</span></div>
                        </div>
                        <div id="deck-hint">é»æ“ŠæŠ½ç‰Œ</div>
                    </div>
                </div>
                <div style="font-size:clamp(7px,1.3vmin,10px);color:#888;margin-top:1px;">å‰© <span id="cards-left">0</span> å¼µ</div>
            </div>

            <div id="seats-layer"></div>

            <!-- ä¸‹æ³¨é¢æ¿ -->
            <div id="bet-panel">
                <div class="chip-row">
                    <!-- 10å…ƒï¼šè—è‰²é‚Š -->
                    <div class="chip-svg-wrap" onclick="unlockAudio();addBet(10)">
                      <svg class="chip-svg" width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="22" fill="#1a5276" stroke="#3498db" stroke-width="3"/>
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#85c1e9" stroke-width="1.5" stroke-dasharray="5 3"/>
                        <circle cx="24" cy="24" r="14" fill="#1f618d"/>
                        <text x="24" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold" font-family="Arial">10</text>
                        <!-- é‚Šç·£åˆ»ç—• -->
                        <line x1="24" y1="2" x2="24" y2="7" stroke="#3498db" stroke-width="2.5"/>
                        <line x1="24" y1="41" x2="24" y2="46" stroke="#3498db" stroke-width="2.5"/>
                        <line x1="2" y1="24" x2="7" y2="24" stroke="#3498db" stroke-width="2.5"/>
                        <line x1="41" y1="24" x2="46" y2="24" stroke="#3498db" stroke-width="2.5"/>
                      </svg>
                    </div>
                    <!-- 50å…ƒï¼šæ·¡è—è‰²é‚Š -->
                    <div class="chip-svg-wrap" onclick="unlockAudio();addBet(50)">
                      <svg class="chip-svg" width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="22" fill="#154360" stroke="#76d7ea" stroke-width="3"/>
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#aed6f1" stroke-width="1.5" stroke-dasharray="5 3"/>
                        <circle cx="24" cy="24" r="14" fill="#1a6080"/>
                        <text x="24" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold" font-family="Arial">50</text>
                        <line x1="24" y1="2" x2="24" y2="7" stroke="#76d7ea" stroke-width="2.5"/>
                        <line x1="24" y1="41" x2="24" y2="46" stroke="#76d7ea" stroke-width="2.5"/>
                        <line x1="2" y1="24" x2="7" y2="24" stroke="#76d7ea" stroke-width="2.5"/>
                        <line x1="41" y1="24" x2="46" y2="24" stroke="#76d7ea" stroke-width="2.5"/>
                      </svg>
                    </div>
                    <!-- 100å…ƒï¼šç´…é‚Š -->
                    <div class="chip-svg-wrap" onclick="unlockAudio();addBet(100)">
                      <svg class="chip-svg" width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="22" fill="#641e16" stroke="#e74c3c" stroke-width="3"/>
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#f1948a" stroke-width="1.5" stroke-dasharray="5 3"/>
                        <circle cx="24" cy="24" r="14" fill="#922b21"/>
                        <text x="24" y="29" text-anchor="middle" fill="white" font-size="10" font-weight="bold" font-family="Arial">100</text>
                        <line x1="24" y1="2" x2="24" y2="7" stroke="#e74c3c" stroke-width="2.5"/>
                        <line x1="24" y1="41" x2="24" y2="46" stroke="#e74c3c" stroke-width="2.5"/>
                        <line x1="2" y1="24" x2="7" y2="24" stroke="#e74c3c" stroke-width="2.5"/>
                        <line x1="41" y1="24" x2="46" y2="24" stroke="#e74c3c" stroke-width="2.5"/>
                      </svg>
                    </div>
                    <!-- 500å…ƒï¼šæ·¡ç¶ é‚Š -->
                    <div class="chip-svg-wrap" onclick="unlockAudio();addBet(500)">
                      <svg class="chip-svg" width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="22" fill="#145a32" stroke="#58d68d" stroke-width="3"/>
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#abebc6" stroke-width="1.5" stroke-dasharray="5 3"/>
                        <circle cx="24" cy="24" r="14" fill="#1e8449"/>
                        <text x="24" y="29" text-anchor="middle" fill="white" font-size="10" font-weight="bold" font-family="Arial">500</text>
                        <line x1="24" y1="2" x2="24" y2="7" stroke="#58d68d" stroke-width="2.5"/>
                        <line x1="24" y1="41" x2="24" y2="46" stroke="#58d68d" stroke-width="2.5"/>
                        <line x1="2" y1="24" x2="7" y2="24" stroke="#58d68d" stroke-width="2.5"/>
                        <line x1="41" y1="24" x2="46" y2="24" stroke="#58d68d" stroke-width="2.5"/>
                      </svg>
                    </div>
                    <!-- 1000å…ƒï¼šé‡‘è‰²é‚Š -->
                    <div class="chip-svg-wrap" onclick="unlockAudio();addBet(1000)">
                      <svg class="chip-svg" width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="22" fill="#7d6608" stroke="#d4ac0d" stroke-width="3"/>
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#f9e79f" stroke-width="1.5" stroke-dasharray="5 3"/>
                        <circle cx="24" cy="24" r="14" fill="#9a7d0a"/>
                        <text x="24" y="29" text-anchor="middle" fill="white" font-size="10" font-weight="bold" font-family="Arial">1K</text>
                        <line x1="24" y1="2" x2="24" y2="7" stroke="#d4ac0d" stroke-width="2.5"/>
                        <line x1="24" y1="41" x2="24" y2="46" stroke="#d4ac0d" stroke-width="2.5"/>
                        <line x1="2" y1="24" x2="7" y2="24" stroke="#d4ac0d" stroke-width="2.5"/>
                        <line x1="41" y1="24" x2="46" y2="24" stroke="#d4ac0d" stroke-width="2.5"/>
                      </svg>
                    </div>
                </div>
                <div class="bet-divider"></div>
                <div class="bet-actions">
                    <input type="number" id="bet-amount" value="0" readonly>
                    <button class="btn-clear" onclick="document.getElementById('bet-amount').value=0">âœ•</button>
                </div>
                <div class="bet-divider"></div>
                <div class="action-row">
                    <button class="btn-up" id="btn-up" onclick="handleAction('up')" style="display:none;">â¬† çŒœå¤§</button>
                    <button class="btn-down" id="btn-down" onclick="handleAction('down')" style="display:none;">â¬‡ çŒœå°</button>
                    <button class="btn-allin" onclick="setAllIn()">ğŸ’¥ ALL IN</button>
                    <button class="btn-fold" onclick="handleAction('fold')">ğŸ³ æ£„ç‰Œ($<span id="fold-cost-ui">0</span>)</button>
                </div>
            </div>

            <!-- éŠæˆ²å…§èŠå¤© -->
            <div id="game-chat-toggle" onclick="toggleGameChat()">
                ğŸ’¬<span class="chat-unread" id="chat-unread"></span>
            </div>
            <div id="game-chat-panel">
                <div id="game-chat-msgs"></div>
                <div id="game-chat-input-row">
                    <input type="text" id="game-chat-input" placeholder="èªªé»ä»€éº¼..." maxlength="60" onkeydown="if(event.key==='Enter')sendGameChat()">
                    <button id="game-chat-send" onclick="sendGameChat()">â¤</button>
                </div>
            </div>

            <!-- â•â• Emoji é¢æ¿ (5å€‹ä¸€åˆ— Ã— 3è¡Œ = 15å€‹) â•â• -->
            <button id="emoji-toggle" onclick="toggleEmojiBar()" title="è¡¨æƒ…ç¬¦è™Ÿ">ğŸ˜„</button>
            <div id="emoji-bar">
                <div class="emoji-label">æŒ‘é‡</div>
                <div class="emoji-grid">
                    <button class="emoji-btn" title="å“ˆå“ˆä½ è¼¸äº†" onclick="sendEmoji('ğŸ˜‚')">ğŸ˜‚</button>
                    <button class="emoji-btn" title="èœ"        onclick="sendEmoji('ğŸ”')">ğŸ”</button>
                    <button class="emoji-btn" title="è·ªä¸‹"      onclick="sendEmoji('ğŸ§')">ğŸ§</button>
                    <button class="emoji-btn" title="çœ¼ç¥æ­»"    onclick="sendEmoji('ğŸ’€')">ğŸ’€</button>
                    <button class="emoji-btn" title="ä½ åœ¨çœ‹æˆ‘?" onclick="sendEmoji('ğŸ‘€')">ğŸ‘€</button>
                </div>
                <div class="emoji-label" style="margin-top:4px;">æç¬‘</div>
                <div class="emoji-grid">
                    <button class="emoji-btn" title="æˆ‘è¦å…¨éƒ¨"  onclick="sendEmoji('ğŸ’¸')">ğŸ’¸</button>
                    <button class="emoji-btn" title="å™´äº†"      onclick="sendEmoji('ğŸ’©')">ğŸ’©</button>
                    <button class="emoji-btn" title="å¤§ç¬‘"      onclick="sendEmoji('ğŸ¤£')">ğŸ¤£</button>
                    <button class="emoji-btn" title="è£æ²’äº‹"    onclick="sendEmoji('ğŸ™ƒ')">ğŸ™ƒ</button>
                    <button class="emoji-btn" title="æˆ‘è£‚äº†"    onclick="sendEmoji('ğŸ« ')">ğŸ« </button>
                </div>
                <div class="emoji-label" style="margin-top:4px;">ç‰Œæ¡Œ</div>
                <div class="emoji-grid">
                    <button class="emoji-btn" title="ç«"        onclick="sendEmoji('ğŸ”¥')">ğŸ”¥</button>
                    <button class="emoji-btn" title="æ‹¿å¥½"      onclick="sendEmoji('ğŸƒ')">ğŸƒ</button>
                    <button class="emoji-btn" title="ç‹"        onclick="sendEmoji('ğŸ‘‘')">ğŸ‘‘</button>
                    <button class="emoji-btn" title="å“­äº†"      onclick="sendEmoji('ğŸ˜­')">ğŸ˜­</button>
                    <button class="emoji-btn" title="æ°æ°"      onclick="sendEmoji('ğŸ‘‹')">ğŸ‘‹</button>
                </div>
            </div>

            <!-- å·¥å…·åˆ— -->
            <div id="tools">
                <button class="tool-btn leave" onclick="leaveRoom()">ğŸšª é›¢é–‹</button>
                <button class="tool-btn" id="host-reset-btn" onclick="hostResetToLobby()" style="display:none;">ğŸš¨ é‡è£½</button>
                <button class="tool-btn" id="host-spec-btn" onclick="toggleSpecMgmtGame()" style="display:none;">ğŸ‘ è§€çœ¾ç®¡ç†</button>
            </div>
            <!-- éŠæˆ²ä¸­è§€çœ¾ç®¡ç†æµ®å±¤ï¼ˆæˆ¿ä¸»å°ˆç”¨ï¼‰ -->
            <div id="spec-mgmt-game" style="display:none;position:absolute;right:10px;bottom:80px;background:rgba(10,25,15,0.97);border:1px solid rgba(52,152,219,0.5);border-radius:12px;padding:10px 12px;z-index:35;min-width:180px;">
                <div style="color:#74b9ff;font-size:0.82rem;margin-bottom:7px;font-weight:bold;">ğŸ‘ è§€çœ¾ç®¡ç†</div>
                <div id="spec-mgmt-game-list"></div>
            </div>
        </div>
    </div>
</div>

<div style="display:none;">
    <div id="main-board"><div id="bet-controls"></div><div id="player-deal-btn"></div><div id="host-controls"></div></div>
    <div id="player-area-wrapper"><div id="player-area"></div></div>
</div>

<script>
/* â•â•â•â• Firebase â•â•â•â• */
const firebaseConfig = {
    apiKey:"AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
    authDomain:"dargongatepoker.firebaseapp.com",
    databaseURL:"https://dargongatepoker-default-rtdb.firebaseio.com",
    projectId:"dargongatepoker",
    storageBucket:"dargongatepoker.firebasestorage.app",
    messagingSenderId:"204663560828",
    appId:"1:204663560828:web:9ede7b6190babde73f07f9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const gameRef  = db.ref('dragonGate/room1');
const chatRef  = db.ref('dragonGate/chat');

/* â•â•â•â• å…¨åŸŸç‹€æ…‹ â•â•â•â• */
let myId='', myName='', myRole='player', localData={};  // myRole: 'player' | 'spectator'
let lastEffectId='INITIAL', lastShotId='INITIAL', lastEmojiTime=0;
let serverOffset=0, wasMyturn=false, emojiBarOpen=false;
let gameChatOpen=false, chatUnreadCount=0;
let lastChatTime=0;
const labels={1:'A',11:'J',12:'Q',13:'K'};
const RECONNECT_WINDOW=60*1000, KICK_GRACE=10*1000;

db.ref('.info/serverTimeOffset').on('value', s => serverOffset=s.val());
function getServerNow(){ return Date.now()+serverOffset; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   éŸ³æ•ˆç³»çµ± â€” å¾¹åº•é‡å¯«ï¼Œè§£æ±º iOS/Android ALL IN ç„¡è²å•é¡Œ
   
   æ ¸å¿ƒç­–ç•¥ï¼š
   â€¢ ä¸€èˆ¬ SFX (win/lose/crash/fold/deal) â†’ HTML <audio> ç›´æ¥æ’­ï¼Œ
     ç¬¬ä¸€æ¬¡æ‰‹å‹¢æ™‚æ‰¹é‡è§£é–ï¼Œä¹‹å¾Œéš¨æ™‚ play()ã€‚
   â€¢ ALL IN SFX â†’ WebAudio API fetch â†’ decodeAudioData â†’ playï¼Œ
     å®Œå…¨ç¹é HTMLMediaElement çš„æ‰‹å‹¢é™åˆ¶ï¼Œ
     åªéœ€è¦ AudioContext åœ¨æ‰‹å‹¢å…§ resume() ä¸€æ¬¡å³å¯ã€‚
   â€¢ BGM â†’ HTML <audio> + GainNodeï¼ˆæ²¿ç”¨èˆŠæ–¹æ¡ˆï¼Œç©©å®šï¼‰ã€‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let _audioCtx     = null;
let _bgmGain      = null;
let _bgmPlaying   = false;
let _bgmVol       = 0.35;
let _audioUnlocked= false;
let _allinBuf     = null;   // WebAudio è§£ç¢¼å¾Œçš„ allin.mp3 buffer
let _allinSrc     = null;   // æ­£åœ¨æ’­çš„ allin AudioBufferSourceNode

function getAudioCtx(){
    if(!_audioCtx){
        try{ _audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    }
    return _audioCtx;
}

/* â”€â”€ é è¼‰ allin.mp3 â†’ WebAudio bufferï¼ˆé é¢è¼‰å…¥å¾Œéœé»˜é€²è¡Œï¼‰ â”€â”€ */
function preloadAllinBuffer(){
    const ctx = getAudioCtx();
    if(!ctx || _allinBuf) return;
    fetch('sfx/allin.mp3')
        .then(r=>r.arrayBuffer())
        .then(ab=>ctx.decodeAudioData(ab))
        .then(buf=>{ _allinBuf = buf; })
        .catch(()=>{});   // å¤±æ•—å°± fallback åˆ° HTML audio
}

/* â”€â”€ æ’­æ”¾ allinï¼ˆWebAudio bufferï¼Œç„¡éœ€æ‰‹å‹¢ï¼Œæœ€å¯é ï¼‰ â”€â”€ */
function playAllinSound(){
    const ctx = getAudioCtx();
    if(!ctx) return _fallbackAllin();
    // ç¢ºä¿ ctx ä¸æ˜¯ suspended
    if(ctx.state === 'suspended'){
        ctx.resume().then(()=> _doPlayAllin(ctx)).catch(()=> _fallbackAllin());
    } else {
        _doPlayAllin(ctx);
    }
}
function _doPlayAllin(ctx){
    if(!_allinBuf){ _fallbackAllin(); return; }
    try{
        if(_allinSrc){ try{ _allinSrc.stop(); }catch(e){} }
        _allinSrc = ctx.createBufferSource();
        _allinSrc.buffer = _allinBuf;
        _allinSrc.connect(ctx.destination);
        _allinSrc.start(0);
    }catch(e){ _fallbackAllin(); }
}
function _fallbackAllin(){
    // HTML audio fallbackï¼ˆå·²åœ¨ unlockAudio è§£é–éï¼‰
    const el = document.getElementById('sfx-allin');
    if(!el) return;
    el.currentTime = 0;
    el.volume = 1;
    el.play().catch(()=>{});
}
function stopAllinSound(){
    if(_allinSrc){ try{ _allinSrc.stop(); }catch(e){} _allinSrc=null; }
    const el = document.getElementById('sfx-allin');
    if(el){ el.pause(); el.currentTime=0; }
}

/* â”€â”€ é¦–æ¬¡æ‰‹å‹¢è§£é–ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰ â”€â”€ */
function unlockAudio(){
    if(_audioUnlocked) return;
    _audioUnlocked = true;

    const ctx = getAudioCtx();
    if(ctx && ctx.state === 'suspended') ctx.resume().catch(()=>{});

    // éœéŸ³ buffer è§£é– AudioContext
    if(ctx){
        try{
            const buf = ctx.createBuffer(1,1,22050);
            const src = ctx.createBufferSource();
            src.buffer=buf; src.connect(ctx.destination); src.start(0);
        }catch(e){}
    }

    // è§£é–æ‰€æœ‰ HTML audio SFXï¼ˆiOSï¼šéœ€åœ¨æ‰‹å‹¢ call stack å…§ play éä¸€æ¬¡ï¼‰
    document.querySelectorAll('audio').forEach(el=>{
        if(el.id==='bgm') return;
        const v = el.volume;
        el.volume = 0;
        el.play().catch(()=>{}).finally(()=>{ el.pause(); el.currentTime=0; el.volume=v||1; });
    });

    // å•Ÿå‹• BGM
    startBgmHtmlFallback();
    // é è¼‰ allin bufferï¼ˆä¸é˜»å¡æ‰‹å‹¢ï¼‰
    preloadAllinBuffer();
}

function startBgmHtmlFallback(){
    // BGM ä»ç”¨ HTML audioï¼Œä½†éŸ³é‡é  GainNodeï¼ˆé€é createMediaElementSourceï¼‰
    const bgm = document.getElementById('bgm');
    if(!bgm) return;
    const ctx = getAudioCtx();
    if(!ctx){ bgm.volume=_bgmVol; bgm.play().then(()=>{ _bgmPlaying=true; updateBgmBtn(); }).catch(()=>{}); return; }
    // åªé€£æ¥ä¸€æ¬¡
    if(!bgm._gainConnected){
        bgm._gainConnected = true;
        try{
            _bgmGain = ctx.createGain();
            _bgmGain.gain.value = _bgmVol;
            const src = ctx.createMediaElementSource(bgm);
            src.connect(_bgmGain);
            _bgmGain.connect(ctx.destination);
        }catch(e){
            // createMediaElementSource åªèƒ½å‘¼å«ä¸€æ¬¡ï¼Œè‹¥å¤±æ•—å°± fallback
            bgm._gainConnected = false;
        }
    }
    bgm.loop = true;
    bgm.volume = 1; // éŸ³é‡å…¨äº¤çµ¦ GainNodeï¼ŒiOS ä¸æ”¯æ´æ­¤è¨­å®šä½†ä¸å½±éŸ¿
    const p = bgm.play();
    if(p && p.then){
        p.then(()=>{ _bgmPlaying=true; updateBgmBtn(); })
         .catch(()=>{ _bgmPlaying=false; updateBgmBtn(); });
    }
}

function toggleBgm(){
    unlockAudio();
    const bgm = document.getElementById('bgm');
    if(!bgm) return;
    if(_bgmPlaying){
        bgm.pause(); _bgmPlaying=false;
    } else {
        bgm.loop=true; bgm.volume=1;
        bgm.play().then(()=>{ _bgmPlaying=true; }).catch(()=>{ _bgmPlaying=false; });
        _bgmPlaying=true;
    }
    updateBgmBtn();
}

function setBgmVol(v){
    _bgmVol = parseFloat(v);
    // iOS: ç”¨ GainNode æ§åˆ¶éŸ³é‡
    if(_bgmGain){
        _bgmGain.gain.setTargetAtTime(_bgmVol, getAudioCtx().currentTime, 0.05);
    } else {
        const bgm = document.getElementById('bgm');
        if(bgm) try{ bgm.volume=_bgmVol; }catch(e){}
    }
    if(_bgmVol > 0 && !_bgmPlaying && _audioUnlocked){ startBgmHtmlFallback(); }
}

function updateBgmBtn(){
    const btn = document.getElementById('bgm-toggle-btn');
    if(!btn) return;
    btn.innerText = _bgmPlaying ? 'ğŸµ' : 'ğŸ”‡';
    btn.classList.toggle('playing', _bgmPlaying);
    btn.title = _bgmPlaying ? 'é—œé–‰èƒŒæ™¯éŸ³æ¨‚' : 'é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚';
}

// ALL IN æ™‚é€é GainNode å£“ä½ BGM
function bgmDuck(on){
    const target = on ? _bgmVol * 0.12 : _bgmVol;
    if(_bgmGain && _audioCtx){
        _bgmGain.gain.setTargetAtTime(target, _audioCtx.currentTime, 0.08);
    } else {
        const bgm = document.getElementById('bgm');
        if(bgm && _bgmPlaying) try{ bgm.volume = target; }catch(e){}
    }
}

function playSfx(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.currentTime = 0;
    try{ el.volume = 1; }catch(e){}
    const p = el.play();
    if(p && p.catch) p.catch(()=>{});
}

/* â”€â”€ iOS All-In GIF ä¸éœ€è¦æ‰‹å‹¢è§£é–ï¼Œç›´æ¥æ“æ§ src å³å¯ â”€â”€ */

/* â•â•â•â• ç•«é¢åˆ‡æ› â•â•â•â• */
function showScreen(name){
    document.getElementById('login-screen').style.display  = name==='login'  ? 'flex' : 'none';
    document.getElementById('lobby-screen').style.display  = name==='lobby'  ? 'flex' : 'none';
    document.getElementById('game-screen').style.display   = name==='game'   ? 'block': 'none';
    // BGM éŸ³é‡ä¾ç•«é¢èª¿æ•´
    const bgm = document.getElementById('bgm');
    if(bgm && _bgmPlaying){
        if(name==='game') bgm.volume = _bgmVol;
        else bgm.volume = _bgmVol * 0.55; // å¤§å»³ç¨ä½
    }
    // BGM æ§åˆ¶å™¨åªåœ¨ç™»å…¥å¾Œé¡¯ç¤º
    const ctrl = document.getElementById('bgm-ctrl');
    if(ctrl) ctrl.style.display = name==='login' ? 'none' : 'flex';
}

/* â•â•â•â• èŠå¤© (ä¿ç•™æœ€è¿‘ 20 æ¢) â•â•â•â• */
function renderChatMsg(data, targetId, myCheck){
    const el = document.getElementById(targetId);
    if(!el) return;
    const isSystem = !data.name;
    const isMe = data.uid === myId;
    const div = document.createElement('div');
    div.className = 'chat-msg' + (isSystem?' system':'') + (isMe?' is-me':'');
    if(isSystem){
        div.innerHTML = `<span style="color:#666;">âš™ï¸ ${data.text}</span>`;
    } else {
        div.innerHTML = `<span class="chat-name">${data.name}</span>${data.text}`;
    }
    el.appendChild(div);
    // ä¿ç•™æœ€è¿‘ 20 æ¢
    while(el.children.length > 20) el.removeChild(el.firstChild);
    el.scrollTop = el.scrollHeight;
}

function sendLobbyChat(){
    const input = document.getElementById('lobby-chat-input');
    const text = input.value.trim();
    if(!text || !myId) return;
    chatRef.push({ uid:myId, name:myName, text, time:firebase.database.ServerValue.TIMESTAMP });
    input.value='';
}

function sendGameChat(){
    const input = document.getElementById('game-chat-input');
    const text = input.value.trim();
    if(!text || !myId) return;
    chatRef.push({ uid:myId, name:myName, text, time:firebase.database.ServerValue.TIMESTAMP });
    input.value='';
}

let _chatListening=false;
function startChatListener(){
    if(_chatListening) return;  // é¿å…é‡è¤‡è¨‚é–±
    _chatListening=true;
    // ç›£è½æœ€å¾Œ 20 æ¢,åªæ¥æ”¶ã€Œæ¯”é€²å…¥æ™‚æ›´æ–°çš„ã€
    chatRef.limitToLast(20).on('child_added', snap => {
        const d = snap.val();
        if(!d || d.time <= lastChatTime) return;
        // åŒæ­¥åˆ°å¤§å»³èŠå¤©
        renderChatMsg(d, 'lobby-chat-msgs', true);
        // åŒæ­¥åˆ°éŠæˆ²å…§èŠå¤©
        renderChatMsg(d, 'game-chat-msgs', true);
        // éŠæˆ²å…§æœªè®€æç¤º
        if(!gameChatOpen && d.uid !== myId){
            chatUnreadCount++;
            const badge = document.getElementById('chat-unread');
            if(badge){ badge.innerText=chatUnreadCount; badge.classList.add('show'); }
        }
    });
}

function toggleGameChat(){
    gameChatOpen = !gameChatOpen;
    const panel = document.getElementById('game-chat-panel');
    const btn   = document.getElementById('game-chat-toggle');
    const badge = document.getElementById('chat-unread');
    if(gameChatOpen){
        panel.style.display='flex'; btn.classList.add('open');
        chatUnreadCount=0; if(badge){ badge.classList.remove('show'); }
        document.getElementById('game-chat-msgs').scrollTop = 9999;
    } else {
        panel.style.display='none'; btn.classList.remove('open');
    }
}

/* â•â•â•â• Emoji â•â•â•â• */
function toggleEmojiBar(){
    emojiBarOpen=!emojiBarOpen;
    const bar=document.getElementById('emoji-bar'), btn=document.getElementById('emoji-toggle');
    if(emojiBarOpen){ bar.style.display='block'; btn.classList.add('open'); btn.innerText='âœ•'; }
    else{ bar.style.display='none'; btn.classList.remove('open'); btn.innerText='ğŸ˜„'; }
}
function sendEmoji(icon){
    gameRef.update({lastEmoji:{name:myName,icon,time:firebase.database.ServerValue.TIMESTAMP}});
    if(emojiBarOpen) toggleEmojiBar();
}
function showEmojiBroadcast(name,icon){
    const a=document.getElementById('emoji-broadcast-area');
    const d=document.createElement('div'); d.className='broadcast-item';
    d.innerText=`${name}: ${icon}`; a.appendChild(d); setTimeout(()=>d.remove(),2500);
}

/* â•â•â•â• Toasts â•â•â•â• */
let myTurnTimer=null;
function showMyTurnToast(){
    const t=document.getElementById('my-turn-toast'); t.style.display='block';
    if('vibrate' in navigator) navigator.vibrate([150,50,150]);
    clearTimeout(myTurnTimer); myTurnTimer=setTimeout(()=>t.style.display='none',3000);
}
let refillTimer=null;
function showRefillToast(fee,count){
    const t=document.getElementById('refill-toast');
    t.innerText=`ğŸ’° æ± é‡‘ä¸è¶³,æ¯äººè£œåº• $${fee}(å…±è£œ $${fee*count})`;
    t.style.display='block'; clearTimeout(refillTimer); refillTimer=setTimeout(()=>t.style.display='none',3500);
}
function showReconnectToast(msg,duration){
    const t=document.getElementById('reconnect-toast'); t.innerHTML=msg; t.style.display='block';
    if(duration) setTimeout(()=>t.style.display='none',duration);
}
function hideReconnectToast(){ document.getElementById('reconnect-toast').style.display='none'; }

/* â•â•â•â• åº§ä½æ¸²æŸ“ â•â•â•â• */
function renderSeats(){
    const layer=document.getElementById('seats-layer');
    if(!layer||!localData.players) return;
    layer.innerHTML='';
    const pKeys=Object.keys(localData.players);
    if(pKeys.length===0) return;

    // æˆ¿ä¸» = joinedAt æœ€å°çš„æ´»èºç©å®¶
    const activeSorted=pKeys
        .filter(k=>!localData.players[k].kickedAt)
        .sort((a,b)=>(localData.players[a].joinedAt||0)-(localData.players[b].joinedAt||0));
    const seatHostId=activeSorted[0]||null;

    pKeys.forEach((id,i)=>{
        const p=localData.players[id];
        const isMe=(id===myId), isHost=(id===seatHostId);
        const isActive=(id===localData.currentPlayerKey);
        const isKicked=!!p.kickedAt;

        let cx,cy;
        if(isMe){
            cx=50; cy=88;
        } else {
            const others=pKeys.filter(k=>k!==myId);
            const oi=others.indexOf(id), oc=others.length;
            const rx=42,ry=36;
            const startDeg=210,endDeg=330;
            const deg=oc===1?270:startDeg+(oi/(oc-1))*(endDeg-startDeg);
            const rad=deg*Math.PI/180;
            cx=50+rx*Math.cos(rad); cy=50+ry*Math.sin(rad);
        }

        const crown=isHost?' ğŸ‘‘':'';
        let tmr='';
        if(isActive&&localData.lastActionTime&&!isKicked){
            const sec=Math.max(0,60-Math.floor((getServerNow()-localData.lastActionTime)/1000));
            const pct=Math.round(sec/60*100);
            const warnCls=sec<15?'warn':'';
            tmr=`<div class="seat-tmr">â±${sec}s</div><div class="seat-timer-bar-wrap"><div class="seat-timer-bar ${warnCls}" style="width:${pct}%"></div></div>`;
        }
        if(isKicked){
            const remain=Math.max(0,Math.ceil((p.kickedAt+KICK_GRACE-getServerNow())/1000));
            tmr=`<div class="seat-tmr">ğŸš« ${remain}så¾Œç§»é™¤</div>`;
        }

        const boxCls=['seat-box',isActive&&!isKicked?'active':'',isMe?'is-me':'',isKicked?'kicked':''].filter(Boolean).join(' ');
        const node=document.createElement('div');
        node.className='seat'+(isMe?' is-me':'');
        node.style.left=cx+'%'; node.style.top=cy+'%';
        const kickBtn=(!isKicked)?`<button class="seat-kick" onclick="kickPlayer('${id}')">âœ•</button>`:'';
        node.innerHTML=`${kickBtn}<div class="${boxCls}"><div class="seat-name">${p.name}${crown}</div><div class="seat-bal">$${p.balance}</div>${tmr}</div>`;

        const boxEl=node.querySelector('.seat-box');
        boxEl.addEventListener('click',e=>{
            if(e.target.classList.contains('seat-kick')) return;
            const exp=boxEl.classList.contains('expanded');
            document.querySelectorAll('.seat-box.expanded').forEach(el=>el.classList.remove('expanded'));
            if(!exp) boxEl.classList.add('expanded');
        });
        layer.appendChild(node);
    });

    document.getElementById('oval').addEventListener('click',e=>{
        if(!e.target.closest('.seat-box'))
            document.querySelectorAll('.seat-box.expanded').forEach(el=>el.classList.remove('expanded'));
    });

    const oval=document.getElementById('oval');
    if(oval){
        if(localData.currentPlayerKey===myId) oval.classList.add('my-turn');
        else oval.classList.remove('my-turn');
    }
}

/* â•â•â•â• å¤§å»³ç©å®¶/è§€çœ¾åˆ—è¡¨æ¸²æŸ“ â•â•â•â• */
function renderLobbyPlayers(players, spectators, isHost){
    players   = players   || localData.players   || {};
    spectators= spectators|| localData.spectators|| {};
    const allP=Object.keys(players);
    const activeP=allP.filter(k=>!players[k].kickedAt)
        .sort((a,b)=>(players[a].joinedAt||0)-(players[b].joinedAt||0));
    const hostId=activeP[0]||null;

    document.getElementById('lobby-player-count').innerText=activeP.length;
    document.getElementById('lobby-spectator-count').innerText=Object.keys(spectators).length;

    // â”€â”€ ç©å®¶åˆ—è¡¨ï¼ˆè·³éè¢«è¸¢å‡ºçš„ï¼‰â”€â”€
    const pList=document.getElementById('lobby-player-list');
    pList.innerHTML='';
    activeP.forEach(id=>{
        const p=players[id], isMe=(id===myId), isH=(id===hostId);
        const div=document.createElement('div');
        div.className='lobby-player-item'+(isH?' is-host':'')+(isMe?' is-me':'');
        let actionBtn='';
        if(isHost && !isMe){
            actionBtn=`<button onclick="demoteToSpectator('${id}','${p.name}')" style="font-size:0.68rem;padding:1px 6px;background:rgba(52,152,219,0.3);border:1px solid rgba(52,152,219,0.6);color:#74b9ff;border-radius:4px;cursor:pointer;white-space:nowrap;">â†“è§€çœ¾</button>`;
        }
        div.innerHTML=`<span class="lobby-player-dot"></span><span class="lobby-player-name">${p.name}</span>${isH?'<span class="lobby-player-crown">ğŸ‘‘</span>':''}${isMe?'<span style="color:#74b9ff;font-size:0.7rem;">(æˆ‘)</span>':''}${actionBtn}`;
        pList.appendChild(div);
    });

    // â”€â”€ è§€çœ¾åˆ—è¡¨ï¼ˆæˆ¿ä¸»æ¨¡å¼ï¼šæ¯äººæœ‰ã€Œå‡ç©å®¶ã€æŒ‰éˆ•ï¼‰â”€â”€
    // â”€â”€ è§€çœ¾åˆ—è¡¨ â”€â”€
    const sList=document.getElementById('lobby-spectator-list');
    const sKeys=Object.keys(spectators);
    sList.innerHTML='';
    sKeys.forEach(id=>{
        const s=spectators[id], isMe=(id===myId&&myRole==='spectator');
        const div=document.createElement('div');
        div.className='lobby-player-item is-spectator'+(isMe?' is-me':'');
        let actionBtn='';
        if(isHost){
            actionBtn=`<button onclick="promoteSpectator('${id}','${s.name}')" style="font-size:0.68rem;padding:1px 6px;background:rgba(46,204,113,0.25);border:1px solid rgba(46,204,113,0.5);color:#2ecc71;border-radius:4px;cursor:pointer;white-space:nowrap;">â†‘ç©å®¶</button>`;
        }
        div.innerHTML=`<span class="lobby-player-dot" style="background:#3498db;"></span><span class="lobby-player-name">${s.name}</span><span class="spectator-tag">è§€çœ¾</span>${isMe?'<span style="color:#74b9ff;font-size:0.7rem;">(æˆ‘)</span>':''}${actionBtn}`;
        sList.appendChild(div);
    });

    if(isHost) renderHostMemberMgmt(activeP, players, spectators);
}

/* æˆ¿ä¸»äººå“¡ç®¡ç†é¢æ¿ï¼ˆå¤§å»³ï¼‰ */
function renderHostMemberMgmt(activeP, players, spectators){
    const list=document.getElementById('host-member-list');
    if(!list) return;
    list.innerHTML='';
    const sKeys=Object.keys(spectators||{});

    if(activeP.length<=1 && sKeys.length===0){
        list.innerHTML='<div style="color:#666;font-size:0.78rem;">ï¼ˆåªæœ‰ä½ ä¸€äººï¼‰</div>';
        return;
    }

    // ç©å®¶ï¼ˆè‡ªå·±ä»¥å¤–ï¼‰â†’ å¯é™è§€çœ¾
    activeP.forEach(id=>{
        const p=(players||{})[id]; if(!p||id===myId) return;
        const row=document.createElement('div');
        row.className='smgmt-row';
        row.innerHTML=`<span class="smgmt-name">ğŸ® ${p.name}</span>
            <button class="btn-kick-spec" onclick="demoteToSpectator('${id}','${p.name}')">é™è§€çœ¾</button>`;
        list.appendChild(row);
    });

    // è§€çœ¾ â†’ å¯å‡ç©å®¶æˆ–ç§»é™¤
    sKeys.forEach(id=>{
        const s=(spectators||{})[id]; if(!s) return;
        const row=document.createElement('div');
        row.className='smgmt-row';
        row.innerHTML=`<span class="smgmt-name">ğŸ‘ ${s.name}</span>
            <button class="btn-promote" onclick="promoteSpectator('${id}','${s.name}')">å‡ç©å®¶</button>
            <button class="btn-kick-spec" onclick="kickSpectator('${id}','${s.name}')">ç§»é™¤</button>`;
        list.appendChild(row);
    });

    if(list.children.length===0)
        list.innerHTML='<div style="color:#666;font-size:0.78rem;">ï¼ˆç„¡å¯ç®¡ç†çš„äººå“¡ï¼‰</div>';
}

/* æˆ¿ä¸»ï¼šå‡è§€çœ¾ç‚ºç©å®¶ï¼ˆåŸå­æ“ä½œï¼šåŒä¸€å€‹ update åŒæ™‚å¯«å…¥+æ¸…é™¤ï¼Œæ¶ˆé™¤ç¬é–“å…©é‚Šéƒ½æ²’æœ‰çš„å•é¡Œï¼‰ */
function promoteSpectator(id, name){
    const s=(localData.spectators||{})[id]||{};
    // ä¸€å€‹ update åŒæ™‚ï¼šplayers/id å¯«å…¥ + spectators/id è¨­ç‚º nullï¼ˆåˆªé™¤ï¼‰
    gameRef.update({
        [`players/${id}`]: { name, balance:0, lastActive: s.lastActive||getServerNow() },
        [`spectators/${id}`]: null
    });
    chatRef.push({uid:'system',text:`ğŸ® ${name} å·²å‡ç‚ºç©å®¶`,time:firebase.database.ServerValue.TIMESTAMP});
}

/* æˆ¿ä¸»ï¼šå°‡ç©å®¶é™ç‚ºè§€çœ¾ï¼ˆåŸå­æ“ä½œï¼šåŒä¸€å€‹ update åŒæ™‚å¯«å…¥+æ¸…é™¤ï¼‰ */
function demoteToSpectator(id, name){
    if(id===myId){ alert('ä¸èƒ½å°‡è‡ªå·±é™ç‚ºè§€çœ¾'); return; }
    const players=localData.players||{};
    const pKeys=Object.keys(players);
    const p=players[id]||{};
    const wasActive=localData.currentPlayerKey===id;
    const remaining=pKeys.filter(k=>k!==id&&!players[k].kickedAt);

    // ä¸€å€‹ update åŒæ™‚ï¼šspectators/id å¯«å…¥ + players/id è¨­ç‚º nullï¼ˆåˆªé™¤ï¼‰
    const updates={
        [`spectators/${id}`]: { name, lastActive: p.lastActive||getServerNow() },
        [`players/${id}`]: null
    };
    // å¦‚æœè¢«é™çš„æ˜¯ç•¶å‰å‡ºç‰Œè€…ï¼Œä¸€ä½µäº¤æ£’
    if(wasActive && remaining.length>0){
        updates.gameState='waiting_deal';
        updates.currentPlayerKey=remaining[0];
        updates.lastActionTime=firebase.database.ServerValue.TIMESTAMP;
    }
    gameRef.update(updates);
    chatRef.push({uid:'system',text:`ğŸ‘ ${name} å·²æ”¹ç‚ºè§€çœ¾`,time:firebase.database.ServerValue.TIMESTAMP});
}

/* æˆ¿ä¸»ï¼šè¸¢è§€çœ¾ */
function kickSpectator(id, name){
    gameRef.child('spectators/'+id).remove();
    chatRef.push({uid:'system',text:`${name} è¢«ç§»å‡ºè§€çœ¾å¸­`,time:firebase.database.ServerValue.TIMESTAMP});
}

/* éŠæˆ²ä¸­è§€çœ¾ç®¡ç† */
function toggleSpecMgmtGame(){
    const p=document.getElementById('spec-mgmt-game');
    p.style.display=p.style.display==='none'?'block':'none';
}
function renderSpecMgmtGame(spectators){
    const list=document.getElementById('spec-mgmt-game-list');
    if(!list) return;
    const sKeys=Object.keys(spectators||{});
    list.innerHTML='';
    if(sKeys.length===0){
        list.innerHTML='<div style="color:#666;font-size:0.78rem;">ï¼ˆç„¡è§€çœ¾ï¼‰</div>';
        return;
    }
    sKeys.forEach(id=>{
        const s=(spectators||{})[id]; if(!s) return;
        const row=document.createElement('div');
        row.style.cssText='display:flex;align-items:center;gap:5px;margin-bottom:5px;font-size:0.82rem;';
        // éŠæˆ²ä¸­åªèƒ½ç§»é™¤è§€çœ¾ï¼Œä¸èƒ½å‡ç©å®¶ï¼ˆå‡é™åªåœ¨å¤§å»³ï¼‰
        row.innerHTML=`<span style="flex:1;color:#ccc;">${s.name}</span>
            <button style="background:#e74c3c;color:white;border:none;border-radius:5px;padding:2px 7px;font-size:0.75rem;cursor:pointer;" onclick="kickSpectator('${id}','${s.name}')">ç§»é™¤</button>`;
        list.appendChild(row);
    });
}

/* è§€çœ¾ç”³è«‹åŠ å…¥ */
function requestJoin(){
    chatRef.push({uid:'system',text:`ğŸ“¢ ${myName}(è§€çœ¾) ç”³è«‹æˆç‚ºç©å®¶ï¼Œè«‹æˆ¿ä¸»åœ¨æˆ¿ä¸»è¨­å®šå‡ç´š`,time:firebase.database.ServerValue.TIMESTAMP});
}

/* â•â•â•â• åŠ å…¥æˆ¿é–“ â•â•â•â• */
function joinRoom(){
    unlockAudio();
    const name=document.getElementById('my-name').value.trim();
    if(!name) return alert('è«‹è¼¸å…¥æš±ç¨±');
    myName=name;

    const savedId  =localStorage.getItem('dgp_myId');
    const savedName=localStorage.getItem('dgp_myName');
    const savedTime=parseInt(localStorage.getItem('dgp_savedAt')||'0');
    const now=Date.now();
    const canReconnect=savedId&&savedName===name&&(now-savedTime<RECONNECT_WINDOW);

    if(canReconnect){
        // åŒæ™‚æŸ¥ç©å®¶å’Œè§€çœ¾å…©æ¢è·¯å¾‘ï¼Œä»¥ Firebase å¯¦éš›è³‡æ–™ç‚ºæº–
        Promise.all([
            gameRef.child('players/'+savedId).once('value'),
            gameRef.child('spectators/'+savedId).once('value')
        ]).then(([pSnap, sSnap])=>{
            const pData=pSnap.val(), sData=sSnap.val();

            if(pData && !pData.kickedAt){
                // âœ… åœ¨ç©å®¶æ¸…å–®ä¸­ï¼Œä¸”æœªè¢«æ¨™è¨˜è¸¢å‡º â†’ ç©å®¶èº«ä»½é‡é€£
                myId=savedId; myRole='player'; saveMyId(name,'player');
                lastChatTime=getServerNow(); window._joinedAt=Date.now();
                // æ›´æ–° lastActiveï¼Œç¢ºä¿æ¸…é™¤ä»»ä½• kickedAt æ¨™è¨˜
                gameRef.child('players/'+myId).update({
                    lastActive: firebase.database.ServerValue.TIMESTAMP,
                    kickedAt: null
                });
                showReconnectToast('ğŸ”„ é‡é€£æˆåŠŸ',2000);
                startListening(); startChatListener();

            } else if(pData && pData.kickedAt){
                // â³ è¢«è¸¢ä¸­ï¼ˆKICK_GRACE æœŸé–“ï¼‰ï¼Œç­‰ç§»é™¤å¾Œå†é‡æ–°åŠ å…¥
                showReconnectToast('â³ ç­‰å¾…åº§ä½é‡‹æ”¾...');
                const chk=setInterval(()=>{
                    gameRef.child('players/'+savedId).once('value',s2=>{
                        if(!s2.val()){ clearInterval(chk); hideReconnectToast(); createNewEntry(name); }
                    });
                },1000);

            } else if(sData){
                // âœ… åœ¨è§€çœ¾æ¸…å–®ä¸­ â†’ è§€çœ¾èº«ä»½é‡é€£
                myId=savedId; myRole='spectator'; saveMyId(name,'spectator');
                lastChatTime=getServerNow(); window._joinedAt=Date.now();
                gameRef.child('spectators/'+myId).update({lastActive:firebase.database.ServerValue.TIMESTAMP});
                showReconnectToast('ğŸ”„ é‡é€£æˆåŠŸï¼ˆè§€çœ¾ï¼‰',2000);
                startListening(); startChatListener();

            } else {
                // å…©é‚Šéƒ½æ‰¾ä¸åˆ° â†’ å…¨æ–°åŠ å…¥
                createNewEntry(name);
            }
        });
    } else {
        createNewEntry(name);
    }
}

function createNewEntry(name){
    gameRef.once('value',snap=>{
        const data=snap.val()||{};
        const players=data.players||{};
        const spectators=data.spectators||{};
        const now=getServerNow();

        // æ¸…ç†éæœŸç©å®¶
        Object.keys(players).forEach(id=>{
            const p=players[id];
            if(!p.kickedAt&&(!p.lastActive||now-p.lastActive>70000)) gameRef.child('players/'+id).remove();
        });
        const pKeys=Object.keys(players).filter(id=>!players[id].kickedAt||(now-players[id].kickedAt<KICK_GRACE));
        if(pKeys.length===0&&Object.keys(spectators).length===0)
            gameRef.update({gameStarted:false,c1:null,c2:null,c3:null,currentPlayerKey:null});

        if(data.gameStarted){
            // éŠæˆ²é€²è¡Œä¸­ â†’ è§€çœ¾
            const newRef=gameRef.child('spectators').push();
            myId=newRef.key; myRole='spectator'; saveMyId(name,'spectator');
            window._joinedAt=Date.now();
            gameRef.child('spectators/'+myId).set({name,lastActive:firebase.database.ServerValue.TIMESTAMP}).then(()=>{
                chatRef.push({uid:'system',text:`ğŸ‘ ${name} ä»¥è§€çœ¾èº«ä»½åŠ å…¥`,time:firebase.database.ServerValue.TIMESTAMP});
                if(data.allInTrigger) lastEffectId=data.allInTrigger;
                if(data.lastEmoji)    lastEmojiTime=data.lastEmoji.time;
                if(data.lastShot)     lastShotId=data.lastShot.id;
                lastChatTime=getServerNow();
                startListening(); startChatListener();
            });
        } else {
            // å¤§å»³ä¸­ â†’ ç©å®¶
            const newRef=gameRef.child('players').push();
            myId=newRef.key; myRole='player'; saveMyId(name,'player');
            window._joinedAt=Date.now();
            gameRef.child('players/'+myId).set({name,balance:0,joinedAt:firebase.database.ServerValue.TIMESTAMP,lastActive:firebase.database.ServerValue.TIMESTAMP}).then(()=>{
                chatRef.push({uid:'system',text:`${name} é€²å…¥å¤§å»³`,time:firebase.database.ServerValue.TIMESTAMP});
                if(data.allInTrigger) lastEffectId=data.allInTrigger;
                if(data.lastEmoji)    lastEmojiTime=data.lastEmoji.time;
                if(data.lastShot)     lastShotId=data.lastShot.id;
                lastChatTime=getServerNow();
                startListening(); startChatListener();
            });
        }
    });
}

function saveMyId(name, role){
    localStorage.setItem('dgp_myId',myId);
    localStorage.setItem('dgp_myName',name);
    localStorage.setItem('dgp_myRole', role||myRole||'player');
    localStorage.setItem('dgp_savedAt',Date.now().toString());
}

/* â•â•â•â• é›¢é–‹æˆ¿é–“ â•â•â•â• */
function leaveRoom(){
    if(!confirm('ç¢ºå®šé›¢é–‹æˆ¿é–“?')) return;
    doLeave();
}
function doLeave(){
    if(!myId) return;

    if(myRole==='spectator'){
        chatRef.push({uid:'system',text:`${myName} é›¢é–‹äº†æˆ¿é–“`,time:firebase.database.ServerValue.TIMESTAMP});
        gameRef.child('spectators/'+myId).remove();
    } else {
        const players=localData.players||{};
        const allKeys=Object.keys(players);
        const wasActive=localData.currentPlayerKey===myId;
        const remaining=allKeys.filter(k=>k!==myId&&!players[k].kickedAt);

        // ç”¨ multi-path update åŸå­åˆªé™¤è‡ªå·±ï¼ŒåŒæ™‚è™•ç†å¾ŒçºŒç‹€æ…‹
        // é€™æ¨£å³ä½¿ gameRef.off() ä¹‹å¾Œé‚„æ˜¯èƒ½é€å‡ºå»
        const updates={};
        updates[`players/${myId}`]=null;  // ç›´æ¥åˆªé™¤è‡ªå·±

        if(remaining.length===0){
            updates.gameStarted=false;
            updates.c1=null; updates.c2=null; updates.c3=null;
            updates.currentPlayerKey=null;
            updates.spectators=null;
        } else if(wasActive){
            updates.gameState='waiting_deal';
            updates.currentPlayerKey=remaining[0];
            updates.lastActionTime=firebase.database.ServerValue.TIMESTAMP;
        }

        // å…ˆ push é›¢é–‹è¨Šæ¯ï¼Œç„¶å¾ŒåŸå­ updateï¼ˆä¸ç­‰ thenï¼Œç›´æ¥æ–·ç·šä¹Ÿæ²’é—œä¿‚ï¼‰
        chatRef.push({uid:'system',text:`${myName} é›¢é–‹äº†æˆ¿é–“`,time:firebase.database.ServerValue.TIMESTAMP});
        gameRef.update(updates);
    }

    localStorage.removeItem('dgp_myId'); localStorage.removeItem('dgp_myName');
    localStorage.removeItem('dgp_myRole'); localStorage.removeItem('dgp_savedAt');
    myId=''; myName=''; myRole='player';
    _chatListening=false; _gameListening=false;
    gameRef.off(); chatRef.off();
    showScreen('login');
    document.getElementById('my-name').value='';
}

/* â•â•â•â• ä¸»ç›£è½ â•â•â•â• */
let _gameListening=false;
function startListening(){
    if(_gameListening){ gameRef.off(); } // å…ˆé—œèˆŠçš„å†é‡é–‹
    _gameListening=true;
    gameRef.on('value',snap=>{
        localData=snap.val()||{};

        // â”€â”€ åˆ¤æ–·è‡ªå·±èº«ä»½ï¼ˆå«æˆ¿ä¸»å‡é™å¾Œè‡ªå‹•åˆ‡æ› roleï¼‰â”€â”€
        const inPlayers   = !!(localData.players   && localData.players[myId]);
        const inSpectators= !!(localData.spectators && localData.spectators[myId]);

        if(!inPlayers && !inSpectators){
            // å‰›åŠ å…¥ 3 ç§’å…§ä¸è§¸ç™¼ç™»å‡ºï¼ˆFirebase å¯«å…¥é‚„åœ¨è·¯ä¸Šï¼‰
            if(window._joinedAt && Date.now()-window._joinedAt < 3000) return;
            // ç”¨ debounce é¿å…åŸå­ update çš„çŸ­æš«ä¸­é–“ç‹€æ…‹èª¤è§¸ç™¼ç™»å‡º
            if(!window._notFoundTimer){
                window._notFoundTimer = setTimeout(()=>{
                    window._notFoundTimer=null;
                    const stillInP=!!(localData.players   && localData.players[myId]);
                    const stillInS=!!(localData.spectators && localData.spectators[myId]);
                    if(!stillInP && !stillInS){
                        localStorage.removeItem('dgp_myId'); localStorage.removeItem('dgp_myName');
                        localStorage.removeItem('dgp_myRole'); localStorage.removeItem('dgp_savedAt');
                        _chatListening=false; _gameListening=false;
                        gameRef.off(); chatRef.off();
                        showScreen('login'); document.getElementById('my-name').value='';
                    }
                }, 800);
            }
            return;
        }
        // æ‰¾åˆ°äº†ï¼Œæ¸…æ‰ debounce timer
        if(window._notFoundTimer){ clearTimeout(window._notFoundTimer); window._notFoundTimer=null; }

        // æˆ¿ä¸»å‡é™å¾Œï¼Œæœ¬åœ° myRole è·Ÿè‘—è‡ªå‹•ä¿®æ­£
        if(inPlayers && myRole!=='player'){
            myRole='player';
            saveMyId(myName,'player');
        } else if(inSpectators && !inPlayers && myRole!=='spectator'){
            myRole='spectator';
            saveMyId(myName,'spectator');
        }

        const players  = localData.players  || {};
        const spectators= localData.spectators||{};
        // æˆ¿ä¸» = æ´»èºç©å®¶ä¸­ joinedAt æœ€å°çš„ï¼ˆæœ€æ—©é€²æˆ¿ï¼‰
        // è‹¥ç„¡ joinedAtï¼ˆèˆŠè³‡æ–™ï¼‰ï¼Œfallback åˆ° Firebase key å­—å…¸é †åºç¬¬ä¸€å€‹
        const activePlayers=Object.entries(players)
            .filter(([k,p])=>!p.kickedAt)
            .sort(([,a],[,b])=>(a.joinedAt||0)-(b.joinedAt||0));
        const hostId=activePlayers.length>0 ? activePlayers[0][0] : null;
        const isHost=myRole==='player' && hostId===myId;
        document.body.className=isHost?'is-host':'';

        // â”€â”€ æ´—ç‰Œå»£æ’­ â”€â”€
        if(localData.shufflingBy && localData.shufflingBy!==myName && !document.getElementById('shuffle-overlay').classList.contains('show')){
            const sTS=localData.shuffleTS||0;
            if(sTS>(window._lastShuffleTS||0)){ window._lastShuffleTS=sTS; playShuffleAnimation(()=>{},localData.shufflingBy); }
        }

        // â”€â”€ Emoji å»£æ’­ â”€â”€
        if(localData.lastEmoji&&localData.lastEmoji.time>lastEmojiTime){
            showEmojiBroadcast(localData.lastEmoji.name,localData.lastEmoji.icon);
            lastEmojiTime=localData.lastEmoji.time;
        }

        // â”€â”€ é£›ç‰Œå»£æ’­(å…¶ä»–äººå°„çš„) â”€â”€
        if(localData.lastShot&&localData.lastShot.id!==lastShotId){
            const shot=localData.lastShot; lastShotId=shot.id;
            if(shot.shooterId!==myId){
                updateCard('c1',localData.c1); updateCard('c2',localData.c2);
                document.getElementById('gate-inner').style.display='none';
                animateShotCard(shot.card,shot.resultType,()=>{
                    updateGateCard(localData.c3);
                    const sfxMap={win:'sfx-win',crash:'sfx-crash',lose:'sfx-lose'};
                    playSfx(sfxMap[shot.resultType]||'sfx-lose');
                    if(shot.resultType==='win') spawnConfetti(40);
                    showResultBanner(shot.emoji,shot.text,shot.delta,shot.resultType);
                });
            }
        }

        // â”€â”€ ALL IN æ•ˆæœ â”€â”€
        if(localData.allInTrigger&&localData.allInTrigger!==lastEffectId){
            lastEffectId=localData.allInTrigger;
            document.getElementById('all-in-overlay').style.display='flex';
            bgmDuck(true); playAllinSound(); showAllinGif();
            setTimeout(()=>{ document.getElementById('all-in-overlay').style.display='none'; bgmDuck(false); stopAllinSound(); hideAllinGif(); },3000);
        }

        // â”€â”€ éŠæˆ²çµæŸå»£æ’­ â”€â”€
        if(localData.gameOverSignal && localData.gameOverSignal!==window._lastGameOverSignal){
            window._lastGameOverSignal = localData.gameOverSignal;
            showGameOver(localData.gameOverRankings||[], localData.gameOverLastCards||null);
        }

        if(localData.gameStarted){
            // â”€â”€ éŠæˆ²ä¸­ â”€â”€
            showScreen('game');
            document.getElementById('spectator-watermark').style.display = myRole==='spectator'?'block':'none';
            document.getElementById('emoji-toggle').style.display='flex';
            document.getElementById('emoji-bar').style.display='none';
            document.getElementById('game-chat-toggle').style.display='flex';
            document.getElementById('tools').style.display='flex';
            emojiBarOpen=false;
            document.getElementById('emoji-toggle').classList.remove('open');
            document.getElementById('emoji-toggle').innerText='ğŸ˜„';
            if(myRole==='player') renderUI(isHost);
            else renderUISpectator();   // è§€çœ¾åªæ¸²æŸ“éœæ…‹ç‰Œé¢/æ± é‡‘
            const isTurnNow=(myRole==='player'&&localData.currentPlayerKey===myId);
            if(isTurnNow&&!wasMyturn) showMyTurnToast();
            wasMyturn=isTurnNow;
        } else {
            // â”€â”€ å¤§å»³ â”€â”€
            showScreen('lobby');
            document.getElementById('spectator-watermark').style.display='none';
            document.getElementById('emoji-toggle').style.display='none';
            document.getElementById('emoji-bar').style.display='none';
            document.getElementById('game-chat-toggle').style.display='none';
            document.getElementById('tools').style.display='none';
            wasMyturn=false;

            if(myRole==='player'){
                document.getElementById('lobby-host-controls').style.display=isHost?'block':'none';
                document.getElementById('lobby-waiting-msg').style.display=isHost?'none':'block';
                document.getElementById('spectator-notice').style.display='none';
            } else {
                // è§€çœ¾
                document.getElementById('lobby-host-controls').style.display='none';
                document.getElementById('lobby-waiting-msg').style.display='none';
                document.getElementById('spectator-notice').style.display='block';
            }
        }

        document.getElementById('host-reset-btn').style.display=(isHost&&myRole==='player')?'block':'none';
        document.getElementById('host-spec-btn').style.display=(isHost&&myRole==='player')?'block':'none';
        // æ›´æ–°éŠæˆ²ä¸­è§€çœ¾ç®¡ç†åˆ—è¡¨
        if(isHost&&myRole==='player') renderSpecMgmtGame(spectators);
        renderSeats();
        renderLobbyPlayers(players, spectators, isHost);
    });
}

/* â•â•â•â• å¿ƒè·³ & è‡ªå‹•æ¸…ç† â•â•â•â• */
setInterval(()=>{
    if(!myId) return;
    if(myRole==='player' && localData.players && localData.players[myId])
        gameRef.child('players/'+myId).update({lastActive:getServerNow()});
    else if(myRole==='spectator' && localData.spectators && localData.spectators[myId])
        gameRef.child('spectators/'+myId).update({lastActive:getServerNow()});
},5000);

setInterval(()=>{
    if(!localData.players||!myId||myRole!=='player') return;
    const now=getServerNow(), players=localData.players;
    const allKeys=Object.keys(players);

    // æˆ¿ä¸» = æ´»èºç©å®¶ä¸­ joinedAt æœ€å°çš„
    const activeSorted=allKeys
        .filter(k=>!players[k].kickedAt)
        .sort((a,b)=>(players[a].joinedAt||0)-(players[b].joinedAt||0));
    if(activeSorted[0]!==myId) return; // åªæœ‰æˆ¿ä¸»åŸ·è¡Œæ¸…ç†

    allKeys.forEach(id=>{
        const p=players[id];
        if(p.kickedAt&&now-p.kickedAt>=KICK_GRACE){
            gameRef.child('players/'+id).remove(); return;
        }
        if(!p.kickedAt&&id!==myId&&(!p.lastActive||now-p.lastActive>70000)){
            gameRef.child('players/'+id).update({kickedAt:getServerNow()});
        }
    });

    if(localData.gameStarted){
        const cpKey=localData.currentPlayerKey;
        if(cpKey&&players[cpKey]&&players[cpKey].kickedAt){
            const active=allKeys.filter(k=>!players[k].kickedAt);
            const ci=active.indexOf(cpKey);
            const nextK=active[(ci+1)%active.length]||active[0]||null;
            gameRef.update({gameState:'waiting_deal',currentPlayerKey:nextK,
                lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:'ç©å®¶è¶…æ™‚,ç§»å‡ºåº§ä½'});
        }
        if(localData.lastActionTime){
            const diff=(now-localData.lastActionTime)/1000;
            if(diff>60.5&&cpKey&&players[cpKey]&&!players[cpKey].kickedAt){
                const ts=getServerNow();
                gameRef.child('players/'+cpKey).update({kickedAt:ts}).then(()=>{
                    const active=allKeys.filter(k=>!players[k].kickedAt&&k!==cpKey);
                    gameRef.update({gameState:'waiting_deal',currentPlayerKey:active[0]||null,
                        statusMsg:'ç©å®¶è¶…æ™‚,ç§»å‡ºåº§ä½',lastActionTime:firebase.database.ServerValue.TIMESTAMP});
                });
            }
        }
    }
    renderSeats();
},1000);

/* â•â•â•â• è¸¢ç©å®¶ â•â•â•â• */
function kickPlayer(id){
    if(!confirm('å‰”é™¤è©²ç©å®¶?(10ç§’å¾Œç§»é™¤,æœŸé–“å¯é‡é€£)')) return;
    const players=localData.players||{};
    const active=Object.keys(players).filter(k=>k!==id&&!players[k].kickedAt);
    const updates={};
    updates[`players/${id}/kickedAt`]=getServerNow();
    if(localData.currentPlayerKey===id){
        updates.gameState='waiting_deal';
        updates.currentPlayerKey=active[0]||null;
        updates.lastActionTime=firebase.database.ServerValue.TIMESTAMP;
    }
    gameRef.update(updates);
    chatRef.push({uid:'system',text:`${players[id]?.name||'ç©å®¶'} è¢«è¸¢å‡ºæˆ¿é–“`,time:firebase.database.ServerValue.TIMESTAMP});
}

/* â•â•â•â• é–‹å±€ â•â•â•â• */
function hostStartGame(){
    const fee=parseInt(document.getElementById('entry-fee').value)||100;
    const start=parseInt(document.getElementById('start-balance').value)||1000;
    const decks=parseInt(document.getElementById('deck-count').value)||2;
    const refill=document.getElementById('auto-refill').checked;
    let players=localData.players, pool=0;
    Object.keys(players).forEach(id=>{ players[id].balance=start-fee; pool+=fee; });

    // å…ˆåˆ‡æ›åˆ°éŠæˆ²ç•«é¢è®“å‹•ç•«é¡¯ç¤º
    const deckData=generateDecks(decks);
    gameRef.update({
        gameStarted:true, deck:deckData, pool, entryFee:fee,
        foldPenalty:parseInt(document.getElementById('fold-penalty').value)||20,
        autoRefill:refill, deckCount:decks, gameState:'waiting_deal',
        currentPlayerKey:Object.keys(players)[0], players,
        lastActionTime:firebase.database.ServerValue.TIMESTAMP, statusMsg:'æ–°å±€é–‹å§‹ï¼Œè«‹æ´—ç‰Œ'
    });
    chatRef.push({uid:'system',text:'éŠæˆ²é–‹å§‹ï¼',time:firebase.database.ServerValue.TIMESTAMP});
    // åˆ‡æ›å¾Œæ’­æ´—ç‰Œå‹•ç•«ï¼ˆå»£æ’­çµ¦æ‰€æœ‰äººçœ‹ï¼‰
    setTimeout(()=>{
        broadcastAndShuffle(()=>{
            gameRef.update({statusMsg:'è«‹é»ç‰Œåº«ç™¼ç‰Œ'});
        });
    },400);
}


/* â•â•â•â• éŠæˆ²å‹•ä½œ â•â•â•â• */
function handleAction(type){
    if(myRole==='spectator') return; // è§€çœ¾ä¸èƒ½æ“ä½œ
    let bet=Math.abs(parseInt(document.getElementById('bet-amount').value))||0;
    if(type!=='fold'&&(bet<1||bet>localData.pool)) return alert('è«‹ä¸‹æ³¨');
    let p=localData.players[myId], nBal=p.balance, nPool=localData.pool;
    let msg='', c3=null, deck=localData.deck||[];
    let resultType='neutral', deltaAmount=0;

    if(type==='fold'){
        nBal-=localData.foldPenalty; nPool+=localData.foldPenalty;
        msg=`${p.name} æ£„ç‰Œ`; resultType='fold'; deltaAmount=-localData.foldPenalty;
    } else {
        if(deck.length<1) deck=generateDecks(localData.deckCount||2);
        c3=deck.pop();
        const min=Math.min(localData.c1.val,localData.c2.val);
        const max=Math.max(localData.c1.val,localData.c2.val);
        if(localData.c1.val===localData.c2.val){
            if(c3.val===localData.c1.val){ nBal-=bet*3; nPool+=bet*3; msg=`æ’æŸ±(-$${bet*3})`; resultType='crash'; deltaAmount=-(bet*3); }
            else if((type==='up'&&c3.val>localData.c1.val)||(type==='down'&&c3.val<localData.c1.val)){ nBal+=bet; nPool-=bet; msg=`çŒœå°(+$${bet})`; resultType='win'; deltaAmount=bet; }
            else{ nBal-=bet; nPool+=bet; msg=`çŒœéŒ¯(-$${bet})`; resultType='lose'; deltaAmount=-bet; }
        } else {
            if(c3.val>min&&c3.val<max){ nBal+=bet; nPool-=bet; msg=`å°„é€²(+$${bet})`; resultType='win'; deltaAmount=bet; }
            else if(c3.val===min||c3.val===max){ nBal-=bet*2; nPool+=bet*2; msg=`æ’æŸ±(-$${bet*2})`; resultType='crash'; deltaAmount=-(bet*2); }
            else{ nBal-=bet; nPool+=bet; msg=`æ²’é€²(-$${bet})`; resultType='lose'; deltaAmount=-bet; }
        }
    }

    const pKeys=Object.keys(localData.players);
    const active=pKeys.filter(k=>!localData.players[k].kickedAt);
    const myActiveIdx=active.indexOf(myId);
    const nextK=active[(myActiveIdx+1)%active.length];

    // â”€â”€ æ›´æ–°æœ¬ç©å®¶é¤˜é¡ â”€â”€
    let updates={
        [`players/${myId}/balance`]:nBal, pool:nPool, deck, c3:c3||null,
        statusMsg:msg, gameState:'waiting_deal', currentPlayerKey:nextK,
        lastActionTime:firebase.database.ServerValue.TIMESTAMP
    };

    // â”€â”€ å–å¾—æ­¤æ¬¡å‹•ä½œå¾Œå„ç©å®¶é¤˜é¡ï¼ˆç”¨æ–¼çµæŸåˆ¤æ–·ï¼‰ â”€â”€
    const balMap={};
    active.forEach(k=>{ balMap[k]=(k===myId)?nBal:localData.players[k].balance; });

    // â”€â”€ åˆ¤æ–·ï¼šæ˜¯å¦æœ‰ç©å®¶æ­¸é›¶ä»¥ä¸‹ï¼Ÿ â”€â”€
    const brokeKeys=active.filter(k=>balMap[k]<=0);
    const poolAfter=nPool;
    const minPoolNeeded=localData.entryFee*active.length;

    if(brokeKeys.length>0 && poolAfter<=0){
        // â”â” ç‹€æ³ä¸€ï¼šæ± å­æ­¸é›¶ ä¸” æœ‰äººç ´ç”¢ â†’ çµå±€ï¼Œå›å¤§å»³ â”â”
        const rankings=active
            .map(k=>({name:localData.players[k].name, balance:balMap[k]}))
            .sort((a,b)=>b.balance-a.balance);

        // èŠå¤©å®¤è²¼çµç®—
        let rankMsg='ğŸ† æœ¬å±€çµç®—ï¼š';
        rankings.forEach((r,i)=>{ rankMsg+=`\n${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||`${i+1}.`} ${r.name} $${r.balance}`; });
        chatRef.push({uid:'system',text:rankMsg,time:firebase.database.ServerValue.TIMESTAMP});

        // å»£æ’­ gameOver è¨Šè™Ÿï¼ˆå¸¶æœ€å¾Œç‰Œé¢ï¼‰
        updates.gameOverSignal=Date.now().toString();
        updates.gameOverRankings=rankings;
        updates.gameOverLastCards={ c1:localData.c1||null, c2:localData.c2||null, c3:c3||null };

        // 15ç§’å¾Œé‡ç½®åˆ°å¤§å»³
        setTimeout(()=>{
            gameRef.update({gameStarted:false,c1:null,c2:null,c3:null,currentPlayerKey:null,gameOverSignal:null,gameOverRankings:null,gameOverLastCards:null});
        },15000);

    } else if(poolAfter<=0 && active.every(k=>balMap[k]>0)){
        // â”â” ç‹€æ³äºŒï¼šæ± å­æ­¸é›¶ï¼Œä½†æ‰€æœ‰äººéƒ½æœ‰éŒ¢ â†’ è‡ªå‹•è£œåº•ï¼ˆç„¡è«– autoRefill è¨­å®šï¼‰ â”â”
        let total=0;
        active.forEach(k=>{ updates[`players/${k}/balance`]=balMap[k]-localData.entryFee; total+=localData.entryFee; });
        updates.pool=poolAfter+total;
        showRefillToast(localData.entryFee,active.length);

    } else if(localData.autoRefill && poolAfter>0 && poolAfter<minPoolNeeded){
        // â”â” ç‹€æ³ä¸‰ï¼ˆautoRefillé–‹å•Ÿï¼‰ï¼šæ± å­>0ä½†ä½æ–¼åº•ç·š â†’ è£œåº• â”â”
        let total=0;
        active.forEach(k=>{ updates[`players/${k}/balance`]=balMap[k]-localData.entryFee; total+=localData.entryFee; });
        updates.pool=poolAfter+total;
        showRefillToast(localData.entryFee,active.length);
    }
    // â”â” ç‹€æ³å››ï¼ˆautoRefillé—œé–‰ï¼‰ï¼šæ± å­>0ä½†ä½ â†’ ä¸è£œï¼Œç¹¼çºŒç©ç›´åˆ°æ­¸é›¶ â”â”

    if(type!=='fold'&&c3){
        updates.lastShot={
            id:Date.now().toString(), shooterId:myId, card:c3, resultType,
            emoji:resultType==='win'?'ğŸ‰':resultType==='crash'?'ğŸ’¥':'ğŸ˜­',
            text:resultType==='win'?(type==='up'||type==='down'?'çŒœå°!':'å°„é€²!'):resultType==='crash'?'æ’æŸ±!!':(type==='up'||type==='down'?'çŒœéŒ¯äº†':'æ²’é€²...'),
            delta:deltaAmount
        };
    }

    gameRef.update(updates);
    document.getElementById('bet-amount').value=0;

    if(type!=='fold'&&c3){
        document.getElementById('gate-inner').style.display='none';
        animateShotCard(c3,resultType,()=>{
            updateGateCard(c3);
            if(resultType==='win'){ playSfx('sfx-win'); spawnConfetti(40); showResultBanner('ğŸ‰',type==='up'?'çŒœå°!':'å°„é€²!',deltaAmount,'win'); }
            else if(resultType==='crash'){ playSfx('sfx-crash'); showResultBanner('ğŸ’¥','æ’æŸ±!!',deltaAmount,'crash'); }
            else{ playSfx('sfx-lose'); showResultBanner('ğŸ˜­',type==='up'||type==='down'?'çŒœéŒ¯äº†':'æ²’é€²...',deltaAmount,'lose'); }
        });
    } else {
        playSfx('sfx-fold');
        showResultBanner('ğŸ³ï¸','æ£„ç‰Œ',deltaAmount,'fold');
    }
}

function onDeckClick(){
    unlockAudio();
    if(!localData.gameStarted) return;
    if(localData.currentPlayerKey!==myId) return;
    if(localData.gameState==='waiting_deal'){
        drawGoalPost();
    } else if(localData.gameState==='waiting_shoot'){
        const bet=Math.abs(parseInt(document.getElementById('bet-amount').value))||0;
        const isSame=localData.c1&&localData.c2&&localData.c1.val===localData.c2.val;
        if(bet<1||bet>localData.pool){
            const h=document.getElementById('deck-hint');
            h.innerText='âš ï¸ è«‹å…ˆä¸‹æ³¨!'; h.classList.add('show');
            setTimeout(()=>{ h.innerText='ä¸‹æ³¨å¾Œé»æ“Šå°„é–€'; },1500); return;
        }
        if(isSame){
            const h=document.getElementById('deck-hint');
            h.innerText='âš ï¸ è«‹çŒœå¤§æˆ–çŒœå°'; h.classList.add('show');
            setTimeout(()=>{ h.innerText='çŒœå¤§/çŒœå°'; },1500);
        } else { handleAction('shoot'); }
    }
}

/* â•â•â•â• ç±Œç¢¼å †æ¸²æŸ“ç³»çµ± â•â•â•â• */
// ç±Œç¢¼å®šç¾©ï¼šé¢å€¼ã€é¡è‰²ä¸»é¡Œ
const CHIP_DEFS = [
    { val:1000, fill:'#7d6608', stroke:'#f0d060', inner:'#9a7d0a', label:'1K',   dot:'#f5e97a' },
    { val:500,  fill:'#145a32', stroke:'#58d68d', inner:'#1e8449', label:'500',  dot:'#7deba4' },
    { val:100,  fill:'#641e16', stroke:'#e74c3c', inner:'#922b21', label:'100',  dot:'#f08070' },
    { val:50,   fill:'#154360', stroke:'#76d7ea', inner:'#1a6080', label:'50',   dot:'#a8e8f5' },
    { val:10,   fill:'#1a3a6e', stroke:'#3498db', inner:'#1f618d', label:'10',   dot:'#85c1e9' },
];

// æŠŠé‡‘é¡åˆ†è§£æˆç±Œç¢¼çµ„åˆï¼ˆè²ªå¿ƒï¼‰
function breakdownChips(amount){
    let remaining = Math.max(0, Math.round(amount));
    const result = [];
    for(const chip of CHIP_DEFS){
        if(remaining >= chip.val){
            const count = Math.min(Math.floor(remaining / chip.val), 12); // æœ€å¤š12æšä¸€æŸ±
            result.push({ ...chip, count });
            remaining -= chip.val * count;
        }
    }
    return result;
}

// ç•«å–®æšç±Œç¢¼ SVGï¼ˆè¶…çœŸå¯¦æ„Ÿï¼š3Då´é¢åšåº¦ + å…‰æ¾¤ + åˆ»ç´‹ï¼‰
function makeChipSVG(chip, size=38){
    const r = size/2 - 2;
    const cx = size/2, cy = size/2;
    // åˆ»ç—•ä½ç½®ï¼ˆ8å€‹ï¼‰
    const notchAngles = [0, 45, 90, 135, 180, 225, 270, 315];
    const notches = notchAngles.map(deg => {
        const rad = deg * Math.PI / 180;
        const x1 = cx + (r-1)*Math.cos(rad), y1 = cy + (r-1)*Math.sin(rad);
        const x2 = cx + (r+2)*Math.cos(rad), y2 = cy + (r+2)*Math.sin(rad);
        return `<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}" stroke="${chip.dot}" stroke-width="2.5" stroke-linecap="round"/>`;
    }).join('');

    // åº•éƒ¨é™°å½±ï¼ˆ3Dæ„Ÿï¼‰
    const shadowR = r + 1;
    // æ–‡å­—å¤§å°
    const fs = chip.label.length >= 3 ? size*0.22 : size*0.26;

    return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <radialGradient id="cg_${chip.val}" cx="38%" cy="32%" r="65%">
      <stop offset="0%" stop-color="${lighten(chip.inner,40)}"/>
      <stop offset="45%" stop-color="${chip.inner}"/>
      <stop offset="100%" stop-color="${darken(chip.fill,20)}"/>
    </radialGradient>
    <radialGradient id="shine_${chip.val}" cx="35%" cy="25%" r="55%">
      <stop offset="0%" stop-color="rgba(255,255,255,0.38)"/>
      <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
    </radialGradient>
  </defs>
  <!-- åº•éƒ¨é™°å½±åœ“ -->
  <ellipse cx="${cx}" cy="${cy+2}" rx="${shadowR}" ry="${shadowR*0.25}" fill="rgba(0,0,0,0.35)"/>
  <!-- ä¸»åœ“ç›¤ -->
  <circle cx="${cx}" cy="${cy}" r="${r}" fill="url(#cg_${chip.val})" stroke="${chip.stroke}" stroke-width="2.2"/>
  <!-- å¤–ç’°è™›ç·š -->
  <circle cx="${cx}" cy="${cy}" r="${r-4}" fill="none" stroke="${chip.dot}" stroke-width="1.2" stroke-dasharray="4 2.5" opacity="0.7"/>
  <!-- å…§åœ“ -->
  <circle cx="${cx}" cy="${cy}" r="${r-9}" fill="${chip.inner}" opacity="0.6"/>
  <!-- åˆ»ç—• -->
  ${notches}
  <!-- å…‰æ¾¤ -->
  <circle cx="${cx}" cy="${cy}" r="${r}" fill="url(#shine_${chip.val})"/>
  <!-- é¢å€¼æ–‡å­— -->
  <text x="${cx}" y="${cy+fs*0.38}" text-anchor="middle" fill="white"
    font-size="${fs.toFixed(1)}" font-weight="bold" font-family="Arial,sans-serif"
    style="text-shadow:0 1px 2px rgba(0,0,0,0.8)">${chip.label}</text>
</svg>`;
}

// è‰²å½©å·¥å…·
function lighten(hex, pct){
    const n=parseInt(hex.slice(1),16);
    const r=Math.min(255,((n>>16)&0xff)+pct), g=Math.min(255,((n>>8)&0xff)+pct), b=Math.min(255,(n&0xff)+pct);
    return `rgb(${r},${g},${b})`;
}
function darken(hex, pct){
    const n=parseInt(hex.slice(1),16);
    const r=Math.max(0,((n>>16)&0xff)-pct), g=Math.max(0,((n>>8)&0xff)-pct), b=Math.max(0,(n&0xff)-pct);
    return `rgb(${r},${g},${b})`;
}

let _lastPoolRendered = -1;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   seededRandï¼šç”¨é‡‘é¡ç•¶ç¨®å­ç”¢ç”Ÿå›ºå®šäº‚æ•¸ï¼Œ
   é€™æ¨£åŒä¸€å€‹é‡‘é¡æ¯æ¬¡åˆ·æ–°ä½ç½®ä¸æœƒæŠ–å‹•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function seededRand(seed){
    let s = seed;
    return function(){
        s = (s * 1664525 + 1013904223) & 0xffffffff;
        return (s >>> 0) / 0xffffffff;
    };
}

function renderPoolChips(amount){
    if(amount === _lastPoolRendered) return;
    _lastPoolRendered = amount;

    const container = document.getElementById('pool-chip-stack');
    const textEl    = document.getElementById('pool-amount-text');
    if(!container) return;

    /* æ›´æ–°é‡‘é¡æ–‡å­— */
    if(textEl){
        textEl.innerText = `ğŸ’° $${amount.toLocaleString()}`;
        textEl.classList.remove('pool-pop');
        void textEl.offsetWidth;
        textEl.classList.add('pool-pop');
        setTimeout(()=>textEl.classList.remove('pool-pop'), 500);
    }

    container.innerHTML = '';
    if(amount <= 0) return;

    /* â”€â”€ 1. æ±ºå®šè¦é¡¯ç¤ºå“ªäº›ç±Œç¢¼ï¼ˆæœ€å¤šé¡¯ç¤º 20 æšï¼Œå¤ªå¤šå°±ç²¾ç°¡ï¼‰ â”€â”€ */
    const chips = breakdownChips(amount);   // [{...chip, count}, ...]
    // å±•å¹³æˆä¸€å€‹é™£åˆ—ï¼Œcount > 6 çš„é¢å€¼æœ€å¤šé¡¯ç¤º6æšï¼ˆé¿å…æ»¿å‘æ»¿è°·ï¼‰
    const flat = [];
    chips.forEach(chip => {
        const show = Math.min(chip.count, 6);
        for(let i=0; i<show; i++) flat.push(chip);
    });
    // æœ€å¤š 22 æšï¼Œå†å¤šæˆªæ–·
    if(flat.length > 22) flat.length = 22;

    /* â”€â”€ 2. å®¹å™¨å°ºå¯¸ï¼ˆéŸ¿æ‡‰å¼ï¼‰ â”€â”€ */
    const W = 130, H = 56;          // é…åˆ CSS è£¡çš„ 130x56
    const chipSize = flat.length > 14 ? 28 : flat.length > 9 ? 31 : 34;
    const half = chipSize / 2;

    /* â”€â”€ 3. ç”¨ã€Œseeded + æ’æ–¥åŠ›ã€æ•£è½ï¼Œè®“å®ƒè‡ªç„¶ä½†ä¸é‡ç–Šå¤ªåš´é‡ â”€â”€ */
    const rand = seededRand(amount);  // é‡‘é¡ç•¶ç¨®å­ â†’ åŒé‡‘é¡ä½ç½®å›ºå®š
    const placed = [];                // å·²æ”¾å¥½çš„åº§æ¨™

    flat.forEach((chip, idx) => {
        // å˜—è©¦æœ€å¤š 30 æ¬¡æ‰¾ä¸€å€‹ã€Œä¸å¤ªæ“ ã€çš„ä½ç½®
        let bestX = rand() * (W - chipSize) + half;
        let bestY = rand() * (H - chipSize) + half;
        let bestScore = -Infinity;

        for(let attempt = 0; attempt < 30; attempt++){
            const cx = rand() * (W - chipSize*0.6) + chipSize*0.3;
            const cy = rand() * (H - chipSize*0.6) + chipSize*0.3;
            // è©•åˆ†ï¼šè·é›¢æ‰€æœ‰å·²æ”¾ç±Œç¢¼è¶Šé è¶Šå¥½ï¼ˆä½†ä¸è¶…éå®¹å™¨é‚Šç•Œå¤ªå¤šï¼‰
            let minDist = Infinity;
            placed.forEach(p => {
                const d = Math.hypot(cx - p.x, cy - p.y);
                if(d < minDist) minDist = d;
            });
            const score = placed.length === 0 ? 999 : minDist;
            if(score > bestScore){ bestScore = score; bestX = cx; bestY = cy; }
        }
        placed.push({ x: bestX, y: bestY });

        /* éš¨æ©Ÿæ—‹è½‰ Â±35Â° */
        const rotDeg = (rand() - 0.5) * 70;
        const delay  = idx * 35;

        const el = document.createElement('div');
        el.className = 'chip-coin';
        // CSS è‡ªè¨‚å±¬æ€§è®“ @keyframes è®€åˆ°æ—‹è½‰å€¼ï¼ˆä¿æŒå‹•ç•«ä¸­æ—‹è½‰ä¸€è‡´ï¼‰
        el.style.cssText = `
            left:${(bestX - half).toFixed(1)}px;
            top:${(bestY  - half).toFixed(1)}px;
            width:${chipSize}px; height:${chipSize}px;
            z-index:${idx};
            --chip-rot:rotate(${rotDeg.toFixed(1)}deg);
            transform:rotate(${rotDeg.toFixed(1)}deg);
            animation-delay:${delay}ms;
        `;
        el.innerHTML = makeChipSVG(chip, chipSize);
        container.appendChild(el);
    });
}

/* â•â•â•â• renderUI â•â•â•â• */
function renderUI(isHost){
    const newPool = localData.pool || 0;
    renderPoolChips(newPool);

    document.getElementById('status-msg').innerText = localData.statusMsg || '';
    document.getElementById('cards-left').innerText = localData.deck ? localData.deck.length : 0;
    document.getElementById('fold-cost-ui').innerText = localData.foldPenalty || 20;
    updateCard('c1', localData.c1); updateCard('c2', localData.c2); updateGateCard(localData.c3);

    const isTurn  = (localData.currentPlayerKey === myId);
    const isSame  = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;
    const deckEl  = document.getElementById('deck-stack');
    const hintEl  = document.getElementById('deck-hint');
    const badgeEl = document.getElementById('deck-badge');
    if(badgeEl) badgeEl.innerText = localData.deck ? localData.deck.length : 0;

    if(isTurn && localData.gameState === 'waiting_deal'){ deckEl.classList.add('can-click'); hintEl.innerText='é»æ“ŠæŠ½ç‰Œ'; hintEl.classList.add('show'); }
    else if(isTurn && localData.gameState === 'waiting_shoot'){ deckEl.classList.add('can-click'); hintEl.innerText=isSame?'çŒœå¤§/çŒœå°':'ä¸‹æ³¨å¾Œé»æ“Šå°„é–€'; hintEl.classList.add('show'); }
    else{ deckEl.classList.remove('can-click'); hintEl.classList.remove('show'); }

    document.getElementById('bet-panel').style.display = (isTurn && localData.gameState === 'waiting_shoot') ? 'flex' : 'none';
    document.getElementById('btn-up').style.display   = isSame ? 'inline-block' : 'none';
    document.getElementById('btn-down').style.display = isSame ? 'inline-block' : 'none';
}

/* â•â•â•â• è§€çœ¾æ¨¡å¼ UIï¼ˆåªçœ‹ä¸æ“ä½œï¼‰â•â•â•â• */
function renderUISpectator(){
    renderPoolChips(localData.pool||0);
    document.getElementById('status-msg').innerText=localData.statusMsg||'';
    document.getElementById('cards-left').innerText=localData.deck?localData.deck.length:0;
    updateCard('c1',localData.c1); updateCard('c2',localData.c2); updateGateCard(localData.c3);
    document.getElementById('bet-panel').style.display='none';
    const deckEl=document.getElementById('deck-stack');
    deckEl.classList.remove('can-click');
    document.getElementById('deck-hint').classList.remove('show');
    document.getElementById('deck-badge').innerText=localData.deck?localData.deck.length:0;
}

/* â•â•â•â• éŠæˆ²çµæŸçµç®— â•â•â•â• */
let _gameOverShown=false;
function showGameOver(rankings, lastCards){
    if(_gameOverShown) return;
    _gameOverShown=true;
    const box=document.getElementById('gameover-rankings');
    box.innerHTML='';

    // é¡¯ç¤ºæœ€å¾Œç‰Œé¢
    if(lastCards && (lastCards.c1||lastCards.c2||lastCards.c3)){
        const cardDiv=document.createElement('div');
        cardDiv.style.cssText='display:flex;justify-content:center;gap:8px;margin-bottom:14px;';
        const mkCard=(c,label)=>{
            if(!c) return `<div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><span style="font-size:0.7rem;color:#888;">${label}</span><div style="width:44px;height:62px;border-radius:6px;border:1.5px dashed rgba(212,175,55,0.3);background:rgba(212,175,55,0.04);"></div></div>`;
            const isRed=c.suit==='â™¥'||c.suit==='â™¦';
            return `<div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><span style="font-size:0.7rem;color:#888;">${label}</span><div style="width:44px;height:62px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px;font-weight:bold;color:${isRed?'#e74c3c':'#111'};border:2px solid #ccc;white-space:pre;">${c.suit}\n${c.label||c.val}</div></div>`;
        };
        cardDiv.innerHTML=mkCard(lastCards.c1,'å·¦æŸ±')+mkCard(lastCards.c3,'é–€ç‰Œ')+mkCard(lastCards.c2,'å³æŸ±');
        box.appendChild(cardDiv);
    }

    rankings.forEach((r,i)=>{
        const row=document.createElement('div');
        row.className='rank-row'+(i===0?' rank-1st':'');
        const medal=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||`${i+1}.`;
        const balClass=r.balance>=0?'pos':'neg';
        row.innerHTML=`<span class="rank-name">${medal} ${r.name}</span><span class="rank-bal ${balClass}">$${r.balance}</span>`;
        box.appendChild(row);
    });
    document.getElementById('gameover-overlay').classList.add('show');
    setTimeout(()=>{
        document.getElementById('gameover-overlay').classList.remove('show');
        _gameOverShown=false;
    },15000);
}
function updateGateCard(c){
    const gi=document.getElementById('gate-inner'), c3g=document.getElementById('c3-in-gate');
    if(!c){ gi.style.display=''; gi.innerText='å¾…å°„é–€'; c3g.style.display='none'; c3g.innerHTML=''; }
    else{
        gi.style.display='none';
        const isRed=c.suit==='â™¥'||c.suit==='â™¦'; c3g.style.display='block';
        const w='clamp(44px,7.5vmin,68px)',h='clamp(62px,10.5vmin,96px)';
        c3g.innerHTML=`<div class="card${isRed?' red':''}" style="width:${w};height:${h};">${c.suit}\n${c.label}</div>`;
    }
}
function updateCard(id,c){
    const el=document.getElementById(id);
    if(!c){ el.classList.add('hidden'); el.innerText='?'; }
    else{ el.classList.remove('hidden'); el.innerText=`${c.suit}\n${c.label}`; el.classList.toggle('red',c.suit==='â™¥'||c.suit==='â™¦'); }
}

/* â•â•â•â• é£›ç‰Œå‹•ç•«ï¼ˆå¾ç‰Œå †é ‚ç«¯æ‹”å‡ºï¼Œæ—‹è½‰å°„å‘ç›®æ¨™ï¼‰â•â•â•â• */
function animateShotCard(cardData,resultType,onDone){
    const canvas=document.getElementById('shot-canvas'), ctx=canvas.getContext('2d');
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    function tr(rect){ return{x:rect.left+rect.width/2,y:rect.top+rect.height/2}; }
    const gate=tr(document.getElementById('gate-frame').getBoundingClientRect());
    const deck=tr(document.getElementById('deck-stack').getBoundingClientRect());
    const lpost=tr(document.getElementById('c1').getBoundingClientRect());
    const rpost=tr(document.getElementById('c2').getBoundingClientRect());
    const isRed=cardData.suit==='â™¥'||cardData.suit==='â™¦';
    const cardW=62,cardH=88;
    let endX,endY;
    if(resultType==='win'){ endX=gate.x; endY=gate.y; }
    else if(resultType==='crash'){ const pp=Math.random()>0.5?lpost:rpost; endX=pp.x; endY=pp.y; }
    else{ endX=Math.random()>0.5?-cardW:canvas.width+cardW; endY=gate.y-30; }

    // æ§åˆ¶é»ï¼šå¾ç‰Œå †å¾€ä¸Šæ‹”å‡ºå†å°„å‘ç›®æ¨™ï¼ˆå¼§å½¢è»Œè·¡ï¼‰
    const pullUpY = deck.y - 120; // å…ˆå¾€ä¸Šæ‹”å‡ºæ•ˆæœ
    const cpX=(deck.x+endX)/2+(Math.random()-0.5)*80;
    const cpY=Math.min(deck.y,endY)-160;
    let t=0,rotation=0;
    let trail=[];
    let particles=[];

    function drawCardFace(x,y,rot,alpha,scale=1){
        ctx.save(); ctx.globalAlpha=alpha; ctx.translate(x,y); ctx.rotate(rot); ctx.scale(scale,scale);
        ctx.shadowColor='rgba(0,0,0,0.6)'; ctx.shadowBlur=18; ctx.shadowOffsetX=4; ctx.shadowOffsetY=4;
        // å¡èƒŒâ†’æ­£é¢åˆ‡æ›ï¼šæ—‹è½‰åˆ°ä¸€åŠé¡¯ç¤ºæ­£é¢
        const showFace = (rotation % (Math.PI*2)) > Math.PI*0.5;
        ctx.fillStyle=showFace?'#fff':'#1e3a64';
        ctx.strokeStyle=showFace?'#bbb':'#3a6a9f';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(-cardW/2+8,-cardH/2); ctx.lineTo(cardW/2-8,-cardH/2);
        ctx.quadraticCurveTo(cardW/2,-cardH/2,cardW/2,-cardH/2+8);
        ctx.lineTo(cardW/2,cardH/2-8); ctx.quadraticCurveTo(cardW/2,cardH/2,cardW/2-8,cardH/2);
        ctx.lineTo(-cardW/2+8,cardH/2); ctx.quadraticCurveTo(-cardW/2,cardH/2,-cardW/2,cardH/2-8);
        ctx.lineTo(-cardW/2,-cardH/2+8); ctx.quadraticCurveTo(-cardW/2,-cardH/2,-cardW/2+8,-cardH/2);
        ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
        if(showFace){
            // å¡ç‰‡å…‰æ¾¤
            const grad=ctx.createLinearGradient(-cardW/2,-cardH/2,cardW/2,cardH/2);
            grad.addColorStop(0,'rgba(255,255,255,0.35)');
            grad.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle=grad; ctx.fill();
            // èŠ±è‰²
            ctx.fillStyle=isRed?'#e74c3c':'#111'; ctx.font="bold 24px Arial";
            ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(cardData.suit,0,-13); ctx.fillText(cardData.label.toString(),0,15);
            // è§’è½å°å­—
            ctx.font="bold 11px Arial"; ctx.textAlign='left'; ctx.textBaseline='top';
            ctx.fillText(cardData.label,-cardW/2+5,-cardH/2+5);
        } else {
            // å¡èƒŒèŠ±ç´‹
            ctx.strokeStyle='rgba(100,160,255,0.3)'; ctx.lineWidth=1;
            ctx.strokeRect(-cardW/2+6,-cardH/2+6,cardW-12,cardH-12);
        }
        ctx.restore();
    }

    // æ‹‰å‡ºå‹•ç•«ï¼ˆå…ˆä¸Šæ‹‰0.3ç§’ï¼‰
    let phase='pull',it=0, pullT=0;
    const PULL_FRAMES=15;

    function spawnCrash(x,y){ for(let i=0;i<32;i++){ const a=Math.random()*Math.PI*2,s=3+Math.random()*9; particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,r:4+Math.random()*5,color:Math.random()>0.5?'#f39c12':'#e74c3c'}); } }
    function spawnWin(x,y){ for(let i=0;i<50;i++){ const a=Math.random()*Math.PI*2,s=2+Math.random()*10; particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-3,life:1,r:3+Math.random()*6,color:['#f1c40f','#2ecc71','#fff','#d4af37','#3498db'][Math.floor(Math.random()*5)]}); } }

    function frame(){
        ctx.clearRect(0,0,canvas.width,canvas.height);

        if(phase==='pull'){
            pullT++;
            const prog=pullT/PULL_FRAMES;
            const eased=prog<0.5?2*prog*prog:-1+(4-2*prog)*prog;
            const y=deck.y-eased*80;
            rotation+=0.12;
            drawCardFace(deck.x,y,rotation,Math.min(1,prog*2));
            if(pullT>=PULL_FRAMES){ phase='fly'; t=0; }
            requestAnimationFrame(frame);
        } else if(phase==='fly'){
            t++; const pp=t/55, e=pp<0.5?2*pp*pp:-1+(4-2*pp)*pp;
            const startX=deck.x, startY=deck.y-80; // å¾æ‹”å‡ºä½ç½®é–‹å§‹
            const bx=(1-e)*(1-e)*startX+2*(1-e)*e*cpX+e*e*endX;
            const by=(1-e)*(1-e)*startY+2*(1-e)*e*cpY+e*e*endY;
            rotation+=0.22; // æ—‹è½‰é£›è¡Œ

            // æ‹–å°¾ç‰¹æ•ˆ
            trail.push({x:bx,y:by,life:1});
            trail.forEach(tr=>{ tr.life-=0.08; });
            trail=trail.filter(tr=>tr.life>0);
            trail.forEach(tr=>{
                ctx.save(); ctx.globalAlpha=tr.life*0.4;
                ctx.fillStyle=isRed?'rgba(231,76,60,0.6)':'rgba(100,150,255,0.5)';
                ctx.beginPath(); ctx.arc(tr.x,tr.y,10*tr.life,0,Math.PI*2); ctx.fill();
                ctx.restore();
            });

            drawCardFace(bx,by,rotation,Math.min(1,pp*3));
            if(t>=55){ phase='impact'; it=0; if(resultType==='crash') spawnCrash(endX,endY); if(resultType==='win') spawnWin(endX,endY); }
            requestAnimationFrame(frame);
        } else if(phase==='impact'){
            it++;
            if(resultType==='win'){
                particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=0.032;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
                particles=particles.filter(p=>p.life>0);
                const rings=[1,0.65,0.4];
                rings.forEach((factor,ri)=>{
                    const r=(40+it*5)*factor, a=Math.max(0,(1-it/28))*factor;
                    if(a>0){ ctx.save(); ctx.strokeStyle=`rgba(46,204,113,${a})`; ctx.lineWidth=3-ri; ctx.beginPath(); ctx.arc(endX,endY,r,0,Math.PI*2); ctx.stroke(); ctx.restore(); }
                });
                // å‹åˆ©å…‰æšˆ
                if(it<15){
                    ctx.save(); ctx.globalAlpha=(15-it)/15*0.4;
                    const grd=ctx.createRadialGradient(endX,endY,0,endX,endY,80);
                    grd.addColorStop(0,'rgba(46,204,113,0.8)'); grd.addColorStop(1,'transparent');
                    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(endX,endY,80,0,Math.PI*2); ctx.fill();
                    ctx.restore();
                }
                const sc=1-it/28, a=1-it/22; if(a>0) drawCardFace(endX,endY,0,a,sc<0.5?0.5:sc);
            }
            else if(resultType==='crash'){
                particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.35;p.life-=0.04;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
                particles=particles.filter(p=>p.life>0);
                // æ’æ“Šéœ‡å‹•
                drawCardFace(endX+(Math.random()-0.5)*(14-it*0.5),endY+(Math.random()-0.5)*5,Math.random()*0.4,Math.max(0,1-it/22));
                // æ’æ“Šå…‰
                if(it<10){ ctx.save(); ctx.globalAlpha=(10-it)/10*0.5; ctx.fillStyle='rgba(243,156,18,0.7)'; ctx.beginPath(); ctx.arc(endX,endY,50-it*4,0,Math.PI*2); ctx.fill(); ctx.restore(); }
            }
            else{
                // æ²’é€²ï¼Œé£›å‡ºç•«é¢
                const a=Math.max(0,1-it/15), fly=it*10, dir=endX<canvas.width/2?-1:1;
                drawCardFace(endX+dir*fly,endY-fly*0.15,rotation+it*0.25,a);
            }
            if(it>=32||(resultType==='lose'&&it>=18)){ ctx.clearRect(0,0,canvas.width,canvas.height); if(onDone) onDone(); return; }
            requestAnimationFrame(frame);
        }
    }
    requestAnimationFrame(frame);
}

/* â•â•â•â• å…¶ä»–å·¥å…· â•â•â•â• */
function showResultBanner(emoji,text,amount,type){
    const b=document.getElementById('result-banner');
    document.getElementById('rb-emoji').innerText=emoji;
    document.getElementById('rb-text').innerText=text;
    const ae=document.getElementById('rb-amount');
    ae.innerText=(amount>=0?'+':'')+'$'+amount;
    ae.className='rb-amount '+(amount>=0?'positive':'negative');
    // æ ¹æ“šçµæœè¨­å®šé¡è‰²ä¸»é¡Œ
    b.className=''; // æ¸…é™¤èˆŠ class
    b.classList.add(type==='win'?'type-win':type==='crash'?'type-crash':'type-lose');
    b.classList.remove('show'); b.style.display='block';
    requestAnimationFrame(()=>requestAnimationFrame(()=>b.classList.add('show')));
    setTimeout(()=>{ b.classList.remove('show'); setTimeout(()=>b.style.display='none',400); },2800);
}
function spawnConfetti(count){
    const cols=['#f1c40f','#2ecc71','#3498db','#e74c3c','#9b59b6','#fff'];
    for(let i=0;i<count;i++){
        const el=document.createElement('div'); el.className='confetti-piece';
        el.style.left=Math.random()*100+'vw'; el.style.background=cols[Math.floor(Math.random()*cols.length)];
        el.style.animationDuration=(1.5+Math.random()*1.5)+'s'; el.style.animationDelay=(Math.random()*0.5)+'s';
        document.body.appendChild(el); setTimeout(()=>el.remove(),3500);
    }
}
function addBet(v){ let cur=parseInt(document.getElementById('bet-amount').value)||0; document.getElementById('bet-amount').value=Math.min(cur+v,localData.pool); }
function setAllIn(){
    unlockAudio();
    document.getElementById('allin-pool-preview').innerText='$'+(localData.pool||0);
    document.getElementById('all-in-confirm-overlay').classList.add('show');
}
function cancelAllIn(){ document.getElementById('all-in-confirm-overlay').classList.remove('show'); }
function confirmAllIn(){
    unlockAudio();
    // æ’­ ALL IN éŸ³æ•ˆï¼ˆWebAudio bufferï¼Œæœ€å¯é ï¼‰
    playAllinSound();
    // é¡¯ç¤º GIFï¼ˆä¸éœ€æ‰‹å‹¢è§£é–ï¼Œç›´æ¥è¨­ src å³å¯æ’­å‹•ç•«ï¼‰
    showAllinGif();
    document.getElementById('all-in-confirm-overlay').classList.remove('show');
    gameRef.update({allInTrigger:getServerNow().toString()});
    document.getElementById('bet-amount').value = localData.pool;
}

/* GIF æ§åˆ¶ï¼šé€éé‡è¨­ src è®“ GIF å¾é ­æ’­ */
function showAllinGif(){
    const gif = document.getElementById('allin-gif');
    const box = document.getElementById('gif-box');
    if(!gif || !box) return;
    // é‡è¨­ src â†’ GIF å¾é ­æ’­æ”¾
    gif.src = '';
    // æ”¾åˆ° gif-box å®¹å™¨
    if(!box.contains(gif)) box.appendChild(gif);
    gif.style.display = 'block';
    // ç”¨æ™‚é–“æˆ³é˜²æ­¢ç€è¦½å™¨å¿«å–ï¼ˆè®“ GIF æ¯æ¬¡é‡æ’­ï¼‰
    setTimeout(()=>{ gif.src = 'allin.gif?' + Date.now(); }, 10);
}
function hideAllinGif(){
    const gif = document.getElementById('allin-gif');
    if(gif){ gif.src=''; gif.style.display='none'; }
}
function hostResetToLobby(){ if(confirm('é‡è£½å¤§å»³ç‹€æ…‹?')) gameRef.update({gameStarted:false}); }
/* â•â•â•â• çœŸå¯¦æ´—ç‰Œï¼ˆRiffle Shuffle æ¨¡æ“¬ï¼‰+ åˆ‡ç‰Œ â•â•â•â•
   æ¨¡æ“¬çœŸå¯¦ç´™ç‰Œæ´—ç‰Œï¼šä»¥ Riffle Shuffle ç‚ºä¸»ï¼ˆæŠ½å–ä¸å®Œç¾çš„é–“éš”äº¤å‰ï¼‰ï¼Œ
   é‡è¤‡ 7 æ¬¡ï¼ˆæ•¸å­¸ä¸Š7æ¬¡ Riffle = æ¥è¿‘éš¨æ©Ÿï¼‰ï¼ŒåŠ å…¥åˆ‡ç‰Œã€‚
   é€™æ¨£ç›¸é„°ç‰Œä»æœ‰çœŸå¯¦çš„é—œè¯æ€§ï¼ˆä¸åƒç´”äº‚æ•¸é‚£éº¼æ¥µç«¯ï¼‰ï¼Œæ›´è²¼è¿‘çœŸå¯¦ç‰Œæ¡Œã€‚
â•â•â•â• */
function riffleShuffle(deck){
    const half1 = deck.slice(0, Math.floor(deck.length/2));
    const half2 = deck.slice(Math.floor(deck.length/2));
    const result = [];
    let i=0, j=0;
    while(i<half1.length || j<half2.length){
        // æ¨¡æ“¬ç¾å¯¦ï¼šæ¯æ¬¡å¾å“ªå´å–ç‰Œçš„æ©Ÿç‡èˆ‡å‰©é¤˜å¼µæ•¸æˆæ¯”ä¾‹ï¼ˆBinomial æ¨¡å‹ï¼‰
        const probLeft = half1.length-i > 0 ? (half1.length-i)/((half1.length-i)+(half2.length-j)) : 0;
        // æ¯æ¬¡å– 1~3 å¼µï¼ˆçœŸå¯¦æ‰‹æ„Ÿï¼šæœ‰æ™‚é€£å–ï¼‰
        const burst = Math.random()<0.3 ? 2 : 1; // 30%æ©Ÿç‡é€£å–2å¼µ
        if(Math.random()<probLeft){
            for(let b=0;b<burst&&i<half1.length;b++) result.push(half1[i++]);
        } else {
            for(let b=0;b<burst&&j<half2.length;b++) result.push(half2[j++]);
        }
    }
    return result;
}

function generateDecks(count){
    let deck=[];
    const suits=['â™ ','â™¥','â™¦','â™£'];
    // å…ˆæŒ‰èŠ±è‰²é †åºç–Šç‰Œï¼ˆæ¨¡æ“¬é–‹æ–°ç‰Œæ™‚çš„åˆå§‹ç‹€æ…‹ï¼‰
    for(let i=0;i<count;i++)
        suits.forEach(s=>{ for(let v=1;v<=13;v++) deck.push({val:v,suit:s,label:labels[v]||v}); });
    // é€²è¡Œ 7 æ¬¡ Riffle Shuffleï¼ˆæ•¸å­¸ä¸Š7æ¬¡å¾Œæ¥è¿‘å……åˆ†æ··åˆï¼‰
    for(let r=0;r<7;r++) deck=riffleShuffle(deck);
    // æ¨¡æ“¬åˆ‡ç‰Œï¼šæœ‰äº›è³­å ´æœƒåœ¨ä¸­æ®µéš¨æ©Ÿåˆ‡
    const cutMin=Math.floor(deck.length*0.3);
    const cutRange=Math.floor(deck.length*0.4);
    const cut=cutMin+Math.floor(Math.random()*cutRange);
    deck=[...deck.slice(cut),...deck.slice(0,cut)];
    return deck;
}


/* â•â•â•â• æ´—ç‰Œå‹•ç•«ï¼ˆå»£æ’­çµ¦æ‰€æœ‰äººçœ‹ï¼‰â•â•â•â• */
function playShuffleAnimation(onComplete, shufflerName){
    const overlay=document.getElementById('shuffle-overlay');
    const stage=document.getElementById('shuffle-stage');
    const bar=document.getElementById('shuffle-progress-bar');
    const nameEl=document.getElementById('shuffle-player-name');
    overlay.classList.add('show');
    stage.innerHTML='';
    bar.style.width='0%';
    if(nameEl) nameEl.innerText = shufflerName ? `${shufflerName} æ­£åœ¨æ´—ç‰Œ...` : '';

    // å»ºç«‹ 12 å¼µè™›æ“¬ç‰Œï¼ˆæ›´å¤šæ›´çœŸå¯¦ï¼‰
    const CARDS=12;
    const cards=[];
    const cx=130, cy=40; // ä¸­å¿ƒå †ä½ç½®
    for(let i=0;i<CARDS;i++){
        const el=document.createElement('div');
        el.className='shuf-card';
        el.style.left=(cx-3+i*0.5)+'px';
        el.style.top=(cy-i*1.2)+'px';
        el.style.zIndex=i;
        stage.appendChild(el);
        cards.push(el);
    }

    let step=0;
    const STEPS=7; // 7æ¬¡æ´—ç‰Œ

    function doShuffle(){
        if(step>=STEPS){
            // æ”¶å°¾ï¼šç‰Œé£›å›ä¸­å¤®å †ç–Š
            cards.forEach((c,i)=>{
                setTimeout(()=>{
                    c.style.left=(cx-3+i*0.5)+'px';
                    c.style.top=(cy-i*1.2)+'px';
                    c.style.transform='rotate(0deg) scale(1)';
                },i*30);
            });
            setTimeout(()=>{
                overlay.classList.remove('show');
                if(onComplete) onComplete();
            },CARDS*30+400);
            return;
        }

        const half=Math.ceil(CARDS/2);
        // å·¦å †
        cards.slice(0,half).forEach((c,i)=>{
            setTimeout(()=>{
                c.style.left=(30+i*3)+'px';
                c.style.top=(20+i*4)+'px';
                c.style.transform=`rotate(${-10-i*1.5}deg)`;
                c.style.zIndex=i;
            },i*20);
        });
        // å³å †
        cards.slice(half).forEach((c,i)=>{
            setTimeout(()=>{
                c.style.left=(190+i*3)+'px';
                c.style.top=(20+i*4)+'px';
                c.style.transform=`rotate(${10+i*1.5}deg)`;
                c.style.zIndex=i;
            },i*20);
        });

        setTimeout(()=>{
            // Riffle mergeå‹•ç•«ï¼šç‰Œäº¤éŒ¯åˆå›ä¸­å¤®
            const order=[];
            let l=0,r=half;
            while(l<half||r<CARDS){
                const probLeft=(half-l)/((half-l)+(CARDS-r)||1);
                if(r>=CARDS||(l<half&&Math.random()<probLeft)) order.push(l++);
                else order.push(r++);
            }
            order.forEach((origIdx,newPos)=>{
                const c=cards[origIdx];
                setTimeout(()=>{
                    c.style.left=(cx-4+newPos*0.5)+'px';
                    c.style.top=(cy-newPos*1.2)+'px';
                    c.style.transform=`rotate(${(Math.random()-0.5)*3}deg)`;
                    c.style.zIndex=newPos;
                },newPos*25);
            });
            step++;
            bar.style.width=(step/STEPS*100)+'%';
            setTimeout(doShuffle, CARDS*25+300);
        }, CARDS*20+250);
    }

    doShuffle();
}

/* â•â•â•â• å»£æ’­æ´—ç‰Œçµ¦æ‰€æœ‰äººçœ‹ â•â•â•â• */
function broadcastAndShuffle(onComplete, nameOverride){
    const name=nameOverride||myName;
    // å…ˆå»£æ’­æ´—ç‰Œé–‹å§‹
    gameRef.update({shufflingBy:name, shuffleTS:firebase.database.ServerValue.TIMESTAMP});
    playShuffleAnimation(()=>{
        // æ´—å®Œå¾Œæ¸…é™¤å»£æ’­æ——æ¨™
        gameRef.update({shufflingBy:null});
        if(onComplete) onComplete();
    }, name);
}


/* â•â•â•â• å¸¶å‹•ç•«çš„æŠ½æŸ±ç‰Œ â•â•â•â• */
function drawGoalPost(){
    playSfx('sfx-deal');
    let deck=localData.deck||[];
    if(deck.length<3) {
        // ç‰Œä¸å¤ ï¼Œéœ€è¦é‡æ–°æ´—ç‰Œï¼Œå»£æ’­æ´—ç‰Œå‹•ç•«çµ¦æ‰€æœ‰äººçœ‹
        broadcastAndShuffle(()=>{
            deck=generateDecks(localData.deckCount||2);
            const c1=deck.pop(), c2=deck.pop();
            gameRef.update({deck,c1,c2,c3:null,gameState:'waiting_shoot',
                lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:'è«‹ä¸‹æ³¨å¾ŒæŠ½é–€ç‰Œ'});
        });
    } else {
        const c1=deck.pop(), c2=deck.pop();
        gameRef.update({deck,c1,c2,c3:null,gameState:'waiting_shoot',
            lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:'è«‹ä¸‹æ³¨å¾ŒæŠ½é–€ç‰Œ'});
    }
}

/* â”€â”€ é é¢è¼‰å…¥å¾Œç«‹å³éœé»˜é è¼‰ allin buffer â”€â”€ */
window.addEventListener('load', ()=>{
    // é é¢è¼‰å…¥å¾Œå˜—è©¦å»ºç«‹ AudioContext ä¸¦é è¼‰ï¼ˆæ¡Œæ©Ÿ/Android ä¸éœ€æ‰‹å‹¢å°±èƒ½ fetch decodeï¼‰
    // iOS æœƒåœ¨ getAudioCtx æ™‚å»ºç«‹ä½† state=suspendedï¼Œfetch ä»å¯åŸ·è¡Œï¼Œdecode åœ¨ resume å¾Œç”Ÿæ•ˆ
    preloadAllinBuffer();
});

/* â”€â”€ resize æ™‚æ›´æ–° canvas å°ºå¯¸é¿å…é£›ç‰Œåº§æ¨™åç§» â”€â”€ */
window.addEventListener('resize', ()=>{
    const c = document.getElementById('shot-canvas');
    if(c){ c.width = window.innerWidth; c.height = window.innerHeight; }
});
</script>
</body>
    </html>

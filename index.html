// 修正後的進入房間邏輯
    function joinRoom() {
        const nameInput = document.getElementById('my-name').value.trim();
        if (!nameInput) return alert("請輸入暱稱");

        // 檢查本地是否有舊 ID
        let savedId = localStorage.getItem('dg_id');
        
        gameRef.child('players').once('value', snap => {
            const players = snap.val() || {};
            
            // 邏輯修正：如果舊 ID 已經不在名單上，且使用者輸入了新名字
            // 視為全新玩家，強制刪除舊 ID 緩存，避免奪權 Bug
            if (savedId && !players[savedId]) {
                localStorage.removeItem('dg_id');
                myId = ""; 
            }

            if (!myId) {
                const newRef = gameRef.child('players').push();
                myId = newRef.key;
                localStorage.setItem('dg_id', myId);
            }

            gameRef.child('players/'+myId).update({ 
                name: nameInput, 
                lastActive: Date.now(),
                balance: localData.gameStarted ? 0 : 1000 // 若遊戲中途加入，初始錢為0或自訂
            });
            
            startListening();
            document.getElementById('login-part').style.display = 'none';
        });
    }

    // 修正後的監聽邏輯 (確保權限判斷更精確)
    function startListening() {
        gameRef.on('value', snap => {
            localData = snap.val() || {};
            if (!localData.players || !localData.players[myId]) {
                // 如果在名單中找不到自己(被踢了)，回到登入畫面
                document.getElementById('setup-area').style.display = 'block';
                document.getElementById('main-board').style.display = 'none';
                document.getElementById('login-part').style.display = 'block';
                return;
            };

            const pKeys = Object.keys(localData.players);
            // 房主權限嚴格判定：名單中第一個產生的 Key 才是房主
            const isHost = (pKeys[0] === myId);
            document.body.className = isHost ? "is-host" : "";

            // 影片觸發邏輯 (保持 video/allin.mp4 2.5秒)
            if (localData.allInTrigger && localData.allInTrigger !== lastEffectId) {
                const videoBox = document.getElementById('video-box');
                videoBox.innerHTML = `
                    <video id="allInVdo" width="315" height="560" autoplay playsinline>
                        <source src="video/allin.mp4" type="video/mp4">
                    </video>`;
                document.getElementById('all-in-overlay').style.display = 'flex';
                setTimeout(() => { 
                    document.getElementById('all-in-overlay').style.display = 'none'; 
                    videoBox.innerHTML = ''; 
                }, 2500);
                lastEffectId = localData.allInTrigger;
            }

            // 遊戲狀態與 UI 控制 (保留原本邏輯)
            if (localData.gameStarted) {
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('main-board').style.display = 'block';
                document.getElementById('fold-cost-ui').innerText = localData.foldPenalty || 0;
                renderUI(isHost);
            } else {
                document.getElementById('setup-area').style.display = 'block';
                document.getElementById('host-part').style.display = isHost ? 'block' : 'none';
                document.getElementById('main-board').style.display = 'none';
            }
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            renderPlayers();
        });
    }

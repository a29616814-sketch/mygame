<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°„é¾é–€ Pro - ç©å®¶è‡ªä¸»ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #d4af37; --dark-green: #1a472a; --card-red: #e74c3c; }
        body { background: var(--dark-green); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 10px; }
        .game-container { max-width: 1000px; margin: auto; }
        .player-list { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; min-height: 80px; }
        .player-card { background: rgba(0,0,0,0.8); padding: 12px; border-radius: 12px; border: 2px solid #444; width: 130px; position: relative; }
        .player-card.active { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); background: rgba(212, 175, 55, 0.1); }
        .player-balance { font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .balance-pos { color: #2ecc71; }
        .balance-neg { color: #ff7675; }
        .board { background: radial-gradient(circle, #2d5a3c 0%, #1a472a 100%); padding: 30px; border-radius: 50px; border: 4px solid var(--gold); }
        .pool-display { font-size: 48px; color: #f1c40f; font-weight: bold; }
        .cards { display: flex; justify-content: center; gap: 15px; margin: 20px 0; height: 160px; }
        .card { width: 100px; height: 145px; background: white; border-radius: 10px; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 35px; font-weight: bold; border: 2px solid #333; box-shadow: 3px 3px 10px rgba(0,0,0,0.3); white-space: pre-wrap; }
        .card.hidden { background: #2c3e50; color: transparent; border: 2px solid #7f8c8d; }
        .card.red { color: var(--card-red); }
        .setup-box { background: rgba(0,0,0,0.8); padding: 25px; border-radius: 20px; border: 2px solid var(--gold); margin-bottom: 20px; }
        input, select { padding: 10px; border-radius: 5px; border: none; text-align: center; font-size: 1rem; }
        button { padding: 10px 18px; cursor: pointer; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; color: #1a472a; margin: 4px; transition: 0.2s; }
        button:disabled { background: #7f8c8d; cursor: not-allowed; }
        #status-msg { height: 50px; font-size: 1.3rem; color: #f1c40f; font-weight: bold; margin: 10px 0; }
        .draw-btn { background: #3498db; color: white; font-size: 1.5rem; padding: 15px 30px; }
    </style>
</head>
<body>

<div id="game-ui" class="game-container">
    <h1>ğŸŸï¸ åŸ”å¢˜å¤§é¾é–€ Pro (æ¸¬è©¦ç‰ˆ)</h1>

    <div id="setup-area" class="setup-box">
        <div id="login-part">
            <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±">
            <button onclick="joinRoom()">é€²å…¥/æ‰¾å›éŠæˆ²</button>
        </div>
        <div id="host-part" style="display:none;">
            <h3>ğŸ‘‘ æˆ¿ä¸»è¨­å®šé¢æ¿</h3>
            <div style="margin:10px;">
                åˆå§‹æœ¬é‡‘: <input type="number" id="start-balance" value="1000" style="width:100px;">
                é–‹å±€åº•æ³¨: <input type="number" id="entry-fee" value="100" style="width:80px;">
            </div>
            <div style="margin:10px;">
                æ£„ç‰ŒæŠ•æ³¨: <input type="number" id="fold-penalty" value="20" style="width:80px;">
                ç‰Œçµ„æ•¸é‡: <select id="deck-count"><option value="1">1</option><option value="2" selected>2</option><option value="4">4</option></select>
            </div>
            <label><input type="checkbox" id="auto-refill" checked> æ± é‡‘ä¸è¶³è‡ªå‹•è£œåº•</label><br><br>
            <button onclick="hostStartGame()" style="background:#2ecc71; color:white; width: 80%;">âœ… é‡æ–°è¨­å®šä¸¦æ­£å¼é–‹æ¡Œ</button>
        </div>
    </div>

    <div id="player-area" class="player-list"></div>

    <div id="main-board" class="board" style="display:none;">
        <div class="pool-display">ğŸ’° $<span id="pool-val">0</span></div>
        <div id="status-msg">ç­‰å¾…ç™¼ç‰Œ...</div>
        <div class="cards">
            <div id="c1" class="card hidden">?</div>
            <div id="c3" class="card hidden">?</div>
            <div id="c2" class="card hidden">?</div>
        </div>

        <div id="controls">
            <div id="draw-phase" style="display:none;">
                <button class="draw-btn" onclick="playerDrawGoal()">ğŸƒ æŠ½é¾é–€ç‰Œ</button>
            </div>

            <div id="bet-phase" style="display:none;">
                <input type="number" id="bet-amount" placeholder="é‡‘é¡" style="width:140px;">
                <div id="action-buttons" style="display:inline-block;">
                    <button id="shoot-normal" onclick="handleAction('shoot')">å°„é–€ï¼</button>
                    <div id="guess-buttons" style="display:none;">
                        <button onclick="handleAction('up')" style="background:#3498db; color:white;">çŒœå¤§</button>
                        <button onclick="handleAction('down')" style="background:#e67e22; color:white;">çŒœå°</button>
                    </div>
                </div>
                <button onclick="handleAction('fold')" style="background:#95a5a6;">æ”¾æ£„ (æ‰£ $<span id="fold-cost-ui">0</span>)</button>
            </div>

            <div id="host-controls" style="margin-top:20px; display:none; border-top: 1px dashed #aaa; padding-top: 10px;">
                <button onclick="hostResetToLobby()" style="background: #e74c3c; color: white;">ğŸš¨ æˆ¿ä¸»å¼·åˆ¶é‡è£½</button>
            </div>
        </div>
        <p style="font-size: 14px; color: #ddd; margin-top:20px;">ğŸ´ å‰©é¤˜ç‰Œæ•¸: <span id="cards-left">0</span></p>
    </div>
</div>

<script>
    // --- Firebase é…ç½® (åŒå‰) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
        authDomain: "dargongatepoker.firebaseapp.com",
        databaseURL: "https://dargongatepoker-default-rtdb.firebaseio.com",
        projectId: "dargongatepoker",
        storageBucket: "dargongatepoker.firebasestorage.app",
        messagingSenderId: "204663560828",
        appId: "1:204663560828:web:9ede7b6190babde73f07f9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameRef = db.ref('dragonGate/room1');

    let myId = localStorage.getItem('dragonGate_myId') || "";
    let myName = localStorage.getItem('dragonGate_myName') || "";
    let localData = {};
    const labels = {1:'A', 11:'J', 12:'Q', 13:'K'};

    function joinRoom() {
        const inputName = document.getElementById('my-name').value.trim();
        if (!inputName) return alert("è«‹è¼¸å…¥æš±ç¨±");
        if (myId && inputName === myName) {
            startListening();
        } else {
            const newRef = gameRef.child('players').push();
            myId = newRef.key; myName = inputName;
            localStorage.setItem('dragonGate_myId', myId);
            localStorage.setItem('dragonGate_myName', myName);
            newRef.set({ name: myName, balance: 0 }).then(startListening);
        }
        document.getElementById('login-part').style.display = 'none';
    }

    function startListening() {
        gameRef.on('value', snap => {
            localData = snap.val() || {};
            if (!localData.players || !localData.players[myId]) return;
            const pKeys = Object.keys(localData.players);
            const isHost = (pKeys[0] === myId);
            
            if (localData.gameStarted) {
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('main-board').style.display = 'block';
                document.getElementById('fold-cost-ui').innerText = localData.foldPenalty || 0;
            } else {
                document.getElementById('setup-area').style.display = 'block';
                document.getElementById('host-part').style.display = isHost ? 'block' : 'none';
                document.getElementById('main-board').style.display = 'none';
            }
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            renderUI();
            renderPlayers();
        });
    }

    // ç©å®¶è‡ªå·±æŠ½ç‰Œ
    function playerDrawGoal() {
        let deck = localData.deck || generateDecks(2);
        if (deck.length < 3) deck = generateDecks(localData.deckCount || 2);
        
        const c1 = deck.pop();
        const c2 = deck.pop();
        
        gameRef.update({
            deck: deck,
            c1: c1,
            c2: c2,
            c3: null,
            gameState: 'betting',
            statusMsg: `ã€${localData.players[myId].name}ã€‘è«‹ä¸‹æ³¨`
        });
    }

    function handleAction(type) {
        let bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
        const p = localData.players[myId];
        if (type !== 'fold' && (bet < 10 || bet > localData.pool)) return alert("ä¸‹æ³¨ç„¡æ•ˆ");

        let nBal = p.balance, nPool = localData.pool, msg = "", c3 = null;
        let deck = localData.deck || [];

        if (type === 'fold') {
            const penalty = localData.foldPenalty || 0;
            nBal -= penalty; nPool += penalty;
            msg = `${p.name} æ”¾æ£„ (-$${penalty})`;
        } else {
            if (deck.length < 1) deck = generateDecks(localData.deckCount || 2);
            c3 = deck.pop();
            const min = Math.min(localData.c1.val, localData.c2.val);
            const max = Math.max(localData.c1.val, localData.c2.val);
            if (localData.c1.val === localData.c2.val) {
                if (c3.val === localData.c1.val) { nBal -= bet*3; nPool += bet*3; msg = `ğŸš§ æ’æŸ±ï¼è¼¸ $${bet*3}`; }
                else if ((type === 'up' && c3.val > localData.c1.val) || (type === 'down' && c3.val < localData.c1.val)) { nBal += bet; nPool -= bet; msg = `ğŸ‰ çŒœå°ï¼è´ $${bet}`; }
                else { nBal -= bet; nPool += bet; msg = `âŒ çŒœéŒ¯ï¼è¼¸ $${bet}`; }
            } else {
                if (c3.val > min && c3.val < max) { nBal += bet; nPool -= bet; msg = `ğŸ‰ å°„é€²ï¼è´ $${bet}`; }
                else if (c3.val === min || c3.val === max) { nBal -= bet*2; nPool += bet*2; msg = `ğŸš§ æ’æŸ±ï¼è¼¸ $${bet*2}`; }
                else { nBal -= bet; nPool += bet; msg = `âŒ æ²’é€²ï¼è¼¸ $${bet}`; }
            }
        }

        const pKeys = Object.keys(localData.players);
        let nextK = pKeys[(pKeys.indexOf(myId) + 1) % pKeys.length];
        let updates = { [`players/${myId}/balance`]: nBal, pool: nPool, deck: deck, c3: (c3 || null), statusMsg: msg, gameState: 'drawing', currentPlayerKey: nextK };
        
        // è£œåº•æª¢æŸ¥
        const threshold = (localData.entryFee || 100) * pKeys.length;
        if ((nPool < threshold && localData.autoRefill) || nPool <= 0) {
            updates.pool = nPool;
            pKeys.forEach(k => {
                let bal = (k === myId ? nBal : localData.players[k].balance);
                updates[`players/${k}/balance`] = bal - localData.entryFee;
                updates.pool += localData.entryFee;
            });
            updates.statusMsg = msg + " | ğŸ’° åŸ·è¡Œè£œåº•ï¼";
        }
        gameRef.update(updates);
        document.getElementById('bet-amount').value = "";
    }

    // --- å·¥å…·å‡½å¼ ---
    function generateDecks(count) {
        let deck = []; const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        for (let i = 0; i < count; i++) suits.forEach(s => { for (let v = 1; v <= 13; v++) deck.push({ val: v, suit: s, label: labels[v] || v }); });
        return deck.sort(() => Math.random() - 0.5);
    }
    async function hostResetToLobby() { if(confirm("å¼·åˆ¶çµæŸç•¶å‰éŠæˆ²å›å¤§å»³ï¼Ÿ")) await gameRef.update({ gameStarted: false }); }
    async function hostStartGame() {
        const fee = parseInt(document.getElementById('entry-fee').value) || 0;
        const start = parseInt(document.getElementById('start-balance').value) || 1000;
        let players = localData.players, newPool = 0;
        Object.keys(players).forEach(id => { players[id].balance = start - fee; newPool += fee; });
        gameRef.set({ gameStarted: true, deck: generateDecks(document.getElementById('deck-count').value), pool: newPool, entryFee: fee, foldPenalty: parseInt(document.getElementById('fold-penalty').value), autoRefill: document.getElementById('auto-refill').checked, gameState: 'drawing', players: players, currentPlayerKey: Object.keys(players)[0], statusMsg: "éŠæˆ²é–‹å§‹ï¼Œè«‹é¦–ä½ç©å®¶æŠ½ç‰Œï¼", c1:null, c2:null, c3:null });
    }

    function renderUI() {
        document.getElementById('pool-val').innerText = localData.pool || 0;
        document.getElementById('status-msg').innerText = localData.statusMsg || "";
        document.getElementById('cards-left').innerText = localData.deck ? localData.deck.length : 0;
        updateCard('c1', localData.c1); updateCard('c2', localData.c2); updateCard('c3', localData.c3);
        
        const isMyTurn = (localData.currentPlayerKey === myId);
        document.getElementById('draw-phase').style.display = (isMyTurn && localData.gameState === 'drawing') ? 'block' : 'none';
        document.getElementById('bet-phase').style.display = (isMyTurn && localData.gameState === 'betting') ? 'block' : 'none';
        
        const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;
        document.getElementById('shoot-normal').style.display = isSame ? 'none' : 'inline-block';
        document.getElementById('guess-buttons').style.display = isSame ? 'inline-block' : 'none';
    }

    function renderPlayers() {
        const area = document.getElementById('player-area'); area.innerHTML = '';
        Object.keys(localData.players).forEach(id => {
            const p = localData.players[id];
            const div = document.createElement('div');
            div.className = `player-card ${id === localData.currentPlayerKey ? 'active' : ''}`;
            const balClass = p.balance >= 0 ? 'balance-pos' : 'balance-neg';
            div.innerHTML = `<b>${p.name}</b><br><span class="player-balance ${balClass}">$${p.balance}</span>`;
            area.appendChild(div);
        });
    }

    function updateCard(id, c) {
        const el = document.getElementById(id);
        if (!c) { el.classList.add('hidden'); el.innerText = '?'; }
        else { el.classList.remove('hidden'); el.innerText = `${c.suit}\n${c.label}`; el.classList.toggle('red', c.suit === 'â™¥' || c.suit === 'â™¦'); }
    }
</script>
</body>
</html>

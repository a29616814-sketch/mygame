<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°„é¾é–€ Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --gold: #d4af37;
    --felt: #2d5a3c;
    --dark: #1a472a;
    --red:  #e74c3c;
    --wood: #8B6914;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
    width: 100%; height: 100%;
    background: #0d1f15;
    color: white;
    font-family: 'Segoe UI', sans-serif;
    overflow: hidden;
    touch-action: manipulation;
}

/* â”€â”€ ç™»å…¥ç•«é¢ â”€â”€ */
#setup-screen {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: radial-gradient(ellipse at center, #1a472a 0%, #0a1f0f 100%);
    z-index: 100;
    padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
}
#setup-screen h1 { font-size: clamp(1.4rem, 5vw, 2.2rem); color: var(--gold); margin-bottom: 24px; text-shadow: 0 2px 12px rgba(212,175,55,0.5); }
.setup-box {
    background: rgba(0,0,0,0.75);
    border: 2px solid var(--gold);
    border-radius: 20px;
    padding: 28px 32px;
    width: min(420px, 90vw);
}
.input-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px; }
.input-row label { color: #aaa; font-size: 0.85rem; }
.input-row input, .input-row select {
    padding: 9px 12px; border-radius: 8px; border: none;
    background: #333; color: white; font-size: 1rem; width: 100%;
}
.input-inline { display: flex; gap: 10px; }
.input-inline > div { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.input-inline label { color: #aaa; font-size: 0.8rem; }
.input-inline input, .input-inline select { padding: 8px; border-radius: 8px; border: none; background: #333; color: white; font-size: 0.95rem; width: 100%; }
.btn-main { width: 100%; padding: 13px; background: #2ecc71; color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 8px; }
.btn-main:active { filter: brightness(0.9); }
.chk-row { display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 0.9rem; margin: 6px 0; }
#host-part { display: none; margin-top: 16px; border-top: 1px solid #444; padding-top: 16px; }
#host-part h3 { color: var(--gold); margin-bottom: 12px; font-size: 1rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â˜… æ–¹å‘é¸æ“‡åˆ‡æ›å™¨ï¼ˆç™»å…¥ç•«é¢ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.orient-switcher {
    display: flex;
    align-items: center;
    gap: 0;
    background: #1a1a1a;
    border-radius: 10px;
    border: 1.5px solid #444;
    overflow: hidden;
    margin-bottom: 16px;
    width: 100%;
}
.orient-btn {
    flex: 1;
    padding: 10px 8px;
    border: none;
    background: transparent;
    color: #888;
    font-size: 0.88rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.22s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
}
.orient-btn .orient-icon {
    font-size: 1.2rem;
    display: inline-block;
    transition: transform 0.22s;
}
.orient-btn.active {
    background: var(--gold);
    color: #1a1a1a;
    border-radius: 8px;
}
.orient-btn:not(.active):hover { color: #ddd; background: rgba(255,255,255,0.05); }
/* ç›´å±åœ–ç¤ºæ—‹è½‰é¡¯ç¤º */
.orient-btn[data-mode="portrait"] .orient-icon { transform: rotate(90deg); }
.orient-hint {
    font-size: 0.75rem;
    color: #777;
    text-align: center;
    margin-bottom: 10px;
    line-height: 1.4;
}
.orient-hint span { color: var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   éŠæˆ²ç•«é¢åŸºåº•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game-screen {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
}

/*
   â˜… æ–¹å‘æ§åˆ¶ï¼š
   - é è¨­ï¼ˆæ©«å±æ¨¡å¼ï¼‰ï¼šä¸æ—‹è½‰ï¼Œæ‰‹æ©Ÿæ©«æ”¾
   - body.prefer-portrait + æ‰‹æ©Ÿç›´æ‹¿ï¼ˆportraitï¼‰ï¼šæ—‹è½‰éŠæˆ²ç•«é¢
   - body.prefer-portrait + æ‰‹æ©Ÿå·²æ©«æ”¾ï¼ˆlandscapeï¼‰ï¼šä¸æ—‹è½‰ï¼ˆå·²æ˜¯æ©«å±ï¼Œç„¡éœ€è½‰ï¼‰
   - body.prefer-landscapeï¼ˆæ©«å±æ¨¡å¼ï¼‰ï¼šèˆ‡èˆŠç‰ˆè¡Œç‚ºç›¸åŒ
*/

/* ç›´å±åå¥½ Ã— æ‰‹æ©Ÿç›´æ‹¿ â†’ æ—‹è½‰éŠæˆ² */
@media (orientation: portrait) {
    body.prefer-portrait #game-screen {
        width: 100vh;
        height: 100vw;
        top: 0;
        left: 0;
        transform-origin: 0 0;
        transform: rotate(90deg) translateX(0) translateY(-100%);
    }
}

/* â”€â”€ æ¡Œé¢ä½ˆå±€ â”€â”€ */
#table-wrap {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: #0d1f15;
    padding-left: max(var(--safe-left), 8px);
    padding-right: max(var(--safe-right), 8px);
    padding-bottom: max(var(--safe-bottom), 0px);
}

/* æ©¢åœ“æ¡Œ */
#oval {
    position: relative;
    width: min(96vw, 1100px);
    height: min(78vh, 560px);
    background: radial-gradient(ellipse at 50% 45%, #3a7a52 0%, #2d5a3c 55%, #1e4a30 100%);
    border-radius: 50%;
    border: 12px solid var(--wood);
    box-shadow:
        0 0 0 4px #5a3a08,
        0 0 0 8px #2a1a04,
        inset 0 0 80px rgba(0,0,0,0.4),
        0 20px 60px rgba(0,0,0,0.8);
    margin-bottom: 10px;
}
#oval::before {
    content: '';
    position: absolute; inset: 0; border-radius: 50%;
    background: repeating-linear-gradient(45deg,transparent,transparent 22px,rgba(255,255,255,0.012) 22px,rgba(255,255,255,0.012) 23px);
    pointer-events: none;
}
@keyframes tableGlow {
    0%,100% { box-shadow: 0 0 0 4px #5a3a08, 0 0 0 8px #2a1a04, inset 0 0 80px rgba(0,0,0,0.4), 0 20px 60px rgba(0,0,0,0.8); }
    50%      { box-shadow: 0 0 0 4px var(--gold), 0 0 0 12px rgba(212,175,55,0.3), inset 0 0 80px rgba(0,0,0,0.4), 0 20px 60px rgba(0,0,0,0.8); }
}
#oval.my-turn { animation: tableGlow 1.5s ease-in-out infinite; }

/* â”€â”€ æ¡Œé¢ä¸­å¤®ç‰Œå€ â”€â”€ */
#table-center {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -56%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    z-index: 10;
    pointer-events: none;
}
#pool-display {
    font-size: clamp(16px, 3vmin, 24px);
    color: #f1c40f;
    font-weight: bold;
    text-shadow: 0 2px 8px rgba(0,0,0,0.8);
}
#status-msg {
    font-size: clamp(9px, 1.8vmin, 13px);
    color: #ccc;
    min-height: 14px;
}

/* ç‰Œè¡Œ */
#cards-and-deck {
    display: flex;
    align-items: center;
    gap: clamp(4px, 1.5vmin, 12px);
    pointer-events: auto;
}

/* é–€æŸ± */
.post-wrap { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.post-label { font-size: clamp(7px,1.4vmin,10px); color: #aaa; letter-spacing: 1px; }
.post-label.gate { color: var(--gold); font-weight: bold; }
.connector { width: clamp(4px,1.2vmin,10px); height: 3px; background: linear-gradient(90deg, rgba(212,175,55,0.6), rgba(212,175,55,0.2)); align-self: center; flex-shrink: 0; }
.connector.r { background: linear-gradient(90deg, rgba(212,175,55,0.2), rgba(212,175,55,0.6)); }

/* ç‰Œ */
.card {
    width:  clamp(44px, 7.5vmin, 68px);
    height: clamp(62px,10.5vmin,96px);
    background: white; border-radius: 8px; color: black;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    font-size: clamp(15px,3.2vmin,26px); font-weight: bold;
    border: 2px solid #333;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
    white-space: pre-wrap; flex-shrink: 0;
}
.card.hidden { background: #1e3a5f; color: transparent; border-color: #3a6a9f; }
.card.red { color: var(--red); }

/* é¾é–€æ¡† */
.gate-frame {
    width:  clamp(44px, 7.5vmin, 68px);
    height: clamp(62px,10.5vmin,96px);
    border: 2px dashed rgba(212,175,55,0.4);
    border-radius: 8px;
    background: rgba(212,175,55,0.04);
    display: flex; align-items: center; justify-content: center;
    position: relative; overflow: visible; flex-shrink: 0;
}
.gate-frame .gate-inner-text { color: rgba(212,175,55,0.3); font-size: clamp(7px,1.3vmin,10px); }
#c3-in-gate { display: none; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10; }

/* ç‰Œå † */
#deck-stack {
    position: relative;
    width:  clamp(44px, 7.5vmin, 68px);
    height: clamp(62px,10.5vmin,96px);
    cursor: default; flex-shrink: 0;
}
.dk { position:absolute; width:100%; height:100%; border-radius:8px; border:1.5px solid #3a6a9f; }
.dk:nth-child(1){ transform:translate(5px,5px); background:#182e49; }
.dk:nth-child(2){ transform:translate(2px,2px); background:#1c3454; }
.dk:nth-child(3){
    transform:translate(0,0);
    background: linear-gradient(135deg,#2a4f80,#1e3a64);
    box-shadow: 3px 3px 10px rgba(0,0,0,0.7);
    display:flex; align-items:center; justify-content:center;
    font-size: clamp(15px,3.2vmin,26px); color:rgba(255,255,255,0.25);
}
#deck-stack.can-click { cursor: pointer; animation: deckPulse 1s ease-in-out infinite; }
#deck-stack.can-click .dk:nth-child(3) {
    background: linear-gradient(135deg,#4a80cc,#2a5090);
    box-shadow: 0 0 18px rgba(212,175,55,0.7), 3px 3px 10px rgba(0,0,0,0.7);
    border-color: var(--gold);
}
@keyframes deckPulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.09);} }
#deck-badge {
    position:absolute; bottom:-8px; right:-8px; z-index:6;
    background:var(--gold); color:#1a472a; font-size:9px; font-weight:bold;
    border-radius:10px; padding:1px 5px;
}
#deck-hint {
    position: absolute;
    bottom: -20px; left: 50%; transform: translateX(-50%);
    white-space: nowrap;
    font-size: clamp(7px,1.4vmin,10px); color:var(--gold);
    opacity:0; transition:opacity 0.3s; pointer-events:none;
}
#deck-hint.show { opacity:1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   åº§ä½ç³»çµ±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.seat { position:absolute; transform:translate(-50%,-50%); z-index:20; text-align:center; }
.seat-box {
    background: rgba(0,0,0,0.82);
    border: 2px solid #555; border-radius: 10px;
    padding: 3px 7px;
    font-size: clamp(7px,1.5vmin,11px);
    min-width: clamp(46px,9vmin,80px);
    max-width: clamp(54px,10vmin,88px);
    line-height: 1.3; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
}
.seat-box.active { border-color:var(--gold); box-shadow:0 0 10px var(--gold); background:rgba(212,175,55,0.12); }
.seat-box.is-me  { border-color:#3498db; }
.seat-box.active.is-me { border-color:var(--gold); }
.seat-name { font-weight:bold; }
.seat-bal  { color:#2ecc71; font-size:clamp(6px,1.3vmin,10px); }
.seat-tmr  { color:#ff7675; font-size:clamp(5px,1.1vmin,9px); }
.seat-kick { position:absolute; top:-5px; right:-5px; background:#e74c3c; color:white; border-radius:50%; width:16px; height:16px; border:1px solid white; display:none; cursor:pointer; font-size:9px; line-height:14px; z-index:25; }
body.is-host .seat:not(.is-me) .seat-kick { display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ä¸‹æ³¨é¢æ¿
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bet-panel {
    position: absolute;
    bottom: 6%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    display: none;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 6px 10px 8px;
    background: rgba(0,0,0,0.78);
    border-radius: 14px;
    border: 1px solid rgba(212,175,55,0.35);
    z-index: 30;
    pointer-events: auto;
    flex-wrap: wrap;
}

.chip-row { display:flex; gap:4px; align-items:center; }
.chip-btn { background:none; border:none; padding:0; cursor:pointer; }
.chip-btn:active { transform:scale(0.88); }
.chip-btn img {
    width: clamp(32px,5.5vmin,46px);
    height: clamp(32px,5.5vmin,46px);
    border-radius:50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
}

.bet-actions { display:flex; align-items:center; gap:4px; flex-wrap:wrap; justify-content:center; }
#bet-amount {
    background:#222; color:var(--gold);
    border:2px solid var(--gold); font-size:0.95rem;
    width:64px; border-radius:7px; padding:2px 5px; text-align:center;
}

.action-row { display:flex; gap:4px; flex-wrap:wrap; justify-content:center; align-items:center; }
.action-row button {
    padding: 6px 10px; border:none; border-radius:7px;
    font-weight:bold; cursor:pointer;
    font-size: clamp(10px,1.6vmin,13px);
    white-space: nowrap;
}
.btn-shoot { background:#2ecc71; color:white; }
.btn-up    { background:#3498db; color:white; }
.btn-down  { background:#e67e22; color:white; }
.btn-allin { background:var(--red); color:white; }
.btn-fold  { background:#7f8c8d; color:white; }
.btn-clear { background:#444; color:white; padding:6px 7px !important; font-size:clamp(9px,1.4vmin,12px) !important; }

.bet-divider { width:1px; height:36px; background:rgba(255,255,255,0.15); margin:0 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â˜… Emoji æ‘ºç–Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#emoji-toggle {
    position: absolute;
    left: 10px;
    bottom: 12px;
    width: 36px; height: 36px;
    background: rgba(0,0,0,0.65);
    border: 1px solid rgba(212,175,55,0.5);
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 31;
    display: none;
    align-items: center; justify-content: center;
    transition: background 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
#emoji-toggle.open { background: rgba(212,175,55,0.25); border-color: var(--gold); }
#emoji-toggle:active { transform: scale(0.9); }

#emoji-bar {
    position: absolute;
    left: 52px;
    bottom: 8px;
    display: none;
    gap: 5px;
    z-index: 30;
    pointer-events: auto;
    background: rgba(0,0,0,0.78);
    padding: 5px 8px;
    border-radius: 22px;
    border: 1px solid rgba(212,175,55,0.3);
    transform-origin: left center;
    animation: emojiSlideIn 0.2s ease-out;
}
@keyframes emojiSlideIn {
    from { opacity:0; transform: scaleX(0.3); }
    to   { opacity:1; transform: scaleX(1); }
}
.emoji-btn {
    font-size:1.2rem; background:none; border:none;
    border-radius:50%; width:34px; height:34px; cursor:pointer;
    transition: transform 0.15s;
}
.emoji-btn:active { transform: scale(1.3); }

/* â”€â”€ å³ä¸‹è§’å·¥å…·åˆ— â”€â”€ */
#tools {
    position: absolute; bottom: 10px; right: 10px;
    display: none; flex-direction: column;
    gap: 5px; z-index: 30; align-items: flex-end;
    pointer-events: auto;
}
.tool-btn { background:rgba(0,0,0,0.6); border:1px solid #555; color:var(--gold); border-radius:20px; padding:5px 10px; cursor:pointer; font-size:clamp(9px,1.6vmin,12px); white-space:nowrap; }
.tool-btn:active { filter:brightness(1.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â˜… Canvas â€” portrait æ—‹è½‰åªåœ¨ prefer-portrait body æ™‚å¥—ç”¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#shot-canvas {
    position: fixed; inset: 0;
    pointer-events: none; z-index: 7000;
}
@media (orientation: portrait) {
    body.prefer-portrait #shot-canvas {
        width: 100vh;
        height: 100vw;
        top: 0; left: 0;
        transform-origin: 0 0;
        transform: rotate(90deg) translateX(0) translateY(-100%);
    }
}

/* result-banner */
#result-banner {
    display:none; position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%) scale(0.5);
    z-index:8000; background:rgba(0,0,0,0.93);
    border-radius:20px; padding:14px 28px;
    border:3px solid var(--gold); text-align:center;
    transition:transform 0.35s cubic-bezier(0.175,0.885,0.32,1.275), opacity 0.35s;
    opacity:0; pointer-events:none;
}
#result-banner.show { display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

.rb-emoji  { font-size:2.2rem; }
.rb-text   { font-size:1.3rem; font-weight:bold; margin:3px 0; }
.rb-amount { font-size:1.7rem; font-weight:bold; }
.rb-amount.positive { color:#2ecc71; }
.rb-amount.negative { color:var(--red); }

.confetti-piece { position:fixed; width:10px; height:14px; top:-20px; border-radius:2px; pointer-events:none; animation:confettiFall linear forwards; z-index:7999; }
@keyframes confettiFall { 0%{transform:translateY(0) rotate(0deg);opacity:1;} 100%{transform:translateY(110vh) rotate(720deg);opacity:0;} }

#all-in-confirm-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:9000; flex-direction:column; justify-content:center; align-items:center; }
#all-in-confirm-overlay.show { display:flex; }
.allin-box { background:linear-gradient(135deg,#1a1a1a,#2c0000); border:3px solid var(--red); border-radius:24px; padding:22px 30px; text-align:center; animation:alinPop 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
@keyframes alinPop { from{transform:scale(0.6);opacity:0;} to{transform:scale(1);opacity:1;} }
.allin-box h2 { font-size:1.5rem; color:var(--red); margin-bottom:6px; }
.allin-box p  { color:#ccc; margin-bottom:12px; }
.allin-amount { font-size:2rem; color:var(--gold); font-weight:bold; margin-bottom:16px; }
.allin-yes { background:var(--red)!important; color:white!important; font-size:1rem!important; padding:9px 20px!important; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin:0 6px; }
.allin-no  { background:#555!important; color:white!important; font-size:1rem!important; padding:9px 20px!important; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin:0 6px; }

#all-in-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.96); z-index:9999; flex-direction:column; justify-content:center; align-items:center; }
#all-in-overlay h1 { color:var(--gold); margin-top:20px; }

/* â˜… my-turn-toast ä¸éš¨éŠæˆ²æ—‹è½‰ï¼Œå›ºå®šåœ¨è¢å¹•å³å´ */
#my-turn-toast {
    display:none; position:fixed;
    top: 50%; right: 12px;
    transform: translateY(-50%) translateX(60px);
    background:var(--gold); color:#1a472a; font-weight:bold; font-size:0.9rem;
    padding:8px 18px; border-radius:30px; z-index:8500;
    box-shadow:0 4px 20px rgba(0,0,0,0.6);
    animation: toastSlideIn 0.4s ease-out forwards;
}
@keyframes toastSlideIn {
    from { transform: translateY(-50%) translateX(60px); opacity:0; }
    to   { transform: translateY(-50%) translateX(0); opacity:1; }
}

#refill-toast { display:none; position:fixed; top:14px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.92); color:var(--gold); border:2px solid var(--gold); font-size:0.85rem; padding:7px 18px; border-radius:20px; z-index:8500; white-space:nowrap; }

#emoji-broadcast-area { position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:10000; }
.broadcast-item { background:rgba(0,0,0,0.88); color:var(--gold); padding:7px 16px; border-radius:30px; margin-bottom:5px; font-weight:bold; border:2px solid var(--gold); animation:fadeUp 2.5s forwards; white-space:nowrap; }
@keyframes fadeUp { 0%{opacity:0;transform:translateY(10px);} 15%{opacity:1;transform:translateY(0);} 80%{opacity:1;} 100%{opacity:0;transform:translateY(-15px);} }

/* å¡ç‰Œå‹è² å‹•ç•« */
@keyframes winPulse  { 0%{box-shadow:2px 2px 8px rgba(0,0,0,0.5);} 40%{transform:scale(1.15);box-shadow:0 0 28px #2ecc71,0 0 55px #2ecc71;} 100%{box-shadow:2px 2px 8px rgba(0,0,0,0.5);} }
@keyframes losePulse { 0%{transform:scale(1);} 20%{transform:translateX(-7px) scale(1.05);box-shadow:0 0 22px var(--red);} 40%{transform:translateX(7px) scale(1.05);box-shadow:0 0 22px var(--red);} 60%{transform:translateX(-4px);} 80%{transform:translateX(4px);} 100%{transform:scale(1);} }
@keyframes crashPulse{ 0%{transform:scale(1);} 30%{transform:scale(1.18) rotate(-5deg);box-shadow:0 0 38px #f39c12;} 60%{transform:scale(1.1) rotate(5deg);} 100%{transform:scale(1);} }
.anim-win   { animation:winPulse 0.7s ease-out; }
.anim-lose  { animation:losePulse 0.7s ease-out; }
.anim-crash { animation:crashPulse 0.7s ease-out; }

/* éš±è—èˆŠç‰ˆå…ƒç´  */
#main-board, #player-area-wrapper, .player-toggle-btn { display:none!important; }
    </style>
</head>
<body>

<canvas id="shot-canvas"></canvas>
<div id="emoji-broadcast-area"></div>

<div id="result-banner">
    <div class="rb-emoji" id="rb-emoji">ğŸ‰</div>
    <div class="rb-text"  id="rb-text">å°„é€²!</div>
    <div class="rb-amount" id="rb-amount">+$0</div>
</div>

<div id="all-in-confirm-overlay">
    <div class="allin-box">
        <h2>ğŸ”¥ ALL IN ç¢ºèª</h2>
        <p>ä½ ç¢ºå®šè¦æŠ¼ä¸Šå…¨éƒ¨å½©é‡‘?</p>
        <div class="allin-amount" id="allin-pool-preview">$0</div>
        <div><button class="allin-yes" onclick="confirmAllIn()">ğŸ’¥ æˆ‘è¦å…¨éƒ¨!</button><button class="allin-no" onclick="cancelAllIn()">å–æ¶ˆ</button></div>
    </div>
</div>

<div id="all-in-overlay"><div id="video-box"></div><h1>æˆ‘è¦å…¨éƒ¨!!!</h1></div>
<div id="refill-toast"></div>
<div id="my-turn-toast">ğŸ¯ è¼ªåˆ°ä½ äº†!</div>

<audio id="sfx-win"   src="sfx/win.mp3"   preload="auto"></audio>
<audio id="sfx-lose"  src="sfx/lose.mp3"  preload="auto"></audio>
<audio id="sfx-crash" src="sfx/crash.mp3" preload="auto"></audio>
<audio id="sfx-fold"  src="sfx/fold.mp3"  preload="auto"></audio>
<audio id="sfx-allin" src="sfx/allin.mp3" preload="auto"></audio>
<audio id="sfx-deal"  src="sfx/deal.mp3"  preload="auto"></audio>

<!-- â•â• ç™»å…¥ç•«é¢ â•â• -->
<div id="setup-screen">
    <h1>ğŸŸï¸ åŸ”å¢˜é‡‘é¾é–€ Pro</h1>
    <div class="setup-box">
        <div id="login-part">

            <!-- â˜… æ–¹å‘é¸æ“‡å™¨ -->
            <div style="margin-bottom:4px;">
                <div class="orient-switcher">
                    <button class="orient-btn active" data-mode="landscape" onclick="setOrient('landscape')">
                        <span class="orient-icon">ğŸ“±</span> æ©«å±æ¨¡å¼
                    </button>
                    <button class="orient-btn" data-mode="portrait" onclick="setOrient('portrait')">
                        <span class="orient-icon">ğŸ“±</span> ç›´å±æ¨¡å¼
                    </button>
                </div>
                <div class="orient-hint" id="orient-hint">
                    <span>æ©«å±</span>ï¼šæ‰‹æ©Ÿæ‰“æ©«ï¼Œç•«é¢æ­£å¸¸é¡¯ç¤º
                </div>
            </div>

            <div class="input-row">
                <label>æš±ç¨±</label>
                <input type="text" id="my-name" placeholder="è¼¸å…¥æš±ç¨±">
            </div>
            <button class="btn-main" onclick="joinRoom()">ğŸƒ é€²å…¥å¤§å»³</button>
        </div>
        <div id="host-part">
            <h3>ğŸ‘‘ æˆ¿ä¸»è¦å‰‡è¨­å®š</h3>
            <div class="input-inline" style="margin-bottom:10px;">
                <div><label>åˆå§‹æœ¬é‡‘</label><input type="number" id="start-balance" value="1000"></div>
                <div><label>é–‹å±€åº•æ³¨</label><input type="number" id="entry-fee" value="100"></div>
                <div><label>æ£„ç‰Œç½°é‡‘</label><input type="number" id="fold-penalty" value="20"></div>
            </div>
            <div class="input-row">
                <label>ç‰Œçµ„æ•¸é‡</label>
                <select id="deck-count">
                    <option value="1">1 å‰¯ç‰Œ</option>
                    <option value="2" selected>2 å‰¯ç‰Œ</option>
                    <option value="3">3 å‰¯ç‰Œ</option>
                    <option value="4">4 å‰¯ç‰Œ</option>
                </select>
            </div>
            <div class="chk-row"><input type="checkbox" id="auto-refill" checked><label>æ± é‡‘ä¸è¶³è‡ªå‹•è£œåº•</label></div>
            <button class="btn-main" onclick="hostStartGame()">âœ… ç¢ºèªä¸¦é–‹æ¡Œ</button>
        </div>
    </div>
</div>

<!-- â•â• éŠæˆ²ç•«é¢ â•â• -->
<div id="game-screen">
    <div id="table-wrap">
        <div id="oval">

            <!-- æ¡Œé¢ä¸­å¤® -->
            <div id="table-center">
                <div id="pool-display">ğŸ’° $<span id="pool-val">0</span></div>
                <div id="status-msg"></div>

                <div id="cards-and-deck">
                    <!-- å·¦æŸ± -->
                    <div class="post-wrap">
                        <div class="post-label">å·¦æŸ±</div>
                        <div id="c1" class="card hidden">?</div>
                    </div>
                    <div class="connector"></div>

                    <!-- é¾é–€ -->
                    <div class="post-wrap">
                        <div class="post-label gate">ğŸ‰ é¾é–€</div>
                        <div class="gate-frame" id="gate-frame">
                            <span class="gate-inner-text" id="gate-inner">å¾…å°„é–€</span>
                            <div id="c3-in-gate"></div>
                        </div>
                    </div>
                    <div class="connector r"></div>

                    <!-- å³æŸ± -->
                    <div class="post-wrap">
                        <div class="post-label">å³æŸ±</div>
                        <div id="c2" class="card hidden">?</div>
                    </div>

                    <!-- åˆ†éš” -->
                    <div style="width:2px;height:50px;background:rgba(255,255,255,0.1);margin:0 3px;align-self:center;flex-shrink:0;"></div>

                    <!-- ç‰Œå † -->
                    <div class="post-wrap" style="position:relative;">
                        <div class="post-label" id="cards-left-lbl" style="color:#aaa;">ç‰Œåº«</div>
                        <div id="deck-stack" onclick="onDeckClick()">
                            <div class="dk"></div>
                            <div class="dk"></div>
                            <div class="dk">ğŸ‚ <span id="deck-badge">0</span></div>
                        </div>
                        <div id="deck-hint">é»æ“ŠæŠ½ç‰Œ</div>
                    </div>
                </div>

                <div style="font-size:clamp(7px,1.3vmin,10px);color:#888;margin-top:1px;">å‰© <span id="cards-left">0</span> å¼µ</div>
            </div>

            <!-- åº§ä½å±¤ -->
            <div id="seats-layer"></div>

            <!-- ä¸‹æ³¨é¢æ¿ -->
            <div id="bet-panel">
                <div class="chip-row">
                    <button class="chip-btn" onclick="addBet(10)"><img src="pic/m10.jpg" onerror="this.style.cssText='width:34px;height:34px;border-radius:50%;background:#27ae60;display:flex;align-items:center;justify-content:center;font-size:10px;color:white;'; this.outerHTML='<div onclick=\'addBet(10)\' style=\'width:34px;height:34px;border-radius:50%;background:#27ae60;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>10</div>'"></button>
                    <button class="chip-btn" onclick="addBet(50)"><img src="pic/m50.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(50)\' style=\'width:34px;height:34px;border-radius:50%;background:#2980b9;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>50</div>'"></button>
                    <button class="chip-btn" onclick="addBet(100)"><img src="pic/m100.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(100)\' style=\'width:34px;height:34px;border-radius:50%;background:#8e44ad;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>100</div>'"></button>
                    <button class="chip-btn" onclick="addBet(500)"><img src="pic/m500.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(500)\' style=\'width:34px;height:34px;border-radius:50%;background:#e67e22;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>500</div>'"></button>
                    <button class="chip-btn" onclick="addBet(1000)"><img src="pic/m1000.jpg" onerror="this.parentElement.innerHTML='<div onclick=\'addBet(1000)\' style=\'width:34px;height:34px;border-radius:50%;background:#c0392b;display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white;cursor:pointer;\'>1K</div>'"></button>
                </div>
                <div class="bet-divider"></div>
                <div class="bet-actions">
                    <input type="number" id="bet-amount" value="0" readonly>
                    <button class="btn-clear" onclick="document.getElementById('bet-amount').value=0">âœ•</button>
                </div>
                <div class="bet-divider"></div>
                <div class="action-row">
                    <button class="btn-up"   id="btn-up"   onclick="handleAction('up')"   style="display:none;">â¬† çŒœå¤§</button>
                    <button class="btn-down" id="btn-down" onclick="handleAction('down')" style="display:none;">â¬‡ çŒœå°</button>
                    <button class="btn-allin" onclick="setAllIn()">ğŸ’¥ ALL IN</button>
                    <button class="btn-fold"  onclick="handleAction('fold')">ğŸ³ æ£„ç‰Œ($<span id="fold-cost-ui">0</span>)</button>
                </div>
            </div>

            <!-- Emoji é–‹é—œ -->
            <button id="emoji-toggle" onclick="toggleEmojiBar()" title="è¡¨æƒ…ç¬¦è™Ÿ">ğŸ˜„</button>

            <!-- Emoji åˆ— -->
            <div id="emoji-bar">
                <button class="emoji-btn" onclick="sendEmoji('ğŸ˜‚')">ğŸ˜‚</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ”¥')">ğŸ”¥</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ’¸')">ğŸ’¸</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ’©')">ğŸ’©</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸƒ')">ğŸƒ</button>
                <button class="emoji-btn" onclick="sendEmoji('ğŸ‘‘')">ğŸ‘‘</button>
            </div>

            <!-- å³ä¸‹è§’å·¥å…· -->
            <div id="tools">
                <button class="tool-btn" id="host-reset-btn" onclick="hostResetToLobby()" style="display:none;">ğŸš¨ é‡è£½</button>
            </div>

        </div><!-- /oval -->
    </div><!-- /table-wrap -->
</div><!-- /game-screen -->

<!-- èˆŠç‰ˆä¿ç•™ DOM -->
<div style="display:none;">
    <div id="setup-area"></div>
    <div id="main-board">
        <div id="bet-controls"></div>
        <div id="player-deal-btn"></div>
        <div id="host-controls"></div>
    </div>
    <div id="player-area-wrapper"><div id="player-area"></div></div>
</div>

<script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â˜… æ–¹å‘åå¥½ï¼ˆæ¯äººç¨ç«‹ï¼Œå­˜ localStorageï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let myOrientPrefer = localStorage.getItem('orientPrefer') || 'landscape';

    function setOrient(mode) {
        myOrientPrefer = mode;
        localStorage.setItem('orientPrefer', mode);
        applyOrient();

        /* æ›´æ–°æŒ‰éˆ•æ¨£å¼ */
        document.querySelectorAll('.orient-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        /* æ›´æ–°æç¤ºæ–‡å­— */
        const hint = document.getElementById('orient-hint');
        if (mode === 'landscape') {
            hint.innerHTML = '<span>æ©«å±</span>ï¼šæ‰‹æ©Ÿæ‰“æ©«ï¼Œç•«é¢æ­£å¸¸é¡¯ç¤º';
        } else {
            hint.innerHTML = '<span>ç›´å±</span>ï¼šæ‰‹æ©Ÿç›´æ‹¿ï¼Œç•«é¢è‡ªå‹•æ—‹è½‰';
        }
    }

    function applyOrient() {
        /* åªæ”¹ body classï¼ŒCSS media query è² è²¬å¯¦éš›æ—‹è½‰ */
        document.body.classList.toggle('prefer-portrait',  myOrientPrefer === 'portrait');
        document.body.classList.toggle('prefer-landscape', myOrientPrefer === 'landscape');
    }

    /* é é¢è¼‰å…¥æ™‚ç«‹å³å¥—ç”¨ */
    applyOrient();
    /* åŒæ­¥æŒ‰éˆ•ç‹€æ…‹ */
    window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.orient-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === myOrientPrefer);
        });
        const hint = document.getElementById('orient-hint');
        if (myOrientPrefer === 'portrait') {
            hint.innerHTML = '<span>ç›´å±</span>ï¼šæ‰‹æ©Ÿç›´æ‹¿ï¼Œç•«é¢è‡ªå‹•æ—‹è½‰';
        } else {
            hint.innerHTML = '<span>æ©«å±</span>ï¼šæ‰‹æ©Ÿæ‰“æ©«ï¼Œç•«é¢æ­£å¸¸é¡¯ç¤º';
        }
    });

    /* â”€â”€ Firebase â”€â”€ */
    const firebaseConfig = {
        apiKey: "AIzaSyDzd-2ZUgrDM8K_85_qSOgpkWuWNzBUBL8",
        authDomain: "dargongatepoker.firebaseapp.com",
        databaseURL: "https://dargongatepoker-default-rtdb.firebaseio.com",
        projectId: "dargongatepoker",
        storageBucket: "dargongatepoker.firebasestorage.app",
        messagingSenderId: "204663560828",
        appId: "1:204663560828:web:9ede7b6190babde73f07f9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameRef = db.ref('dragonGate/room1');

    /* â”€â”€ å…¨åŸŸç‹€æ…‹ â”€â”€ */
    let myId = "";
    let localData = {};
    let lastEffectId = "INITIAL";
    let lastShotId   = "INITIAL";
    let lastEmojiTime = 0;
    let serverOffset = 0;
    let wasMyturn = false;
    let emojiBarOpen = false;
    const labels = {1:'A', 11:'J', 12:'Q', 13:'K'};

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());
    function getServerNow() { return Date.now() + serverOffset; }

    /* â”€â”€ éŸ³æ•ˆ â”€â”€ */
    function playSfx(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.currentTime = 0;
        el.play().catch(() => {});
    }

    /* â”€â”€ Emoji æ‘ºç–Š â”€â”€ */
    function toggleEmojiBar() {
        emojiBarOpen = !emojiBarOpen;
        const bar = document.getElementById('emoji-bar');
        const btn = document.getElementById('emoji-toggle');
        if (emojiBarOpen) {
            bar.style.display = 'flex';
            btn.classList.add('open');
            btn.innerText = 'âœ•';
        } else {
            bar.style.display = 'none';
            btn.classList.remove('open');
            btn.innerText = 'ğŸ˜„';
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â˜… é£›ç‰Œå‹•ç•«ï¼ˆä¾å„äººæ–¹å‘åå¥½åˆ¤æ–·åº§æ¨™è½‰æ›ï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function animateShotCard(cardData, resultType, onDone) {
        const canvas = document.getElementById('shot-canvas');
        const ctx = canvas.getContext('2d');

        /*
          åˆ¤æ–·æ˜¯å¦éœ€è¦æ—‹è½‰åº§æ¨™ï¼š
          - prefer-portrait  ä¸”ç›®å‰æ˜¯ portrait  â†’ éœ€è¦æ—‹è½‰ï¼ˆç•«é¢å·²è¢« CSS æ—‹è½‰ 90 åº¦ï¼‰
          - å…¶ä»–æƒ…æ³ â†’ ä¸æ—‹è½‰
        */
        const isPortrait = window.innerHeight > window.innerWidth;
        const needRotate = (myOrientPrefer === 'portrait') && isPortrait;

        if (needRotate) {
            canvas.width  = window.innerHeight;
            canvas.height = window.innerWidth;
        } else {
            canvas.width  = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        const gateEl = document.getElementById('gate-frame');
        const gateRect = gateEl.getBoundingClientRect();
        const deckEl = document.getElementById('deck-stack');
        const deckRect = deckEl.getBoundingClientRect();
        const c1Rect = document.getElementById('c1').getBoundingClientRect();
        const c2Rect = document.getElementById('c2').getBoundingClientRect();

        function tr(rect) {
            if (!needRotate) return { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
            return {
                x: rect.top  + rect.height/2,
                y: canvas.height - (rect.left + rect.width/2)
            };
        }

        const gate   = tr(gateRect);
        const deck   = tr(deckRect);
        const lpost  = tr(c1Rect);
        const rpost  = tr(c2Rect);

        const isRed = cardData.suit === 'â™¥' || cardData.suit === 'â™¦';
        const cardW = 60, cardH = 86;

        let startX = deck.x, startY = deck.y;
        let endX, endY;
        if (resultType === 'win') {
            endX = gate.x; endY = gate.y;
        } else if (resultType === 'crash') {
            const post = Math.random() > 0.5 ? lpost : rpost;
            endX = post.x; endY = post.y;
        } else {
            endX = Math.random() > 0.5 ? -cardW : canvas.width + cardW;
            endY = gate.y - 40;
        }

        const cpX = (startX + endX) / 2 + (Math.random() - 0.5) * 80;
        const cpY = Math.min(startY, endY) - 130;
        let t = 0, rotation = 0;
        const duration = 50;

        function drawCard(x, y, rot, alpha) {
            ctx.save(); ctx.globalAlpha = alpha; ctx.translate(x, y); ctx.rotate(rot);
            ctx.fillStyle = '#fff'; ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
            roundRect(ctx, -cardW/2, -cardH/2, cardW, cardH, 8);
            ctx.fill(); ctx.stroke();
            ctx.fillStyle = isRed ? '#e74c3c' : '#000';
            ctx.font = `bold 20px 'Segoe UI'`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(cardData.suit, 0, -10);
            ctx.fillText(cardData.label.toString(), 0, 14);
            ctx.restore();
        }
        function roundRect(c, x, y, w, h, r) {
            c.beginPath();
            c.moveTo(x+r,y); c.lineTo(x+w-r,y); c.quadraticCurveTo(x+w,y,x+w,y+r);
            c.lineTo(x+w,y+h-r); c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
            c.lineTo(x+r,y+h); c.quadraticCurveTo(x,y+h,x,y+h-r);
            c.lineTo(x,y+r); c.quadraticCurveTo(x,y,x+r,y); c.closePath();
        }

        let particles = [];
        function spawnCrash(x, y) {
            for (let i=0; i<20; i++) {
                const a=Math.random()*Math.PI*2, s=3+Math.random()*6;
                particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,color:Math.random()>0.5?'#f39c12':'#e74c3c'});
            }
        }
        let phase='fly', it=0;
        function frame() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if (phase==='fly') {
                t++;
                const p=t/duration, e=p<0.5?2*p*p:-1+(4-2*p)*p;
                const bx=(1-e)*(1-e)*startX+2*(1-e)*e*cpX+e*e*endX;
                const by=(1-e)*(1-e)*startY+2*(1-e)*e*cpY+e*e*endY;
                rotation+=0.15;
                drawCard(bx,by,rotation,Math.min(1,p*3));
                if(t>=duration){phase='impact';if(resultType==='crash')spawnCrash(endX,endY);}
                requestAnimationFrame(frame);
            } else if(phase==='impact'){
                it++;
                if(resultType==='win'){
                    const sc=1-it/25,a=1-it/20;
                    if(a>0){ctx.save();ctx.strokeStyle=`rgba(46,204,113,${a})`;ctx.lineWidth=4;ctx.beginPath();ctx.arc(endX,endY,50+it*3,0,Math.PI*2);ctx.stroke();ctx.restore();drawCard(endX,endY,0,a*sc);}
                } else if(resultType==='crash'){
                    particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.3;p.life-=0.04;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();ctx.restore();});
                    particles=particles.filter(p=>p.life>0);
                    drawCard(endX+(Math.random()-0.5)*(10-it*0.5),endY,Math.random()*0.3,Math.max(0,1-it/20));
                } else {
                    const a=Math.max(0,1-it/15),fly=it*8,dir=endX<canvas.width/2?-1:1;
                    drawCard(endX+dir*fly,endY-fly*0.3,rotation+it*0.2,a);
                }
                if(it>=25||(resultType==='lose'&&it>=18)){ctx.clearRect(0,0,canvas.width,canvas.height);if(onDone)onDone();return;}
                requestAnimationFrame(frame);
            }
        }
        requestAnimationFrame(frame);
    }

    /* â”€â”€ çµæœæ©«å¹… â”€â”€ */
    function showResultBanner(emoji, text, amount, type) {
        const b = document.getElementById('result-banner');
        document.getElementById('rb-emoji').innerText = emoji;
        document.getElementById('rb-text').innerText = text;
        const ae = document.getElementById('rb-amount');
        ae.innerText = (amount>=0?'+':'')+'$'+amount;
        ae.className = 'rb-amount '+(amount>=0?'positive':'negative');
        b.classList.remove('show'); b.style.display='block';
        requestAnimationFrame(()=>requestAnimationFrame(()=>b.classList.add('show')));
        setTimeout(()=>{b.classList.remove('show');setTimeout(()=>b.style.display='none',400);},2800);
    }

    /* â”€â”€ å½©ç´™ â”€â”€ */
    function spawnConfetti(count) {
        const cols=['#f1c40f','#2ecc71','#3498db','#e74c3c','#9b59b6','#fff'];
        for(let i=0;i<count;i++){
            const el=document.createElement('div');el.className='confetti-piece';
            el.style.left=Math.random()*100+'vw';el.style.background=cols[Math.floor(Math.random()*cols.length)];
            el.style.animationDuration=(1.5+Math.random()*1.5)+'s';el.style.animationDelay=(Math.random()*0.5)+'s';
            document.body.appendChild(el);setTimeout(()=>el.remove(),3500);
        }
    }

    /* â”€â”€ Toasts â”€â”€ */
    let myTurnTimer=null;
    function showMyTurnToast(){
        const t=document.getElementById('my-turn-toast');t.style.display='block';
        if('vibrate'in navigator)navigator.vibrate([150,50,150]);
        clearTimeout(myTurnTimer);myTurnTimer=setTimeout(()=>t.style.display='none',3000);
    }
    let refillTimer=null;
    function showRefillToast(fee,count){
        const t=document.getElementById('refill-toast');
        t.innerText=`ğŸ’° æ± é‡‘ä¸è¶³,æ¯äººè£œåº• $${fee}(å…±è£œ $${fee*count})`;
        t.style.display='block';clearTimeout(refillTimer);refillTimer=setTimeout(()=>t.style.display='none',3500);
    }

    /* â”€â”€ åº§ä½æ¸²æŸ“ â”€â”€ */
    function renderSeats() {
        const layer = document.getElementById('seats-layer');
        if (!layer || !localData.players) return;
        layer.innerHTML = '';
        const pKeys = Object.keys(localData.players);
        const n = pKeys.length;
        if (n === 0) return;
        const myIdx = pKeys.indexOf(myId);
        const rx = 42, ry = 38;

        pKeys.forEach((id, i) => {
            const p = localData.players[id];
            const isMe     = (id === myId);
            const isHost   = (i === 0);
            const isActive = (id === localData.currentPlayerKey);
            const relIdx   = (i - myIdx + n) % n;
            const angleRad = (90 + relIdx * (360/n)) * Math.PI / 180;
            const cx = 50 + rx * Math.cos(angleRad);
            const cy = 50 + ry * Math.sin(angleRad);
            const crown = isHost ? ' ğŸ‘‘' : '';
            let tmr = '';
            if (isActive && localData.lastActionTime) {
                const sec = Math.max(0, 60 - Math.floor((getServerNow()-localData.lastActionTime)/1000));
                tmr = `<div class="seat-tmr">â±${sec}s</div>`;
            }
            const boxCls = ['seat-box',isActive?'active':'',isMe?'is-me':''].filter(Boolean).join(' ');
            const node = document.createElement('div');
            node.className = 'seat'+(isMe?' is-me':'');
            node.style.left = cx+'%'; node.style.top = cy+'%';
            node.innerHTML = `<button class="seat-kick" onclick="kickPlayer('${id}')">âœ•</button><div class="${boxCls}"><div class="seat-name">${p.name}${crown}</div><div class="seat-bal">$${p.balance}</div>${tmr}</div>`;
            layer.appendChild(node);
        });

        const oval = document.getElementById('oval');
        if (oval) {
            if (localData.currentPlayerKey===myId) oval.classList.add('my-turn');
            else oval.classList.remove('my-turn');
        }
    }

    /* â”€â”€ é»æ“Šç‰Œå † â”€â”€ */
    function onDeckClick() {
        if (!localData.gameStarted) return;
        if (localData.currentPlayerKey !== myId) return;
        if (localData.gameState === 'waiting_deal') {
            drawGoalPost();
        } else if (localData.gameState === 'waiting_shoot') {
            const bet = Math.abs(parseInt(document.getElementById('bet-amount').value)) || 0;
            const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;
            if (bet < 1 || bet > localData.pool) {
                const h = document.getElementById('deck-hint');
                h.innerText = 'âš ï¸ è«‹å…ˆä¸‹æ³¨!'; h.classList.add('show');
                setTimeout(()=>{h.innerText='ä¸‹æ³¨å¾Œé»æ“Šå°„é–€';},1500); return;
            }
            if (isSame) {
                const h = document.getElementById('deck-hint');
                h.innerText = 'âš ï¸ è«‹çŒœå¤§æˆ–çŒœå°'; h.classList.add('show');
                setTimeout(()=>{h.innerText='çŒœå¤§/çŒœå°';},1500);
            } else {
                handleAction('shoot');
            }
        }
    }

    /* â”€â”€ å¿ƒè·³ â”€â”€ */
    setInterval(()=>{
        if(myId&&localData.players&&localData.players[myId])
            gameRef.child('players/'+myId).update({lastActive:getServerNow()});
    },5000);

    setInterval(()=>{
        if(!localData.players) return;
        const now=getServerNow(),players=localData.players,pKeys=Object.keys(players);
        if(pKeys[0]===myId){
            pKeys.forEach(id=>{if(id!==myId&&(!players[id].lastActive||now-players[id].lastActive>60000))gameRef.child('players/'+id).remove();});
        }
        if(pKeys.length===0&&localData.gameStarted){gameRef.update({gameStarted:false,c1:null,c2:null,c3:null});return;}
        if(!localData.gameStarted)return;
        const cpKey=localData.currentPlayerKey;
        if(cpKey&&!players[cpKey]){gameRef.update({gameState:'waiting_deal',currentPlayerKey:pKeys[0],lastActionTime:firebase.database.ServerValue.TIMESTAMP});return;}
        if(pKeys[0]===myId&&localData.lastActionTime){
            const diff=(now-localData.lastActionTime)/1000;
            if(diff>60.5){
                gameRef.child('players/'+cpKey).remove().then(()=>{
                    const nk=Object.keys(localData.players).filter(k=>k!==cpKey);
                    gameRef.update({gameState:'waiting_deal',currentPlayerKey:nk[0]||null,statusMsg:"ç©å®¶è¶…æ™‚è¸¢é™¤",lastActionTime:firebase.database.ServerValue.TIMESTAMP});
                });
            }
        }
        renderSeats();
    },1000);

    /* â”€â”€ é€²å ´ â”€â”€ */
    function togglePlayers(){}

    function joinRoom() {
        const name = document.getElementById('my-name').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
        const now = getServerNow();
        gameRef.once('value', snap => {
            const data = snap.val() || {};
            const players = data.players || {};
            Object.keys(players).forEach(id => {
                if (!players[id].lastActive || now - players[id].lastActive > 60000) {
                    delete players[id]; gameRef.child('players/'+id).remove();
                }
            });
            const pKeys = Object.keys(players);
            if (pKeys.length === 0) gameRef.update({gameStarted:false,c1:null,c2:null,c3:null,currentPlayerKey:null});
            const newRef = gameRef.child('players').push();
            myId = newRef.key;
            gameRef.child('players/'+myId).update({name,balance:0,lastActive:now});
            if(data.allInTrigger) lastEffectId = data.allInTrigger;
            if(data.lastEmoji)    lastEmojiTime = data.lastEmoji.time;
            if(data.lastShot)     lastShotId    = data.lastShot.id;
            startListening();
            document.getElementById('login-part').style.display = 'none';
        });
    }

    function startListening() {
        gameRef.on('value', snap => {
            localData = snap.val() || {};
            if (!localData.players || !localData.players[myId]) return;

            const pKeys  = Object.keys(localData.players);
            const isHost = (pKeys[0] === myId);
            document.body.className = isHost ? "is-host" : "";
            /* é‡æ–°å¥—ç”¨æ–¹å‘ï¼ˆbody class è¢«è¦†å¯«äº†ï¼Œè¦è£œå›ä¾†ï¼‰ */
            applyOrient();

            if (localData.lastEmoji && localData.lastEmoji.time > lastEmojiTime) {
                showEmojiBroadcast(localData.lastEmoji.name, localData.lastEmoji.icon);
                lastEmojiTime = localData.lastEmoji.time;
            }

            /* å»£æ’­é£›ç‰Œ */
            if (localData.lastShot && localData.lastShot.id !== lastShotId) {
                const shot = localData.lastShot;
                lastShotId = shot.id;
                if (shot.shooterId !== myId) {
                    updateCard('c1', localData.c1);
                    updateCard('c2', localData.c2);
                    document.getElementById('gate-inner').style.display = 'none';
                    animateShotCard(shot.card, shot.resultType, () => {
                        updateGateCard(localData.c3);
                        const sfxMap={win:'sfx-win',crash:'sfx-crash',lose:'sfx-lose'};
                        playSfx(sfxMap[shot.resultType]||'sfx-lose');
                        if(shot.resultType==='win')spawnConfetti(40);
                        showResultBanner(shot.emoji,shot.text,shot.delta,shot.resultType);
                    });
                }
            }

            if (localData.allInTrigger && localData.allInTrigger !== lastEffectId) {
                const v = document.getElementById('video-box');
                v.innerHTML=`<video width="315" height="560" autoplay playsinline><source src="video/allin.mp4" type="video/mp4"></video>`;
                document.getElementById('all-in-overlay').style.display='flex';
                playSfx('sfx-allin');
                setTimeout(()=>document.getElementById('all-in-overlay').style.display='none',2500);
                lastEffectId = localData.allInTrigger;
            }

            if (localData.gameStarted) {
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                document.getElementById('emoji-toggle').style.display = 'flex';
                document.getElementById('emoji-bar').style.display = 'none';
                emojiBarOpen = false;
                document.getElementById('emoji-toggle').classList.remove('open');
                document.getElementById('emoji-toggle').innerText = 'ğŸ˜„';
                document.getElementById('tools').style.display = 'flex';
                renderUI(isHost);
                const isTurnNow = (localData.currentPlayerKey === myId);
                if (isTurnNow && !wasMyturn) showMyTurnToast();
                wasMyturn = isTurnNow;
            } else {
                document.getElementById('setup-screen').style.display = 'flex';
                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('emoji-toggle').style.display = 'none';
                document.getElementById('emoji-bar').style.display = 'none';
                document.getElementById('tools').style.display = 'none';
                document.getElementById('host-part').style.display = isHost ? 'block' : 'none';
                /* è¿”å›ç™»å…¥ç•«é¢æ™‚åŒæ­¥é¸æ“‡å™¨ç‹€æ…‹ */
                document.querySelectorAll('.orient-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === myOrientPrefer);
                });
                wasMyturn = false;
            }
            const hrb = document.getElementById('host-reset-btn');
            if (hrb) hrb.style.display = isHost ? 'block' : 'none';
            renderSeats();
        });
    }

    /* â”€â”€ Emoji â”€â”€ */
    function sendEmoji(icon) {
        gameRef.update({lastEmoji:{name:localData.players[myId].name,icon,time:firebase.database.ServerValue.TIMESTAMP}});
        if (emojiBarOpen) toggleEmojiBar();
    }
    function showEmojiBroadcast(name, icon) {
        const a=document.getElementById('emoji-broadcast-area');
        const d=document.createElement('div');d.className='broadcast-item';
        d.innerText=`${name}: ${icon}`;a.appendChild(d);setTimeout(()=>d.remove(),2500);
    }

    /* â”€â”€ renderPlayers â”€â”€ */
    function renderPlayers() {}

    /* â”€â”€ hostStartGame â”€â”€ */
    function hostStartGame() {
        const fee   = parseInt(document.getElementById('entry-fee').value)||100;
        const start = parseInt(document.getElementById('start-balance').value)||1000;
        const decks = parseInt(document.getElementById('deck-count').value)||2;
        const refill= document.getElementById('auto-refill').checked;
        let players=localData.players, pool=0;
        Object.keys(players).forEach(id=>{players[id].balance=start-fee;pool+=fee;});
        gameRef.update({
            gameStarted:true,deck:generateDecks(decks),pool,entryFee:fee,
            foldPenalty:parseInt(document.getElementById('fold-penalty').value)||20,
            autoRefill:refill,deckCount:decks,gameState:'waiting_deal',
            currentPlayerKey:Object.keys(players)[0],players,
            lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:"æ–°å±€é–‹å§‹"
        });
    }

    function drawGoalPost() {
        playSfx('sfx-deal');
        let deck=localData.deck||[];
        if(deck.length<3)deck=generateDecks(localData.deckCount||2);
        const c1=deck.pop(),c2=deck.pop();
        gameRef.update({deck,c1,c2,c3:null,gameState:'waiting_shoot',lastActionTime:firebase.database.ServerValue.TIMESTAMP,statusMsg:"è«‹ä¸‹æ³¨å¾ŒæŠ½é–€ç‰Œ"});
    }

    function handleAction(type) {
        let bet=Math.abs(parseInt(document.getElementById('bet-amount').value))||0;
        if(type!=='fold'&&(bet<1||bet>localData.pool))return alert("è«‹ä¸‹æ³¨");
        let p=localData.players[myId],nBal=p.balance,nPool=localData.pool;
        let msg="",c3=null,deck=localData.deck||[];
        let resultType='neutral',deltaAmount=0;

        if(type==='fold'){
            nBal-=localData.foldPenalty;nPool+=localData.foldPenalty;
            msg=`${p.name} æ£„ç‰Œ`;resultType='fold';deltaAmount=-localData.foldPenalty;
        } else {
            if(deck.length<1)deck=generateDecks(localData.deckCount||2);
            c3=deck.pop();
            const min=Math.min(localData.c1.val,localData.c2.val);
            const max=Math.max(localData.c1.val,localData.c2.val);
            if(localData.c1.val===localData.c2.val){
                if(c3.val===localData.c1.val){nBal-=bet*3;nPool+=bet*3;msg=`æ’æŸ±(-$${bet*3})`;resultType='crash';deltaAmount=-(bet*3);}
                else if((type==='up'&&c3.val>localData.c1.val)||(type==='down'&&c3.val<localData.c1.val)){nBal+=bet;nPool-=bet;msg=`çŒœå°(+$${bet})`;resultType='win';deltaAmount=bet;}
                else{nBal-=bet;nPool+=bet;msg=`çŒœéŒ¯(-$${bet})`;resultType='lose';deltaAmount=-bet;}
            } else {
                if(c3.val>min&&c3.val<max){nBal+=bet;nPool-=bet;msg=`å°„é€²(+$${bet})`;resultType='win';deltaAmount=bet;}
                else if(c3.val===min||c3.val===max){nBal-=bet*2;nPool+=bet*2;msg=`æ’æŸ±(-$${bet*2})`;resultType='crash';deltaAmount=-(bet*2);}
                else{nBal-=bet;nPool+=bet;msg=`æ²’é€²(-$${bet})`;resultType='lose';deltaAmount=-bet;}
            }
        }

        const pKeys=Object.keys(localData.players);
        let nextK=pKeys[(pKeys.indexOf(myId)+1)%pKeys.length];
        let updates={
            [`players/${myId}/balance`]:nBal,pool:nPool,deck,c3:c3||null,
            statusMsg:msg,gameState:'waiting_deal',currentPlayerKey:nextK,
            lastActionTime:firebase.database.ServerValue.TIMESTAMP
        };

        const minPoolNeeded=localData.entryFee*pKeys.length;
        const needRefill=(localData.autoRefill&&nPool<minPoolNeeded)||(nPool<=0);
        let refillTriggered=false;
        if(needRefill){
            let total=0;
            pKeys.forEach(k=>{const cb=(k===myId)?nBal:localData.players[k].balance;updates[`players/${k}/balance`]=cb-localData.entryFee;total+=localData.entryFee;});
            updates.pool=nPool+total;refillTriggered=true;
        }

        if(type!=='fold'&&c3){
            updates.lastShot={
                id:Date.now().toString(),shooterId:myId,card:c3,resultType,
                emoji:resultType==='win'?'ğŸ‰':resultType==='crash'?'ğŸ’¥':'ğŸ˜­',
                text:resultType==='win'?(type==='up'||type==='down'?'çŒœå°!':'å°„é€²!'):resultType==='crash'?'æ’æŸ±!!':(type==='up'||type==='down'?'çŒœéŒ¯äº†':'æ²’é€²...'),
                delta:deltaAmount
            };
        }

        gameRef.update(updates);
        document.getElementById('bet-amount').value=0;

        if(type!=='fold'&&c3){
            document.getElementById('gate-inner').style.display='none';
            animateShotCard(c3,resultType,()=>{
                updateGateCard(c3);
                if(resultType==='win'){playSfx('sfx-win');spawnConfetti(40);showResultBanner('ğŸ‰',type==='up'?'çŒœå°!':'å°„é€²!',deltaAmount,'win');}
                else if(resultType==='crash'){playSfx('sfx-crash');showResultBanner('ğŸ’¥','æ’æŸ±!!',deltaAmount,'crash');}
                else{playSfx('sfx-lose');showResultBanner('ğŸ˜­',type==='up'||type==='down'?'çŒœéŒ¯äº†':'æ²’é€²...',deltaAmount,'lose');}
                if(refillTriggered)showRefillToast(localData.entryFee,pKeys.length);
            });
        } else {
            playSfx('sfx-fold');
            showResultBanner('ğŸ³ï¸','æ£„ç‰Œ',deltaAmount,'fold');
            if(refillTriggered)showRefillToast(localData.entryFee,pKeys.length);
        }
    }

    function renderUI(isHost) {
        document.getElementById('pool-val').innerText   = localData.pool || 0;
        document.getElementById('status-msg').innerText = localData.statusMsg || "";
        document.getElementById('cards-left').innerText = localData.deck ? localData.deck.length : 0;
        document.getElementById('fold-cost-ui').innerText = localData.foldPenalty || 20;

        updateCard('c1', localData.c1);
        updateCard('c2', localData.c2);
        updateGateCard(localData.c3);

        const isTurn = (localData.currentPlayerKey === myId);
        const isSame = localData.c1 && localData.c2 && localData.c1.val === localData.c2.val;

        const deckEl  = document.getElementById('deck-stack');
        const hintEl  = document.getElementById('deck-hint');
        const badgeEl = document.getElementById('deck-badge');
        if (badgeEl) badgeEl.innerText = localData.deck ? localData.deck.length : 0;

        if (isTurn && localData.gameState === 'waiting_deal') {
            deckEl.classList.add('can-click');
            hintEl.innerText='é»æ“ŠæŠ½ç‰Œ'; hintEl.classList.add('show');
        } else if (isTurn && localData.gameState === 'waiting_shoot') {
            deckEl.classList.add('can-click');
            hintEl.innerText = isSame ? 'çŒœå¤§/çŒœå°' : 'ä¸‹æ³¨å¾Œé»æ“Šå°„é–€';
            hintEl.classList.add('show');
        } else {
            deckEl.classList.remove('can-click');
            hintEl.classList.remove('show');
        }

        const betPanel = document.getElementById('bet-panel');
        betPanel.style.display = (isTurn && localData.gameState === 'waiting_shoot') ? 'flex' : 'none';

        document.getElementById('btn-up').style.display   = isSame ? 'inline-block' : 'none';
        document.getElementById('btn-down').style.display = isSame ? 'inline-block' : 'none';
    }

    function updateGateCard(c) {
        const gi=document.getElementById('gate-inner'),c3g=document.getElementById('c3-in-gate');
        if(!c){gi.style.display='';gi.innerText='å¾…å°„é–€';c3g.style.display='none';c3g.innerHTML='';}
        else{
            gi.style.display='none';
            const isRed=c.suit==='â™¥'||c.suit==='â™¦';
            c3g.style.display='block';
            const w='clamp(44px,7.5vmin,68px)',h='clamp(62px,10.5vmin,96px)';
            c3g.innerHTML=`<div class="card${isRed?' red':''}" style="width:${w};height:${h};">${c.suit}\n${c.label}</div>`;
        }
    }
    function updateCard(id,c){
        const el=document.getElementById(id);
        if(!c){el.classList.add('hidden');el.innerText='?';}
        else{el.classList.remove('hidden');el.innerText=`${c.suit}\n${c.label}`;el.classList.toggle('red',c.suit==='â™¥'||c.suit==='â™¦');}
    }
    function addBet(v){
        let cur=parseInt(document.getElementById('bet-amount').value)||0;
        document.getElementById('bet-amount').value=Math.min(cur+v,localData.pool);
    }
    function setAllIn(){
        document.getElementById('allin-pool-preview').innerText='$'+(localData.pool||0);
        document.getElementById('all-in-confirm-overlay').classList.add('show');
    }
    function cancelAllIn(){document.getElementById('all-in-confirm-overlay').classList.remove('show');}
    function confirmAllIn(){
        document.getElementById('all-in-confirm-overlay').classList.remove('show');
        gameRef.update({allInTrigger:getServerNow().toString()});
        document.getElementById('bet-amount').value=localData.pool;
    }
    function generateDecks(count){
        let deck=[];const suits=['â™ ','â™¥','â™¦','â™£'];
        for(let i=0;i<count;i++)suits.forEach(s=>{for(let v=1;v<=13;v++)deck.push({val:v,suit:s,label:labels[v]||v});});
        return deck.sort(()=>Math.random()-0.5);
    }
    function kickPlayer(id){if(confirm("å‰”é™¤è©²ç©å®¶?"))gameRef.child('players/'+id).remove();}
    function hostResetToLobby(){if(confirm("é‡è£½å¤§å»³ç‹€æ…‹?"))gameRef.update({gameStarted:false});}
</script>
</body>
</html>
